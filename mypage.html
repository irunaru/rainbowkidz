<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸ‘¤ ë‚´ í˜ì´ì§€ - ë¬´ì§€ê°œ ìœ ì¹˜ì›</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    /* ===== DESIGN TOKENS (SAFE TO EDIT) ===== */
  :root {
      --bg:#f2f2f7; --card:#fff; --text:#1c1c1e; --sub:#636366; --sub2:#8e8e93;
      --border:#e5e5ea; --accent:#ff6b6b; --yar:#ff9f0a; --blue:#007aff;
      --radius-card:16px; --radius-pill:999px; --shadow:0 1px 4px rgba(0,0,0,.06);
    }
    body { font-family:'Noto Sans KR',-apple-system,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
    .hidden { display:none !important; }
    #loader { position:fixed; inset:0; background:rgba(255,255,255,.96); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9000; gap:10px; }
    .spinner { width:28px; height:28px; border:3px solid var(--border); border-top-color:var(--text); border-radius:50%; animation:spin .8s linear infinite; }
    @keyframes spin { to{ transform:rotate(360deg); } }

  /* ===== COMPONENTS (SAFE TO EDIT) ===== */
    .header { background:var(--card); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:100; }
    .header-inner { max-width:640px; margin:0 auto; padding:10px 16px; display:flex; align-items:center; }
    .header-title { font-size:17px; font-weight:900; }
    .container { max-width:640px; margin:0 auto; padding:16px 16px 96px; }
    .profile-card { background:var(--card); border-radius:var(--radius-card); padding:20px; margin-bottom:12px; box-shadow:var(--shadow); }
    .profile-top { display:flex; align-items:center; gap:16px; }
    .avatar-wrap { position:relative; flex-shrink:0; cursor:pointer; }
    .avatar-img { width:78px; height:78px; border-radius:22px; background:var(--bg); border:2px solid var(--border); overflow:hidden; display:flex; align-items:center; justify-content:center; font-size:36px; }
    .avatar-img img { width:100%; height:100%; object-fit:cover; }
    .avatar-cam { position:absolute; bottom:-6px; right:-6px; width:24px; height:24px; background:var(--text); border-radius:50%; color:#fff; display:flex; align-items:center; justify-content:center; font-size:12px; border:2px solid var(--card); pointer-events:none; }
    .profile-info { flex:1; min-width:0; }
    .profile-nick { font-size:20px; font-weight:900; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .profile-sub { font-size:12px; color:var(--sub); }
    .profile-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .btn-sm { padding:7px 14px; border-radius:var(--radius-pill); font-size:12px; font-weight:800; cursor:pointer; border:none; font-family:inherit; min-height:34px; }
    .btn-sm.primary { background:var(--text); color:#fff; }
    .btn-sm.outline { background:var(--bg); color:var(--text); border:1.5px solid var(--border); }
    .btn-sm:active { opacity:.75; }
    .nick-edit { background:var(--bg); border-radius:14px; padding:12px; margin-top:14px; }
    .nick-edit-hint { font-size:12px; color:var(--sub); line-height:1.45; margin-bottom:8px; }
    .nick-row { display:flex; gap:8px; }
    .nick-input { flex:1; padding:10px 12px; border-radius:10px; border:1.5px solid var(--border); font-family:inherit; font-size:15px; min-height:44px; }
    .nick-input:focus { outline:none; border-color:var(--text); }
    .nick-save { padding:0 16px; background:var(--text); color:#fff; border:none; border-radius:10px; font-family:inherit; font-size:13px; font-weight:800; cursor:pointer; min-height:44px; white-space:nowrap; }
    .nick-save:disabled { opacity:.5; }
    .nick-msg { font-size:12px; margin-top:6px; min-height:16px; }
    .nick-msg.err { color:var(--accent); }
    .nick-msg.cool { color:var(--sub); }
    .unified-tabs { display:flex; background:var(--card); border-radius:var(--radius-card); padding:4px; margin-top:16px; gap:4px; box-shadow:var(--shadow); border:1px solid var(--border); }
    .u-tab-btn { flex:1; padding:12px 0; border:none; background:transparent; cursor:pointer; border-radius:12px; display:flex; flex-direction:column; align-items:center; position:relative; transition:background .15s; font-family:inherit; }
    .u-tab-btn.active { background:var(--bg); }
    .u-tab-btn .num { font-size:18px; font-weight:900; color:var(--sub2); }
    .u-tab-btn.active .num { color:var(--text); }
    .u-tab-btn .label { font-size:11px; font-weight:800; color:var(--sub2); margin-top:2px; }
    .u-tab-btn.active .label { color:var(--text); }
    .u-badge { position:absolute; top:8px; right:16%; background:var(--accent); color:#fff; border-radius:10px; font-size:10px; font-weight:900; padding:1px 5px; border:2px solid var(--card); }
    .list-item { background:var(--card); border-radius:var(--radius-card); padding:16px; margin-bottom:10px; box-shadow:var(--shadow); display:flex; gap:12px; align-items:flex-start; cursor:pointer; }
    .item-avatar { width:46px; height:46px; border-radius:14px; background:var(--bg); flex-shrink:0; overflow:hidden; border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:22px; }
    .item-avatar img { width:100%; height:100%; object-fit:cover; }
    .item-body { flex:1; min-width:0; }
    .item-top { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:4px; }
    .item-nick { font-size:14px; font-weight:900; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .item-tag { font-size:11px; font-weight:800; color:var(--blue); background:rgba(0,122,255,0.08); padding:2px 6px; border-radius:5px; flex-shrink:0; }
    .item-content { font-size:13px; color:var(--sub); line-height:1.45; word-break:break-word; margin-top:4px; }
    .item-target { font-size:12px; color:var(--sub); background:var(--bg); padding:5px 10px; border-radius:8px; display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin:4px 0; }
    .item-meta { font-size:11px; color:var(--sub2); white-space:nowrap; }
    .post-card { background:var(--card); border-radius:var(--radius-card); padding:16px; margin-bottom:10px; box-shadow:var(--shadow); cursor:pointer; }
    .post-title { font-size:15px; font-weight:900; margin-bottom:6px; line-height:1.35; }
    .post-body { font-size:13px; color:var(--sub); line-height:1.45; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; margin-bottom:10px; }
    .post-meta { display:flex; gap:12px; font-size:12px; color:var(--sub); align-items:center; }
    .post-delete { margin-left:auto; color:var(--accent); border:none; background:none; font-size:12px; font-weight:900; cursor:pointer; font-family:inherit; }
    .empty { text-align:center; padding:48px 20px; color:var(--sub2); }
    .bottom-nav { position:fixed; bottom:0; left:0; right:0; background:var(--card); border-top:1px solid var(--border); display:flex; z-index:100; padding-bottom:env(safe-area-inset-bottom,0); }
    .bottom-nav a { flex:1; text-align:center; padding:12px 0; text-decoration:none; color:var(--sub); font-size:10px; font-weight:800; }
    .bottom-nav a.active { color:var(--text); }
    .confirm-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:2000; display:flex; align-items:center; justify-content:center; padding:24px; }
    .confirm-overlay.hidden { display:none; }
    .confirm-box { background:#fff; padding:22px; border-radius:22px; width:100%; max-width:300px; text-align:center; }
    .confirm-title { font-weight:900; margin-bottom:10px; font-size:16px; }
    .confirm-sub { font-size:13px; color:var(--sub); line-height:1.45; margin-bottom:16px; }
    .confirm-btns { display:flex; gap:8px; }
    .confirm-btn { flex:1; padding:12px; border:none; border-radius:12px; font-weight:900; cursor:pointer; font-family:inherit; }
    .confirm-btn.no { background:var(--bg); color:var(--text); border:1.5px solid var(--border); }
    .confirm-btn.yes { background:var(--accent); color:#fff; }
  </style>
</head>
<body>
<div id="loader">
  <div style="font-size:44px;">ğŸŒˆ</div>
  <div class="spinner"></div>
  <div style="font-size:13px;color:var(--sub);">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>
<div class="header">
  <div class="header-inner"><div class="header-title">ğŸ‘¤ ë‚´ í˜ì´ì§€</div></div>
</div>
<div class="container">
  <div class="profile-card">
    <div class="profile-top">
      <div class="avatar-wrap" id="avatarWrap">
        <div class="avatar-img" id="avatarImg">ğŸ‘¤</div>
        <div class="avatar-cam">ğŸ“·</div>
      </div>
      <div class="profile-info">
        <div class="profile-nick" id="nickDisplay">-</div>
        <div class="profile-sub" id="profileSub">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <div class="profile-actions">
          <button class="btn-sm primary" id="avatarBtn" type="button">ğŸ¨ ê¾¸ë¯¸ê¸°</button>
          <button class="btn-sm outline" id="nickToggleBtn" type="button">âœï¸ ë‹‰ë„¤ì„ ì„¤ì •</button>
        </div>
      </div>
    </div>
    <div class="nick-edit hidden" id="nickEdit">
      <div class="nick-edit-hint">í•œê¸€Â·ì˜ë¬¸Â·ìˆ«ì 1~10ì. ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì€ ë¶ˆê°€í•©ë‹ˆë‹¤.</div>
      <div class="nick-row">
        <input class="nick-input" id="nickInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" maxlength="10" autocomplete="off">
        <button class="nick-save" id="nickSaveBtn" type="button">ì €ì¥</button>
      </div>
      <div class="nick-msg" id="nickMsg"></div>
    </div>
    <input type="file" id="avatarInput" accept="image/*" style="display:none">
    <div class="unified-tabs" style="margin-top:16px;">
      <button class="u-tab-btn active" id="tabPosts" type="button">
        <span class="num" id="statPosts">0</span>
        <span class="label">âœï¸ ë‚´ ê¸€</span>
      </button>
      <button class="u-tab-btn" id="tabYars" type="button">
        <span class="num" id="statYars">0</span>
        <span class="label">ğŸŒŸ ë°›ì€ ì•¼ë¥´~</span>
        <span class="u-badge hidden" id="yarBadge">0</span>
      </button>
      <button class="u-tab-btn" id="tabComments" type="button">
        <span class="num" id="statComments">0</span>
        <span class="label">ğŸ’¬ ë°›ì€ ëŒ“ê¸€</span>
        <span class="u-badge hidden" id="cmtBadge">0</span>
      </button>
    </div>
  </div>
  <div id="secPosts"></div>
  <div id="secYars" class="hidden"></div>
  <div id="secComments" class="hidden"></div>
</div>
<div class="bottom-nav">
  <a href="index.html">ğŸ  í™ˆ</a>
  <a href="#" id="writeNavBtn">âœï¸ ê¸€ì“°ê¸°</a>
  <a href="mypage.html" class="active">ğŸ‘¤ ë‚´ í˜ì´ì§€</a>
</div>
<div class="confirm-overlay hidden" id="confirmOverlay">
  <div class="confirm-box">
    <div class="confirm-title">ê¸€ì„ ì‚­ì œí• ê¹Œìš”?</div>
    <div class="confirm-sub">ì‚­ì œí•˜ë©´ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
    <div class="confirm-btns">
      <button class="confirm-btn no" id="confirmNo" type="button">ì·¨ì†Œ</button>
      <button class="confirm-btn yes" id="confirmYes" type="button">ì‚­ì œ</button>
    </div>
  </div>
</div>
<script>
(() => {
  if (window.__rk_mypage_loaded) return;
  window.__rk_mypage_loaded = true;
  'use strict';
  const API = 'https://rainbowkidz-api.irunaru.workers.dev/api/v1';
  let guestId = null, myNickname = null;
  let myPosts = [], allYarers = [], receivedComments = [];
  let pendingDeleteFn = null;
  const $ = id => document.getElementById(id);
  const esc = s => String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  const relTime = d => {
    if (!d) return '';
    const sec = (Date.now() - new Date(d).getTime()) / 1000;
    if (sec < 60) return 'ë°©ê¸ˆ';
    if (sec < 3600) return `${Math.floor(sec/60)}ë¶„ ì „`;
    if (sec < 86400) return `${Math.floor(sec/3600)}ì‹œê°„ ì „`;
    if (sec < 604800) return `${Math.floor(sec/86400)}ì¼ ì „`;
    try { return new Date(d).toLocaleDateString('ko-KR',{month:'long',day:'numeric'}); } catch { return ''; }
  };
  const apiUrl = p => { const sep = p.includes('?')?'&':'?'; return guestId?`${API}${p}${sep}guest_id=${encodeURIComponent(guestId)}`:`${API}${p}`; };

  // [FIX 2/3] createSafeImg - src ì—†ìœ¼ë©´ ì´ëª¨ì§€ë§Œ ë°˜í™˜
  const createSafeImg = (src, fallbackEmoji) => {
    if (!src) return `<span style="font-size:22px;">${fallbackEmoji}</span>`;
    return `<img src="${esc(src)}" alt="" onerror="this.outerHTML='<span style=\\'font-size:22px;\\'>${fallbackEmoji}</span>'">`;
  };

  const setLoader = on => $('loader').classList.toggle('hidden', !on);

  async function initGuest() {
    try {
      const r = await fetch(`${API}/guest/init`, { method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body:JSON.stringify({existing_gid:localStorage.getItem('rkGuestId')||null}) });
      if (r.ok) { const d = await r.json(); if (d.guest_id) { guestId = d.guest_id; localStorage.setItem('rkGuestId', d.guest_id); } }
    } catch {}
    try {
      const r = await fetch(apiUrl('/me'), { credentials:'include' });
      if (r.ok) {
        const d = await r.json();
        myNickname = d.guest?.nickname || null;
        if (myNickname) localStorage.setItem('rkNickname', myNickname);
        else localStorage.removeItem('rkNickname');
        if (d.guest?.image_url) $('avatarImg').innerHTML = createSafeImg(d.guest.image_url + `?t=${Date.now()}`, 'ğŸ‘¤');
      }
    } catch { myNickname = localStorage.getItem('rkNickname') || null; }
  }

  function updateProfileUI() {
    $('nickDisplay').textContent = myNickname || 'ìµëª… ì¹œêµ¬';
    $('profileSub').textContent  = myNickname ? 'ë¬´ì§€ê°œ ìœ ì¹˜ì› ë©¤ë²„' : 'ë‹‰ë„¤ì„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”';
    $('nickToggleBtn').textContent = myNickname ? 'âœï¸ ë‹‰ë„¤ì„ ë³€ê²½' : 'âœï¸ ë‹‰ë„¤ì„ ì„¤ì •';
  }

  function showNickMsg(text, type) { const el=$('nickMsg'); el.textContent=text||''; el.className='nick-msg'+(type?` ${type}`:''); }

  function toggleNickEdit(forceOpen) {
    const box = $('nickEdit');
    const willOpen = typeof forceOpen === 'boolean' ? forceOpen : box.classList.contains('hidden');
    box.classList.toggle('hidden', !willOpen);
    if (willOpen) { $('nickInput').value = myNickname || ''; $('nickInput').focus(); showNickMsg('',''); }
  }

  async function saveNick() {
    const val = $('nickInput').value.trim();
    showNickMsg('','');
    if (!val || val.length > 10) { showNickMsg('1~10ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”','err'); return; }
    if (!/^[ê°€-í£ã„±-ã…ã…-ã…£a-zA-Z0-9]+$/.test(val)) { showNickMsg('í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ê°€ëŠ¥í•´ìš”','err'); return; }
    const btn = $('nickSaveBtn'); btn.disabled = true; btn.textContent = 'ì €ì¥ ì¤‘...';
    try {
      const r = await fetch(apiUrl('/guest/nickname'), { method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body:JSON.stringify({nickname:val}) });
      const d = await r.json().catch(()=>({}));
      if (r.ok && d.ok) { myNickname = d.nickname||val; localStorage.setItem('rkNickname', myNickname); updateProfileUI(); toggleNickEdit(false); }
      else if (d.error === 'nickname_cooldown_7days') showNickMsg('7ì¼ì´ ì§€ë‚˜ì•¼ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš”','cool');
      else if (d.error === 'nickname_taken') showNickMsg('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì´ì—ìš”','err');
      else showNickMsg(d.error||'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”','err');
    } catch { showNickMsg('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”','err'); }
    btn.disabled = false; btn.textContent = 'ì €ì¥';
  }

  async function uploadAvatar(file) {
    if (!file) return;
    if (file.size > 5*1024*1024) { alert('5MB ì´í•˜ ì´ë¯¸ì§€ë§Œ ê°€ëŠ¥í•´ìš”'); return; }
    setLoader(true);
    const fd = new FormData(); fd.append('image', file); if (guestId) fd.append('guest_id', guestId);
    try {
      const r = await fetch(apiUrl('/guest/upload-image'), { method:'POST', credentials:'include', body:fd });
      const d = await r.json().catch(()=>({}));
      if (r.ok && d.ok && d.image_url) $('avatarImg').innerHTML = createSafeImg(d.image_url+`?t=${Date.now()}`, 'ğŸ‘¤');
      else alert(d.error||'ì—…ë¡œë“œ ì‹¤íŒ¨');
    } catch { alert('ì—…ë¡œë“œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'); }
    finally { setLoader(false); $('avatarInput').value = ''; }
  }

  async function loadAll() {
    try {
      const pr = await fetch(apiUrl('/my/posts?limit=50&offset=0'), { credentials:'include' });
      myPosts = pr.ok ? ((await pr.json()).posts || []) : [];
    } catch { myPosts = []; }

    const yarPromises = myPosts.map(p => fetch(apiUrl(`/posts/${p.id}/yars`), {credentials:'include'}).then(r=>r.json()).catch(()=>({yarers:[]})));
    const cmtPromises = myPosts.map(p => fetch(apiUrl(`/posts/${p.id}`),      {credentials:'include'}).then(r=>r.json()).catch(()=>({comments:[]})));

    try {
      const [yarRes, cmtRes] = await Promise.all([Promise.all(yarPromises), Promise.all(cmtPromises)]);

      // [FIX 2] yarersì— image_url í¬í•¨ (workerê°€ guests(nickname,image_url) ë°˜í™˜)
      allYarers = yarRes.flatMap((d, i) => (d.yarers||[]).map(y => ({
        ...y,
        post_id:    myPosts[i].id,
        post_title: myPosts[i].title || (myPosts[i].body?.slice(0,30)) || '',
      }))).sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

      // [FIX 3/4] ë‚´ ëŒ“ê¸€ ì œì™¸ + system_users/guests ì´ë¯¸ì§€ í†µí•©
      const myGid = guestId || localStorage.getItem('rkGuestId');
      receivedComments = cmtRes.flatMap((d, i) => (d.comments||[])
        .filter(c => {
          const isMineByNick = myNickname && c.nickname === myNickname;
          const isMineByGid  = myGid && c.guest_id && c.guest_id === myGid;
          return !(isMineByNick || isMineByGid);
        })
        .map(c => ({
          ...c,
          image_url:    c.system_users?.image_url || c.guests?.image_url || null,
          display_nick: c.system_users?.display_name || c.nickname || 'ìµëª…',
          post_id:      myPosts[i].id,
          post_title:   myPosts[i].title || (myPosts[i].body?.slice(0,30)) || '',
        }))
      ).sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

    } catch { allYarers = []; receivedComments = []; }

    // [FIX 5] statYars = yar_count í•©ì‚°ìœ¼ë¡œ í†µì¼
    $('statPosts').textContent    = myPosts.length;
    $('statYars').textContent     = myPosts.reduce((s,p) => s+(p.yar_count||0), 0);
    $('statComments').textContent = receivedComments.length;

    checkYarBadge();
    checkCmtBadge();
    renderPosts();
    renderYarers();
    renderComments();
  }

  function renderPosts() {
    const sec = $('secPosts');
    if (!myPosts.length) { sec.innerHTML = '<div class="empty">ì•„ì§ ì“´ ê¸€ì´ ì—†ì–´ìš”.</div>'; return; }
    sec.innerHTML = myPosts.map(p => `
      <div class="post-card" data-post-id="${p.id}">
        <div class="post-title">${esc(p.title||p.body?.slice(0,40)||'')}</div>
        ${p.body?`<div class="post-body">${esc(p.body)}</div>`:''}
        <div class="post-meta">
          <span>${relTime(p.created_at)}</span>
          <span>ğŸ’¬ ${p.comment_count||0}</span>
          <span>ğŸŒŸ ${p.yar_count||0}</span>
          <button class="post-delete" type="button" data-del-id="${p.id}">ì‚­ì œ</button>
        </div>
      </div>`).join('');
    sec.querySelectorAll('.post-card').forEach(card => {
      card.addEventListener('click', e => {
        if (e.target.closest('[data-del-id]')) return;
        const id = Number(card.dataset.postId);
        if (Number.isFinite(id)) location.href = `index.html?postId=${id}`;
      });
    });
    sec.querySelectorAll('[data-del-id]').forEach(btn => {
      btn.addEventListener('click', e => { e.preventDefault(); e.stopPropagation(); confirmDelete(Number(btn.dataset.delId)); });
    });
  }

  function renderYarers() {
    const sec = $('secYars');
    if (!allYarers.length) { sec.innerHTML = '<div class="empty">ë°›ì€ ì•¼ë¥´~ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
    sec.innerHTML = allYarers.map(y => `
      <div class="list-item" data-post-id="${y.post_id}">
        <div class="item-avatar">${createSafeImg(y.image_url, 'ğŸ‘¤')}</div>
        <div class="item-body">
          <div class="item-top">
            <span class="item-nick">${esc(y.nickname||'ìµëª…')}</span>
            <span class="item-meta">${relTime(y.created_at)}</span>
          </div>
          <div class="item-target">ğŸ“ ${esc(y.post_title||'ë‚´ ê¸€')}</div>
        </div>
      </div>`).join('');
    sec.querySelectorAll('.list-item').forEach(it => {
      it.addEventListener('click', () => { const id=Number(it.dataset.postId); if(Number.isFinite(id)) location.href=`index.html?postId=${id}`; });
    });
  }

  function renderComments() {
    const sec = $('secComments');
    if (!receivedComments.length) { sec.innerHTML = '<div class="empty">ë°›ì€ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
    sec.innerHTML = receivedComments.map(c => `
      <div class="list-item" data-post-id="${c.post_id}">
        <div class="item-avatar">${createSafeImg(c.image_url, 'ğŸ—£ï¸')}</div>
        <div class="item-body">
          <div class="item-top">
            <span class="item-nick">${esc(c.display_nick)}</span>
            <span class="item-meta">${relTime(c.created_at)}</span>
          </div>
          <div class="item-target">ğŸ“ ${esc(c.post_title||'ë‚´ ê¸€')}</div>
          <div class="item-content">${esc(c.body||'')}</div>
        </div>
      </div>`).join('');
    sec.querySelectorAll('.list-item').forEach(it => {
      it.addEventListener('click', () => { const id=Number(it.dataset.postId); if(Number.isFinite(id)) location.href=`index.html?postId=${id}`; });
    });
  }

  function switchTab(tab) {
    ['posts','yars','comments'].forEach(t => {
      $(`tab${t.charAt(0).toUpperCase()+t.slice(1)}`).classList.toggle('active', t===tab);
      $(`sec${t.charAt(0).toUpperCase()+t.slice(1)}`).classList.toggle('hidden', t!==tab);
    });
    if (tab === 'yars')     markYarRead();
    if (tab === 'comments') markCmtRead();
  }

  function checkYarBadge() {
    const saved = JSON.parse(localStorage.getItem('rkYarCounts')||'{}');
    let n = 0;
    myPosts.forEach(p => { const prev=saved[p.id]||0; if((p.yar_count||0)>prev) n+=(p.yar_count||0)-prev; });
    const badge = $('yarBadge');
    if (n>0) { badge.textContent=String(n); badge.classList.remove('hidden'); } else badge.classList.add('hidden');
  }

  function markYarRead() {
    const c = {}; myPosts.forEach(p => { c[p.id]=p.yar_count||0; });
    localStorage.setItem('rkYarCounts', JSON.stringify(c));
    $('yarBadge').classList.add('hidden');
    // [FIX 6] íƒ­ ì „í™˜ ì‹œ í†µê³„ ìˆ«ì ê°±ì‹ 
    $('statYars').textContent = myPosts.reduce((s,p) => s+(p.yar_count||0), 0);
  }

  function checkCmtBadge() {
    const saved = JSON.parse(localStorage.getItem('rkCmtCounts')||'{}');
    let n = 0;
    myPosts.forEach(p => { const prev=saved[p.id]||0; if((p.comment_count||0)>prev) n+=(p.comment_count||0)-prev; });
    const badge = $('cmtBadge');
    if (n>0) { badge.textContent=String(n); badge.classList.remove('hidden'); } else badge.classList.add('hidden');
  }

  function markCmtRead() {
    const c = {}; myPosts.forEach(p => { c[p.id]=p.comment_count||0; });
    localStorage.setItem('rkCmtCounts', JSON.stringify(c));
    $('cmtBadge').classList.add('hidden');
    $('statComments').textContent = receivedComments.length;
  }

  function confirmDelete(id) {
    pendingDeleteFn = async () => {
      try {
        const r = await fetch(apiUrl(`/posts/${id}`), { method:'DELETE', credentials:'include' });
        if (r.ok) { await loadAll(); switchTab('posts'); }
      } catch {}
    };
    $('confirmOverlay').classList.remove('hidden');
  }
  function closeConfirm() { $('confirmOverlay').classList.add('hidden'); pendingDeleteFn = null; }

  // ì´ë²¤íŠ¸ ë°”ì¸ë”©
  $('tabPosts').addEventListener('click',    () => switchTab('posts'));
  $('tabYars').addEventListener('click',     () => switchTab('yars'));
  $('tabComments').addEventListener('click', () => switchTab('comments'));
  $('nickToggleBtn').addEventListener('click', e => { e.stopPropagation(); toggleNickEdit(); });
  $('nickSaveBtn').addEventListener('click',   e => { e.preventDefault(); saveNick(); });
  $('nickInput').addEventListener('keypress',  e => { if(e.key==='Enter') saveNick(); });
  // [FIX 1] avatarBtnì— stopPropagation - avatarWrap ë²„ë¸”ë§ ë°©ì§€
  $('avatarBtn').addEventListener('click',  e => { e.stopPropagation(); $('avatarInput').click(); });
  $('avatarWrap').addEventListener('click', ()  => $('avatarInput').click());
  $('avatarInput').addEventListener('change', e => uploadAvatar(e.target.files && e.target.files[0]));
  $('confirmNo').addEventListener('click',  closeConfirm);
  $('confirmYes').addEventListener('click', () => { const fn=pendingDeleteFn; closeConfirm(); if(typeof fn==='function') fn(); });
  $('confirmOverlay').addEventListener('click', e => { if(e.target===$('confirmOverlay')) closeConfirm(); });
  // [FIX 4] ê¸€ì“°ê¸° â†’ index.html#write (index.htmlì—ì„œ í•´ì‹œ ê°ì§€í•´ì„œ ëª¨ë‹¬ ì—´ê¸°)
  $('writeNavBtn').addEventListener('click', e => { e.preventDefault(); location.href='index.html#write'; });

  // ì´ˆê¸°í™”
  (async () => {
    try { await initGuest(); updateProfileUI(); await loadAll(); }
    finally { setLoader(false); }
  })();
})();
</script>
</body>
</html>
