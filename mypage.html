<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸ‘¤ ë‚´ í˜ì´ì§€ - ë¬´ì§€ê°œ ìœ ì¹˜ì›</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    :root {
      --bg:#f2f2f7; --card:#fff; --text:#1c1c1e; --sub:#8e8e93; --border:#e5e5ea;
      --accent:#ff6b6b; --blue:#007aff; --green:#34c759; --yar:#ff9f0a;
      --radius-card:16px;
    }
    body { font-family:'Noto Sans KR',-apple-system,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
    .hidden { display:none !important; }

    /* ë¡œë”© */
    #globalLoader { position:fixed; inset:0; background:rgba(255,255,255,.96); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9000; gap:14px; }
    #globalLoader.hidden { display:none; }
    .spinner { width:28px; height:28px; border:3px solid var(--border); border-top-color:var(--text); border-radius:50%; animation:spin .8s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    .skel { border-radius:12px; background:linear-gradient(90deg,#f0f0f0 25%,#e8e8e8 50%,#f0f0f0 75%); background-size:200% 100%; animation:shimmer 1.3s ease-in-out infinite; }

    /* í—¤ë” */
    .header { background:var(--card); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:100; }
    .header-inner { max-width:640px; margin:0 auto; padding:10px 16px; display:flex; align-items:center; gap:10px; }
    .back-btn { width:34px; height:34px; border-radius:50%; background:var(--bg); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:16px; cursor:pointer; text-decoration:none; flex-shrink:0; color:var(--text); }
    .header-title { font-size:17px; font-weight:900; }

    /* ì»¨í…Œì´ë„ˆ */
    .container { max-width:640px; margin:0 auto; padding:16px 16px 100px; }

    /* í”„ë¡œí•„ ì¹´ë“œ */
    .profile-card { background:var(--card); border-radius:var(--radius-card); padding:20px; margin-bottom:16px; box-shadow:0 1px 4px rgba(0,0,0,.06); }
    .profile-top { display:flex; align-items:center; gap:14px; margin-bottom:16px; }
    .profile-avatar { width:64px; height:64px; border-radius:16px; background:var(--bg); border:1.5px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:32px; flex-shrink:0; }
    .profile-info { flex:1; }
    .profile-nick { font-size:20px; font-weight:900; margin-bottom:2px; }
    .profile-sub { font-size:12px; color:var(--sub); line-height:1.4; }
    .nick-btn { padding:8px 16px; border-radius:20px; border:1.5px solid var(--border); background:var(--bg); font-size:13px; font-weight:700; cursor:pointer; font-family:inherit; color:var(--text); white-space:nowrap; }
    .nick-btn:active { opacity:.75; }

    /* ë‹‰ë„¤ì„ í¸ì§‘ ì¸ë¼ì¸ */
    .nick-edit-wrap { background:var(--bg); border-radius:12px; padding:14px; }
    .nick-edit-label { font-size:12px; color:var(--sub); margin-bottom:8px; line-height:1.5; }
    .nick-edit-row { display:flex; gap:8px; }
    .nick-edit-input { flex:1; padding:10px 14px; border:1.5px solid var(--border); border-radius:10px; font-size:15px; font-family:inherit; text-align:center; }
    .nick-edit-input:focus { outline:none; border-color:var(--text); }
    .nick-save-btn { padding:10px 18px; background:var(--text); color:#fff; border:none; border-radius:10px; font-size:13px; font-weight:700; cursor:pointer; font-family:inherit; white-space:nowrap; }
    .nick-save-btn:disabled { opacity:.5; }
    .nick-edit-error { font-size:12px; color:var(--accent); margin-top:6px; min-height:16px; }
    .nick-edit-cooldown { font-size:12px; color:var(--sub); margin-top:6px; }

    /* í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ */
    .avatar-wrap { position:relative; width:64px; height:64px; flex-shrink:0; }
    .profile-avatar { width:64px; height:64px; border-radius:16px; background:var(--bg); border:1.5px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:32px; overflow:hidden; width:100%; height:100%; }
    .profile-avatar img { width:100%; height:100%; object-fit:cover; }
    .avatar-upload-btn { position:absolute; bottom:-4px; right:-4px; width:22px; height:22px; background:var(--text); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:11px; cursor:pointer; border:2px solid var(--card); }
    /* ìƒˆ ëŒ“ê¸€ ë°°ì§€ */
    .tab-badge { display:inline-block; background:var(--accent); color:#fff; border-radius:10px; font-size:10px; font-weight:700; padding:1px 6px; margin-left:4px; vertical-align:middle; }
    /* ì•¼ë¥´ ëª©ë¡ */
    .yar-item { display:flex; align-items:center; gap:10px; padding:10px 0; border-bottom:1px solid var(--border); }
    .yar-item:last-child { border-bottom:none; }
    .yar-nick { font-size:14px; font-weight:700; }
    .yar-post-title { font-size:12px; color:var(--sub); margin-top:2px; }
    .yar-time { font-size:11px; color:var(--sub); margin-left:auto; white-space:nowrap; }
    /* ê¸°ê¸° ì•ˆë‚´ */
    .device-notice { background:#fff9ee; border:1px solid #ffe5b4; border-radius:12px; padding:12px 14px; font-size:13px; color:#7c5c00; line-height:1.5; margin-bottom:16px; }

    /* í†µê³„ */
    .stats-row { display:flex; gap:8px; margin-top:12px; }
    .stat-chip { flex:1; text-align:center; background:var(--bg); border-radius:12px; padding:10px 8px; }
    .stat-num { font-size:18px; font-weight:900; }
    .stat-label { font-size:11px; color:var(--sub); margin-top:2px; }

    /* íƒ­ */
    .tab-bar { display:flex; border-bottom:1.5px solid var(--border); margin-bottom:12px; }
    .tab-btn { flex:1; padding:10px 0; font-size:14px; font-weight:700; color:var(--sub); background:none; border:none; cursor:pointer; font-family:inherit; border-bottom:2.5px solid transparent; margin-bottom:-1.5px; }
    .tab-btn.active { color:var(--text); border-bottom-color:var(--text); }

    /* ê²Œì‹œê¸€ ì¹´ë“œ */
    .post-card { background:var(--card); border-radius:var(--radius-card); padding:14px; margin-bottom:10px; box-shadow:0 1px 4px rgba(0,0,0,.06); cursor:pointer; }
    .post-card:active { opacity:.85; }
    .post-title { font-size:15px; font-weight:700; margin-bottom:4px; }
    .post-body { font-size:13px; color:var(--sub); line-height:1.5; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; margin-bottom:8px; }
    .post-meta { display:flex; align-items:center; gap:10px; font-size:12px; color:var(--sub); }
    .post-del { margin-left:auto; padding:5px 12px; background:var(--accent); color:#fff; border:none; border-radius:20px; font-size:11px; font-weight:700; cursor:pointer; font-family:inherit; flex-shrink:0; }
    .post-del:active { opacity:.75; }

    /* ëŒ“ê¸€ ì¹´ë“œ */
    .cmt-card { background:var(--card); border-radius:var(--radius-card); padding:14px; margin-bottom:10px; box-shadow:0 1px 4px rgba(0,0,0,.06); }
    .cmt-origin { font-size:12px; color:var(--blue); font-weight:700; margin-bottom:6px; cursor:pointer; }
    .cmt-origin:active { opacity:.75; }
    .cmt-body { font-size:14px; line-height:1.5; margin-bottom:8px; }
    .cmt-meta { display:flex; align-items:center; gap:10px; font-size:12px; color:var(--sub); }
    .cmt-del { margin-left:auto; padding:5px 12px; background:var(--accent); color:#fff; border:none; border-radius:20px; font-size:11px; font-weight:700; cursor:pointer; font-family:inherit; flex-shrink:0; }

    /* ë¹ˆ ìƒíƒœ */
    .empty { text-align:center; padding:48px 20px; }
    .empty-icon { font-size:42px; margin-bottom:10px; }
    .empty-text { font-size:15px; font-weight:700; margin-bottom:4px; }
    .empty-sub { font-size:13px; color:var(--sub); }

    /* ë” ë³´ê¸° */
    .load-more { width:100%; padding:13px; background:var(--card); border:1.5px solid var(--border); border-radius:var(--radius-card); font-size:14px; font-weight:700; color:var(--sub); cursor:pointer; font-family:inherit; }
    .load-more:disabled { opacity:.5; }

    /* ë°”í…€ ë„¤ë¹„ */
    .bottom-nav { position:fixed; bottom:0; left:0; right:0; background:var(--card); border-top:1px solid var(--border); display:flex; z-index:100; padding-bottom:env(safe-area-inset-bottom,0); }
    .bottom-nav a { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:8px 0 6px; text-decoration:none; color:var(--sub); font-size:10px; font-weight:600; gap:2px; }
    .bottom-nav a.active { color:var(--text); }
    .nav-icon { font-size:22px; }

    /* ê¸€ì“°ê¸° ëª¨ë‹¬ */
    .write-overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:flex-end; justify-content:center; z-index:3000; }
    .write-overlay.hidden { display:none; }
    .write-panel { width:100%; max-width:640px; background:var(--card); border-radius:20px 20px 0 0; padding:0 0 env(safe-area-inset-bottom,0); }
    .write-handle { width:36px; height:4px; background:var(--border); border-radius:2px; margin:10px auto; }
    .write-head { padding:0 16px 12px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border); }
    .write-head-title { font-size:17px; font-weight:900; }
    .write-close { padding:6px 14px; border:1px solid var(--border); border-radius:20px; background:var(--bg); font-size:12px; cursor:pointer; font-family:inherit; }
    .write-body { padding:16px; }
    .write-input { width:100%; padding:12px; border:1.5px solid var(--border); border-radius:12px; font-size:15px; font-family:inherit; margin-bottom:10px; }
    .write-input:focus { outline:none; border-color:var(--text); }
    .write-textarea { width:100%; padding:12px; border:1.5px solid var(--border); border-radius:12px; font-size:14px; font-family:inherit; min-height:120px; resize:none; line-height:1.6; }
    .write-textarea:focus { outline:none; border-color:var(--text); }
    .write-footer { display:flex; gap:8px; padding:12px 16px; border-top:1px solid var(--border); padding-bottom:calc(12px + env(safe-area-inset-bottom,0)); }
    .write-submit { flex:1; padding:13px; background:var(--text); color:#fff; border:none; border-radius:12px; font-size:15px; font-weight:700; cursor:pointer; font-family:inherit; }
    .write-submit:disabled { opacity:.5; }
    .write-error { font-size:12px; color:var(--accent); min-height:16px; padding:0 16px 8px; }
    /* ê²Œì‹œê¸€ ìƒì„¸ ì˜¤ë²„ë ˆì´ (index.htmlì—ì„œ ë³µì‚¬) */
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:flex-end; justify-content:center; z-index:2000; }
    .overlay.hidden { display:none; }
    .detail-panel { width:100%; max-width:640px; background:var(--card); border-radius:20px 20px 0 0; max-height:90vh; display:flex; flex-direction:column; }
    .detail-handle { width:36px; height:4px; background:var(--border); border-radius:2px; margin:10px auto 0; flex-shrink:0; }
    .detail-head { padding:12px 16px 10px; border-bottom:1px solid var(--border); flex-shrink:0; }
    .detail-title { font-size:17px; font-weight:900; margin-bottom:6px; }
    .detail-meta { font-size:12px; color:var(--sub); display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .detail-meta-author { font-weight:700; color:var(--text); }
    .detail-scroll { flex:1; overflow-y:auto; }
    .detail-body { padding:14px 16px; font-size:14px; line-height:1.7; border-bottom:1px solid var(--border); white-space:pre-wrap; }
    .detail-body a { color:var(--blue); text-decoration:underline; word-break:break-all; }
    .detail-media { padding:0 16px 12px; }
    .detail-media img { width:100%; border-radius:12px; display:block; margin-bottom:8px; max-height:400px; object-fit:cover; }
    .detail-media video { width:100%; border-radius:12px; display:block; margin-bottom:8px; max-height:400px; }
    .detail-media audio { width:100%; border-radius:12px; display:block; margin-bottom:8px; }
    .detail-footer { padding:10px 16px; display:flex; align-items:center; gap:10px; border-bottom:1px solid var(--border); flex-shrink:0; }
    .detail-stat { font-size:13px; color:var(--sub); }
    .detail-yar { margin-left:auto; display:flex; align-items:center; gap:4px; padding:6px 14px; border-radius:20px; border:1.5px solid var(--border); background:var(--bg); font-size:13px; font-weight:700; cursor:pointer; font-family:inherit; color:var(--sub); }
    .detail-yar.active { border-color:var(--yar); color:var(--yar); background:#fff9ee; }
    .detail-close { padding:6px 14px; border:1px solid var(--border); border-radius:20px; background:var(--bg); font-size:12px; cursor:pointer; font-family:inherit; flex-shrink:0; }
    .comments-wrap { padding:0 16px 10px; }
    .ctab { padding:4px 10px; border-radius:20px; border:1.5px solid var(--border); background:var(--bg); color:var(--sub); font-size:11px; font-weight:700; cursor:pointer; font-family:inherit; }
    .ctab-active { border-color:var(--text); background:var(--text); color:#fff; }
    .comment-item { padding:10px 0; border-bottom:1px solid var(--border); display:flex; gap:8px; align-items:flex-start; }
    .comment-item:last-child { border-bottom:none; }
    .comment-avatar { width:28px; height:28px; border-radius:8px; background:var(--bg); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:15px; flex-shrink:0; overflow:hidden; }
    .comment-avatar img { width:100%; height:100%; object-fit:cover; }
    .comment-right { flex:1; min-width:0; }
    .comment-nick { font-size:12px; font-weight:700; }
    .comment-body { font-size:13px; line-height:1.5; margin-top:3px; }
    .comment-time { font-size:11px; color:var(--sub); margin-top:2px; }
    .comment-form { flex-shrink:0; background:var(--card); border-top:1px solid var(--border); padding:10px 16px; display:flex; gap:8px; padding-bottom:calc(10px + env(safe-area-inset-bottom,0)); }
    .comment-input { flex:1; padding:10px 12px; border:1.5px solid var(--border); border-radius:22px; font-size:14px; font-family:inherit; }
    .comment-input:focus { outline:none; border-color:var(--text); }
    .comment-send { padding:10px 16px; background:var(--text); color:#fff; border:none; border-radius:22px; font-size:13px; font-weight:700; cursor:pointer; font-family:inherit; }
    .comment-send:disabled { opacity:.5; }
  </style>
</head>
<body>

<!-- ë¡œë”© -->
<div id="globalLoader">
  <div style="font-size:48px;">ğŸ‘¤</div>
  <div class="spinner"></div>
  <div style="font-size:14px;color:var(--sub);">ë‚´ í˜ì´ì§€ ë¡œë”© ì¤‘...</div>
</div>

<!-- í—¤ë” -->
<div class="header">
  <div class="header-inner">
    <a class="back-btn" href="index.html">â†</a>
    <div class="header-title">ë‚´ í˜ì´ì§€</div>
  </div>
</div>

<div class="container">

  <!-- í”„ë¡œí•„ ì¹´ë“œ -->
  <div class="profile-card" id="profileCard">
    <div class="profile-top">
      <div class="avatar-wrap" onclick="document.getElementById('avatarFileInput').click()" title="í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½" style="cursor:pointer;">
        <div class="profile-avatar" id="profileAvatar">ğŸ‘¤</div>
        <div class="avatar-upload-btn">ğŸ“·</div>
      </div>
      <input type="file" id="avatarFileInput" accept="image/*" style="display:none" onchange="uploadAvatar(this)">
      <div class="profile-info">
        <div class="profile-nick" id="nickDisplay">ë‹‰ë„¤ì„ ì—†ìŒ</div>
        <div class="profile-sub" id="profileSub">ì´ ê¸°ê¸°ì—ì„œ ì‘ì„±í•œ ê¸€ê³¼ ëŒ“ê¸€ì„ ë³¼ ìˆ˜ ìˆì–´ìš”</div>
      </div>
      <button class="nick-btn" id="nickEditBtn" onclick="toggleNickEdit()">âœï¸ ë‹‰ë„¤ì„</button>
    </div>

    <!-- ë‹‰ë„¤ì„ í¸ì§‘ (ì¸ë¼ì¸) -->
    <div class="nick-edit-wrap hidden" id="nickEditWrap">
      <div class="nick-edit-label">
        ë‹‰ë„¤ì„ì€ ì–¸ì œë“  ë°”ê¿€ ìˆ˜ ìˆì–´ìš”. ì¤‘ë³µë„ í—ˆìš©ë¼ìš”.<br>
        ë‹¨, ë³€ê²½ í›„ 7ì¼ê°„ ì¬ë³€ê²½ì´ ì œí•œë©ë‹ˆë‹¤.
      </div>
      <div class="nick-edit-row">
        <input class="nick-edit-input" id="nickEditInput" placeholder="ë‹‰ë„¤ì„ (1~10ì)" maxlength="10" autocomplete="off">
        <button class="nick-save-btn" id="nickSaveBtn" onclick="saveNickname()">ì €ì¥</button>
      </div>
      <div class="nick-edit-error hidden" id="nickEditError"></div>
      <div class="nick-edit-cooldown hidden" id="nickEditCooldown"></div>
    </div>

    <!-- í†µê³„ -->
    <div class="stats-row">
      <div class="stat-chip">
        <div class="stat-num" id="statPosts">-</div>
        <div class="stat-label">ì‘ì„±í•œ ê¸€</div>
      </div>
      <div class="stat-chip">
        <div class="stat-num" id="statComments">-</div>
        <div class="stat-label">ì‘ì„±í•œ ëŒ“ê¸€</div>
      </div>
      <div class="stat-chip">
        <div class="stat-num" id="statYars">-</div>
        <div class="stat-label">ë°›ì€ ì•¼ë¥´~</div>
      </div>
    </div>
  </div>

  <!-- ê¸°ê¸° ì•ˆë‚´ (ìƒˆ ê¸°ê¸°ì´ê±°ë‚˜ ë‹‰ë„¤ì„ ì—†ì„ ë•Œ) -->
  <div class="device-notice hidden" id="deviceNotice">
    ğŸ“± ì´ ê¸°ê¸°ì—ì„œ ì‘ì„±í•œ ê¸€ê³¼ ëŒ“ê¸€ë§Œ ë³´ì—¬ìš”. ê¸°ê¸°ê°€ ë°”ë€Œë©´ ìƒˆ êµì‹¤ë¡œ ë“¤ì–´ì˜¨ ê±°ì˜ˆìš”.
  </div>

  <!-- íƒ­ -->
  <div class="tab-bar">
    <button class="tab-btn active" id="tabPosts"    onclick="switchTab('posts')">ğŸ“ ë‚´ ê¸€</button>
    <button class="tab-btn"        id="tabComments" onclick="switchTab('comments')">ğŸ’¬ ë‚´ ëŒ“ê¸€<span class="tab-badge hidden" id="cmtBadge"></span></button>
    <button class="tab-btn"        id="tabYars"     onclick="switchTab('yars')">ğŸŒŸ ì•¼ë¥´~</button>
  </div>

  <!-- ë‚´ ê¸€ ëª©ë¡ -->
  <div id="postsSection">
    <div class="skel" style="height:100px;margin-bottom:10px;"></div>
    <div class="skel" style="height:100px;margin-bottom:10px;"></div>
  </div>

  <!-- ë‚´ ëŒ“ê¸€ ëª©ë¡ -->
  <div id="commentsSection" class="hidden">
    <div class="skel" style="height:80px;margin-bottom:10px;"></div>
    <div class="skel" style="height:80px;margin-bottom:10px;"></div>
  </div>

  <!-- ë°›ì€ ì•¼ë¥´~ ëª©ë¡ -->
  <div id="yarsSection" class="hidden"></div>

  <!-- ë” ë³´ê¸° -->
  <button class="load-more hidden" id="loadMoreBtn" onclick="loadMore()">ë” ë³´ê¸°</button>

</div>

<!-- ë°”í…€ ë„¤ë¹„ -->
<div class="bottom-nav">
  <a href="index.html"><span class="nav-icon">ğŸ </span>í™ˆ</a>
  <a href="#" onclick="openWrite();return false;" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px 0 6px;text-decoration:none;color:var(--sub);font-size:10px;font-weight:600;gap:2px;">
    <span style="width:42px;height:28px;background:var(--text);border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:18px;">âœï¸</span>ê¸€ì“°ê¸°
  </a>
  <a href="mypage.html" class="active"><span class="nav-icon">ğŸ‘¤</span>ë‚´ í˜ì´ì§€</a>
</div>

<!-- ê¸€ì“°ê¸° ëª¨ë‹¬ -->
<div class="write-overlay hidden" id="writeOverlay" onclick="handleWriteOverlay(event)">
  <div class="write-panel" onclick="event.stopPropagation()">
    <div class="write-handle"></div>
    <div class="write-head">
      <div class="write-head-title">âœï¸ ì´ì•¼ê¸° ì“°ê¸°</div>
      <button class="write-close" onclick="closeWrite()">âœ• ë‹«ê¸°</button>
    </div>
    <div class="write-body">
      <input class="write-input" id="writeTitle" placeholder="ì œëª© (2~80ì)" maxlength="80">
      <textarea class="write-textarea" id="writeBody" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”... (5ì ì´ìƒ)" maxlength="5000"></textarea>
    </div>
    <div class="write-error" id="writeError"></div>
    <div class="write-footer">
      <button class="write-submit" id="writeSubmitBtn" onclick="submitWrite()">ê²Œì‹œí•˜ê¸°</button>
    </div>
  </div>
</div>

<!-- ê²Œì‹œê¸€ ìƒì„¸ íŒ¨ë„ -->
<div class="overlay hidden" id="detailOverlay" onclick="handleDetailOverlay(event)">
  <div class="detail-panel" onclick="event.stopPropagation()">
    <div class="detail-handle"></div>
    <div class="detail-head">
      <div class="detail-title" id="dTitle"></div>
      <div class="detail-meta">
        <span class="detail-meta-author" id="dAuthor"></span>
        <span id="dTime"></span>
      </div>
    </div>
    <div class="detail-scroll">
      <div class="detail-body" id="dBody"></div>
      <div class="detail-media" id="dMedia"></div>
      <div class="detail-footer">
        <span class="detail-stat" id="dStats"></span>
        <button class="detail-yar" id="dYarBtn" onclick="toggleDetailYar()">ğŸŒŸ ì•¼ë¥´~</button>
        <button class="detail-close" onclick="closeDetail()">âœ• ë‹«ê¸°</button>
      </div>
      <div class="comments-wrap">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0 6px;">
          <span style="font-size:13px;font-weight:700;color:var(--sub);">ëŒ“ê¸€</span>
          <div style="display:flex;gap:6px;">
            <button id="cTabLatest"  onclick="switchCommentTab('latest')"  class="ctab ctab-active">ìµœì‹ ìˆœ</button>
            <button id="cTabPopular" onclick="switchCommentTab('popular')" class="ctab">ì¸ê¸°ìˆœ</button>
          </div>
        </div>
        <div id="dComments"></div>
      </div>
    </div>
    <div class="comment-form">
      <input class="comment-input" id="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." maxlength="500">
      <button class="comment-send" id="commentSendBtn" onclick="submitComment()">ì „ì†¡</button>
    </div>
  </div>
</div>

<script>
  const API = 'https://rainbowkidz-api.irunaru.workers.dev/api/v1';

  // â”€â”€ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let guestId     = null;
  let myNickname  = null;
  let currentTab  = 'posts';
  let myPosts     = [];
  let myComments  = [];
  let postsOffset   = 0;
  let commentsOffset = 0;
  const LIMIT     = 20;
  let hasMore     = false;

  // ìƒì„¸ íŒ¨ë„ ìƒíƒœ
  let currentPost     = null;
  let currentComments = [];
  let commentSort     = 'latest';

  // â”€â”€ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const esc = s => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  const relTime = d => {
    const s = (Date.now() - new Date(d)) / 1000;
    if (s < 60)     return 'ë°©ê¸ˆ';
    if (s < 3600)   return `${Math.floor(s/60)}ë¶„ ì „`;
    if (s < 86400)  return `${Math.floor(s/3600)}ì‹œê°„ ì „`;
    if (s < 604800) return `${Math.floor(s/86400)}ì¼ ì „`;
    return new Date(d).toLocaleDateString('ko-KR',{month:'long',day:'numeric'});
  };
  const getYar = id => localStorage.getItem(`rkYar_${id}`) === '1';
  const setYar = (id, v) => localStorage.setItem(`rkYar_${id}`, v ? '1' : '0');

  function detectMediaType(url) {
    if (!url) return null;
    const u = url.toLowerCase().split('?')[0];
    if (/\.(jpg|jpeg|png|gif|webp|avif|svg)$/.test(u)) return 'image';
    if (/\.(mp4|webm|mov|avi|mkv)$/.test(u)) return 'video';
    if (/\.(mp3|wav|ogg|m4a|aac|flac)$/.test(u)) return 'audio';
    if (/youtube\.com|youtu\.be/.test(url)) return 'youtube';
    return 'link';
  }
  function linkify(text) {
    return esc(text).replace(/(https?:\/\/[^\s&<>"]+)/g,
      '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
  }

  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeDetail(); });

  // â”€â”€ ê²ŒìŠ¤íŠ¸ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function initGuest() {
    try {
      const r = await fetch(`${API}/guest/init`, { method:'POST', credentials:'include' });
      if (!r.ok) return;
      const d = await r.json();
      guestId = d.guest_id;

      // í•­ìƒ /me í˜¸ì¶œë¡œ ë‹‰ë„¤ì„ í™•ì¸ (ì„œë²„ê°€ ìµœì¢… ê¶Œìœ„)
      try {
        const m = await fetch(`${API}/me`, { credentials:'include' });
        if (m.ok) {
          const md = await m.json();
          myNickname = md.guest?.nickname || null;
          if (myNickname) localStorage.setItem('rkNickname', myNickname);
          else localStorage.removeItem('rkNickname');
        }
      } catch {
        myNickname = localStorage.getItem('rkNickname') || null;
      }
    } catch {}
  }

  // â”€â”€ ê¸€ì“°ê¸° ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function openWrite() {
    if (!myNickname && guestId) {
      try {
        const m = await fetch(`${API}/me`, { credentials:'include' });
        if (m.ok) { const md = await m.json(); myNickname = md.guest?.nickname || null; }
      } catch {}
      if (!myNickname) myNickname = localStorage.getItem('rkNickname');
    }
    if (!myNickname) {
      alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”. ë‚´ í˜ì´ì§€ ìƒë‹¨ì—ì„œ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
      toggleNickEdit();
      return;
    }
    document.getElementById('writeOverlay').classList.remove('hidden');
    document.getElementById('writeTitle').focus();
    document.getElementById('writeError').textContent = '';
  }
  function closeWrite() { document.getElementById('writeOverlay').classList.add('hidden'); }
  function handleWriteOverlay(e) { if (e.target.id === 'writeOverlay') closeWrite(); }

  async function submitWrite() {
    const title = document.getElementById('writeTitle').value.trim();
    const body  = document.getElementById('writeBody').value.trim();
    const errEl = document.getElementById('writeError');
    const btn   = document.getElementById('writeSubmitBtn');
    if (title.length < 2) { errEl.textContent = 'ì œëª©ì€ 2ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”'; return; }
    if (body.length  < 5) { errEl.textContent = 'ë‚´ìš©ì€ 5ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”'; return; }
    errEl.textContent = '';
    btn.disabled = true; btn.textContent = 'ê²Œì‹œ ì¤‘...';
    try {
      const r = await fetch(`${API}/posts`, {
        method: 'POST', credentials: 'include',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ title, body, guest_id: guestId }),
      });
      const d = await r.json();
      if (d.ok) {
        document.getElementById('writeTitle').value = '';
        document.getElementById('writeBody').value  = '';
        closeWrite();
        // ë‚´ ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        myPosts = []; postsOffset = 0;
        await loadMyPosts(true);
        switchTab('posts');
      } else if (d.error === 'rate_limit_post') {
        errEl.textContent = 'ë„ˆë¬´ ë¹ ë¦…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”';
      } else {
        errEl.textContent = d.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”';
      }
    } catch { errEl.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'; }
    btn.disabled = false; btn.textContent = 'ê²Œì‹œí•˜ê¸°';
  }

  // â”€â”€ í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function uploadAvatar(input) {
    const file = input.files[0];
    if (!file) return;
    if (file.size > 5 * 1024 * 1024) { alert('5MB ì´í•˜ ì´ë¯¸ì§€ë§Œ ê°€ëŠ¥í•´ìš”'); return; }

    const avatarEl = document.getElementById('profileAvatar');
    avatarEl.innerHTML = '<div class="spinner"></div>';

    const formData = new FormData();
    formData.append('image', file);
    // ì¿ í‚¤ê°€ ëˆ„ë½ë  ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ guest_idë„ í•¨ê»˜ ì „ì†¡
    if (guestId) formData.append('guest_id', guestId);

    try {
      const r = await fetch(`${API}/guest/upload-image`, {
        method: 'POST', credentials: 'include', body: formData,
      });
      const d = await r.json();
      if (d.ok) {
        avatarEl.innerHTML = `<img src="${d.image_url}?t=${Date.now()}" alt="í”„ë¡œí•„">`;
      } else {
        alert(d.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
        avatarEl.textContent = 'ğŸ‘¤';
      }
    } catch {
      alert('ì—…ë¡œë“œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”');
      avatarEl.textContent = 'ğŸ‘¤';
    }
    input.value = '';
  }

  // â”€â”€ ë‹‰ë„¤ì„ í¸ì§‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleNickEdit() {
    const wrap = document.getElementById('nickEditWrap');
    const isHidden = wrap.classList.contains('hidden');
    wrap.classList.toggle('hidden', !isHidden);
    if (isHidden) {
      const inp = document.getElementById('nickEditInput');
      inp.value = myNickname || '';
      inp.focus();
    }
  }

  document.getElementById('nickEditInput').addEventListener('keypress', e => {
    if (e.key === 'Enter') saveNickname();
  });

  async function saveNickname() {
    const val    = document.getElementById('nickEditInput').value.trim();
    const errEl  = document.getElementById('nickEditError');
    const coolEl = document.getElementById('nickEditCooldown');
    const btn    = document.getElementById('nickSaveBtn');

    errEl.classList.add('hidden');
    coolEl.classList.add('hidden');

    if (!val || val.length > 10) { errEl.textContent = '1~10ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”'; errEl.classList.remove('hidden'); return; }
    if (!/^[ê°€-í£ã„±-ã…ã…-ã…£a-zA-Z0-9]+$/.test(val)) { errEl.textContent = 'í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ê°€ëŠ¥í•´ìš”'; errEl.classList.remove('hidden'); return; }

    btn.disabled = true; btn.textContent = 'ì €ì¥ì¤‘...';

    try {
      const r = await fetch(`${API}/guest/nickname`, {
        method:'POST', credentials:'include',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ nickname: val, guest_id: guestId }),
      });
      const d = await r.json();
      if (d.ok) {
        myNickname = d.nickname;
        localStorage.setItem('rkNickname', d.nickname);
        document.getElementById('nickDisplay').textContent = d.nickname;
        document.getElementById('nickEditWrap').classList.add('hidden');
        updateProfileSub();
      } else if (d.error === 'nickname_cooldown_7days') {
        coolEl.textContent = 'ë‹‰ë„¤ì„ì€ 7ì¼ë§ˆë‹¤ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš”';
        coolEl.classList.remove('hidden');
      } else {
        errEl.textContent = d.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”';
        errEl.classList.remove('hidden');
      }
    } catch {
      errEl.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”';
      errEl.classList.remove('hidden');
    }
    btn.disabled = false; btn.textContent = 'ì €ì¥';
  }

  function updateProfileSub() {
    const sub = document.getElementById('profileSub');
    if (myNickname) {
      sub.textContent = 'ì´ ê¸°ê¸°ì—ì„œ ì‘ì„±í•œ ê¸€ê³¼ ëŒ“ê¸€ì„ ë³¼ ìˆ˜ ìˆì–´ìš”';
    } else {
      sub.textContent = 'ë‹‰ë„¤ì„ì„ ì„¤ì •í•˜ë©´ ê¸€ê³¼ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆì–´ìš”';
      document.getElementById('deviceNotice').classList.remove('hidden');
    }
  }

  // â”€â”€ íƒ­ ì „í™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function switchTab(tab) {
    if (currentTab === tab) return;
    currentTab = tab;
    document.getElementById('tabPosts').classList.toggle('active', tab === 'posts');
    document.getElementById('tabComments').classList.toggle('active', tab === 'comments');
    document.getElementById('tabYars').classList.toggle('active', tab === 'yars');
    document.getElementById('postsSection').classList.toggle('hidden', tab !== 'posts');
    document.getElementById('commentsSection').classList.toggle('hidden', tab !== 'comments');
    document.getElementById('yarsSection').classList.toggle('hidden', tab !== 'yars');
    document.getElementById('loadMoreBtn').classList.add('hidden');

    if (tab === 'posts' && myPosts.length === 0) loadMyPosts(true);
    if (tab === 'comments') { markCommentsRead(); if (myComments.length === 0) loadMyComments(true); }
    if (tab === 'yars') loadYarers();
  }

  // â”€â”€ ë‚´ ê¸€ ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadMyPosts(reset = false) {
    if (reset) { myPosts = []; postsOffset = 0; }
    const sec = document.getElementById('postsSection');
    if (reset) sec.innerHTML = '<div class="skel" style="height:100px;margin-bottom:10px;"></div>'.repeat(3);

    try {
      const r = await fetch(`${API}/my/posts?limit=${LIMIT}&offset=${postsOffset}`, { credentials:'include' });
      const d = await r.json();
      const newPosts = d.posts || [];
      myPosts = reset ? newPosts : [...myPosts, ...newPosts];
      hasMore = newPosts.length === LIMIT;
      postsOffset += newPosts.length;
      renderPosts(reset);
    } catch {
      sec.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ˜¢</div><div class="empty-text">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div></div>';
    }
  }

  function renderPosts(reset = true) {
    const sec = document.getElementById('postsSection');
    document.getElementById('statPosts').textContent = myPosts.length + (hasMore && currentTab === 'posts' ? '+' : '');
    checkNewComments();

    if (!myPosts.length) {
      sec.innerHTML = `<div class="empty">
        <div class="empty-icon">ğŸ“</div>
        <div class="empty-text">ì•„ì§ ì‘ì„±í•œ ê¸€ì´ ì—†ì–´ìš”</div>
        <div class="empty-sub">í™ˆì—ì„œ ì´ì•¼ê¸°ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!</div>
      </div>`;
      document.getElementById('loadMoreBtn').classList.add('hidden');
      return;
    }
    if (reset) {
      sec.innerHTML = myPosts.map(p => renderPostCard(p)).join('');
    } else {
      const frag = document.createDocumentFragment();
      myPosts.slice(-LIMIT).forEach(p => {
        if (!document.getElementById(`mp-${p.id}`)) {
          const div = document.createElement('div');
          div.innerHTML = renderPostCard(p);
          frag.appendChild(div.firstElementChild);
        }
      });
      sec.appendChild(frag);
    }
    const btn = document.getElementById('loadMoreBtn');
    if (hasMore && currentTab === 'posts') { btn.classList.remove('hidden'); btn.textContent = 'ë” ë³´ê¸°'; }
    else btn.classList.add('hidden');
  }

  function renderPostCard(p) {
    return `<div class="post-card" id="mp-${p.id}" onclick="openDetail(${p.id})">
      <div class="post-title">${esc(p.title || p.body?.slice(0,30) || '')}</div>
      ${p.body ? `<div class="post-body">${esc(p.body)}</div>` : ''}
      <div class="post-meta">
        <span>ğŸ’¬ ${p.comment_count||0}</span>
        <span>ğŸŒŸ ${p.yar_count||0}</span>
        <span>ğŸ‘ ${p.view_count||0}</span>
        <span>${relTime(p.created_at)}</span>
        <button class="post-del" onclick="deletePost(event,${p.id})">ì‚­ì œ</button>
      </div>
    </div>`;
  }

  // â”€â”€ ë‚´ ëŒ“ê¸€ ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadMyComments(reset = false) {
    if (reset) { myComments = []; commentsOffset = 0; }
    const sec = document.getElementById('commentsSection');
    if (reset) sec.innerHTML = '<div class="skel" style="height:80px;margin-bottom:10px;"></div>'.repeat(3);

    try {
      const r = await fetch(`${API}/my/comments?limit=${LIMIT}&offset=${commentsOffset}`, { credentials:'include' });
      const d = await r.json();
      const newCmts = d.comments || [];
      myComments = reset ? newCmts : [...myComments, ...newCmts];
      hasMore = newCmts.length === LIMIT;
      commentsOffset += newCmts.length;
      renderCommentList(reset);
    } catch {
      sec.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ˜¢</div><div class="empty-text">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div></div>';
    }
  }

  // ìƒˆ ëŒ“ê¸€ ì•Œë¦¼: ë‚´ ê¸€ì— ë‹¬ë¦° ëŒ“ê¸€ ìˆ˜ë¥¼ ë§ˆì§€ë§‰ í™•ì¸ ì‹œì ê³¼ ë¹„êµ
  function checkNewComments() {
    if (!myPosts.length) return;
    const savedCounts = JSON.parse(localStorage.getItem('rkCmtCounts') || '{}');
    let hasNew = false;
    let totalNew = 0;
    myPosts.forEach(p => {
      const saved = savedCounts[p.id] || 0;
      if (p.comment_count > saved) { hasNew = true; totalNew += p.comment_count - saved; }
    });
    const badge = document.getElementById('cmtBadge');
    if (badge) {
      badge.textContent = totalNew > 0 ? totalNew : '';
      badge.classList.toggle('hidden', !hasNew);
    }
  }

  function markCommentsRead() {
    const counts = {};
    myPosts.forEach(p => { counts[p.id] = p.comment_count; });
    localStorage.setItem('rkCmtCounts', JSON.stringify(counts));
    const badge = document.getElementById('cmtBadge');
    if (badge) { badge.textContent = ''; badge.classList.add('hidden'); }
  }

  function renderCommentList(reset = true) {
    const sec = document.getElementById('commentsSection');
    document.getElementById('statComments').textContent = myComments.length + (hasMore && currentTab === 'comments' ? '+' : '');

    if (!myComments.length) {
      sec.innerHTML = `<div class="empty">
        <div class="empty-icon">ğŸ’¬</div>
        <div class="empty-text">ì•„ì§ ì‘ì„±í•œ ëŒ“ê¸€ì´ ì—†ì–´ìš”</div>
        <div class="empty-sub">ì´ì•¼ê¸°ì— ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</div>
      </div>`;
      document.getElementById('loadMoreBtn').classList.add('hidden');
      return;
    }
    if (reset) {
      sec.innerHTML = myComments.map(cm => renderCommentCard(cm)).join('');
    } else {
      const frag = document.createDocumentFragment();
      myComments.slice(-LIMIT).forEach(cm => {
        if (!document.getElementById(`mc-${cm.id}`)) {
          const div = document.createElement('div');
          div.innerHTML = renderCommentCard(cm);
          frag.appendChild(div.firstElementChild);
        }
      });
      sec.appendChild(frag);
    }
    const btn = document.getElementById('loadMoreBtn');
    if (hasMore && currentTab === 'comments') { btn.classList.remove('hidden'); btn.textContent = 'ë” ë³´ê¸°'; }
    else btn.classList.add('hidden');
  }

  function renderCommentCard(cm) {
    const postTitle = cm.post_title ? esc(cm.post_title) : 'ê²Œì‹œê¸€ ë³´ê¸°';
    return `<div class="cmt-card" id="mc-${cm.id}">
      <div class="cmt-origin" onclick="openDetail(${cm.post_id})">ğŸ“ ${postTitle} â†’</div>
      <div class="cmt-body">${esc(cm.body)}</div>
      <div class="cmt-meta">
        <span>${relTime(cm.created_at)}</span>
        <button class="cmt-del" onclick="deleteComment(event,${cm.id})">ì‚­ì œ</button>
      </div>
    </div>`;
  }

  // â”€â”€ ë” ë³´ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadMore() {
    const btn = document.getElementById('loadMoreBtn');
    btn.disabled = true; btn.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    if (currentTab === 'posts') await loadMyPosts(false);
    else await loadMyComments(false);
    btn.disabled = false; btn.textContent = 'ë” ë³´ê¸°';
  }

  // â”€â”€ ì‚­ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function deletePost(e, postId) {
    e.stopPropagation();
    if (!confirm('ì´ ê¸€ì„ ì‚­ì œí• ê¹Œìš”?')) return;
    try {
      const r = await fetch(`${API}/posts/${postId}`, { method:'DELETE', credentials:'include' });
      const d = await r.json();
      if (d.ok) {
        myPosts = myPosts.filter(p => p.id !== postId);
        document.getElementById(`mp-${postId}`)?.remove();
        if (!myPosts.length) renderPosts(true);
        document.getElementById('statPosts').textContent = myPosts.length;
      } else {
        alert(d.error === 'not_your_post' ? 'ë‚´ ê¸€ì´ ì•„ë‹ˆì—ìš”' : (d.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'));
      }
    } catch { alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'); }
  }

  async function deleteComment(e, cmtId) {
    e.stopPropagation();
    if (!confirm('ì´ ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?')) return;
    try {
      const r = await fetch(`${API}/comments/${cmtId}`, { method:'DELETE', credentials:'include' });
      const d = await r.json();
      if (d.ok) {
        myComments = myComments.filter(c => c.id !== cmtId);
        document.getElementById(`mc-${cmtId}`)?.remove();
        if (!myComments.length) renderCommentList(true);
        document.getElementById('statComments').textContent = myComments.length;
      } else {
        alert(d.error === 'not_your_comment' ? 'ë‚´ ëŒ“ê¸€ì´ ì•„ë‹ˆì—ìš”' : (d.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'));
      }
    } catch { alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'); }
  }

  // â”€â”€ ì•¼ë¥´~ ì¹´ìš´íŠ¸ ì§‘ê³„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function calcTotalYars() {
    // ì•¼ë¥´~ ìˆ˜ëŠ” yar_count í•©ì‚°ìœ¼ë¡œ ë¹ ë¥´ê²Œ í‘œì‹œ (ìƒì„¸ ëª©ë¡ì€ íƒ­ í´ë¦­ ì‹œ ë¡œë“œ)
    const total = myPosts.reduce((s, p) => s + (p.yar_count || 0), 0);
    document.getElementById('statYars').textContent = total;
  }

  // â”€â”€ ë°›ì€ ì•¼ë¥´~ ëª©ë¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadYarers() {
    const sec = document.getElementById('yarsSection');
    if (!myPosts.length) {
      sec.innerHTML = '<div class="empty"><div class="empty-icon">ğŸŒŸ</div><div class="empty-text">ì‘ì„±í•œ ê¸€ì´ ì—†ì–´ìš”</div></div>';
      return;
    }
    sec.innerHTML = '<div class="skel" style="height:60px;margin-bottom:8px;"></div>'.repeat(3);

    try {
      // ë‚´ ê¸€ ì „ì²´ì˜ ì•¼ë¥´~ ëª©ë¡ì„ ë³‘ë ¬ë¡œ ê°€ì ¸ì˜¤ê¸°
      const results = await Promise.all(
        myPosts.map(p =>
          fetch(`${API}/posts/${p.id}/yars`)
            .then(r => r.json())
            .then(d => ({ post: p, yarers: d.yarers || [] }))
            .catch(() => ({ post: p, yarers: [] }))
        )
      );

      // ì „ì²´ ì•¼ë¥´~ ëª©ë¡ í•©ì‚° (ìµœì‹ ìˆœ)
      const allYarers = [];
      results.forEach(({ post, yarers }) => {
        yarers.forEach(y => allYarers.push({ ...y, post_title: post.title || post.body?.slice(0,30) || '' }));
      });
      allYarers.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

      // í†µê³„ ì—…ë°ì´íŠ¸
      document.getElementById('statYars').textContent = allYarers.length;

      if (!allYarers.length) {
        sec.innerHTML = '<div class="empty"><div class="empty-icon">ğŸŒŸ</div><div class="empty-text">ì•„ì§ ë°›ì€ ì•¼ë¥´~ê°€ ì—†ì–´ìš”</div><div class="empty-sub">ì¢‹ì€ ê¸€ì„ ì“°ë©´ ì¹œêµ¬ë“¤ì´ ì•¼ë¥´~ë¥¼ ëˆ„ë¥¼ ê±°ì˜ˆìš”!</div></div>';
        return;
      }

      sec.innerHTML = `<div style="background:var(--card);border-radius:var(--radius-card);padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.06);">
        ${allYarers.map(y => `<div class="yar-item">
          <div>
            <div style="font-size:16px;">ğŸŒŸ</div>
          </div>
          <div style="flex:1;min-width:0;">
            <div class="yar-nick">${esc(y.nickname)}</div>
            <div class="yar-post-title">${esc(y.post_title)}</div>
          </div>
          <div class="yar-time">${relTime(y.created_at)}</div>
        </div>`).join('')}
      </div>`;
    } catch {
      sec.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ˜¢</div><div class="empty-text">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div></div>';
    }
  }

  // â”€â”€ ê²Œì‹œê¸€ ìƒì„¸ íŒ¨ë„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function openDetail(postId) {
    commentSort = 'latest';
    switchCommentTab('latest', false);
    document.getElementById('dTitle').textContent  = '';
    document.getElementById('dBody').innerHTML     = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    document.getElementById('dAuthor').textContent = '';
    document.getElementById('dTime').textContent   = '';
    document.getElementById('dStats').textContent  = '';
    document.getElementById('dMedia').innerHTML    = '';
    document.getElementById('dComments').innerHTML = '';
    document.getElementById('commentInput').value  = '';
    document.getElementById('detailOverlay').classList.remove('hidden');

    fetch(`${API}/posts/${postId}/view`, { method:'POST' }).catch(() => {});

    try {
      const r = await fetch(`${API}/posts/${postId}`);
      const d = await r.json();
      if (!d.ok) { document.getElementById('dBody').textContent = 'ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì–´ìš”'; return; }
      const p = d.post;
      currentPost     = p;
      currentComments = d.comments || [];

      const isSystem   = p.author_type === 'system';
      const authorName = isSystem ? (p.character_name||'ìºë¦­í„°') : (p.nickname||'ìµëª…');

      document.getElementById('dTitle').textContent  = p.title || '';
      document.getElementById('dBody').innerHTML     = linkify(p.body || '');
      document.getElementById('dAuthor').textContent = authorName;
      document.getElementById('dTime').textContent   = relTime(p.created_at);
      document.getElementById('dStats').textContent  =
        `ğŸ’¬ ëŒ“ê¸€ ${d.comments?.length||0} Â· ğŸ‘ ì¡°íšŒ ${p.view_count||0}`;

      // ë¯¸ë””ì–´
      const mediaWrap = document.getElementById('dMedia');
      mediaWrap.innerHTML = '';
      if (p.media_url) {
        const mtype = detectMediaType(p.media_url);
        if (mtype === 'image') {
          mediaWrap.innerHTML = `<img src="${esc(p.media_url)}" alt="ì´ë¯¸ì§€" onclick="this.requestFullscreen?.()" style="cursor:zoom-in;">`;
        } else if (mtype === 'video') {
          mediaWrap.innerHTML = `<video src="${esc(p.media_url)}" controls playsinline></video>`;
        } else if (mtype === 'audio') {
          mediaWrap.innerHTML = `<div style="font-size:13px;color:var(--sub);margin-bottom:4px;">ğŸµ ìŒì•…</div><audio src="${esc(p.media_url)}" controls></audio>`;
        } else if (mtype === 'youtube') {
          const m = p.media_url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
          if (m) mediaWrap.innerHTML = `<div style="position:relative;padding-top:56.25%;border-radius:12px;overflow:hidden;"><iframe src="https://www.youtube.com/embed/${m[1]}" style="position:absolute;inset:0;width:100%;height:100%;border:none;" allowfullscreen></iframe></div>`;
        }
      }

      const isYar = getYar(postId);
      syncDetailYar(p.yar_count||0, isYar);
      renderDetailComments(currentComments);
    } catch (e) {
      document.getElementById('dBody').textContent = `ì˜¤ë¥˜: ${e.message}`;
    }
  }

  function syncDetailYar(count, active) {
    const btn = document.getElementById('dYarBtn');
    btn.className = `detail-yar${active?' active':''}`;
    btn.innerHTML = `ğŸŒŸ ì•¼ë¥´~ ${count}`;
  }

  async function toggleDetailYar() {
    if (!currentPost) return;
    if (!myNickname) { alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”'); return; }
    const postId = currentPost.id;
    const wasYar = getYar(postId);
    setYar(postId, !wasYar);
    try {
      const r = await fetch(`${API}/posts/${postId}/yar`, {
        method: wasYar ? 'DELETE' : 'POST',
        credentials: 'include',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({}),
      });
      const d = await r.json();
      if (d.ok) {
        syncDetailYar(d.yar_count, !wasYar);
        currentPost.yar_count = d.yar_count;
        // ë‚´ ê¸€ ëª©ë¡ì˜ ì•¼ë¥´ ìˆ˜ ì—…ë°ì´íŠ¸
        const mp = myPosts.find(p => p.id == postId);
        if (mp) { mp.yar_count = d.yar_count; calcTotalYars(); }
      }
    } catch {}
  }

  function closeDetail() {
    document.getElementById('detailOverlay').classList.add('hidden');
    currentPost = null; currentComments = [];
  }
  function handleDetailOverlay(e) { if (e.target.id === 'detailOverlay') closeDetail(); }

  function switchCommentTab(sort, rerender = true) {
    commentSort = sort;
    const btnL = document.getElementById('cTabLatest');
    const btnP = document.getElementById('cTabPopular');
    if (!btnL || !btnP) return;
    btnL.className = 'ctab' + (sort === 'latest'  ? ' ctab-active' : '');
    btnP.className = 'ctab' + (sort === 'popular' ? ' ctab-active' : '');
    if (rerender) renderDetailComments(currentComments);
  }

  function renderDetailComments(comments) {
    const wrap = document.getElementById('dComments');
    if (!comments.length) {
      wrap.innerHTML = '<div style="color:var(--sub);font-size:13px;padding:8px 0 16px;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ì–´ìš”.</div>';
      return;
    }
    let sorted = [...comments];
    if (commentSort === 'popular') {
      sorted.sort((a, b) => {
        const aS = a.author_type === 'system' ? 1 : 0;
        const bS = b.author_type === 'system' ? 1 : 0;
        if (bS !== aS) return bS - aS;
        return new Date(b.created_at) - new Date(a.created_at);
      });
    } else {
      sorted.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    }
    wrap.innerHTML = sorted.map(cm => {
      const nick       = cm.system_users?.display_name || cm.nickname || 'ìµëª…';
      const imgUrl     = cm.system_users?.image_url;
      const emoji      = cm.system_users?.emoji || 'ğŸ—£ï¸';
      const avatarHtml = imgUrl
        ? `<img src="${esc(imgUrl)}" alt="${esc(nick)}" data-emoji="${esc(emoji)}" onerror="this.outerHTML='<span style=\\'font-size:15px;\\'>' + this.dataset.emoji + '</span>'">`
        : `<span style="font-size:15px;">${esc(emoji)}</span>`;
      return `<div class="comment-item">
        <div class="comment-avatar">${avatarHtml}</div>
        <div class="comment-right">
          <div class="comment-nick">${esc(nick)}</div>
          <div class="comment-body">${esc(cm.body)}</div>
          <div class="comment-time">${relTime(cm.created_at)}</div>
        </div>
      </div>`;
    }).join('');
  }

  document.getElementById('commentInput').addEventListener('keypress', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); submitComment(); }
  });

  async function submitComment() {
    if (!currentPost) return;
    if (!myNickname) { alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”'); return; }
    const body = document.getElementById('commentInput').value.trim();
    if (!body) return;
    const btn = document.getElementById('commentSendBtn');
    btn.disabled = true; btn.textContent = 'ì „ì†¡ì¤‘';
    try {
      const r = await fetch(`${API}/posts/${currentPost.id}/comments`, {
        method:'POST', credentials:'include',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ body, guest_id: guestId }),
      });
      const d = await r.json();
      if (d.ok) {
        document.getElementById('commentInput').value = '';
        const r2 = await fetch(`${API}/posts/${currentPost.id}`);
        const d2 = await r2.json();
        currentComments = d2.comments || [];
        renderDetailComments(currentComments);
        document.getElementById('dStats').textContent =
          `ğŸ’¬ ëŒ“ê¸€ ${d2.comments?.length||0} Â· ğŸ‘ ì¡°íšŒ ${d2.post?.view_count||0}`;
        // ë‚´ ëŒ“ê¸€ ëª©ë¡ë„ ê°±ì‹  í•„ìš” ì‹œ ì´ˆê¸°í™”
        if (currentTab === 'comments') { myComments = []; commentsOffset = 0; loadMyComments(true); }
      } else {
        alert(d.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”');
      }
    } catch (e) { alert(`ì˜¤ë¥˜: ${e.message}`); }
    btn.disabled = false; btn.textContent = 'ì „ì†¡';
  }

  // â”€â”€ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function init() {
    await initGuest();

    // ë‹‰ë„¤ì„ + í”„ë¡œí•„ ì´ë¯¸ì§€ í‘œì‹œ
    document.getElementById('nickDisplay').textContent = myNickname || 'ë‹‰ë„¤ì„ ì—†ìŒ';
    updateProfileSub();

    // í”„ë¡œí•„ ì´ë¯¸ì§€ ë¡œë“œ (/meì—ì„œ image_url í¬í•¨)
    try {
      const m = await fetch(`${API}/me`, { credentials:'include' });
      if (m.ok) {
        const md = await m.json();
        if (md.guest?.image_url) {
          document.getElementById('profileAvatar').innerHTML =
            `<img src="${md.guest.image_url}" alt="í”„ë¡œí•„">`;
        }
        if (md.guest?.nickname && !myNickname) {
          myNickname = md.guest.nickname;
          document.getElementById('nickDisplay').textContent = myNickname;
        }
      }
    } catch {}

    // ë‚´ ê¸€ ë¡œë“œ
    await loadMyPosts(true);
    calcTotalYars();

    document.getElementById('globalLoader').classList.add('hidden');
  }
  init();
</script>
</body>
</html>
