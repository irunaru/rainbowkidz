<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸ‘¤ ë‚´ í˜ì´ì§€ - ë¬´ì§€ê°œ ìœ ì¹˜ì›</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

    /* â”€â”€ ê³µí†µ ë””ìì¸ í† í° (index.html ê³¼ ì™„ì „ ë™ì¼) â”€â”€ */
    :root {
      --bg:#f2f2f7;
      --card:#fff;
      --text:#1c1c1e;
      --sub:#636366;
      --sub2:#8e8e93;
      --border:#e5e5ea;
      --accent:#ff6b6b;
      --yar:#ff9f0a;
      --blue:#007aff;
      --green:#34c759;
      --radius-card:16px;
      --radius-icon:14px;
      --radius-pill:999px;
      --shadow-card:0 1px 4px rgba(0,0,0,.06);
    }

    body { font-family:'Noto Sans KR',-apple-system,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
    .hidden { display:none !important; }

    /* â”€â”€ ë¡œë” / ìŠ¤ì¼ˆë ˆí†¤ â”€â”€ */
    #globalLoader { position:fixed; inset:0; background:rgba(255,255,255,.96); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9000; gap:14px; }
    #globalLoader.hidden { display:none; }
    .spinner { width:28px; height:28px; border:3px solid var(--border); border-top-color:var(--text); border-radius:50%; animation:spin .8s linear infinite; }
    @keyframes spin    { to { transform:rotate(360deg); } }
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    @keyframes missionPop { 0%{transform:scale(1)} 40%{transform:scale(1.2)} 70%{transform:scale(.95)} 100%{transform:scale(1)} }
    .skel { border-radius:var(--radius-card); background:linear-gradient(90deg,#f0f0f0 25%,#e8e8e8 50%,#f0f0f0 75%); background-size:200% 100%; animation:shimmer 1.3s ease-in-out infinite; }

    /* â”€â”€ í—¤ë” â”€â”€ */
    .header { background:var(--card); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:100; }
    .header-inner { max-width:640px; margin:0 auto; padding:10px 16px; display:flex; align-items:center; gap:10px; }
    .back-btn { min-width:44px; min-height:44px; border-radius:50%; background:var(--bg); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:18px; cursor:pointer; text-decoration:none; color:var(--text); flex-shrink:0; }
    .header-title { font-size:17px; font-weight:900; }

    /* â”€â”€ í˜ì´ì§€ ë ˆì´ì•„ì›ƒ â”€â”€ */
    .container { max-width:640px; margin:0 auto; padding:16px 16px 96px; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ì¹´ë“œ 1 â€“ í”„ë¡œí•„
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .profile-card { background:var(--card); border-radius:var(--radius-card); padding:20px; margin-bottom:12px; box-shadow:var(--shadow-card); }

    /* ì•„ë°”íƒ€ â€“ ê·¸ë¼ë””ì–¸íŠ¸ ë§ */
    .avatar-area { display:flex; flex-direction:column; align-items:center; margin-bottom:14px; }
    .avatar-ring {
      width:88px; height:88px; border-radius:22px;
      padding:3px;
      background:linear-gradient(135deg,#ff9f0a,#ff6b6b,#af52de);
      cursor:pointer; position:relative; flex-shrink:0;
    }
    .avatar-ring-inner {
      width:100%; height:100%; border-radius:19px;
      background:var(--card); overflow:hidden;
      display:flex; align-items:center; justify-content:center; font-size:40px;
    }
    .avatar-ring-inner img { width:100%; height:100%; object-fit:cover; }
    .avatar-cam-btn {
      position:absolute; bottom:-6px; right:-6px;
      width:26px; height:26px; background:var(--text); border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-size:12px; cursor:pointer; border:2.5px solid var(--card);
    }

    /* ë‹‰ë„¤ì„ + CTA */
    .profile-identity { text-align:center; margin-bottom:14px; }
    .profile-nick { font-size:22px; font-weight:900; margin-bottom:4px; }
    .profile-hint { font-size:12px; color:var(--sub); line-height:1.4; margin-bottom:10px; }
    .profile-cta-row { display:flex; gap:8px; justify-content:center; }
    .btn-primary {
      padding:9px 22px; border-radius:var(--radius-pill); border:none;
      background:var(--text); color:#fff;
      font-size:13px; font-weight:700; cursor:pointer; font-family:inherit;
      min-height:44px; display:flex; align-items:center; gap:5px;
    }
    .btn-primary:active { opacity:.8; }
    .btn-outline {
      padding:9px 18px; border-radius:var(--radius-pill);
      border:1.5px solid var(--border); background:var(--bg); color:var(--text);
      font-size:13px; font-weight:700; cursor:pointer; font-family:inherit;
      min-height:44px; display:flex; align-items:center; gap:5px;
    }
    .btn-outline:active { opacity:.8; }

    /* ë‹‰ë„¤ì„ í¸ì§‘ ì¸ë¼ì¸ ë°•ìŠ¤ */
    .nick-edit-box { background:var(--bg); border-radius:12px; padding:14px; margin-bottom:14px; }
    .nick-edit-hint { font-size:12px; color:var(--sub); margin-bottom:8px; line-height:1.5; }
    .nick-edit-row  { display:flex; gap:8px; }
    .nick-edit-input { flex:1; padding:11px 14px; border:1.5px solid var(--border); border-radius:10px; font-size:15px; font-family:inherit; text-align:center; min-height:44px; }
    .nick-edit-input:focus { outline:none; border-color:var(--text); }
    .nick-save-btn { padding:11px 18px; background:var(--text); color:#fff; border:none; border-radius:10px; font-size:13px; font-weight:700; cursor:pointer; font-family:inherit; white-space:nowrap; min-height:44px; }
    .nick-save-btn:disabled { opacity:.5; }
    .nick-edit-error    { font-size:12px; color:var(--accent); margin-top:6px; }
    .nick-edit-cooldown { font-size:12px; color:var(--sub);   margin-top:6px; }

    /* í†µê³„ ì¹© â€“ ì•„ì´ì½˜ + ìˆ«ì + í•œê¸€ ë¼ë²¨ */
    .stats-row { display:flex; gap:8px; }
    .stat-chip {
      flex:1; text-align:center;
      background:var(--bg); border-radius:14px; padding:12px 6px;
      cursor:pointer; border:2px solid transparent;
      transition:border-color .15s, background .15s;
      user-select:none; min-height:44px;
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px;
    }
    .stat-chip:active { opacity:.8; }
    /* ìƒ‰+í…Œë‘ë¦¬+ë°°ê²½ 3ì¤‘ ê°•ì¡° â†’ ìƒ‰ë§¹ ëŒ€ë¹„ */
    .stat-chip.active { border-color:var(--text); background:var(--card); }
    .stat-icon  { font-size:17px; }
    .stat-num   { font-size:16px; font-weight:900; }
    .stat-label { font-size:10px; color:var(--sub); font-weight:700; }
    .stat-chip.active .stat-label { color:var(--text); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ì¹´ë“œ 2 â€“ ì˜¤ëŠ˜ì˜ ë¯¸ì…˜
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .mission-card {
      background:var(--card); border-radius:var(--radius-card);
      padding:16px 18px; margin-bottom:12px;
      box-shadow:var(--shadow-card);
      border-left:4px solid var(--yar);
    }
    .mission-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .mission-title  { font-size:13px; font-weight:900; display:flex; align-items:center; gap:5px; }
    .mission-reward {
      background:#fff3cd; color:#a16207;
      border-radius:var(--radius-pill); font-size:11px; font-weight:700;
      padding:3px 10px;
    }
    .mission-text   { font-size:14px; font-weight:700; margin-bottom:10px; line-height:1.4; }
    .mission-bar-wrap { background:var(--bg); border-radius:var(--radius-pill); height:8px; overflow:hidden; margin-bottom:6px; }
    .mission-bar { height:100%; border-radius:var(--radius-pill); background:linear-gradient(90deg,var(--yar),#ffcd56); transition:width .4s ease; }
    .mission-meta   { font-size:11px; color:var(--sub); display:flex; justify-content:space-between; }
    .mission-done   {
      display:inline-flex; align-items:center; gap:4px;
      background:#e6f9ed; color:var(--green);
      border-radius:var(--radius-pill); font-size:12px; font-weight:700;
      padding:4px 12px; margin-top:8px;
      animation:missionPop .4s ease;
    }
    /* ë‹‰ë„¤ì„ ì—†ì„ ë•Œ íŒíŠ¸ */
    .mission-no-nick {
      font-size:12px; color:var(--sub); margin-top:6px; text-align:center; line-height:1.5;
    }
    .mission-no-nick button {
      background:none; border:none; color:var(--blue); font-size:12px; font-weight:700;
      cursor:pointer; font-family:inherit; padding:0; text-decoration:underline;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       íƒ­ ë°” â€“ í•„ ë°°ê²½ active (index.html ìŠ¤íƒ€ì¼ í†µì¼)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .tab-bar {
      display:flex; background:var(--bg); border-radius:var(--radius-pill);
      padding:4px; margin-bottom:14px; gap:4px;
    }
    .tab-btn {
      flex:1; padding:10px 0; font-size:13px; font-weight:700;
      color:var(--sub); background:transparent; border:none;
      cursor:pointer; font-family:inherit; border-radius:var(--radius-pill);
      transition:background .15s, color .15s;
      min-height:44px; display:flex; align-items:center; justify-content:center; gap:4px;
    }
    .tab-btn.active { color:var(--text); background:var(--card); box-shadow:0 1px 4px rgba(0,0,0,.1); }
    .tab-badge {
      display:inline-flex; align-items:center; justify-content:center;
      background:var(--accent); color:#fff; border-radius:var(--radius-pill);
      font-size:10px; font-weight:700; min-width:18px; height:18px; padding:0 4px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       í™œë™ ì¹´ë“œ (ê¸€ + ëŒ“ê¸€ í˜¼í•© í”¼ë“œ)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .activity-item {
      background:var(--card); border-radius:var(--radius-card);
      padding:14px; margin-bottom:10px;
      box-shadow:var(--shadow-card); position:relative;
    }
    .activity-item-head { display:flex; align-items:center; gap:6px; margin-bottom:8px; }
    .type-badge { padding:3px 10px; border-radius:var(--radius-pill); font-size:10px; font-weight:700; flex-shrink:0; }
    .badge-post    { background:#e8f0fe; color:#1a56c4; }
    .badge-comment { background:#e6f9ed; color:#15803d; }
    .item-ts { font-size:11px; color:var(--sub2); }
    /* â‹¯ ì˜¤ë²„í”Œë¡œ ë²„íŠ¼ â€“ 44 Ã— 44 í„°ì¹˜ ì˜ì—­ */
    .overflow-btn {
      margin-left:auto;
      width:44px; height:44px; border-radius:50%;
      background:transparent; border:none;
      cursor:pointer; font-size:20px; color:var(--sub2);
      display:flex; align-items:center; justify-content:center; flex-shrink:0;
    }
    .overflow-btn:active { background:var(--bg); }
    .activity-origin { font-size:12px; color:var(--blue); font-weight:700; margin-bottom:5px; cursor:pointer; }
    .activity-origin:active { opacity:.75; }
    .activity-title  { font-size:15px; font-weight:700; margin-bottom:4px; cursor:pointer; line-height:1.4; }
    .activity-title:active { opacity:.75; }
    .activity-body   { font-size:13px; color:var(--sub); line-height:1.5; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; margin-bottom:8px; }
    .activity-meta   { display:flex; align-items:center; gap:10px; font-size:12px; color:var(--sub); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ë°›ì€ ë°˜ì‘ (ì•¼ë¥´~) ëª©ë¡
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .reactions-card { background:var(--card); border-radius:var(--radius-card); padding:4px 14px; margin-bottom:10px; box-shadow:var(--shadow-card); }
    .reaction-item  { display:flex; align-items:center; gap:10px; padding:13px 0; border-bottom:1px solid var(--border); cursor:pointer; min-height:52px; }
    .reaction-item:last-child { border-bottom:none; }
    .reaction-item:active { opacity:.75; }
    .reaction-icon-wrap { width:40px; height:40px; border-radius:12px; background:#fff3cd; display:flex; align-items:center; justify-content:center; font-size:20px; flex-shrink:0; }
    .reaction-info  { flex:1; min-width:0; }
    .reaction-nick  { font-size:14px; font-weight:700; }
    .reaction-post  { font-size:12px; color:var(--sub); margin-top:2px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .reaction-time  { font-size:11px; color:var(--sub2); margin-left:auto; flex-shrink:0; white-space:nowrap; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ë¹ˆ ìƒíƒœ
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .empty { text-align:center; padding:48px 20px; }
    .empty-icon { font-size:44px; margin-bottom:12px; }
    .empty-text { font-size:15px; font-weight:700; margin-bottom:4px; }
    .empty-sub  { font-size:13px; color:var(--sub); }

    /* ë”ë³´ê¸° */
    .load-more { width:100%; padding:13px; background:var(--card); border:1.5px solid var(--border); border-radius:var(--radius-card); font-size:14px; font-weight:700; color:var(--sub); cursor:pointer; font-family:inherit; min-height:44px; }
    .load-more:disabled { opacity:.5; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ë°”í…€ ë„¤ë¹„ (index.html ê³¼ ë™ì¼)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .bottom-nav { position:fixed; bottom:0; left:0; right:0; background:var(--card); border-top:1px solid var(--border); display:flex; z-index:100; padding-bottom:env(safe-area-inset-bottom,0); }
    .bottom-nav a { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:8px 0 6px; text-decoration:none; color:var(--sub); font-size:10px; font-weight:600; gap:2px; min-height:50px; }
    .bottom-nav a.active { color:var(--text); }
    .nav-icon { font-size:22px; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ì˜¤ë²„í”Œë¡œ ë°”í…€ì‹œíŠ¸
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .sheet-overlay { position:fixed; inset:0; background:rgba(0,0,0,.4); z-index:4000; display:flex; align-items:flex-end; justify-content:center; }
    .sheet-overlay.hidden { display:none; }
    .sheet-panel { width:100%; max-width:640px; background:var(--card); border-radius:20px 20px 0 0; padding:0 0 env(safe-area-inset-bottom,12px); overflow:hidden; }
    .sheet-handle { width:36px; height:4px; background:var(--border); border-radius:2px; margin:12px auto 8px; }
    .sheet-label { font-size:12px; color:var(--sub2); text-align:center; padding:0 16px 10px; border-bottom:1px solid var(--border); }
    .sheet-item  { width:100%; padding:0 24px; text-align:left; font-size:16px; font-weight:700; font-family:inherit; background:none; border:none; cursor:pointer; display:flex; align-items:center; gap:12px; color:var(--text); min-height:54px; }
    .sheet-item:active { background:var(--bg); }
    .sheet-item.danger { color:var(--accent); }
    .sheet-sep   { height:1px; background:var(--border); margin:0 16px; }
    .sheet-cancel { width:100%; padding:0 24px; text-align:center; font-size:16px; font-weight:700; font-family:inherit; background:none; border:none; cursor:pointer; color:var(--sub); margin-top:4px; min-height:54px; }
    .sheet-cancel:active { background:var(--bg); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ì‚­ì œ í™•ì¸ ëª¨ë‹¬
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .confirm-overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:5000; display:flex; align-items:center; justify-content:center; padding:24px; }
    .confirm-overlay.hidden { display:none; }
    .confirm-box { background:var(--card); border-radius:20px; padding:24px; width:100%; max-width:300px; text-align:center; }
    .confirm-icon  { font-size:36px; margin-bottom:10px; }
    .confirm-title { font-size:17px; font-weight:900; margin-bottom:6px; }
    .confirm-sub   { font-size:13px; color:var(--sub); margin-bottom:20px; line-height:1.5; }
    .confirm-btns  { display:flex; gap:8px; }
    .confirm-cancel { flex:1; padding:13px; border:1.5px solid var(--border); border-radius:12px; font-size:15px; font-weight:700; cursor:pointer; font-family:inherit; background:var(--bg); min-height:48px; }
    .confirm-ok     { flex:1; padding:13px; border:none; border-radius:12px; font-size:15px; font-weight:700; cursor:pointer; font-family:inherit; background:var(--accent); color:#fff; min-height:48px; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ê¸€ì“°ê¸° ëª¨ë‹¬ (index.html ê³¼ ë™ì¼)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .write-overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:flex-end; justify-content:center; z-index:3000; }
    .write-overlay.hidden { display:none; }
    .write-panel { width:100%; max-width:640px; background:var(--card); border-radius:20px 20px 0 0; padding:0 0 env(safe-area-inset-bottom,0); }
    .write-handle { width:36px; height:4px; background:var(--border); border-radius:2px; margin:10px auto; }
    .write-head { padding:0 16px 12px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border); }
    .write-head-title { font-size:17px; font-weight:900; }
    .write-close { padding:7px 14px; border:1px solid var(--border); border-radius:var(--radius-pill); background:var(--bg); font-size:12px; cursor:pointer; font-family:inherit; min-height:36px; }
    .write-body { padding:16px; }
    .write-input { width:100%; padding:12px; border:1.5px solid var(--border); border-radius:12px; font-size:15px; font-family:inherit; margin-bottom:10px; min-height:44px; }
    .write-input:focus { outline:none; border-color:var(--text); }
    .write-textarea { width:100%; padding:12px; border:1.5px solid var(--border); border-radius:12px; font-size:14px; font-family:inherit; min-height:120px; resize:none; line-height:1.6; }
    .write-textarea:focus { outline:none; border-color:var(--text); }
    .write-footer { display:flex; gap:8px; padding:12px 16px; border-top:1px solid var(--border); padding-bottom:calc(12px + env(safe-area-inset-bottom,0)); }
    .write-submit { flex:1; padding:13px; background:var(--text); color:#fff; border:none; border-radius:12px; font-size:15px; font-weight:700; cursor:pointer; font-family:inherit; min-height:48px; }
    .write-submit:disabled { opacity:.5; }
    .write-error { font-size:12px; color:var(--accent); min-height:16px; padding:0 16px 8px; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ê²Œì‹œê¸€ ìƒì„¸ íŒ¨ë„ (index.html ê³¼ ë™ì¼)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:flex-end; justify-content:center; z-index:2000; }
    .overlay.hidden { display:none; }
    .detail-panel  { width:100%; max-width:640px; background:var(--card); border-radius:20px 20px 0 0; max-height:90vh; display:flex; flex-direction:column; }
    .detail-handle { width:36px; height:4px; background:var(--border); border-radius:2px; margin:10px auto 0; flex-shrink:0; }
    .detail-head   { padding:12px 16px 10px; border-bottom:1px solid var(--border); flex-shrink:0; }
    .detail-title  { font-size:17px; font-weight:900; margin-bottom:6px; }
    .detail-meta   { font-size:12px; color:var(--sub); display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .detail-meta-author { font-weight:700; color:var(--text); }
    .detail-scroll { flex:1; overflow-y:auto; }
    .detail-body   { padding:14px 16px; font-size:14px; line-height:1.7; border-bottom:1px solid var(--border); white-space:pre-wrap; }
    .detail-body a { color:var(--blue); text-decoration:underline; word-break:break-all; }
    .detail-media  { padding:0 16px 12px; }
    .detail-media img   { width:100%; border-radius:12px; display:block; margin-bottom:8px; max-height:400px; object-fit:cover; }
    .detail-media video { width:100%; border-radius:12px; display:block; margin-bottom:8px; max-height:400px; }
    .detail-media audio { width:100%; border-radius:12px; display:block; margin-bottom:8px; }
    .detail-footer { padding:10px 16px; display:flex; align-items:center; gap:10px; border-bottom:1px solid var(--border); flex-shrink:0; }
    .detail-stat   { font-size:13px; color:var(--sub); }
    .detail-yar    { margin-left:auto; display:flex; align-items:center; gap:4px; padding:7px 14px; border-radius:var(--radius-pill); border:1.5px solid var(--border); background:var(--bg); font-size:13px; font-weight:700; cursor:pointer; font-family:inherit; color:var(--sub); min-height:44px; }
    .detail-yar.active { border-color:var(--yar); color:var(--yar); background:#fff9ee; }
    .detail-close  { padding:7px 14px; border:1px solid var(--border); border-radius:var(--radius-pill); background:var(--bg); font-size:12px; cursor:pointer; font-family:inherit; min-height:44px; flex-shrink:0; }
    .comments-wrap { padding:0 16px 10px; }
    .ctab { padding:5px 12px; border-radius:var(--radius-pill); border:1.5px solid var(--border); background:var(--bg); color:var(--sub); font-size:11px; font-weight:700; cursor:pointer; font-family:inherit; min-height:36px; }
    .ctab-active { border-color:var(--text); background:var(--text); color:#fff; }
    .comment-item  { padding:10px 0; border-bottom:1px solid var(--border); display:flex; gap:8px; align-items:flex-start; }
    .comment-item:last-child { border-bottom:none; }
    .comment-avatar { width:30px; height:30px; border-radius:8px; background:var(--bg); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:15px; flex-shrink:0; overflow:hidden; }
    .comment-avatar img { width:100%; height:100%; object-fit:cover; }
    .comment-right  { flex:1; min-width:0; }
    .comment-nick   { font-size:12px; font-weight:700; }
    .comment-body   { font-size:13px; line-height:1.5; margin-top:3px; }
    .comment-time   { font-size:11px; color:var(--sub2); margin-top:2px; }
    .comment-form  { flex-shrink:0; background:var(--card); border-top:1px solid var(--border); padding:10px 16px; display:flex; gap:8px; padding-bottom:calc(10px + env(safe-area-inset-bottom,0)); }
    .comment-input { flex:1; padding:10px 14px; border:1.5px solid var(--border); border-radius:var(--radius-pill); font-size:14px; font-family:inherit; min-height:44px; }
    .comment-input:focus { outline:none; border-color:var(--text); }
    .comment-send  { padding:10px 18px; background:var(--text); color:#fff; border:none; border-radius:var(--radius-pill); font-size:13px; font-weight:700; cursor:pointer; font-family:inherit; min-height:44px; }
    .comment-send:disabled { opacity:.5; }
  </style>
</head>
<body>

<!-- ë¡œë”© -->
<div id="globalLoader">
  <div style="font-size:52px;">ğŸŒˆ</div>
  <div class="spinner"></div>
  <div style="font-size:14px;color:var(--sub);">ë‚´ í˜ì´ì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<!-- í—¤ë” -->
<div class="header">
  <div class="header-inner">
    <a class="back-btn" href="index.html" aria-label="í™ˆìœ¼ë¡œ">â†</a>
    <div class="header-title">ë‚´ í˜ì´ì§€</div>
  </div>
</div>

<div class="container">

  <!-- â•â• ì¹´ë“œ 1: í”„ë¡œí•„ â•â• -->
  <div class="profile-card">

    <!-- ì•„ë°”íƒ€ -->
    <div class="avatar-area">
      <div class="avatar-ring" onclick="document.getElementById('avatarFileInput').click()" title="í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½">
        <div class="avatar-ring-inner" id="profileAvatar">ğŸ‘¤</div>
        <div class="avatar-cam-btn">ğŸ“·</div>
      </div>
    </div>
    <input type="file" id="avatarFileInput" accept="image/*" style="display:none" onchange="uploadAvatar(this)">

    <!-- ë‹‰ë„¤ì„ + CTA -->
    <div class="profile-identity">
      <div class="profile-nick" id="nickDisplay">ë‹‰ë„¤ì„ ì—†ìŒ</div>
      <div class="profile-hint" id="profileHint">ì´ ê¸°ê¸°ì—ì„œ ì‘ì„±í•œ ê¸€ê³¼ ëŒ“ê¸€ì„ ë³¼ ìˆ˜ ìˆì–´ìš”</div>
      <div class="profile-cta-row">
        <button class="btn-primary" onclick="document.getElementById('avatarFileInput').click()">ğŸ¨ ê¾¸ë¯¸ê¸°</button>
        <button class="btn-outline"  onclick="toggleNickEdit()">âœï¸ ë‹‰ë„¤ì„ ë³€ê²½</button>
      </div>
    </div>

    <!-- ë‹‰ë„¤ì„ í¸ì§‘ ì¸ë¼ì¸ (í† ê¸€) -->
    <div class="nick-edit-box hidden" id="nickEditBox">
      <div class="nick-edit-hint">7ì¼ë§ˆë‹¤ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš” Â· í•œê¸€, ì˜ë¬¸, ìˆ«ì 1~10ì</div>
      <div class="nick-edit-row">
        <input class="nick-edit-input" id="nickEditInput" placeholder="ìƒˆ ë‹‰ë„¤ì„ ì…ë ¥" maxlength="10" autocomplete="off">
        <button class="nick-save-btn" id="nickSaveBtn" onclick="saveNickname()">ì €ì¥</button>
      </div>
      <div class="nick-edit-error    hidden" id="nickEditError"></div>
      <div class="nick-edit-cooldown hidden" id="nickEditCooldown"></div>
    </div>

    <!-- í†µê³„ ì¹© 3ê°œ -->
    <div class="stats-row">
      <div class="stat-chip active" id="chipPosts" onclick="switchTab('activity')">
        <span class="stat-icon">âœï¸</span>
        <span class="stat-num" id="statPosts">-</span>
        <span class="stat-label">ë‚´ ê¸€</span>
      </div>
      <div class="stat-chip" id="chipComments" onclick="switchTab('activity')">
        <span class="stat-icon">ğŸ’¬</span>
        <span class="stat-num" id="statComments">-</span>
        <span class="stat-label">ë‚´ ëŒ“ê¸€</span>
      </div>
      <div class="stat-chip" id="chipYars" onclick="switchTab('reactions')">
        <span class="stat-icon">ğŸŒŸ</span>
        <span class="stat-num" id="statYars">-</span>
        <span class="stat-label">ë‚´ ì•¼ë¥´~</span>
      </div>
    </div>
  </div>

  <!-- â•â• ì¹´ë“œ 2: ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ â•â• -->
  <div class="mission-card" id="missionCard">
    <div class="mission-header">
      <div class="mission-title">ğŸ¯ ì˜¤ëŠ˜ì˜ ë¯¸ì…˜</div>
      <div class="mission-reward">ğŸŒŸ ì•¼ë¥´~ +1</div>
    </div>
    <div class="mission-text" id="missionText">ì¹œêµ¬ ê¸€ì— ë”°ëœ»í•œ ëŒ“ê¸€ 1ê°œ ë‹¬ê¸° ğŸ’¬</div>
    <div class="mission-bar-wrap">
      <div class="mission-bar" id="missionBar" style="width:0%"></div>
    </div>
    <div class="mission-meta">
      <span id="missionLabel">0 / 1 ì™„ë£Œ</span>
      <span id="missionPct">0%</span>
    </div>
    <div class="mission-done hidden" id="missionDone">âœ… ë¯¸ì…˜ ì™„ë£Œ! ì•¼ë¥´~ +1 íšë“</div>
    <div class="mission-no-nick hidden" id="missionNoNick">
      ë‹‰ë„¤ì„ì„ ì„¤ì •í•˜ë©´ ë¯¸ì…˜ì— ì°¸ì—¬í•  ìˆ˜ ìˆì–´ìš”!
      <button onclick="toggleNickEdit();document.getElementById('nickEditBox').scrollIntoView({behavior:'smooth'})">ì§€ê¸ˆ ì„¤ì •í•˜ê¸°</button>
    </div>
  </div>

  <!-- â•â• íƒ­ (í•„ ë°°ê²½) â•â• -->
  <div class="tab-bar">
    <button class="tab-btn active" id="tabActivity"  onclick="switchTab('activity')">
      ğŸ“ ë‚´ í™œë™
    </button>
    <button class="tab-btn"        id="tabReactions" onclick="switchTab('reactions')">
      ğŸŒŸ ë°›ì€ ë°˜ì‘
      <span class="tab-badge hidden" id="reactionBadge"></span>
    </button>
  </div>

  <!-- ë‚´ í™œë™ ì„¹ì…˜ -->
  <div id="activitySection">
    <div class="skel" style="height:96px;margin-bottom:10px;"></div>
    <div class="skel" style="height:80px;margin-bottom:10px;"></div>
    <div class="skel" style="height:96px;margin-bottom:10px;"></div>
  </div>

  <!-- ë°›ì€ ë°˜ì‘ ì„¹ì…˜ (ì´ˆê¸° ìˆ¨ê¹€) -->
  <div id="reactionsSection" class="hidden"></div>

  <button class="load-more hidden" id="loadMoreBtn" onclick="loadMore()">ë” ë³´ê¸°</button>
</div>

<!-- ë°”í…€ ë„¤ë¹„ -->
<div class="bottom-nav">
  <a href="index.html"><span class="nav-icon">ğŸ </span>í™ˆ</a>
  <a href="#" onclick="openWrite();return false;"
     style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px 0 6px;text-decoration:none;color:var(--sub);font-size:10px;font-weight:600;gap:2px;">
    <span style="width:42px;height:28px;background:var(--text);border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:18px;">âœï¸</span>ê¸€ì“°ê¸°
  </a>
  <a href="mypage.html" class="active"><span class="nav-icon">ğŸ‘¤</span>ë‚´ í˜ì´ì§€</a>
</div>

<!-- â•â• ì˜¤ë²„í”Œë¡œ ë°”í…€ì‹œíŠ¸ â•â• -->
<div class="sheet-overlay hidden" id="sheetOverlay" onclick="closeSheet()">
  <div class="sheet-panel" onclick="event.stopPropagation()">
    <div class="sheet-handle"></div>
    <div class="sheet-label" id="sheetLabel"></div>
    <button class="sheet-item" id="sheetEditBtn" onclick="sheetEdit()">âœï¸ ìˆ˜ì •</button>
    <div class="sheet-sep"></div>
    <button class="sheet-item danger" onclick="sheetDeleteRequest()">ğŸ—‘ ì‚­ì œ</button>
    <div class="sheet-sep"></div>
    <button class="sheet-cancel" onclick="closeSheet()">ì·¨ì†Œ</button>
  </div>
</div>

<!-- â•â• ì‚­ì œ í™•ì¸ ëª¨ë‹¬ â•â• -->
<div class="confirm-overlay hidden" id="confirmOverlay">
  <div class="confirm-box">
    <div class="confirm-icon">ğŸ¥º</div>
    <div class="confirm-title">ì •ë§ ì‚­ì œí• ê¹Œìš”?</div>
    <div class="confirm-sub">ì‚­ì œí•˜ë©´ ë˜ëŒë¦´ ìˆ˜ ì—†ì–´ìš”.<br>ê·¸ë˜ë„ ì§€ìš¸ê¹Œìš”?</div>
    <div class="confirm-btns">
      <button class="confirm-cancel" onclick="closeConfirm()">ì•„ë‹ˆìš”</button>
      <button class="confirm-ok"     onclick="confirmDelete()">ë„¤, ì‚­ì œí• ê²Œìš”</button>
    </div>
  </div>
</div>

<!-- â•â• ê¸€ì“°ê¸° ëª¨ë‹¬ â•â• -->
<div class="write-overlay hidden" id="writeOverlay" onclick="handleWriteOverlay(event)">
  <div class="write-panel" onclick="event.stopPropagation()">
    <div class="write-handle"></div>
    <div class="write-head">
      <div class="write-head-title">âœï¸ ì´ì•¼ê¸° ì“°ê¸°</div>
      <button class="write-close" onclick="closeWrite()">âœ• ë‹«ê¸°</button>
    </div>
    <div class="write-body">
      <input    class="write-input"    id="writeTitle" placeholder="ì œëª© (2~80ì)"           maxlength="80">
      <textarea class="write-textarea" id="writeBody"  placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”... (5ì ì´ìƒ)" maxlength="5000"></textarea>
    </div>
    <div class="write-error" id="writeError"></div>
    <div class="write-footer">
      <button class="write-submit" id="writeSubmitBtn" onclick="submitWrite()">ê²Œì‹œí•˜ê¸°</button>
    </div>
  </div>
</div>

<!-- â•â• ê²Œì‹œê¸€ ìƒì„¸ íŒ¨ë„ â•â• -->
<div class="overlay hidden" id="detailOverlay" onclick="handleDetailOverlay(event)">
  <div class="detail-panel" onclick="event.stopPropagation()">
    <div class="detail-handle"></div>
    <div class="detail-head">
      <div class="detail-title" id="dTitle"></div>
      <div class="detail-meta">
        <span class="detail-meta-author" id="dAuthor"></span>
        <span id="dTime"></span>
      </div>
    </div>
    <div class="detail-scroll">
      <div class="detail-body"  id="dBody"></div>
      <div class="detail-media" id="dMedia"></div>
      <div class="detail-footer">
        <span class="detail-stat" id="dStats"></span>
        <button class="detail-yar" id="dYarBtn" onclick="toggleDetailYar()">ğŸŒŸ ì•¼ë¥´~</button>
        <button class="detail-close" onclick="closeDetail()">âœ• ë‹«ê¸°</button>
      </div>
      <div class="comments-wrap">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0 6px;">
          <span style="font-size:13px;font-weight:700;color:var(--sub);">ëŒ“ê¸€</span>
          <div style="display:flex;gap:6px;">
            <button id="cTabLatest"  onclick="switchCommentTab('latest')"  class="ctab ctab-active">ìµœì‹ ìˆœ</button>
            <button id="cTabPopular" onclick="switchCommentTab('popular')" class="ctab">ì¸ê¸°ìˆœ</button>
          </div>
        </div>
        <div id="dComments"></div>
      </div>
    </div>
    <div class="comment-form">
      <input  class="comment-input" id="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." maxlength="500">
      <button class="comment-send"  id="commentSendBtn" onclick="submitComment()">ì „ì†¡</button>
    </div>
  </div>
</div>

<script>
  'use strict';
  const API    = 'https://rainbowkidz-api.irunaru.workers.dev/api/v1';
  const apiUrl = (path, ng = false) => {
    if (!ng || !guestId) return `${API}${path}`;
    return `${API}${path}${path.includes('?') ? '&' : '?'}guest_id=${encodeURIComponent(guestId)}`;
  };

  /* â”€â”€ ì „ì—­ ìƒíƒœ â”€â”€ */
  let guestId      = null;
  let myNickname   = null;
  let currentTab   = 'activity';
  let myPosts      = [];
  let myComments   = [];
  let activityFeed = [];   // [{type:'post'|'comment', data, ts}]
  let allYarers    = [];
  let currentPost  = null;
  let currentComments = [];
  let commentSort  = 'latest';

  // ì˜¤ë²„í”Œë¡œ / ì‚­ì œ ìƒíƒœ
  let sheetType    = null;  // 'post' | 'comment'
  let sheetId      = null;
  let pendingDeleteFn = null;

  // ë¯¸ì…˜ (ë¡œì»¬ í•˜ë£¨ ë‹¨ìœ„)
  const TODAY_KEY  = 'rkMission_' + new Date().toDateString();
  let missionDone  = parseInt(localStorage.getItem(TODAY_KEY) || '0');

  /* â”€â”€ ìœ í‹¸ â”€â”€ */
  const esc = s => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  const relTime = d => {
    const s = (Date.now() - new Date(d)) / 1000;
    if (s < 60)     return 'ë°©ê¸ˆ';
    if (s < 3600)   return `${Math.floor(s/60)}ë¶„ ì „`;
    if (s < 86400)  return `${Math.floor(s/3600)}ì‹œê°„ ì „`;
    if (s < 604800) return `${Math.floor(s/86400)}ì¼ ì „`;
    return new Date(d).toLocaleDateString('ko-KR', { month:'long', day:'numeric' });
  };
  const getYar = id => localStorage.getItem(`rkYar_${id}`) === '1';
  const setYar = (id, v) => localStorage.setItem(`rkYar_${id}`, v ? '1' : '0');

  function detectMediaType(url) {
    if (!url) return null;
    const u = url.toLowerCase().split('?')[0];
    if (/\.(jpg|jpeg|png|gif|webp|avif|svg)$/.test(u)) return 'image';
    if (/\.(mp4|webm|mov)$/.test(u)) return 'video';
    if (/\.(mp3|wav|ogg|m4a|aac)$/.test(u)) return 'audio';
    if (/youtube\.com|youtu\.be/.test(url)) return 'youtube';
    return 'link';
  }
  function linkify(t) {
    return esc(t).replace(/(https?:\/\/[^\s&<>"]+)/g,
      '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
  }

  document.addEventListener('keydown', e => {
    if (e.key !== 'Escape') return;
    closeDetail(); closeSheet(); closeConfirm();
  });

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ê²ŒìŠ¤íŠ¸ ì´ˆê¸°í™”
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  async function initGuest() {
    try {
      const r = await fetch(`${API}/guest/init`, {
        method:'POST', credentials:'include',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ existing_gid: localStorage.getItem('rkGuestId') || null }),
      });
      if (!r.ok) return;
      const d = await r.json();
      guestId = d.guest_id;
      if (guestId) localStorage.setItem('rkGuestId', guestId);
      try {
        const m = await fetch(apiUrl('/me', true), { credentials:'include' });
        if (m.ok) {
          const md = await m.json();
          myNickname = md.guest?.nickname || null;
          if (myNickname) localStorage.setItem('rkNickname', myNickname);
          else             localStorage.removeItem('rkNickname');
        }
      } catch { myNickname = localStorage.getItem('rkNickname') || null; }
    } catch {}
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ë¯¸ì…˜ ì¹´ë“œ
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function renderMissionUI() {
    const done  = Math.min(missionDone, 1);
    const pct   = done * 100;
    document.getElementById('missionBar').style.width = pct + '%';
    document.getElementById('missionLabel').textContent = `${done} / 1 ì™„ë£Œ`;
    document.getElementById('missionPct').textContent   = pct + '%';
    document.getElementById('missionDone').classList.toggle('hidden', done < 1);
    // ë‹‰ë„¤ì„ ì—†ìœ¼ë©´ ì°¸ì—¬ ìœ ë„
    const noNick = document.getElementById('missionNoNick');
    noNick.classList.toggle('hidden', !!myNickname);
  }
  function tickMission() {
    if (!myNickname) return;
    if (missionDone < 1) {
      missionDone = 1;
      localStorage.setItem(TODAY_KEY, '1');
      renderMissionUI();
    }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     í”„ë¡œí•„ íŒíŠ¸ / ë‹‰ë„¤ì„ í¸ì§‘
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function updateProfileUI() {
    document.getElementById('nickDisplay').textContent = myNickname || 'ë‹‰ë„¤ì„ ì—†ìŒ';
    document.getElementById('profileHint').textContent = myNickname
      ? 'ì´ ê¸°ê¸°ì—ì„œ ì‘ì„±í•œ ê¸€ê³¼ ëŒ“ê¸€ì„ ë³¼ ìˆ˜ ìˆì–´ìš”'
      : 'ë‹‰ë„¤ì„ì„ ì„¤ì •í•˜ë©´ ê¸€Â·ëŒ“ê¸€Â·ì•¼ë¥´~ë¥¼ í•  ìˆ˜ ìˆì–´ìš”!';
    renderMissionUI();
  }

  function toggleNickEdit() {
    const box  = document.getElementById('nickEditBox');
    const show = box.classList.contains('hidden');
    box.classList.toggle('hidden', !show);
    if (show) {
      const inp = document.getElementById('nickEditInput');
      inp.value = myNickname || '';
      inp.focus();
    }
  }
  document.getElementById('nickEditInput').addEventListener('keypress', e => {
    if (e.key === 'Enter') saveNickname();
  });

  async function saveNickname() {
    const val    = document.getElementById('nickEditInput').value.trim();
    const errEl  = document.getElementById('nickEditError');
    const coolEl = document.getElementById('nickEditCooldown');
    const btn    = document.getElementById('nickSaveBtn');
    errEl.classList.add('hidden'); coolEl.classList.add('hidden');
    if (!val || val.length > 10) { errEl.textContent = '1~10ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”'; errEl.classList.remove('hidden'); return; }
    if (!/^[ê°€-í£ã„±-ã…ã…-ã…£a-zA-Z0-9]+$/.test(val)) { errEl.textContent = 'í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ê°€ëŠ¥í•´ìš”'; errEl.classList.remove('hidden'); return; }
    btn.disabled = true; btn.textContent = 'ì €ì¥ ì¤‘...';
    try {
      const r = await fetch(`${API}/guest/nickname`, {
        method:'POST', credentials:'include',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ nickname: val, guest_id: guestId }),
      });
      const d = await r.json();
      if (d.ok) {
        myNickname = d.nickname;
        localStorage.setItem('rkNickname', d.nickname);
        document.getElementById('nickEditBox').classList.add('hidden');
        updateProfileUI();
      } else if (d.error === 'nickname_cooldown_7days') {
        coolEl.textContent = '7ì¼ì´ ì§€ë‚˜ì•¼ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš”'; coolEl.classList.remove('hidden');
      } else if (d.error === 'nickname_taken') {
        errEl.textContent = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì´ì—ìš”. ë‹¤ë¥¸ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'; errEl.classList.remove('hidden');
      } else { errEl.textContent = d.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'; errEl.classList.remove('hidden'); }
    } catch { errEl.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'; errEl.classList.remove('hidden'); }
    btn.disabled = false; btn.textContent = 'ì €ì¥';
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ì•„ë°”íƒ€ ì—…ë¡œë“œ
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  async function uploadAvatar(input) {
    const file = input.files[0];
    if (!file) return;
    if (file.size > 5 * 1024 * 1024) { alert('5MB ì´í•˜ ì´ë¯¸ì§€ë§Œ ê°€ëŠ¥í•´ìš”'); return; }
    const avEl = document.getElementById('profileAvatar');
    avEl.innerHTML = '<div class="spinner"></div>';
    const fd = new FormData();
    fd.append('image', file);
    if (guestId) fd.append('guest_id', guestId);
    try {
      const r = await fetch(apiUrl('/guest/upload-image', true), { method:'POST', credentials:'include', body: fd });
      const d = await r.json();
      if (d.ok) { avEl.innerHTML = `<img src="${d.image_url}?t=${Date.now()}" alt="í”„ë¡œí•„">`; }
      else { alert(d.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨'); avEl.textContent = 'ğŸ‘¤'; }
    } catch { alert('ì—…ë¡œë“œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'); avEl.textContent = 'ğŸ‘¤'; }
    input.value = '';
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     íƒ­ ì „í™˜
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function switchTab(tab) {
    currentTab = tab;
    const isA  = tab === 'activity';
    document.getElementById('tabActivity').classList.toggle('active', isA);
    document.getElementById('tabReactions').classList.toggle('active', !isA);
    document.getElementById('activitySection').classList.toggle('hidden', !isA);
    document.getElementById('reactionsSection').classList.toggle('hidden', isA);
    document.getElementById('loadMoreBtn').classList.add('hidden');
    // í†µê³„ ì¹© active ìƒíƒœ
    ['chipPosts','chipComments'].forEach(id => document.getElementById(id).classList.toggle('active', isA));
    document.getElementById('chipYars').classList.toggle('active', !isA);
    if (!isA) { markReactionsRead(); loadYarers(); }
    else if (!activityFeed.length) { loadActivity(true); }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ë‚´ í™œë™ ë¡œë“œ (ê¸€ + ëŒ“ê¸€ í˜¼í•©)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  async function loadActivity(reset = false) {
    if (reset) { activityFeed = []; myPosts = []; myComments = []; }
    const sec = document.getElementById('activitySection');
    if (reset) sec.innerHTML = '<div class="skel" style="height:96px;margin-bottom:10px;"></div>'.repeat(3);
    try {
      const [pr, cr] = await Promise.all([
        fetch(apiUrl('/my/posts?limit=50&offset=0', true),    { credentials:'include' }),
        fetch(apiUrl('/my/comments?limit=50&offset=0', true), { credentials:'include' }),
      ]);
      myPosts    = pr.ok ? (await pr.json()).posts    || [] : [];
      myComments = cr.ok ? (await cr.json()).comments || [] : [];

      activityFeed = [
        ...myPosts.map(p    => ({ type:'post',    data:p, ts: new Date(p.created_at).getTime() })),
        ...myComments.map(c => ({ type:'comment', data:c, ts: new Date(c.created_at).getTime() })),
      ].sort((a, b) => b.ts - a.ts);

      // í†µê³„ ì—…ë°ì´íŠ¸
      document.getElementById('statPosts').textContent    = myPosts.length;
      document.getElementById('statComments').textContent = myComments.length;
      document.getElementById('statYars').textContent     = myPosts.reduce((s, p) => s + (p.yar_count||0), 0);

      checkNewReactions();
      renderActivity();
    } catch {
      sec.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ˜¢</div><div class="empty-text">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div><div class="empty-sub">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”</div></div>';
    }
  }

  function loadMore() {}  // í˜ì´ì§€ë„¤ì´ì…˜ í™•ì¥ ê°€ëŠ¥

  function renderActivity() {
    const sec = document.getElementById('activitySection');
    if (!activityFeed.length) {
      sec.innerHTML = `<div class="empty">
        <div class="empty-icon">ğŸ“</div>
        <div class="empty-text">ì•„ì§ í™œë™ ë‚´ì—­ì´ ì—†ì–´ìš”</div>
        <div class="empty-sub">ê¸€ì„ ì“°ê±°ë‚˜ ëŒ“ê¸€ì„ ë‹¬ì•„ë³´ì„¸ìš”!</div>
      </div>`;
      return;
    }
    sec.innerHTML = activityFeed.map(item => renderActivityCard(item)).join('');
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     í™œë™ ì¹´ë“œ ë Œë” â€“ â‹¯ ì˜¤ë²„í”Œë¡œ ë²„íŠ¼
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function renderActivityCard(item) {
    if (item.type === 'post') {
      const p = item.data;
      const preview = esc((p.title || p.body || '').slice(0, 20));
      return `<div class="activity-item">
        <div class="activity-item-head">
          <span class="type-badge badge-post">âœï¸ ë‚´ ê¸€</span>
          <span class="item-ts">${relTime(p.created_at)}</span>
          <button class="overflow-btn" aria-label="ë©”ë‰´"
            onclick="openSheet('post',${p.id},${JSON.stringify(esc(p.title||p.body?.slice(0,20)||''))})">â‹¯</button>
        </div>
        <div class="activity-title" onclick="openDetail(${p.id})">${esc(p.title || p.body?.slice(0,40) || '')}</div>
        ${p.body ? `<div class="activity-body">${esc(p.body)}</div>` : ''}
        <div class="activity-meta">
          <span>ğŸ’¬ ${p.comment_count||0}</span>
          <span>ğŸŒŸ ${p.yar_count||0}</span>
          <span>ğŸ‘ ${p.view_count||0}</span>
        </div>
      </div>`;
    } else {
      const c = item.data;
      return `<div class="activity-item">
        <div class="activity-item-head">
          <span class="type-badge badge-comment">ğŸ’¬ ë‚´ ëŒ“ê¸€</span>
          <span class="item-ts">${relTime(c.created_at)}</span>
          <button class="overflow-btn" aria-label="ë©”ë‰´"
            onclick="openSheet('comment',${c.id},${JSON.stringify(esc(c.body?.slice(0,20)||''))})">â‹¯</button>
        </div>
        <div class="activity-origin" onclick="openDetail(${c.post_id})">ğŸ“ ${esc(c.post_title || 'ì›ë³¸ ê¸€ ë³´ê¸°')} â†’</div>
        <div class="activity-body">${esc(c.body)}</div>
      </div>`;
    }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ì˜¤ë²„í”Œë¡œ ë°”í…€ì‹œíŠ¸ ì œì–´
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function openSheet(type, id, label) {
    sheetType = type; sheetId = id;
    document.getElementById('sheetLabel').textContent = label ? `"${label}"` : '';
    // ê¸€ ìˆ˜ì •ë§Œ ì§€ì› (ëŒ“ê¸€ ìˆ˜ì • API ë¯¸êµ¬í˜„ ì‹œ ìˆ¨ê¹€)
    document.getElementById('sheetEditBtn').style.display = type === 'post' ? '' : 'none';
    document.getElementById('sheetOverlay').classList.remove('hidden');
  }
  function closeSheet() {
    document.getElementById('sheetOverlay').classList.add('hidden');
    sheetType = null; sheetId = null;
  }
  function sheetEdit() {
    closeSheet();
    // TODO: ìˆ˜ì • ê¸°ëŠ¥ (í˜„ì¬ API ë¯¸ì§€ì› â†’ ì•ˆë‚´)
    alert('ìˆ˜ì • ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì´ì—ìš” ğŸ˜Š');
  }
  function sheetDeleteRequest() {
    const type = sheetType, id = sheetId;
    closeSheet();
    pendingDeleteFn = type === 'post'
      ? () => deletePost(id)
      : () => deleteComment(id);
    document.getElementById('confirmOverlay').classList.remove('hidden');
  }
  function closeConfirm() {
    document.getElementById('confirmOverlay').classList.add('hidden');
    pendingDeleteFn = null;
  }
  function confirmDelete() {
    closeConfirm();
    if (pendingDeleteFn) pendingDeleteFn();
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ì‚­ì œ API í˜¸ì¶œ
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  async function deletePost(postId) {
    try {
      const r = await fetch(apiUrl(`/posts/${postId}`, true), { method:'DELETE', credentials:'include' });
      const d = await r.json();
      if (d.ok) {
        myPosts      = myPosts.filter(p => p.id !== postId);
        activityFeed = activityFeed.filter(i => !(i.type === 'post' && i.data.id === postId));
        document.getElementById('statPosts').textContent = myPosts.length;
        document.getElementById('statYars').textContent  = myPosts.reduce((s,p) => s+(p.yar_count||0),0);
        renderActivity();
      } else { alert(d.error === 'not_your_post' ? 'ë‚´ ê¸€ì´ ì•„ë‹ˆì—ìš”' : (d.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”')); }
    } catch { alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'); }
  }

  async function deleteComment(cmtId) {
    try {
      const r = await fetch(`${API}/comments/${cmtId}`, { method:'DELETE', credentials:'include' });
      const d = await r.json();
      if (d.ok) {
        myComments   = myComments.filter(c => c.id !== cmtId);
        activityFeed = activityFeed.filter(i => !(i.type === 'comment' && i.data.id === cmtId));
        document.getElementById('statComments').textContent = myComments.length;
        renderActivity();
      } else { alert(d.error === 'not_your_comment' ? 'ë‚´ ëŒ“ê¸€ì´ ì•„ë‹ˆì—ìš”' : (d.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”')); }
    } catch { alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'); }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ë°›ì€ ì•¼ë¥´~ ë°°ì§€ + ëª©ë¡
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function checkNewReactions() {
    const saved = JSON.parse(localStorage.getItem('rkCmtCounts') || '{}');
    let n = 0;
    myPosts.forEach(p => {
      const prev = saved[p.id] || 0;
      if ((p.comment_count||0) > prev) n += (p.comment_count||0) - prev;
    });
    const badge = document.getElementById('reactionBadge');
    if (n > 0) { badge.textContent = n; badge.classList.remove('hidden'); }
    else        { badge.classList.add('hidden'); }
  }
  function markReactionsRead() {
    const c = {};
    myPosts.forEach(p => { c[p.id] = p.comment_count || 0; });
    localStorage.setItem('rkCmtCounts', JSON.stringify(c));
    document.getElementById('reactionBadge').classList.add('hidden');
  }

  async function loadYarers() {
    const sec = document.getElementById('reactionsSection');
    if (!myPosts.length) {
      sec.innerHTML = '<div class="empty"><div class="empty-icon">ğŸŒŸ</div><div class="empty-text">ì•„ì§ ì‘ì„±í•œ ê¸€ì´ ì—†ì–´ìš”</div></div>';
      return;
    }
    sec.innerHTML = '<div class="skel" style="height:60px;margin-bottom:8px;"></div>'.repeat(3);
    try {
      const results = await Promise.all(
        myPosts.map(p =>
          fetch(`${API}/posts/${p.id}/yars`)
            .then(r => r.json())
            .then(d => ({ post:p, yarers: d.yarers || [] }))
            .catch(() => ({ post:p, yarers: [] }))
        )
      );
      allYarers = [];
      results.forEach(({ post, yarers }) => {
        yarers.forEach(y => allYarers.push({ ...y, post_id:post.id, post_title:post.title||post.body?.slice(0,30)||'' }));
      });
      allYarers.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      document.getElementById('statYars').textContent = allYarers.length;

      if (!allYarers.length) {
        sec.innerHTML = `<div class="empty">
          <div class="empty-icon">ğŸŒŸ</div>
          <div class="empty-text">ì•„ì§ ë°›ì€ ì•¼ë¥´~ê°€ ì—†ì–´ìš”</div>
          <div class="empty-sub">ì¢‹ì€ ê¸€ì„ ì“°ë©´ ì¹œêµ¬ë“¤ì´ ì•¼ë¥´~ë¥¼ ëˆŒëŸ¬ì¤„ ê±°ì˜ˆìš”!</div>
        </div>`;
        return;
      }
      sec.innerHTML = `<div class="reactions-card">
        ${allYarers.map(y => `
          <div class="reaction-item" onclick="openDetail(${y.post_id})">
            <div class="reaction-icon-wrap">ğŸŒŸ</div>
            <div class="reaction-info">
              <div class="reaction-nick">${esc(y.nickname)}</div>
              <div class="reaction-post">${esc(y.post_title)}</div>
            </div>
            <div class="reaction-time">${relTime(y.created_at)}</div>
          </div>`).join('')}
      </div>`;
    } catch {
      sec.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ˜¢</div><div class="empty-text">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div></div>';
    }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ê¸€ì“°ê¸° ëª¨ë‹¬
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  async function openWrite() {
    if (!myNickname && guestId) {
      try { const m = await fetch(apiUrl('/me', true), { credentials:'include' }); if (m.ok) { const md = await m.json(); myNickname = md.guest?.nickname || null; } } catch {}
      if (!myNickname) myNickname = localStorage.getItem('rkNickname');
    }
    if (!myNickname) { alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”!'); toggleNickEdit(); return; }
    document.getElementById('writeOverlay').classList.remove('hidden');
    document.getElementById('writeTitle').focus();
    document.getElementById('writeError').textContent = '';
  }
  function closeWrite() { document.getElementById('writeOverlay').classList.add('hidden'); }
  function handleWriteOverlay(e) { if (e.target.id === 'writeOverlay') closeWrite(); }

  async function submitWrite() {
    const title = document.getElementById('writeTitle').value.trim();
    const body  = document.getElementById('writeBody').value.trim();
    const errEl = document.getElementById('writeError');
    const btn   = document.getElementById('writeSubmitBtn');
    if (title.length < 2) { errEl.textContent = 'ì œëª©ì€ 2ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”'; return; }
    if (body.length  < 5) { errEl.textContent = 'ë‚´ìš©ì€ 5ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”'; return; }
    errEl.textContent = '';
    btn.disabled = true; btn.textContent = 'ê²Œì‹œ ì¤‘...';
    try {
      const r = await fetch(`${API}/posts`, {
        method:'POST', credentials:'include',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ title, body, guest_id: guestId }),
      });
      const d = await r.json();
      if (d.ok) {
        document.getElementById('writeTitle').value = '';
        document.getElementById('writeBody').value  = '';
        closeWrite(); await loadActivity(true); switchTab('activity');
      } else if (d.error === 'rate_limit_post') { errEl.textContent = 'ë„ˆë¬´ ë¹ ë¦…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”'; }
      else { errEl.textContent = d.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'; }
    } catch { errEl.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'; }
    btn.disabled = false; btn.textContent = 'ê²Œì‹œí•˜ê¸°';
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ê²Œì‹œê¸€ ìƒì„¸ íŒ¨ë„
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  async function openDetail(postId) {
    commentSort = 'latest'; switchCommentTab('latest', false);
    ['dTitle','dAuthor','dTime','dStats'].forEach(id => { document.getElementById(id).textContent = ''; });
    document.getElementById('dBody').innerHTML     = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    document.getElementById('dComments').innerHTML = '';
    document.getElementById('dMedia').innerHTML    = '';
    document.getElementById('commentInput').value  = '';
    document.getElementById('detailOverlay').classList.remove('hidden');
    fetch(`${API}/posts/${postId}/view`, { method:'POST' }).catch(() => {});
    try {
      const r = await fetch(`${API}/posts/${postId}`);
      const d = await r.json();
      if (!d.ok) { document.getElementById('dBody').textContent = 'ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì–´ìš”'; return; }
      const p = d.post;
      currentPost     = p;
      currentComments = d.comments || [];
      const isSystem   = p.author_type === 'system';
      document.getElementById('dTitle').textContent  = p.title || '';
      document.getElementById('dBody').innerHTML     = linkify(p.body || '');
      document.getElementById('dAuthor').textContent = isSystem ? (p.character_name||'ìºë¦­í„°') : (p.nickname||'ìµëª…');
      document.getElementById('dTime').textContent   = relTime(p.created_at);
      document.getElementById('dStats').textContent  = `ğŸ’¬ ëŒ“ê¸€ ${d.comments?.length||0} Â· ğŸ‘ ì¡°íšŒ ${p.view_count||0}`;
      renderDetailMedia(p.media_url);
      syncDetailYar(p.yar_count||0, getYar(postId));
      renderDetailComments(currentComments);
    } catch { document.getElementById('dBody').textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'; }
  }

  function renderDetailMedia(url) {
    const wrap = document.getElementById('dMedia');
    wrap.innerHTML = '';
    if (!url) return;
    const mt = detectMediaType(url);
    if (mt === 'image') {
      wrap.innerHTML = `<img src="${esc(url)}" alt="ì´ë¯¸ì§€" onclick="this.requestFullscreen?.()" style="cursor:zoom-in;">`;
    } else if (mt === 'video') {
      wrap.innerHTML = `<video src="${esc(url)}" controls playsinline></video>`;
    } else if (mt === 'audio') {
      wrap.innerHTML = `<div style="font-size:13px;color:var(--sub);margin-bottom:4px;">ğŸµ ìŒì•…</div><audio src="${esc(url)}" controls></audio>`;
    } else if (mt === 'youtube') {
      const ym = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
      if (ym) wrap.innerHTML = `<div style="position:relative;padding-top:56.25%;border-radius:12px;overflow:hidden;"><iframe src="https://www.youtube.com/embed/${ym[1]}" style="position:absolute;inset:0;width:100%;height:100%;border:none;" allowfullscreen></iframe></div>`;
    } else {
      wrap.innerHTML = `<a href="${esc(url)}" target="_blank" rel="noopener" style="color:var(--blue);font-size:13px;">ğŸ”— ì²¨ë¶€ ë§í¬ ì—´ê¸°</a>`;
    }
  }

  function syncDetailYar(count, active) {
    const btn = document.getElementById('dYarBtn');
    btn.className = `detail-yar${active ? ' active' : ''}`;
    btn.innerHTML = `ğŸŒŸ ì•¼ë¥´~ ${count}`;
  }
  async function toggleDetailYar() {
    if (!currentPost) return;
    if (!myNickname) { alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”'); return; }
    const pid = currentPost.id, wasYar = getYar(pid);
    setYar(pid, !wasYar);
    try {
      const r = await fetch(`${API}/posts/${pid}/yar`, {
        method: wasYar ? 'DELETE' : 'POST', credentials:'include',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({}),
      });
      const d = await r.json();
      if (d.ok) {
        syncDetailYar(d.yar_count, !wasYar);
        currentPost.yar_count = d.yar_count;
        const mp = myPosts.find(p => p.id == pid);
        if (mp) { mp.yar_count = d.yar_count; document.getElementById('statYars').textContent = myPosts.reduce((s,p)=>s+(p.yar_count||0),0); }
      }
    } catch {}
  }
  function closeDetail() { document.getElementById('detailOverlay').classList.add('hidden'); currentPost = null; currentComments = []; }
  function handleDetailOverlay(e) { if (e.target.id === 'detailOverlay') closeDetail(); }

  function switchCommentTab(sort, rerender = true) {
    commentSort = sort;
    const L = document.getElementById('cTabLatest'), P = document.getElementById('cTabPopular');
    if (!L || !P) return;
    L.className = 'ctab' + (sort === 'latest'  ? ' ctab-active' : '');
    P.className = 'ctab' + (sort === 'popular' ? ' ctab-active' : '');
    if (rerender) renderDetailComments(currentComments);
  }

  function renderDetailComments(comments) {
    const wrap = document.getElementById('dComments');
    if (!comments.length) {
      wrap.innerHTML = '<div style="color:var(--sub);font-size:13px;padding:8px 0 16px;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ì–´ìš”.</div>';
      return;
    }
    let sorted = [...comments];
    if (commentSort === 'popular') {
      sorted.sort((a, b) => { const aS = a.author_type==='system'?1:0, bS = b.author_type==='system'?1:0; return bS !== aS ? bS-aS : new Date(b.created_at)-new Date(a.created_at); });
    } else { sorted.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)); }
    wrap.innerHTML = sorted.map(cm => {
      const nick = cm.system_users?.display_name || cm.nickname || 'ìµëª…';
      const img  = cm.system_users?.image_url;
      const emo  = cm.system_users?.emoji || 'ğŸ—£ï¸';
      const av   = img
        ? `<img src="${esc(img)}" alt="${esc(nick)}" data-emoji="${esc(emo)}" onerror="this.outerHTML='<span style=\\'font-size:15px;\\'>' + this.dataset.emoji + '</span>'">`
        : `<span style="font-size:15px;">${esc(emo)}</span>`;
      return `<div class="comment-item">
        <div class="comment-avatar">${av}</div>
        <div class="comment-right">
          <div class="comment-nick">${esc(nick)}</div>
          <div class="comment-body">${esc(cm.body)}</div>
          <div class="comment-time">${relTime(cm.created_at)}</div>
        </div>
      </div>`;
    }).join('');
  }

  document.getElementById('commentInput').addEventListener('keypress', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); submitComment(); }
  });

  async function submitComment() {
    if (!currentPost) return;
    if (!myNickname) { alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”'); return; }
    const body = document.getElementById('commentInput').value.trim();
    if (!body) return;
    const btn = document.getElementById('commentSendBtn');
    btn.disabled = true; btn.textContent = 'ì „ì†¡ì¤‘';
    try {
      const r = await fetch(`${API}/posts/${currentPost.id}/comments`, {
        method:'POST', credentials:'include',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ body, guest_id: guestId }),
      });
      const d = await r.json();
      if (d.ok) {
        document.getElementById('commentInput').value = '';
        const r2 = await fetch(`${API}/posts/${currentPost.id}`);
        const d2 = await r2.json();
        currentComments = d2.comments || [];
        renderDetailComments(currentComments);
        document.getElementById('dStats').textContent = `ğŸ’¬ ëŒ“ê¸€ ${d2.comments?.length||0} Â· ğŸ‘ ì¡°íšŒ ${d2.post?.view_count||0}`;
        tickMission();   // â† ë¯¸ì…˜ ë‹¬ì„± ì²´í¬
      } else { alert(d.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'); }
    } catch { alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'); }
    btn.disabled = false; btn.textContent = 'ì „ì†¡';
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ì´ˆê¸°í™”
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  async function init() {
    await initGuest();
    updateProfileUI();
    try {
      const m = await fetch(apiUrl('/me', true), { credentials:'include' });
      if (m.ok) {
        const md = await m.json();
        if (md.guest?.image_url) {
          document.getElementById('profileAvatar').innerHTML = `<img src="${md.guest.image_url}" alt="í”„ë¡œí•„">`;
        }
        if (md.guest?.nickname && !myNickname) {
          myNickname = md.guest.nickname;
          updateProfileUI();
        }
      }
    } catch {}
    await loadActivity(true);
    renderMissionUI();
    document.getElementById('globalLoader').classList.add('hidden');
  }
  init();
</script>
</body>
</html>
