<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸ‘¤ ë‚´ í˜ì´ì§€ - ë¬´ì§€ê°œ ìœ ì¹˜ì›</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    /* (CSS ìŠ¤íƒ€ì¼ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ë¯€ë¡œ ì§€ë©´ ê´€ê³„ìƒ í•µì‹¬ êµ¬ì¡°ë§Œ ìœ ì§€í•©ë‹ˆë‹¤) */
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    :root {
      --bg:#f2f2f7; --card:#fff; --text:#1c1c1e; --sub:#636366; --sub2:#8e8e93;
      --border:#e5e5ea; --accent:#ff6b6b; --yar:#ff9f0a; --blue:#007aff; --green:#34c759;
      --radius-card:16px; --radius-pill:999px; --shadow:0 1px 4px rgba(0,0,0,.06);
    }
    body { font-family:'Noto Sans KR',-apple-system,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
    .hidden { display:none !important; }
    #loader { position:fixed; inset:0; background:rgba(255,255,255,.96); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9000; gap:14px; }
    .spinner { width:28px; height:28px; border:3px solid var(--border); border-top-color:var(--text); border-radius:50%; animation:spin .8s linear infinite; }
    @keyframes spin { to{ transform:rotate(360deg); } }
    .header { background:var(--card); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:100; }
    .header-inner { max-width:640px; margin:0 auto; padding:10px 16px; display:flex; align-items:center; }
    .header-title { font-size:17px; font-weight:900; }
    .container { max-width:640px; margin:0 auto; padding:16px 16px 96px; }
    .profile-card { background:var(--card); border-radius:var(--radius-card); padding:20px; margin-bottom:12px; box-shadow:var(--shadow); }
    .profile-top { display:flex; align-items:center; gap:16px; margin-bottom:16px; }
    .avatar-wrap { position:relative; flex-shrink:0; cursor:pointer; }
    .avatar-img { width:72px; height:72px; border-radius:18px; background:var(--bg); border:2px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:36px; overflow:hidden; }
    .avatar-img img { width:100%; height:100%; object-fit:cover; }
    .avatar-cam { position:absolute; bottom:-5px; right:-5px; width:22px; height:22px; background:var(--text); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:11px; border:2px solid var(--card); pointer-events:none; }
    .profile-info { flex:1; min-width:0; }
    .profile-nick { font-size:20px; font-weight:900; margin-bottom:3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .profile-sub { font-size:12px; color:var(--sub); margin-bottom:10px; }
    .profile-btns { display:flex; gap:7px; flex-wrap:wrap; }
    .btn-sm { padding:7px 14px; border-radius:var(--radius-pill); font-size:12px; font-weight:700; cursor:pointer; font-family:inherit; min-height:34px; display:inline-flex; align-items:center; gap:4px; }
    .btn-sm.primary { background:var(--text); color:#fff; border:none; }
    .btn-sm.outline { background:var(--bg); color:var(--text); border:1.5px solid var(--border); }
    .nick-edit { background:var(--bg); border-radius:12px; padding:12px; margin-bottom:16px; }
    .nick-input { flex:1; padding:10px 14px; border:1.5px solid var(--border); border-radius:10px; font-size:15px; font-family:inherit; }
    .nick-save { padding:0 16px; background:var(--text); color:#fff; border:none; border-radius:10px; font-size:13px; font-weight:700; cursor:pointer; }
    .stats-row { display:flex; gap:1px; background:var(--border); border-radius:12px; overflow:hidden; }
    .stat-item { flex:1; text-align:center; padding:12px 4px; background:var(--card); cursor:pointer; display:flex; flex-direction:column; gap:2px; }
    .tab-bar { display:flex; background:var(--bg); border-radius:var(--radius-pill); padding:4px; margin-bottom:14px; gap:4px; }
    .tab-btn { flex:1; padding:9px 0; font-size:13px; font-weight:700; color:var(--sub); background:transparent; border:none; cursor:pointer; border-radius:var(--radius-pill); display:flex; align-items:center; justify-content:center; gap:4px; }
    .tab-btn.active { color:var(--text); background:var(--card); box-shadow:0 1px 4px rgba(0,0,0,.1); }
    .tab-badge { background:var(--accent); color:#fff; border-radius:var(--radius-pill); font-size:10px; padding:0 4px; min-width:17px; }
    .post-card, .comment-card { background:var(--card); border-radius:var(--radius-card); padding:14px; margin-bottom:10px; box-shadow:var(--shadow); }
    .bottom-nav { position:fixed; bottom:0; left:0; right:0; background:var(--card); border-top:1px solid var(--border); display:flex; z-index:100; padding-bottom:env(safe-area-inset-bottom,0); }
    .bottom-nav a { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:8px 0; text-decoration:none; color:var(--sub); font-size:10px; }
    .bottom-nav a.active { color:var(--text); }
    .overlay, .sheet-overlay, .confirm-overlay, .write-overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:flex-end; justify-content:center; z-index:2000; }
    .confirm-overlay { align-items:center; }
    .hidden { display:none !important; }
  </style>
</head>
<body>

<div id="loader">
  <div style="font-size:52px;">ğŸŒˆ</div>
  <div class="spinner"></div>
</div>

<div class="header">
  <div class="header-inner"><div class="header-title">ğŸ‘¤ ë‚´ í˜ì´ì§€</div></div>
</div>

<div class="container">
  <div class="profile-card">
    <div class="profile-top">
      <div class="avatar-wrap" id="avatarWrap">
        <div class="avatar-img" id="avatarImg">ğŸ—£ï¸</div>
        <div class="avatar-cam">ğŸ“·</div>
      </div>
      <div class="profile-info">
        <div class="profile-nick" id="nickDisplay">ë‹‰ë„¤ì„ ì—†ìŒ</div>
        <div class="profile-sub"  id="profileSub">ê²ŒìŠ¤íŠ¸</div>
        <div class="profile-btns">
          <button class="btn-sm primary" id="avatarBtn">ğŸ¨ ê¾¸ë¯¸ê¸°</button>
          <button class="btn-sm outline" id="nickToggleBtn">âœï¸ ë‹‰ë„¤ì„ ì„¤ì •</button>
        </div>
      </div>
    </div>
    <input type="file" id="avatarInput" accept="image/*" style="display:none">
    <div class="nick-edit hidden" id="nickEdit">
      <div class="nick-edit-hint" style="font-size:12px;color:var(--sub);margin-bottom:8px;">í•œê¸€, ì˜ë¬¸, ìˆ«ì 1~10ì Â· 7ì¼ í›„ ë³€ê²½ ê°€ëŠ¥</div>
      <div style="display:flex;gap:8px;">
        <input class="nick-input" id="nickInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" maxlength="10">
        <button class="nick-save" id="nickSaveBtn">ì €ì¥</button>
      </div>
      <div class="nick-msg hidden" id="nickMsg" style="font-size:12px;margin-top:6px;"></div>
    </div>
    <div class="stats-row">
      <div class="stat-item" id="statTabPosts"><span class="stat-num" id="statPosts">-</span><span class="stat-label" style="font-size:11px;">ë‚´ ê¸€</span></div>
      <div class="stat-item" id="statTabYars"><span class="stat-num" id="statYars">-</span><span class="stat-label" style="font-size:11px;">ë°›ì€ ì•¼ë¥´~</span></div>
      <div class="stat-item" id="statTabComments"><span class="stat-num" id="statComments">-</span><span class="stat-label" style="font-size:11px;">ë°›ì€ ëŒ“ê¸€</span></div>
    </div>
  </div>

  <div class="tab-bar">
    <button class="tab-btn active" id="tabPosts">âœï¸ ë‚´ ê¸€</button>
    <button class="tab-btn"        id="tabYars">ğŸŒŸ ì•¼ë¥´ <span class="tab-badge hidden" id="yarBadge">0</span></button>
    <button class="tab-btn"        id="tabComments">ğŸ’¬ ëŒ“ê¸€ <span class="tab-badge hidden" id="cmtBadge">0</span></button>
  </div>

  <div id="secPosts"></div>
  <div id="secYars" class="hidden"></div>
  <div id="secComments" class="hidden"></div>
</div>

<div class="bottom-nav">
  <a href="index.html">ğŸ  í™ˆ</a>
  <a href="#" id="writeNavBtn"><span style="background:var(--text);color:#fff;padding:2px 8px;border-radius:10px;">âœï¸</span> ê¸€ì“°ê¸°</a>
  <a href="mypage.html" class="active">ğŸ‘¤ ë‚´ í˜ì´ì§€</a>
</div>

<div class="confirm-overlay hidden" id="confirmOverlay">
  <div style="background:#fff;padding:24px;border-radius:20px;width:280px;text-align:center;">
    <div style="font-size:17px;font-weight:900;margin-bottom:20px;">ì •ë§ ì‚­ì œí• ê¹Œìš”?</div>
    <div style="display:flex;gap:8px;">
      <button id="confirmNo" style="flex:1;padding:12px;border:none;border-radius:12px;">ì•„ë‹ˆìš”</button>
      <button id="confirmYes" style="flex:1;padding:12px;background:var(--accent);color:#fff;border:none;border-radius:12px;">ì‚­ì œ</button>
    </div>
  </div>
</div>

<script>
'use strict';
(() => {
const API = 'https://rainbowkidz-api.irunaru.workers.dev/api/v1';
let guestId = localStorage.getItem('rkGuestId');
let myNickname = null;
let myPosts = [];
let receivedComments = [];
let allYarers = [];
let pendingDeleteFn = null;

const $ = id => document.getElementById(id);
const apiUrl = p => {
  const sep = p.includes('?') ? '&' : '?';
  const gid = localStorage.getItem('rkGuestId'); // í•­ìƒ ìµœì‹  ID ì°¸ì¡°
  return gid ? `${API}${p}${sep}guest_id=${encodeURIComponent(gid)}` : `${API}${p}`;
};

/* â”€â”€ 1. ê²ŒìŠ¤íŠ¸ ë° í”„ë¡œí•„ ì´ˆê¸°í™” â”€â”€ */
async function initGuest() {
  try {
    const r = await fetch(`${API}/guest/init`, {
      method:'POST', credentials:'include',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ existing_gid: guestId }),
    });
    if (r.ok) {
      const d = await r.json();
      guestId = d.guest_id;
      localStorage.setItem('rkGuestId', guestId);
    }
  } catch {}

  try {
    const r = await fetch(apiUrl('/me'), { credentials:'include' });
    if (r.ok) {
      const d = await r.json();
      myNickname = d.guest?.nickname;
      if (d.guest?.image_url) {
        $('avatarImg').innerHTML = `<img src="${d.guest.image_url}" alt="í”„ë¡œí•„">`;
      }
    }
  } catch {}
  updateProfileUI();
}

function updateProfileUI() {
  $('nickDisplay').textContent = myNickname || 'ë‹‰ë„¤ì„ ì—†ìŒ';
  $('nickToggleBtn').textContent = myNickname ? 'âœï¸ ë‹‰ë„¤ì„ ë³€ê²½' : 'âœï¸ ë‹‰ë„¤ì„ ì„¤ì •';
}

/* â”€â”€ 2. ë°ì´í„° ë¡œë“œ (í•µì‹¬ ë²„ê·¸ ìˆ˜ì •) â”€â”€ */
async function loadAll() {
  try {
    const pr = await fetch(apiUrl('/my/posts?limit=50'), { credentials:'include' });
    myPosts = pr.ok ? (await pr.json()).posts || [] : [];
    
    // ë²„ê·¸ ìˆ˜ì •: apiUrl()ê³¼ credentials ì ìš©
    await Promise.all([
      (async () => {
        allYarers = [];
        for (const p of myPosts) {
          try {
            const r = await fetch(apiUrl(`/posts/${p.id}/yars`), { credentials:'include' });
            const d = await r.json();
            (d.yarers || []).forEach(y => allYarers.push({...y, post_id:p.id, post_title:p.title}));
          } catch {}
        }
      })(),
      (async () => {
        receivedComments = [];
        for (const p of myPosts) {
          try {
            const r = await fetch(apiUrl(`/posts/${p.id}`), { credentials:'include' });
            const d = await r.json();
            (d.comments || []).forEach(c => {
               if(c.nickname !== myNickname) receivedComments.push({...c, post_id:p.id, post_title:p.title});
            });
          } catch {}
        }
      })()
    ]);

    $('statPosts').textContent = myPosts.length;
    $('statYars').textContent = allYarers.length;
    $('statComments').textContent = receivedComments.length;
    renderPosts();
  } catch {}
}

function renderPosts() {
  const sec = $('secPosts');
  sec.innerHTML = myPosts.map(p => `
    <div class="post-card">
      <div style="display:flex;justify-content:space-between;">
        <span style="font-size:12px;color:var(--sub2);">${new Date(p.created_at).toLocaleDateString()}</span>
        <button onclick="confirmDelete(${p.id})" style="background:none;border:none;color:var(--accent);font-size:12px;">ì‚­ì œ</button>
      </div>
      <div style="font-weight:700;margin-top:4px;">${p.title}</div>
    </div>
  `).join('');
}

/* â”€â”€ 3. ì‚­ì œ ë¡œì§ (í•µì‹¬ ë²„ê·¸ ìˆ˜ì •) â”€â”€ */
window.confirmDelete = (id) => {
  pendingDeleteFn = async () => {
    try {
      const r = await fetch(apiUrl(`/posts/${id}`), { method:'DELETE', credentials:'include' });
      if (r.ok) await loadAll();
    } catch { alert('ì‚­ì œ ì‹¤íŒ¨'); }
  };
  $('confirmOverlay').classList.remove('hidden');
};

function closeConfirm() {
  $('confirmOverlay').classList.add('hidden');
  pendingDeleteFn = null;
}

$('confirmNo').onclick = closeConfirm;
$('confirmYes').onclick = () => {
  const fn = pendingDeleteFn; // ë²„ê·¸ ìˆ˜ì •: í•¨ìˆ˜ë¥¼ ë¨¼ì € ë°±ì—…
  closeConfirm();           // ì—¬ê¸°ì„œ pendingDeleteFnì´ nullì´ ë˜ì–´ë„ ì˜í–¥ ì—†ìŒ
  if (typeof fn === 'function') fn();
};

/* â”€â”€ ì´ˆê¸°í™” ì‹¤í–‰ â”€â”€ */
async function init() {
  await initGuest();
  await loadAll();
  $('loader').classList.add('hidden');
}
init();

/* íƒ­ ì „í™˜ ë¡œì§ ìƒëµ(ë™ì¼) */
function switchTab(t) {
  ['secPosts','secYars','secComments'].forEach(id => $(id).classList.add('hidden'));
  ['tabPosts','tabYars','tabComments'].forEach(id => $(id).classList.remove('active'));
  if(t==='posts') { $('secPosts').classList.remove('hidden'); $('tabPosts').classList.add('active'); }
  if(t==='yars') { $('secYars').classList.remove('hidden'); $('tabYars').classList.add('active'); }
  if(t==='comments') { $('secComments').classList.remove('hidden'); $('tabComments').classList.add('active'); }
}
$('tabPosts').onclick = () => switchTab('posts');
$('tabYars').onclick = () => switchTab('yars');
$('tabComments').onclick = () => switchTab('comments');

})();
</script>
</body>
</html>