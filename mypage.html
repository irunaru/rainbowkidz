<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸ‘¤ ë‚´ í˜ì´ì§€ - ë¬´ì§€ê°œ ìœ ì¹˜ì›</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    :root {
      --bg:#f2f2f7; --card:#fff; --text:#1c1c1e; --sub:#636366; --sub2:#8e8e93;
      --border:#e5e5ea; --accent:#ff6b6b; --yar:#ff9f0a; --blue:#007aff; --green:#34c759;
      --radius-card:16px; --radius-pill:999px; --shadow:0 1px 4px rgba(0,0,0,.06);
    }
    body { font-family:'Noto Sans KR',-apple-system,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
    .hidden { display:none !important; }

    #loader { position:fixed; inset:0; background:rgba(255,255,255,.96); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9000; gap:14px; }
    .spinner { width:28px; height:28px; border:3px solid var(--border); border-top-color:var(--text); border-radius:50%; animation:spin .8s linear infinite; }
    @keyframes spin    { to{ transform:rotate(360deg); } }
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    .skel { border-radius:var(--radius-card); background:linear-gradient(90deg,#f0f0f0 25%,#e8e8e8 50%,#f0f0f0 75%); background-size:200% 100%; animation:shimmer 1.3s ease-in-out infinite; }

    .header { background:var(--card); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:100; }
    .header-inner { max-width:640px; margin:0 auto; padding:10px 16px; display:flex; align-items:center; }
    .header-title { font-size:17px; font-weight:900; }

    .container { max-width:640px; margin:0 auto; padding:16px 16px 96px; }

    .profile-card { background:var(--card); border-radius:var(--radius-card); padding:20px; margin-bottom:12px; box-shadow:var(--shadow); }
    .profile-top { display:flex; align-items:center; gap:16px; margin-bottom:16px; }
    .avatar-wrap { position:relative; flex-shrink:0; cursor:pointer; }
    .avatar-img { width:72px; height:72px; border-radius:18px; background:var(--bg); border:2px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:36px; overflow:hidden; }
    .avatar-img img { width:100%; height:100%; object-fit:cover; }
    .avatar-cam { position:absolute; bottom:-5px; right:-5px; width:22px; height:22px; background:var(--text); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:11px; border:2px solid var(--card); pointer-events:none; }
    .profile-info { flex:1; min-width:0; }
    .profile-nick { font-size:20px; font-weight:900; margin-bottom:3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .profile-sub  { font-size:12px; color:var(--sub); margin-bottom:10px; }
    .profile-btns { display:flex; gap:7px; flex-wrap:wrap; }
    .btn-sm { padding:7px 14px; border-radius:var(--radius-pill); font-size:12px; font-weight:700; cursor:pointer; font-family:inherit; min-height:34px; display:inline-flex; align-items:center; gap:4px; white-space:nowrap; }
    .btn-sm.primary { background:var(--text); color:#fff; border:none; }
    .btn-sm.outline { background:var(--bg); color:var(--text); border:1.5px solid var(--border); }
    .btn-sm:active  { opacity:.75; }

    .nick-edit { background:var(--bg); border-radius:12px; padding:12px; margin-bottom:16px; }
    .nick-edit-hint { font-size:12px; color:var(--sub); margin-bottom:8px; line-height:1.5; }
    .nick-edit-row  { display:flex; gap:8px; }
    .nick-input { flex:1; padding:10px 14px; border:1.5px solid var(--border); border-radius:10px; font-size:15px; font-family:inherit; min-height:44px; }
    .nick-input:focus { outline:none; border-color:var(--text); }
    .nick-save { padding:0 16px; background:var(--text); color:#fff; border:none; border-radius:10px; font-size:13px; font-weight:700; cursor:pointer; font-family:inherit; min-height:44px; white-space:nowrap; }
    .nick-save:disabled { opacity:.5; }
    .nick-msg { font-size:12px; margin-top:6px; min-height:16px; }
    .nick-msg.err  { color:var(--accent); }
    .nick-msg.cool { color:var(--sub); }

    .stats-row { display:flex; gap:1px; background:var(--border); border-radius:12px; overflow:hidden; }
    .stat-item { flex:1; text-align:center; padding:12px 4px; background:var(--card); cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:2px; transition:background .15s; }
    .stat-item:active { background:var(--bg); }
    .stat-num   { font-size:18px; font-weight:900; }
    .stat-label { font-size:11px; color:var(--sub); font-weight:600; }

    .tab-bar { display:flex; background:var(--bg); border-radius:var(--radius-pill); padding:4px; margin-bottom:14px; gap:4px; }
    .tab-btn { flex:1; padding:9px 0; font-size:13px; font-weight:700; color:var(--sub); background:transparent; border:none; cursor:pointer; font-family:inherit; border-radius:var(--radius-pill); transition:background .15s, color .15s; min-height:42px; display:flex; align-items:center; justify-content:center; gap:4px; }
    .tab-btn.active { color:var(--text); background:var(--card); box-shadow:0 1px 4px rgba(0,0,0,.1); }
    .tab-badge { display:inline-flex; align-items:center; justify-content:center; background:var(--accent); color:#fff; border-radius:var(--radius-pill); font-size:10px; font-weight:700; min-width:17px; height:17px; padding:0 4px; }

    .post-card { background:var(--card); border-radius:var(--radius-card); padding:14px; margin-bottom:10px; box-shadow:var(--shadow); }
    .post-card-head { display:flex; align-items:center; gap:6px; margin-bottom:8px; }
    .post-ts    { font-size:11px; color:var(--sub2); }
    .more-btn   { margin-left:auto; width:44px; height:44px; display:flex; align-items:center; justify-content:center; background:none; border:none; cursor:pointer; font-size:20px; color:var(--sub2); border-radius:50%; flex-shrink:0; }
    .more-btn:active { background:var(--bg); }
    .post-title { font-size:15px; font-weight:700; line-height:1.4; margin-bottom:4px; cursor:pointer; }
    .post-title:active { opacity:.75; }
    .post-body  { font-size:13px; color:var(--sub); line-height:1.5; margin-bottom:8px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .post-meta  { display:flex; gap:10px; font-size:12px; color:var(--sub); }

    .comment-card { background:var(--card); border-radius:var(--radius-card); padding:14px; margin-bottom:10px; box-shadow:var(--shadow); }
    .comment-card-head { display:flex; align-items:center; gap:6px; margin-bottom:6px; }
    .comment-origin { font-size:12px; color:var(--blue); font-weight:700; cursor:pointer; display:inline-block; margin-bottom:6px; }
    .comment-origin:active { opacity:.75; }
    .comment-body-text { font-size:14px; line-height:1.5; }
    .comment-author-nick { font-size:13px; font-weight:700; margin-bottom:4px; display:block; color:var(--sub); }

    .yar-card { background:var(--card); border-radius:var(--radius-card); padding:4px 14px; margin-bottom:10px; box-shadow:var(--shadow); }
    .yar-item  { display:flex; align-items:center; gap:10px; padding:12px 0; border-bottom:1px solid var(--border); cursor:pointer; min-height:50px; }
    .yar-item:last-child { border-bottom:none; }
    .yar-item:active { opacity:.75; }
    .yar-icon  { width:38px; height:38px; border-radius:10px; background:#fff3cd; display:flex; align-items:center; justify-content:center; font-size:20px; flex-shrink:0; }
    .yar-info  { flex:1; min-width:0; }
    .yar-nick  { font-size:14px; font-weight:700; }
    .yar-post  { font-size:12px; color:var(--sub); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .yar-time  { font-size:11px; color:var(--sub2); flex-shrink:0; white-space:nowrap; }

    .empty { text-align:center; padding:48px 20px; }
    .empty-icon { font-size:44px; margin-bottom:12px; }
    .empty-text { font-size:15px; font-weight:700; margin-bottom:4px; }
    .empty-sub  { font-size:13px; color:var(--sub); }

    .bottom-nav { position:fixed; bottom:0; left:0; right:0; background:var(--card); border-top:1px solid var(--border); display:flex; z-index:100; padding-bottom:env(safe-area-inset-bottom,0); }
    .bottom-nav a { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:8px 0 6px; text-decoration:none; color:var(--sub); font-size:10px; font-weight:600; gap:2px; min-height:50px; }
    .bottom-nav a.active { color:var(--text); }
    .nav-icon { font-size:22px; }

    .sheet-overlay { position:fixed; inset:0; background:rgba(0,0,0,.4); z-index:4000; display:flex; align-items:flex-end; justify-content:center; }
    .sheet-overlay.hidden { display:none; }
    .sheet-panel   { width:100%; max-width:640px; background:var(--card); border-radius:20px 20px 0 0; padding-bottom:env(safe-area-inset-bottom,12px); overflow:hidden; }
    .sheet-handle  { width:36px; height:4px; background:var(--border); border-radius:2px; margin:12px auto 8px; }
    .sheet-label   { font-size:12px; color:var(--sub2); text-align:center; padding:0 16px 10px; border-bottom:1px solid var(--border); }
    .sheet-btn     { width:100%; padding:0 24px; text-align:left; font-size:16px; font-weight:700; font-family:inherit; background:none; border:none; cursor:pointer; display:flex; align-items:center; gap:12px; color:var(--text); min-height:54px; }
    .sheet-btn:active { background:var(--bg); }
    .sheet-btn.danger { color:var(--accent); }
    .sheet-sep     { height:1px; background:var(--border); margin:0 16px; }
    .sheet-cancel  { width:100%; padding:0 24px; text-align:center; font-size:16px; font-weight:700; font-family:inherit; background:none; border:none; cursor:pointer; color:var(--sub); min-height:54px; }
    .sheet-cancel:active { background:var(--bg); }

    .confirm-overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:5000; display:flex; align-items:center; justify-content:center; padding:24px; }
    .confirm-overlay.hidden { display:none; }
    .confirm-box   { background:var(--card); border-radius:20px; padding:24px; width:100%; max-width:300px; text-align:center; }
    .confirm-icon  { font-size:36px; margin-bottom:10px; }
    .confirm-title { font-size:17px; font-weight:900; margin-bottom:6px; }
    .confirm-sub   { font-size:13px; color:var(--sub); margin-bottom:20px; line-height:1.5; }
    .confirm-btns  { display:flex; gap:8px; }
    .confirm-no    { flex:1; padding:13px; border:1.5px solid var(--border); border-radius:12px; font-size:15px; font-weight:700; cursor:pointer; font-family:inherit; background:var(--bg); min-height:48px; }
    .confirm-yes   { flex:1; padding:13px; border:none; border-radius:12px; font-size:15px; font-weight:700; cursor:pointer; font-family:inherit; background:var(--accent); color:#fff; min-height:48px; }

    .write-overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:flex-end; justify-content:center; z-index:3000; }
    .write-overlay.hidden { display:none; }
    .write-panel   { width:100%; max-width:640px; background:var(--card); border-radius:20px 20px 0 0; }
    .write-handle  { width:36px; height:4px; background:var(--border); border-radius:2px; margin:10px auto; }
    .write-head    { padding:0 16px 12px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border); }
    .write-head-title { font-size:17px; font-weight:900; }
    .write-close   { padding:7px 14px; border:1px solid var(--border); border-radius:var(--radius-pill); background:var(--bg); font-size:12px; cursor:pointer; font-family:inherit; min-height:36px; }
    .write-body    { padding:16px; }
    .write-input   { width:100%; padding:12px; border:1.5px solid var(--border); border-radius:12px; font-size:15px; font-family:inherit; margin-bottom:10px; min-height:44px; }
    .write-input:focus { outline:none; border-color:var(--text); }
    .write-textarea{ width:100%; padding:12px; border:1.5px solid var(--border); border-radius:12px; font-size:14px; font-family:inherit; min-height:120px; resize:none; line-height:1.6; }
    .write-textarea:focus { outline:none; border-color:var(--text); }
    .write-error   { font-size:12px; color:var(--accent); min-height:16px; padding:0 16px 8px; }
    .write-footer  { display:flex; padding:12px 16px; border-top:1px solid var(--border); padding-bottom:calc(12px + env(safe-area-inset-bottom,0)); }
    .write-submit  { flex:1; padding:13px; background:var(--text); color:#fff; border:none; border-radius:12px; font-size:15px; font-weight:700; cursor:pointer; font-family:inherit; min-height:48px; }
    .write-submit:disabled { opacity:.5; }

    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:flex-end; justify-content:center; z-index:2000; }
    .overlay.hidden { display:none; }
    .detail-panel  { width:100%; max-width:640px; background:var(--card); border-radius:20px 20px 0 0; max-height:90vh; display:flex; flex-direction:column; }
    .detail-handle { width:36px; height:4px; background:var(--border); border-radius:2px; margin:10px auto 0; flex-shrink:0; }
    .detail-head   { padding:12px 16px 10px; border-bottom:1px solid var(--border); flex-shrink:0; }
    .detail-title  { font-size:17px; font-weight:900; margin-bottom:6px; }
    .detail-meta   { font-size:12px; color:var(--sub); display:flex; gap:8px; flex-wrap:wrap; }
    .detail-meta-author { font-weight:700; color:var(--text); }
    .detail-scroll { flex:1; overflow-y:auto; }
    .detail-body   { padding:14px 16px; font-size:14px; line-height:1.7; border-bottom:1px solid var(--border); white-space:pre-wrap; }
    .detail-body a { color:var(--blue); text-decoration:underline; word-break:break-all; }
    .detail-media  { padding:0 16px 12px; }
    .detail-media img   { width:100%; border-radius:12px; display:block; margin-bottom:8px; max-height:400px; object-fit:cover; }
    .detail-media video { width:100%; border-radius:12px; display:block; margin-bottom:8px; }
    .detail-media audio { width:100%; border-radius:12px; display:block; margin-bottom:8px; }
    .detail-footer { padding:10px 16px; display:flex; align-items:center; gap:10px; border-bottom:1px solid var(--border); flex-shrink:0; }
    .detail-stat   { font-size:13px; color:var(--sub); }
    .detail-yar    { margin-left:auto; display:flex; align-items:center; gap:4px; padding:7px 14px; border-radius:var(--radius-pill); border:1.5px solid var(--border); background:var(--bg); font-size:13px; font-weight:700; cursor:pointer; font-family:inherit; color:var(--sub); min-height:44px; }
    .detail-yar.on { border-color:var(--yar); color:var(--yar); background:#fff9ee; }
    .detail-close  { padding:7px 14px; border:1px solid var(--border); border-radius:var(--radius-pill); background:var(--bg); font-size:12px; cursor:pointer; font-family:inherit; min-height:44px; }
    .comments-wrap { padding:0 16px 10px; }
    .ctab     { padding:5px 12px; border-radius:var(--radius-pill); border:1.5px solid var(--border); background:var(--bg); color:var(--sub); font-size:11px; font-weight:700; cursor:pointer; font-family:inherit; min-height:36px; }
    .ctab.on  { border-color:var(--text); background:var(--text); color:#fff; }
    .cmt-item { padding:10px 0; border-bottom:1px solid var(--border); display:flex; gap:8px; }
    .cmt-item:last-child { border-bottom:none; }
    .cmt-avatar { width:30px; height:30px; border-radius:8px; background:var(--bg); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:15px; flex-shrink:0; overflow:hidden; }
    .cmt-avatar img { width:100%; height:100%; object-fit:cover; }
    .cmt-right  { flex:1; min-width:0; }
    .cmt-nick   { font-size:12px; font-weight:700; }
    .cmt-body   { font-size:13px; line-height:1.5; margin-top:3px; }
    .cmt-time   { font-size:11px; color:var(--sub2); margin-top:2px; }
    .cmt-form   { flex-shrink:0; background:var(--card); border-top:1px solid var(--border); padding:10px 16px; display:flex; gap:8px; padding-bottom:calc(10px + env(safe-area-inset-bottom,0)); }
    .cmt-input  { flex:1; padding:10px 14px; border:1.5px solid var(--border); border-radius:var(--radius-pill); font-size:14px; font-family:inherit; min-height:44px; }
    .cmt-input:focus { outline:none; border-color:var(--text); }
    .cmt-send   { padding:10px 18px; background:var(--text); color:#fff; border:none; border-radius:var(--radius-pill); font-size:13px; font-weight:700; cursor:pointer; font-family:inherit; min-height:44px; }
    .cmt-send:disabled { opacity:.5; }
  </style>
</head>
<body>

<div id="loader">
  <div style="font-size:52px;">ğŸŒˆ</div>
  <div class="spinner"></div>
  <div style="font-size:14px;color:var(--sub);">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<div class="header">
  <div class="header-inner">
    <div class="header-title">ğŸ‘¤ ë‚´ í˜ì´ì§€</div>
  </div>
</div>

<div class="container">
  <div class="profile-card">
    <div class="profile-top">
      <div class="avatar-wrap" id="avatarWrap">
        <div class="avatar-img" id="avatarImg">ğŸ—£ï¸</div>
        <div class="avatar-cam">ğŸ“·</div>
      </div>
      <div class="profile-info">
        <div class="profile-nick" id="nickDisplay">ë‹‰ë„¤ì„ ì—†ìŒ</div>
        <div class="profile-sub"  id="profileSub">ê²ŒìŠ¤íŠ¸</div>
        <div class="profile-btns">
          <button class="btn-sm primary" id="avatarBtn">ğŸ¨ ê¾¸ë¯¸ê¸°</button>
          <button class="btn-sm outline" id="nickToggleBtn">âœï¸ ë‹‰ë„¤ì„ ì„¤ì •</button>
        </div>
      </div>
    </div>
    <input type="file" id="avatarInput" accept="image/*" style="display:none">

    <div class="nick-edit hidden" id="nickEdit">
      <div class="nick-edit-hint">í•œê¸€, ì˜ë¬¸, ìˆ«ì 1~10ì Â· 7ì¼ í›„ ë³€ê²½ ê°€ëŠ¥</div>
      <div class="nick-edit-row">
        <input class="nick-input" id="nickInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" maxlength="10" autocomplete="off">
        <button class="nick-save" id="nickSaveBtn">ì €ì¥</button>
      </div>
      <div class="nick-msg hidden" id="nickMsg"></div>
    </div>

    <div class="stats-row">
      <div class="stat-item" id="statTabPosts">
        <span class="stat-num" id="statPosts">-</span>
        <span class="stat-label">ë‚´ ê¸€</span>
      </div>
      <div class="stat-item" id="statTabYars">
        <span class="stat-num" id="statYars">-</span>
        <span class="stat-label">ë°›ì€ ì•¼ë¥´~</span>
      </div>
      <div class="stat-item" id="statTabComments">
        <span class="stat-num" id="statComments">-</span>
        <span class="stat-label">ë°›ì€ ëŒ“ê¸€</span>
      </div>
    </div>
  </div>

  <div class="tab-bar">
    <button class="tab-btn active" id="tabPosts">âœï¸ ë‚´ ê¸€</button>
    <button class="tab-btn"        id="tabYars">
      ğŸŒŸ ë°›ì€ ì•¼ë¥´~
      <span class="tab-badge hidden" id="yarBadge">0</span>
    </button>
    <button class="tab-btn"        id="tabComments">
      ğŸ’¬ ë°›ì€ ëŒ“ê¸€
      <span class="tab-badge hidden" id="cmtBadge">0</span>
    </button>
  </div>

  <div id="secPosts">
    <div class="skel" style="height:90px;margin-bottom:10px;"></div>
    <div class="skel" style="height:90px;margin-bottom:10px;"></div>
    <div class="skel" style="height:90px;margin-bottom:10px;"></div>
  </div>
  <div id="secYars"     class="hidden"></div>
  <div id="secComments" class="hidden"></div>
</div>

<div class="bottom-nav">
  <a href="index.html"><span class="nav-icon">ğŸ </span>í™ˆ</a>
  <a href="#" id="writeNavBtn">
    <span style="width:42px;height:28px;background:var(--text);border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:18px;">âœï¸</span>
    ê¸€ì“°ê¸°
  </a>
  <a href="mypage.html" class="active"><span class="nav-icon">ğŸ‘¤</span>ë‚´ í˜ì´ì§€</a>
</div>

<div class="sheet-overlay hidden" id="sheetOverlay">
  <div class="sheet-panel">
    <div class="sheet-handle"></div>
    <div class="sheet-label" id="sheetLabel"></div>
    <button class="sheet-btn" id="sheetEditBtn">âœï¸ ìˆ˜ì •</button>
    <div class="sheet-sep"></div>
    <button class="sheet-btn danger" id="sheetDeleteBtn">ğŸ—‘ ì‚­ì œ</button>
    <div class="sheet-sep"></div>
    <button class="sheet-cancel" id="sheetCancelBtn">ì·¨ì†Œ</button>
  </div>
</div>

<div class="confirm-overlay hidden" id="confirmOverlay">
  <div class="confirm-box">
    <div class="confirm-icon">ğŸ¥º</div>
    <div class="confirm-title">ì •ë§ ì‚­ì œí• ê¹Œìš”?</div>
    <div class="confirm-sub">ì‚­ì œí•˜ë©´ ë˜ëŒë¦´ ìˆ˜ ì—†ì–´ìš”.<br>ê·¸ë˜ë„ ì§€ìš¸ê¹Œìš”?</div>
    <div class="confirm-btns">
      <button class="confirm-no"  id="confirmNo">ì•„ë‹ˆìš”</button>
      <button class="confirm-yes" id="confirmYes">ë„¤, ì‚­ì œí• ê²Œìš”</button>
    </div>
  </div>
</div>

<div class="write-overlay hidden" id="writeOverlay">
  <div class="write-panel">
    <div class="write-handle"></div>
    <div class="write-head">
      <div class="write-head-title">âœï¸ ì´ì•¼ê¸° ì“°ê¸°</div>
      <button class="write-close" id="writeCloseBtn">âœ• ë‹«ê¸°</button>
    </div>
    <div class="write-body">
      <input    class="write-input"    id="writeTitle" placeholder="ì œëª© (2~80ì)"              maxlength="80">
      <textarea class="write-textarea" id="writeBody"  placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”... (5ì ì´ìƒ)" maxlength="5000"></textarea>
    </div>
    <div class="write-error" id="writeError"></div>
    <div class="write-footer">
      <button class="write-submit" id="writeSubmitBtn">ê²Œì‹œí•˜ê¸°</button>
    </div>
  </div>
</div>

<div class="overlay hidden" id="detailOverlay">
  <div class="detail-panel" onclick="event.stopPropagation()">
    <div class="detail-handle"></div>
    <div class="detail-head">
      <div class="detail-title" id="dTitle"></div>
      <div class="detail-meta">
        <span class="detail-meta-author" id="dAuthor"></span>
        <span id="dTime"></span>
      </div>
    </div>
    <div class="detail-scroll">
      <div class="detail-body"  id="dBody"></div>
      <div class="detail-media" id="dMedia"></div>
      <div class="detail-footer">
        <span class="detail-stat" id="dStats"></span>
        <button class="detail-yar"   id="dYarBtn">ğŸŒŸ ì•¼ë¥´~</button>
        <button class="detail-close" id="dCloseBtn">âœ• ë‹«ê¸°</button>
      </div>
      <div class="comments-wrap">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0 6px;">
          <span style="font-size:13px;font-weight:700;color:var(--sub);">ëŒ“ê¸€</span>
          <div style="display:flex;gap:6px;">
            <button class="ctab on" id="cLatest">ìµœì‹ ìˆœ</button>
            <button class="ctab"    id="cPopular">ì¸ê¸°ìˆœ</button>
          </div>
        </div>
        <div id="dComments"></div>
      </div>
    </div>
    <div class="cmt-form">
      <input  class="cmt-input" id="cmtInput"   placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." maxlength="500">
      <button class="cmt-send"  id="cmtSendBtn">ì „ì†¡</button>
    </div>
  </div>
</div>

<script>
'use strict';
(() => {

const API = 'https://rainbowkidz-api.irunaru.workers.dev/api/v1';

let guestId         = null;
let myNickname      = null;
let myJoinedAt      = null;
let myPosts         = [];
let receivedComments = []; // (SNS ì „í™˜) ë‚´ ëŒ“ê¸€ ëŒ€ì‹  ë‚´ ê¸€ì— ë‹¬ë¦° ëŒ“ê¸€ ë³´ê´€
let currentTab      = 'posts';
let allYarers       = [];
let currentPost     = null;
let currentComments = [];
let commentSort     = 'latest';
let pendingDeleteFn = null;
let sheetType       = null;
let sheetId         = null;

const $ = id => document.getElementById(id);
const esc = s => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const relTime = d => {
  const s = (Date.now() - new Date(d)) / 1000;
  if (s < 60)     return 'ë°©ê¸ˆ';
  if (s < 3600)   return `${Math.floor(s/60)}ë¶„ ì „`;
  if (s < 86400)  return `${Math.floor(s/3600)}ì‹œê°„ ì „`;
  if (s < 604800) return `${Math.floor(s/86400)}ì¼ ì „`;
  return new Date(d).toLocaleDateString('ko-KR',{month:'long',day:'numeric'});
};
const joinDate = d => new Date(d).toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric'});

// ë²„ê·¸ìˆ˜ì • 2: apiUrl í—¬í¼ë¥¼ ëª¨ë“  fetch í˜¸ì¶œì—ì„œ ì•ˆì „í•˜ê²Œ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •
const apiUrl = p => {
  const sep = p.includes('?') ? '&' : '?';
  return guestId ? `${API}${p}${sep}guest_id=${encodeURIComponent(guestId)}` : `${API}${p}`;
};

const getYar = id => localStorage.getItem(`rkYar_${id}`) === '1';
const setYar = (id, v) => localStorage.setItem(`rkYar_${id}`, v ? '1' : '0');

function detectMedia(url) {
  if (!url) return null;
  const u = url.toLowerCase().split('?')[0];
  if (/\.(jpg|jpeg|png|gif|webp|avif|svg)$/.test(u)) return 'image';
  if (/\.(mp4|webm|mov)$/.test(u))                    return 'video';
  if (/\.(mp3|wav|ogg|m4a|aac)$/.test(u))             return 'audio';
  if (/youtube\.com|youtu\.be/.test(url))              return 'youtube';
  return 'link';
}
function linkify(t) {
  return esc(t).replace(/(https?:\/\/[^\s&<>"]+)/g,'<a href="$1" target="_blank" rel="noopener">$1</a>');
}

/* â”€â”€ ê²ŒìŠ¤íŠ¸ ì´ˆê¸°í™” â”€â”€ */
async function initGuest() {
  try {
    const r = await fetch(`${API}/guest/init`, {
      method:'POST', credentials:'include',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ existing_gid: localStorage.getItem('rkGuestId') || null }),
    });
    if (r.ok) {
      const d = await r.json();
      guestId = d.guest_id;
      if (guestId) localStorage.setItem('rkGuestId', guestId);
    }
  } catch {}
  
  // ë²„ê·¸ìˆ˜ì • 3: í”„ë¡œí•„ ì´ë¯¸ì§€ ìœ ì§€ë¥¼ ìœ„í•´ /me í˜¸ì¶œ ì‹œ í™•ì‹¤í•˜ê²Œ ì¸ì¦ ì •ë³´ ì „ì†¡
  try {
    const r = await fetch(apiUrl('/me'), { credentials:'include' });
    if (r.ok) {
      const d = await r.json();
      myNickname = d.guest?.nickname   || null;
      myJoinedAt = d.guest?.created_at || null;
      if (myNickname) localStorage.setItem('rkNickname', myNickname);
      else            localStorage.removeItem('rkNickname');
      if (d.guest?.image_url) {
        $('avatarImg').innerHTML = `<img src="${esc(d.guest.image_url)}" alt="í”„ë¡œí•„">`;
      }
    }
  } catch {
    myNickname = localStorage.getItem('rkNickname') || null;
  }
}

/* â”€â”€ í”„ë¡œí•„ UI â”€â”€ */
function updateProfileUI() {
  $('nickDisplay').textContent = myNickname || 'ë‹‰ë„¤ì„ ì—†ìŒ';
  $('profileSub').textContent  = myNickname
    ? (myJoinedAt ? `ê²ŒìŠ¤íŠ¸ Â· ${joinDate(myJoinedAt)} ê°€ì…` : 'ê²ŒìŠ¤íŠ¸')
    : 'ë‹‰ë„¤ì„ì„ ì„¤ì •í•˜ë©´ ê¸€Â·ëŒ“ê¸€Â·ì•¼ë¥´~ë¥¼ í•  ìˆ˜ ìˆì–´ìš”';
  $('nickToggleBtn').textContent = myNickname ? 'âœï¸ ë‹‰ë„¤ì„ ë³€ê²½' : 'âœï¸ ë‹‰ë„¤ì„ ì„¤ì •';
}

/* â”€â”€ ë‹‰ë„¤ì„ í¸ì§‘ â”€â”€ */
function toggleNickEdit() {
  const box  = $('nickEdit');
  const open = box.classList.contains('hidden');
  box.classList.toggle('hidden', !open);
  if (open) { $('nickInput').value = myNickname || ''; $('nickInput').focus(); clearNickMsg(); }
}
function clearNickMsg() { $('nickMsg').textContent = ''; $('nickMsg').className = 'nick-msg hidden'; }
function showNickMsg(txt, type) { $('nickMsg').textContent = txt; $('nickMsg').className = `nick-msg ${type}`; }

$('nickToggleBtn').addEventListener('click', toggleNickEdit);
$('nickInput').addEventListener('keypress', e => { if (e.key === 'Enter') saveNick(); });
$('nickSaveBtn').addEventListener('click', saveNick);

async function saveNick() {
  const val = $('nickInput').value.trim();
  clearNickMsg();
  if (!val || val.length > 10)                       { showNickMsg('1~10ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”','err'); return; }
  if (!/^[ê°€-í£ã„±-ã…ã…-ã…£a-zA-Z0-9]+$/.test(val)) { showNickMsg('í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ê°€ëŠ¥í•´ìš”','err'); return; }
  const btn = $('nickSaveBtn');
  btn.disabled = true; btn.textContent = 'ì €ì¥ ì¤‘...';
  try {
    const r = await fetch(`${API}/guest/nickname`, {
      method:'POST', credentials:'include',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ nickname: val, guest_id: guestId }),
    });
    const d = await r.json();
    if (d.ok) {
      myNickname = d.nickname;
      localStorage.setItem('rkNickname', d.nickname);
      $('nickEdit').classList.add('hidden');
      $('nickInput').value = '';
      updateProfileUI();
    } else if (d.error === 'nickname_cooldown_7days') { showNickMsg('7ì¼ì´ ì§€ë‚˜ì•¼ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš”','cool');
    } else if (d.error === 'nickname_taken')          { showNickMsg('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì´ì—ìš”','err');
    } else                                            { showNickMsg(d.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”','err'); }
  } catch { showNickMsg('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”','err'); }
  btn.disabled = false; btn.textContent = 'ì €ì¥';
}

/* â”€â”€ ì•„ë°”íƒ€ ì—…ë¡œë“œ â”€â”€ */
$('avatarBtn').addEventListener('click',  () => $('avatarInput').click());
$('avatarWrap').addEventListener('click', () => $('avatarInput').click());
$('avatarInput').addEventListener('change', async function() {
  const file = this.files[0];
  if (!file) return;
  if (file.size > 5 * 1024 * 1024) { alert('5MB ì´í•˜ ì´ë¯¸ì§€ë§Œ ê°€ëŠ¥í•´ìš”'); this.value=''; return; }
  $('avatarImg').innerHTML = '<div class="spinner"></div>';
  const fd = new FormData();
  fd.append('image', file);
  if (guestId) fd.append('guest_id', guestId);
  try {
    const r = await fetch(apiUrl('/guest/upload-image'), { method:'POST', credentials:'include', body:fd });
    const d = await r.json();
    if (d.ok) { $('avatarImg').innerHTML = `<img src="${esc(d.image_url)}?t=${Date.now()}" alt="í”„ë¡œí•„">`; }
    else       { $('avatarImg').textContent = 'ğŸ—£ï¸'; alert(d.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨'); }
  } catch { $('avatarImg').textContent = 'ğŸ—£ï¸'; alert('ì—…ë¡œë“œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'); }
  this.value = '';
});

/* â”€â”€ í†µí•© ë°ì´í„° ë¡œë“œ (ë³‘ë ¬ ë¹„ë™ê¸° ì²˜ë¦¬ ì ìš©) â”€â”€ */
async function loadAll() {
  try {
    const pr = await fetch(apiUrl('/my/posts?limit=50&offset=0'), { credentials:'include' });
    myPosts = pr.ok ? (await pr.json()).posts || [] : [];
  } catch { myPosts = []; }

  allYarers = [];
  receivedComments = [];

  if (myPosts.length > 0) {
    // ë²„ê·¸ìˆ˜ì • 2: apiUrl ì‚¬ìš© + credentials:'include' ì ìš©í•˜ì—¬ ê¶Œí•œ ë¬¸ì œ í•´ê²°
    const yarPromises = myPosts.map(p =>
      fetch(apiUrl(`/posts/${p.id}/yars`), { credentials:'include' })
        .then(r => r.ok ? r.json() : { yarers: [] })
        .then(d => ({ post:p, yarers: d.yarers || [] }))
        .catch(() => ({ post:p, yarers:[] }))
    );

    const cmtPromises = myPosts.map(p =>
      fetch(apiUrl(`/posts/${p.id}`), { credentials:'include' })
        .then(r => r.ok ? r.json() : { comments: [] })
        .then(d => ({ post:p, comments: d.comments || [] }))
        .catch(() => ({ post:p, comments:[] }))
    );

    const [yarResults, cmtResults] = await Promise.all([
      Promise.all(yarPromises),
      Promise.all(cmtPromises)
    ]);

    yarResults.forEach(({ post, yarers }) => {
      yarers.forEach(y => allYarers.push({
        ...y,
        post_id: post.id,
        post_title: post.title || post.body?.slice(0,30) || '',
      }));
    });
    allYarers.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

    cmtResults.forEach(({ post, comments }) => {
      comments.forEach(c => {
        // ë³¸ì¸ì´ ì‘ì„±í•œ ëŒ“ê¸€ì€ ë°›ì€ ì•Œë¦¼ì—ì„œ ì œì™¸
        if (c.nickname !== myNickname) {
          receivedComments.push({
            ...c,
            post_id: post.id,
            post_title: post.title || post.body?.slice(0,30) || '',
          });
        }
      });
    });
    receivedComments.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
  }

  $('statPosts').textContent    = myPosts.length;
  $('statYars').textContent     = allYarers.length;
  $('statComments').textContent = receivedComments.length;

  checkYarBadge();
  checkCmtBadge();
  renderPosts();
  
  if (currentTab === 'yars') renderYarers();
  if (currentTab === 'comments') renderReceivedCommentsCards();
}

/* â”€â”€ íƒ­ ì „í™˜ â”€â”€ */
function switchTab(tab) {
  currentTab = tab;

  $('tabPosts').classList.toggle('active',    tab === 'posts');
  $('tabYars').classList.toggle('active',     tab === 'yars');
  $('tabComments').classList.toggle('active', tab === 'comments');

  $('secPosts').classList.toggle('hidden',    tab !== 'posts');
  $('secYars').classList.toggle('hidden',     tab !== 'yars');
  $('secComments').classList.toggle('hidden', tab !== 'comments');

  if (tab === 'posts')    renderPosts();
  if (tab === 'yars')     { markYarRead(); renderYarers(); }
  if (tab === 'comments') { markCmtRead(); renderReceivedCommentsCards(); }
}

/* â”€â”€ ë‚´ ê¸€ ë Œë” â”€â”€ */
function renderPosts() {
  const sec = $('secPosts');
  if (!myPosts.length) {
    sec.innerHTML = `<div class="empty"><div class="empty-icon">âœï¸</div><div class="empty-text">ì•„ì§ ì“´ ê¸€ì´ ì—†ì–´ìš”</div><div class="empty-sub">ì²« ì´ì•¼ê¸°ë¥¼ ì¨ë³´ì„¸ìš”!</div></div>`;
    return;
  }
  const frag = document.createDocumentFragment();
  myPosts.forEach(p => frag.appendChild(makePostCard(p)));
  sec.innerHTML = '';
  sec.appendChild(frag);
}

function makePostCard(p) {
  const div = document.createElement('div');
  div.className = 'post-card';
  div.innerHTML = `
    <div class="post-card-head">
      <span class="post-ts">${relTime(p.created_at)}</span>
      <button class="more-btn" data-type="post" data-id="${p.id}" data-label="${esc((p.title||p.body||'').slice(0,20))}">â‹¯</button>
    </div>
    <div class="post-title" data-post-id="${p.id}">${esc(p.title || p.body?.slice(0,40) || '')}</div>
    ${p.body ? `<div class="post-body">${esc(p.body)}</div>` : ''}
    <div class="post-meta">
      <span>ğŸ’¬ ${p.comment_count || 0}</span>
      <span>ğŸŒŸ ${p.yar_count    || 0}</span>
      <span>ğŸ‘ ${p.view_count   || 0}</span>
    </div>`;
  div.addEventListener('click', e => {
    const mb = e.target.closest('.more-btn');
    if (mb) { openSheet('post', +mb.dataset.id, mb.dataset.label); return; }
    const pt = e.target.closest('.post-title');
    if (pt) openDetail(+pt.dataset.postId);
  });
  return div;
}

/* â”€â”€ ì•¼ë¥´~ ë°°ì§€ ë° ë Œë” â”€â”€ */
function checkYarBadge() {
  const saved = JSON.parse(localStorage.getItem('rkYarCounts') || '{}');
  let n = 0;
  myPosts.forEach(p => {
    const prev = saved[p.id] || 0;
    if ((p.yar_count || 0) > prev) n += (p.yar_count || 0) - prev;
  });
  const badge = $('yarBadge');
  if (n > 0) { badge.textContent = n; badge.classList.remove('hidden'); }
  else        { badge.classList.add('hidden'); }
}

function markYarRead() {
  const c = {};
  myPosts.forEach(p => { c[p.id] = p.yar_count || 0; });
  localStorage.setItem('rkYarCounts', JSON.stringify(c));
  $('yarBadge').classList.add('hidden');
}

function renderYarers() {
  const sec = $('secYars');
  if (!allYarers.length) {
    sec.innerHTML = `<div class="empty"><div class="empty-icon">ğŸŒŸ</div><div class="empty-text">ì•„ì§ ë°›ì€ ì•¼ë¥´~ê°€ ì—†ì–´ìš”</div><div class="empty-sub">ì¢‹ì€ ê¸€ì„ ì“°ë©´ ì¹œêµ¬ë“¤ì´ ë°˜ì‘í•´ ì¤„ ê±°ì˜ˆìš”!</div></div>`;
    return;
  }
  const card = document.createElement('div');
  card.className = 'yar-card';
  allYarers.forEach(y => {
    const item = document.createElement('div');
    item.className = 'yar-item';
    item.innerHTML = `
      <div class="yar-icon">ğŸŒŸ</div>
      <div class="yar-info">
        <div class="yar-nick">${esc(y.nickname)}</div>
        <div class="yar-post">${esc(y.post_title)}</div>
      </div>
      <div class="yar-time">${relTime(y.created_at)}</div>`;
    item.addEventListener('click', () => openDetail(y.post_id));
    card.appendChild(item);
  });
  sec.innerHTML = '';
  sec.appendChild(card);
}

/* â”€â”€ ë°›ì€ ëŒ“ê¸€ ë°°ì§€ ë° ë Œë” (SNS ìš”ì†Œ) â”€â”€ */
function checkCmtBadge() {
  const saved = JSON.parse(localStorage.getItem('rkCmtCounts') || '{}');
  let n = 0;
  myPosts.forEach(p => {
    const prev = saved[p.id] || 0;
    if ((p.comment_count || 0) > prev) n += (p.comment_count || 0) - prev;
  });
  const badge = $('cmtBadge');
  if (n > 0) { badge.textContent = n; badge.classList.remove('hidden'); }
  else        { badge.classList.add('hidden'); }
}

function markCmtRead() {
  const c = {};
  myPosts.forEach(p => { c[p.id] = p.comment_count || 0; });
  localStorage.setItem('rkCmtCounts', JSON.stringify(c));
  $('cmtBadge').classList.add('hidden');
}

function renderReceivedCommentsCards() {
  const sec = $('secComments');
  if (!receivedComments.length) {
    sec.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ’¬</div><div class="empty-text">ì•„ì§ ë°›ì€ ëŒ“ê¸€ì´ ì—†ì–´ìš”</div><div class="empty-sub">ê¸€ì— ë‹¬ë¦° ëŒ“ê¸€ë“¤ì´ ì—¬ê¸°ì— ëª¨ì…ë‹ˆë‹¤.</div></div>`;
    return;
  }
  const frag = document.createDocumentFragment();
  receivedComments.forEach(c => frag.appendChild(makeReceivedCommentCard(c)));
  sec.innerHTML = '';
  sec.appendChild(frag);
}

function makeReceivedCommentCard(c) {
  const div = document.createElement('div');
  div.className = 'comment-card';
  div.innerHTML = `
    <div class="comment-card-head">
      <span class="post-ts">${relTime(c.created_at)}</span>
    </div>
    <div class="comment-origin" data-post-id="${c.post_id}">ğŸ“ ${esc(c.post_title || 'ì›ë³¸ ê¸€ ë³´ê¸°')} â†’</div>
    <span class="comment-author-nick">ğŸ‘¤ ${esc(c.nickname || 'ìµëª…')}</span>
    <div class="comment-body-text">${esc(c.body)}</div>`;
  div.addEventListener('click', e => {
    const co = e.target.closest('.comment-origin');
    if (co) openDetail(+co.dataset.postId);
    else openDetail(c.post_id);
  });
  return div;
}

/* â”€â”€ ë°”í…€ì‹œíŠ¸ â”€â”€ */
function openSheet(type, id, label) {
  sheetType = type; sheetId = id;
  $('sheetLabel').textContent     = label ? `"${label}"` : '';
  $('sheetEditBtn').style.display = type === 'post' ? 'flex' : 'none';
  $('sheetOverlay').classList.remove('hidden');
}
function closeSheet() {
  $('sheetOverlay').classList.add('hidden');
  sheetType = null; sheetId = null;
}
$('sheetOverlay').addEventListener('click',  e => { if (e.target === $('sheetOverlay')) closeSheet(); });
$('sheetCancelBtn').addEventListener('click', closeSheet);
$('sheetEditBtn').addEventListener('click',   () => { closeSheet(); alert('ìˆ˜ì • ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì´ì—ìš” ğŸ˜Š'); });

$('sheetDeleteBtn').addEventListener('click', () => {
  const t = sheetType, id = sheetId;
  closeSheet();
  pendingDeleteFn = t === 'post' ? () => deletePost(id) : () => deleteComment(id);
  $('confirmOverlay').classList.remove('hidden');
});

/* â”€â”€ ì‚­ì œ í™•ì¸ â”€â”€ */
function closeConfirm() { $('confirmOverlay').classList.add('hidden'); pendingDeleteFn = null; }
$('confirmNo').addEventListener('click',  closeConfirm);

// ë²„ê·¸ìˆ˜ì • 1: Confirm ì°½ ë‹«í˜ìœ¼ë¡œ ì¸í•œ í•¨ìˆ˜ ì†Œì‹¤ ë°©ì§€ ë°±ì—… ë¡œì§ ì ìš©
$('confirmYes').addEventListener('click', () => { 
  const fn = pendingDeleteFn; 
  closeConfirm(); 
  if (typeof fn === 'function') fn(); 
});

async function deletePost(postId) {
  try {
    const r = await fetch(apiUrl(`/posts/${postId}`), { method:'DELETE', credentials:'include' });
    const d = await r.json();
    if (d.ok) {
      myPosts = myPosts.filter(p => p.id !== postId);
      await loadAll();
    } else { alert(d.error === 'not_your_post' ? 'ë‚´ ê¸€ì´ ì•„ë‹ˆì—ìš”' : (d.error || 'ì˜¤ë¥˜')); }
  } catch { alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'); }
}

async function deleteComment(cmtId) {
  // SNS ë§ˆì´í˜ì´ì§€ êµ¬ì¡° ë³€ê²½ìœ¼ë¡œ ë‚´ ëŒ“ê¸€ ëª©ë¡ì´ ì—†ì–´ì¡Œì§€ë§Œ ê¸°ëŠ¥ì€ ìœ ì§€
  try {
    const r = await fetch(apiUrl(`/comments/${cmtId}`), { method:'DELETE', credentials:'include' });
    const d = await r.json();
    if (!d.ok) { alert(d.error === 'not_your_comment' ? 'ë‚´ ëŒ“ê¸€ì´ ì•„ë‹ˆì—ìš”' : (d.error || 'ì˜¤ë¥˜')); }
  } catch { alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'); }
}

/* â”€â”€ ê¸€ì“°ê¸° ëª¨ë‹¬ â”€â”€ */
function openWrite() {
  if (!myNickname) { toggleNickEdit(); $('nickEdit').scrollIntoView({ behavior:'smooth' }); return; }
  $('writeError').textContent = '';
  $('writeTitle').value = '';
  $('writeBody').value  = '';
  $('writeOverlay').classList.remove('hidden');
  $('writeTitle').focus();
}
function closeWrite() { $('writeOverlay').classList.add('hidden'); }

$('writeNavBtn').addEventListener('click',   e => { e.preventDefault(); openWrite(); });
$('writeCloseBtn').addEventListener('click', closeWrite);
$('writeOverlay').addEventListener('click',  e => { if (e.target === $('writeOverlay')) closeWrite(); });
$('writeSubmitBtn').addEventListener('click', async () => {
  const title = $('writeTitle').value.trim();
  const body  = $('writeBody').value.trim();
  const errEl = $('writeError');
  const btn   = $('writeSubmitBtn');
  errEl.textContent = '';
  if (title.length < 2) { errEl.textContent = 'ì œëª©ì€ 2ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”'; return; }
  if (body.length  < 5) { errEl.textContent = 'ë‚´ìš©ì€ 5ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”'; return; }
  btn.disabled = true; btn.textContent = 'ê²Œì‹œ ì¤‘...';
  try {
    const r = await fetch(apiUrl('/posts'), {
      method:'POST', credentials:'include',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ title, body, guest_id: guestId }),
    });
    const d = await r.json();
    if (d.ok) {
      closeWrite();
      await loadAll();
      switchTab('posts');
    } else if (d.error === 'rate_limit_post') { errEl.textContent = 'ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”';
    } else                                    { errEl.textContent = d.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'; }
  } catch { errEl.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'; }
  btn.disabled = false; btn.textContent = 'ê²Œì‹œí•˜ê¸°';
});

/* â”€â”€ ê²Œì‹œê¸€ ìƒì„¸ â”€â”€ */
async function openDetail(postId) {
  commentSort = 'latest';
  syncCmtTabs();
  $('dTitle').textContent  = '';
  $('dAuthor').textContent = '';
  $('dTime').textContent   = '';
  $('dStats').textContent  = '';
  $('dBody').innerHTML     = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
  $('dMedia').innerHTML    = '';
  $('dComments').innerHTML = '';
  $('cmtInput').value      = '';
  $('detailOverlay').classList.remove('hidden');
  fetch(`${API}/posts/${postId}/view`, { method:'POST' }).catch(() => {});
  try {
    const r = await fetch(`${API}/posts/${postId}`);
    const d = await r.json();
    if (!d.ok) { $('dBody').textContent = 'ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì–´ìš”'; return; }
    const p = d.post;
    currentPost     = p;
    currentComments = d.comments || [];
    const isSystem  = p.author_type === 'system';
    $('dTitle').textContent  = p.title || '';
    $('dBody').innerHTML     = linkify(p.body || '');
    $('dAuthor').textContent = isSystem ? (p.character_name || 'ìºë¦­í„°') : (p.nickname || 'ìµëª…');
    $('dTime').textContent   = relTime(p.created_at);
    $('dStats').textContent  = `ğŸ’¬ ëŒ“ê¸€ ${d.comments?.length || 0} Â· ğŸ‘ ì¡°íšŒ ${p.view_count || 0}`;
    renderMedia(p.media_url);
    syncYarBtn(p.yar_count || 0, getYar(postId));
    renderCmts(currentComments);
  } catch { $('dBody').textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'; }
}

function renderMedia(url) {
  const w = $('dMedia'); w.innerHTML = '';
  if (!url) return;
  const mt = detectMedia(url);
  if (mt === 'image') {
    w.innerHTML = `<img src="${esc(url)}" alt="ì´ë¯¸ì§€" style="cursor:zoom-in;" onclick="this.requestFullscreen?.()">`;
  } else if (mt === 'video') {
    w.innerHTML = `<video src="${esc(url)}" controls playsinline></video>`;
  } else if (mt === 'audio') {
    w.innerHTML = `<div style="font-size:13px;color:var(--sub);margin-bottom:4px;">ğŸµ ìŒì•…</div><audio src="${esc(url)}" controls></audio>`;
  } else if (mt === 'youtube') {
    const m = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
    if (m) w.innerHTML = `<div style="position:relative;padding-top:56.25%;border-radius:12px;overflow:hidden;"><iframe src="https://www.youtube.com/embed/${m[1]}" style="position:absolute;inset:0;width:100%;height:100%;border:none;" allowfullscreen></iframe></div>`;
  } else {
    w.innerHTML = `<a href="${esc(url)}" target="_blank" rel="noopener" style="color:var(--blue);font-size:13px;">ğŸ”— ì²¨ë¶€ ë§í¬ ì—´ê¸°</a>`;
  }
}

function syncYarBtn(count, active) {
  const btn = $('dYarBtn');
  btn.className = `detail-yar${active ? ' on' : ''}`;
  btn.innerHTML = `ğŸŒŸ ì•¼ë¥´~ ${count}`;
}

function closeDetail() {
  $('detailOverlay').classList.add('hidden');
  currentPost = null; currentComments = [];
}

$('dCloseBtn').addEventListener('click', closeDetail);
$('detailOverlay').addEventListener('click', e => { if (e.target === $('detailOverlay')) closeDetail(); });

$('dYarBtn').addEventListener('click', async () => {
  if (!currentPost) return;
  if (!myNickname) { closeDetail(); toggleNickEdit(); return; }
  const pid = currentPost.id, was = getYar(pid);
  setYar(pid, !was);
  syncYarBtn((currentPost.yar_count || 0) + (was ? -1 : 1), !was);
  try {
    const r = await fetch(apiUrl(`/posts/${pid}/yar`), {
      method: was ? 'DELETE' : 'POST', credentials:'include',
      headers:{'Content-Type':'application/json'}, body: JSON.stringify({}),
    });
    const d = await r.json();
    if (d.ok) {
      currentPost.yar_count = d.yar_count;
      syncYarBtn(d.yar_count, !was);
      const mp = myPosts.find(p => p.id === pid);
      if (mp) { mp.yar_count = d.yar_count; $('statYars').textContent = myPosts.reduce((s,p)=>s+(p.yar_count||0),0); }
    } else { setYar(pid, was); syncYarBtn(currentPost.yar_count, was); }
  } catch { setYar(pid, was); syncYarBtn(currentPost.yar_count, was); }
});

/* â”€â”€ ëŒ“ê¸€ íƒ­ â”€â”€ */
function syncCmtTabs() {
  $('cLatest').className  = 'ctab' + (commentSort === 'latest'  ? ' on' : '');
  $('cPopular').className = 'ctab' + (commentSort === 'popular' ? ' on' : '');
}
$('cLatest').addEventListener('click',  () => { commentSort = 'latest';  syncCmtTabs(); renderCmts(currentComments); });
$('cPopular').addEventListener('click', () => { commentSort = 'popular'; syncCmtTabs(); renderCmts(currentComments); });

function renderCmts(cmts) {
  const w = $('dComments');
  if (!cmts.length) { w.innerHTML = '<div style="color:var(--sub);font-size:13px;padding:8px 0 16px;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ì–´ìš”.</div>'; return; }
  let s = [...cmts];
  if (commentSort === 'popular') {
    s.sort((a, b) => {
      const aS = a.author_type==='system' ? 1 : 0, bS = b.author_type==='system' ? 1 : 0;
      return bS !== aS ? bS - aS : new Date(b.created_at) - new Date(a.created_at);
    });
  } else { s.sort((a,b) => new Date(b.created_at)-new Date(a.created_at)); }
  w.innerHTML = s.map(cm => {
    const nick = cm.system_users?.display_name || cm.nickname || 'ìµëª…';
    const img  = cm.system_users?.image_url;
    const emo  = cm.system_users?.emoji || 'ğŸ—£ï¸';
    const av   = img
      ? `<img src="${esc(img)}" alt="${esc(nick)}" data-emoji="${esc(emo)}" onerror="this.outerHTML='<span style=\\'font-size:15px;\\'>${esc(emo)}</span>'">`
      : `<span style="font-size:15px;">${esc(emo)}</span>`;
    return `<div class="cmt-item">
      <div class="cmt-avatar">${av}</div>
      <div class="cmt-right">
        <div class="cmt-nick">${esc(nick)}</div>
        <div class="cmt-body">${esc(cm.body)}</div>
        <div class="cmt-time">${relTime(cm.created_at)}</div>
      </div>
    </div>`;
  }).join('');
}

/* â”€â”€ ëŒ“ê¸€ ì „ì†¡ â”€â”€ */
$('cmtInput').addEventListener('keypress', e => { if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendCmt(); } });
$('cmtSendBtn').addEventListener('click', sendCmt);

async function sendCmt() {
  if (!currentPost) return;
  if (!myNickname) { closeDetail(); toggleNickEdit(); return; }
  const body = $('cmtInput').value.trim();
  if (!body) return;
  const btn = $('cmtSendBtn');
  btn.disabled = true; btn.textContent = 'ì „ì†¡ì¤‘';
  try {
    const r = await fetch(`${API}/posts/${currentPost.id}/comments`, {
      method:'POST', credentials:'include',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ body, guest_id: guestId }),
    });
    const d = await r.json();
    if (d.ok) {
      $('cmtInput').value = '';
      const r2 = await fetch(`${API}/posts/${currentPost.id}`);
      const d2 = await r2.json();
      currentComments = d2.comments || [];
      renderCmts(currentComments);
      $('dStats').textContent = `ğŸ’¬ ëŒ“ê¸€ ${d2.comments?.length||0} Â· ğŸ‘ ì¡°íšŒ ${d2.post?.view_count||0}`;
      const mp = myPosts.find(p => p.id === currentPost.id);
      if (mp) mp.comment_count = (mp.comment_count || 0) + 1;
    } else { alert(d.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'); }
  } catch { alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'); }
  btn.disabled = false; btn.textContent = 'ì „ì†¡';
}

/* â”€â”€ ESC â”€â”€ */
document.addEventListener('keydown', e => {
  if (e.key !== 'Escape') return;
  if (!$('confirmOverlay').classList.contains('hidden')) { closeConfirm(); return; }
  if (!$('sheetOverlay').classList.contains('hidden'))   { closeSheet();   return; }
  if (!$('writeOverlay').classList.contains('hidden'))   { closeWrite();   return; }
  if (!$('detailOverlay').classList.contains('hidden'))  { closeDetail();  return; }
});

/* â”€â”€ ì´ˆê¸°í™” (finally ë¸”ë¡ ì¶”ê°€ë¡œ ë¬´í•œë¡œë”© ê·¼ì› ì°¨ë‹¨) â”€â”€ */
async function init() {
  try {
    await initGuest();
    updateProfileUI();
    await loadAll();
  } catch(e) {
    console.error("Initialization error:", e);
  } finally {
    $('loader').classList.add('hidden');
  }
}

// íƒ­ ë²„íŠ¼ ì´ë²¤íŠ¸
document.getElementById('tabPosts').addEventListener('click', () => switchTab('posts'));
document.getElementById('tabYars').addEventListener('click', () => switchTab('yars'));
document.getElementById('tabComments').addEventListener('click', () => switchTab('comments'));

// í†µê³„ í´ë¦­ ì´ë²¤íŠ¸
document.getElementById('statTabPosts').addEventListener('click', () => switchTab('posts'));
document.getElementById('statTabYars').addEventListener('click', () => switchTab('yars'));
document.getElementById('statTabComments').addEventListener('click', () => switchTab('comments'));

init();

window.switchTab = switchTab;
window.openDetail = openDetail;
window.closeDetail = closeDetail;
window.openWrite = openWrite;
window.closeWrite = closeWrite;
window.sendCmt = sendCmt;

})();
</script>
</body>
</html>
