<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸ” ê´€ë¦¬ì - ë¬´ì§€ê°œ ìœ ì¹˜ì›</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    :root {
      --bg:#f2f2f7; --card:#fff; --text:#1c1c1e; --sub:#8e8e93; --border:#e5e5ea;
      --accent:#ff6b6b; --blue:#007aff; --green:#34c759; --yar:#ff9f0a; --purple:#af52de;
      --radius-card:16px; --radius-btn:12px;
    }
    body { font-family:'Noto Sans KR',-apple-system,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
    .hidden { display:none !important; }
    @keyframes spin    { to { transform:rotate(360deg); } }
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    .skel { border-radius:12px; background:linear-gradient(90deg,#f0f0f0 25%,#e8e8e8 50%,#f0f0f0 75%); background-size:200% 100%; animation:shimmer 1.3s ease-in-out infinite; }
    .spinner-sm { width:16px; height:16px; border:2px solid rgba(255,255,255,.4); border-top-color:#fff; border-radius:50%; animation:spin .6s linear infinite; display:inline-block; }

    /* ë¡œê·¸ì¸ í™”ë©´ */
    #loginScreen { position:fixed; inset:0; background:var(--bg); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9000; gap:16px; padding:24px; }
    #loginScreen.hidden { display:none; }
    .login-box { background:var(--card); border-radius:20px; padding:28px 24px; width:100%; max-width:320px; text-align:center; box-shadow:0 4px 20px rgba(0,0,0,.1); }
    .login-emoji { font-size:48px; margin-bottom:10px; }
    .login-title { font-size:20px; font-weight:900; margin-bottom:4px; }
    .login-sub   { font-size:13px; color:var(--sub); margin-bottom:20px; }
    .login-input { width:100%; padding:14px; border:1.5px solid var(--border); border-radius:var(--radius-btn); font-size:16px; font-family:inherit; text-align:center; margin-bottom:10px; letter-spacing:2px; }
    .login-input:focus { outline:none; border-color:var(--text); }
    .login-btn { width:100%; padding:14px; background:var(--text); color:#fff; border:none; border-radius:var(--radius-btn); font-size:15px; font-weight:700; cursor:pointer; font-family:inherit; }
    .login-btn:disabled { opacity:.5; }
    .login-error { font-size:12px; color:var(--accent); margin-top:8px; min-height:16px; }

    /* í—¤ë” */
    .header { background:var(--card); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:100; }
    .header-inner { max-width:800px; margin:0 auto; padding:10px 16px; display:flex; align-items:center; justify-content:space-between; }
    .header-left  { display:flex; align-items:center; gap:8px; }
    .header-logo  { font-size:22px; }
    .header-title { font-size:17px; font-weight:900; }
    .header-badge { background:var(--accent); color:#fff; font-size:10px; font-weight:700; padding:2px 8px; border-radius:10px; }
    .logout-btn   { padding:6px 14px; border:1px solid var(--border); border-radius:20px; background:var(--bg); font-size:12px; cursor:pointer; font-family:inherit; color:var(--sub); }

    /* íƒ‘ ë„¤ë¹„ íƒ­ */
    .top-nav { background:var(--card); border-bottom:1.5px solid var(--border); }
    .top-nav-inner { max-width:800px; margin:0 auto; display:flex; overflow-x:auto; scrollbar-width:none; -webkit-overflow-scrolling:touch; }
    .top-nav-inner::-webkit-scrollbar { display:none; }
    .top-nav-btn { flex-shrink:0; padding:12px 20px; font-size:14px; font-weight:700; color:var(--sub); background:none; border:none; cursor:pointer; font-family:inherit; border-bottom:2.5px solid transparent; white-space:nowrap; transition:color .15s,border-color .15s; }
    .top-nav-btn.active { color:var(--text); border-bottom-color:var(--text); }

    .container { max-width:800px; margin:0 auto; padding:16px 16px 60px; }

    /* ì„¹ì…˜ í—¤ë” */
    .section-title { font-size:18px; font-weight:900; margin-bottom:4px; }
    .section-sub   { font-size:13px; color:var(--sub); margin-bottom:16px; }

    /* ê³µí†µ ì¹´ë“œ */
    .card { background:var(--card); border-radius:var(--radius-card); padding:20px; margin-bottom:16px; box-shadow:0 1px 4px rgba(0,0,0,.06); }

    /* í¼ */
    .form-label   { font-size:12px; font-weight:700; color:var(--sub); margin-bottom:6px; display:block; }
    .form-input   { width:100%; padding:11px 14px; border:1.5px solid var(--border); border-radius:var(--radius-btn); font-size:14px; font-family:inherit; margin-bottom:12px; }
    .form-input:focus   { outline:none; border-color:var(--text); }
    .form-textarea { width:100%; padding:11px 14px; border:1.5px solid var(--border); border-radius:var(--radius-btn); font-size:14px; font-family:inherit; min-height:100px; resize:vertical; margin-bottom:12px; }
    .form-textarea:focus { outline:none; border-color:var(--text); }
    .form-select  { width:100%; padding:11px 14px; border:1.5px solid var(--border); border-radius:var(--radius-btn); font-size:14px; font-family:inherit; margin-bottom:12px; background:var(--card); }
    .form-select:focus  { outline:none; border-color:var(--text); }
    .form-row { display:flex; gap:10px; }
    .form-row > * { flex:1; }

    /* ë²„íŠ¼ */
    .btn { padding:11px 20px; border-radius:var(--radius-btn); font-size:14px; font-weight:700; cursor:pointer; font-family:inherit; border:none; display:inline-flex; align-items:center; gap:6px; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .btn-primary  { background:var(--text); color:#fff; }
    .btn-blue     { background:var(--blue); color:#fff; }
    .btn-green    { background:var(--green); color:#fff; }
    .btn-red      { background:var(--accent); color:#fff; }
    .btn-outline  { background:var(--bg); color:var(--text); border:1.5px solid var(--border); }
    .btn-sm       { padding:6px 12px; font-size:12px; border-radius:8px; }
    .btn-full     { width:100%; justify-content:center; }
    .btn-group    { display:flex; gap:8px; flex-wrap:wrap; }

    /* ìºë¦­í„° ê·¸ë¦¬ë“œ */
    .char-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:10px; }
    .char-card { background:var(--bg); border-radius:14px; padding:12px 8px; text-align:center; cursor:pointer; border:2px solid transparent; transition:border-color .15s,transform .1s; }
    .char-card:active { transform:scale(.95); }
    .char-card.selected { border-color:var(--blue); background:#e8f0fe; }
    .char-card-avatar { width:60px; height:60px; border-radius:12px; background:var(--card); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:28px; margin:0 auto 6px; overflow:hidden; }
    .char-card-avatar img { width:100%; height:100%; object-fit:cover; }
    .char-card-name { font-size:12px; font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .char-card-type { font-size:10px; color:var(--sub); margin-top:2px; }

    /* ìºë¦­í„° íŒ¨ë„ (ì‚¬ì´ë“œ) */
    .char-panel-overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:2000; display:flex; align-items:flex-end; justify-content:center; }
    .char-panel-overlay.hidden { display:none; }
    .char-panel { width:100%; max-width:640px; background:var(--card); border-radius:20px 20px 0 0; max-height:92vh; display:flex; flex-direction:column; }
    .char-panel-handle { width:36px; height:4px; background:var(--border); border-radius:2px; margin:10px auto; flex-shrink:0; }
    .char-panel-head { padding:0 16px 12px; border-bottom:1px solid var(--border); flex-shrink:0; display:flex; align-items:center; gap:10px; }
    .char-panel-avatar { width:44px; height:44px; border-radius:10px; background:var(--bg); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:24px; overflow:hidden; flex-shrink:0; }
    .char-panel-avatar img { width:100%; height:100%; object-fit:cover; }
    .char-panel-name { font-size:17px; font-weight:900; }
    .char-panel-sub  { font-size:12px; color:var(--sub); }
    .char-panel-close { margin-left:auto; padding:8px; border:1px solid var(--border); background:var(--bg); border-radius:50%; cursor:pointer; font-size:14px; width:32px; height:32px; display:flex; align-items:center; justify-content:center; }
    .char-panel-body { flex:1; overflow-y:auto; padding:16px; }
    .char-panel-tabs { display:flex; gap:0; border-bottom:1.5px solid var(--border); margin-bottom:14px; }
    .char-panel-tab  { flex:1; padding:8px 0; font-size:13px; font-weight:700; color:var(--sub); background:none; border:none; cursor:pointer; font-family:inherit; border-bottom:2px solid transparent; margin-bottom:-1.5px; }
    .char-panel-tab.active { color:var(--text); border-bottom-color:var(--text); }
    .char-post-item { background:var(--bg); border-radius:10px; padding:10px 12px; margin-bottom:8px; }
    .char-post-title { font-size:13px; font-weight:700; margin-bottom:4px; }
    .char-post-body  { font-size:12px; color:var(--sub); line-height:1.4; margin-bottom:6px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .char-post-meta  { font-size:11px; color:var(--sub); display:flex; gap:8px; }
    .char-post-btns  { display:flex; gap:6px; margin-top:6px; }

    /* ê¸€ í¸ì§‘ ëª¨ë‹¬ */
    .edit-overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:flex-end; justify-content:center; z-index:3000; }
    .edit-overlay.hidden { display:none; }
    .edit-panel { width:100%; max-width:640px; background:var(--card); border-radius:20px 20px 0 0; padding-bottom:env(safe-area-inset-bottom,0); }
    .edit-handle { width:36px; height:4px; background:var(--border); border-radius:2px; margin:10px auto; }
    .edit-head { padding:0 16px 12px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border); }
    .edit-head-title { font-size:16px; font-weight:900; }
    .edit-body { padding:16px; max-height:60vh; overflow-y:auto; }
    .edit-footer { padding:12px 16px; border-top:1px solid var(--border); display:flex; gap:8px; }

    /* AI ìƒì„± */
    .ai-char-select-wrap { background:var(--bg); border-radius:12px; padding:14px; margin-bottom:14px; }
    .ai-char-select-label { font-size:13px; font-weight:700; margin-bottom:10px; color:var(--sub); }
    .ai-char-mini-grid { display:flex; gap:8px; overflow-x:auto; padding-bottom:4px; -webkit-overflow-scrolling:touch; scrollbar-width:none; }
    .ai-char-mini-grid::-webkit-scrollbar { display:none; }
    .ai-char-mini { flex-shrink:0; width:64px; text-align:center; cursor:pointer; }
    .ai-char-mini-av { width:48px; height:48px; border-radius:10px; background:var(--card); border:2px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:22px; margin:0 auto 4px; overflow:hidden; transition:border-color .15s; }
    .ai-char-mini-av img { width:100%; height:100%; object-fit:cover; }
    .ai-char-mini.selected .ai-char-mini-av { border-color:var(--blue); background:#e8f0fe; }
    .ai-char-mini-name { font-size:10px; font-weight:700; color:var(--sub); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .ai-generated-preview { background:var(--bg); border-radius:12px; padding:14px; margin-top:12px; }
    .ai-gen-label { font-size:12px; font-weight:700; color:var(--sub); margin-bottom:8px; }
    .ai-gen-title { font-size:15px; font-weight:700; margin-bottom:6px; }
    .ai-gen-body  { font-size:13px; line-height:1.6; color:var(--text); white-space:pre-wrap; }
    .ai-gen-actions { display:flex; gap:8px; margin-top:12px; }

    /* ê´€ë¦¬ ëª©ë¡ */
    .mgmt-item { background:var(--card); border-radius:var(--radius-card); padding:14px; margin-bottom:10px; box-shadow:0 1px 4px rgba(0,0,0,.06); }
    .mgmt-item-head { display:flex; align-items:flex-start; gap:10px; }
    .mgmt-item-info { flex:1; min-width:0; }
    .mgmt-item-title { font-size:14px; font-weight:700; margin-bottom:2px; }
    .mgmt-item-meta  { font-size:12px; color:var(--sub); }
    .mgmt-item-btns  { display:flex; gap:6px; flex-shrink:0; }
    .mgmt-type-badge { display:inline-block; font-size:10px; font-weight:700; padding:2px 8px; border-radius:10px; margin-bottom:4px; }
    .badge-char    { background:#e8f0fe; color:var(--blue); }
    .badge-guest   { background:#f0fbe8; color:var(--green); }
    .badge-notice  { background:#feede8; color:var(--accent); }
    .badge-system-user { background:#f3e8fe; color:var(--purple); }

    /* ê³µì§€ ë¯¸ë””ì–´ ì²¨ë¶€ */
    .media-preview { margin-top:10px; }
    .media-preview img { max-width:100%; border-radius:10px; max-height:200px; object-fit:cover; }
    .media-preview-url { font-size:12px; color:var(--blue); word-break:break-all; }

    /* ì•Œë¦¼ í† ìŠ¤íŠ¸ */
    .toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%); background:#1c1c1e; color:#fff; padding:10px 20px; border-radius:20px; font-size:13px; font-weight:600; z-index:9999; opacity:0; transition:opacity .25s; pointer-events:none; white-space:nowrap; max-width:90vw; text-align:center; }
    .toast.show { opacity:1; }
    .toast.error { background:var(--accent); }
  </style>
</head>
<body>

<!-- ë¡œê·¸ì¸ -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-emoji">ğŸ”</div>
    <div class="login-title">ê´€ë¦¬ì íŒ¨ë„</div>
    <div class="login-sub">ë¬´ì§€ê°œ ìœ ì¹˜ì› & ì–´ë¦°ì´ì§‘</div>
    <input class="login-input" type="password" id="loginInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
    <button class="login-btn" id="loginBtn" onclick="doLogin()">ì…ì¥í•˜ê¸°</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- í† ìŠ¤íŠ¸ -->
<div class="toast" id="toast"></div>

<!-- í—¤ë” -->
<div class="header hidden" id="mainHeader">
  <div class="header-inner">
    <div class="header-left">
      <span class="header-logo">ğŸŒˆ</span>
      <span class="header-title">ê´€ë¦¬ì íŒ¨ë„</span>
      <span class="header-badge">ADMIN</span>
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <a href="index.html" style="padding:6px 12px;background:var(--bg);color:var(--sub);border:1px solid var(--border);border-radius:20px;font-size:12px;font-weight:700;text-decoration:none;">ğŸ  í™ˆ</a>
      <button class="logout-btn" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>
</div>

<!-- íƒ‘ ë„¤ë¹„ -->
<div class="top-nav hidden" id="topNav">
  <div class="top-nav-inner">
    <button class="top-nav-btn active" onclick="switchMainTab('characters')" id="mnChars">ğŸ¾ ìºë¦­í„°</button>
    <button class="top-nav-btn"        onclick="switchMainTab('write')"      id="mnWrite">âœï¸ ê¸€ì“°ê¸°</button>
    <button class="top-nav-btn"        onclick="switchMainTab('notice')"     id="mnNotice">ğŸ“Œ ê³µì§€</button>
    <button class="top-nav-btn"        onclick="switchMainTab('manage')"     id="mnManage">ğŸ”§ ê´€ë¦¬</button>
    <button class="top-nav-btn"        onclick="switchMainTab('addchar')"    id="mnAddChar">â• ìºë¦­í„° ì¶”ê°€</button>
    <button class="top-nav-btn"        onclick="switchMainTab('sysuser')"    id="mnSysUser">ğŸ‘¤ ì‹œìŠ¤í…œ ìœ ì €</button>
  </div>
</div>

<div class="container hidden" id="mainContent">

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ íƒ­: ìºë¦­í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="tabCharacters">
    <div class="section-title">ğŸ¾ ìºë¦­í„°</div>
    <div class="section-sub">ìºë¦­í„°ë¥¼ íƒ­í•˜ë©´ ìƒì„¸ ì •ë³´ì™€ ê¸€ ëª©ë¡ì„ ë³¼ ìˆ˜ ìˆì–´ìš”</div>
    <div class="char-grid" id="charGrid">
      <div class="char-card skel" style="height:110px;"></div>
      <div class="char-card skel" style="height:110px;"></div>
      <div class="char-card skel" style="height:110px;"></div>
      <div class="char-card skel" style="height:110px;"></div>
      <div class="char-card skel" style="height:110px;"></div>
      <div class="char-card skel" style="height:110px;"></div>
    </div>
  </div>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ íƒ­: ê¸€ì“°ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="tabWrite" class="hidden">
    <div class="section-title">âœï¸ ê¸€ì“°ê¸°</div>
    <div class="section-sub">AI ìë™ ìƒì„± ë˜ëŠ” ì§ì ‘ ì‘ì„±í•˜ì„¸ìš”</div>

    <!-- AI ìƒì„± -->
    <div class="card">
      <div style="font-size:15px;font-weight:700;margin-bottom:14px;">ğŸ¤– AI ìë™ ìƒì„±</div>
      <div class="ai-char-select-wrap">
        <div class="ai-char-select-label">ìºë¦­í„° ì„ íƒ</div>
        <div class="ai-char-mini-grid" id="aiCharGrid"></div>
      </div>
      <label class="form-label">ì£¼ì œ / í‚¤ì›Œë“œ (ì„ íƒ)</label>
      <input class="form-input" id="aiPrompt" placeholder="ì˜ˆ: ì˜¤ëŠ˜ ê°„ì‹, ìš´ë™íšŒ ì—°ìŠµ, ë‚®ì  ê±°ë¶€...">
      <label class="form-label">ì–´ì¡°</label>
      <select class="form-select" id="aiTone">
        <option value="cute">ê·€ì—¬ì›€ (ê¸°ë³¸)</option>
        <option value="funny">ìœ ë¨¸ëŸ¬ìŠ¤</option>
        <option value="emotional">ê°ì„±ì </option>
        <option value="serious">ì§„ì§€í•˜ê²Œ</option>
      </select>
      <div class="btn-group">
        <button class="btn btn-blue" id="aiGenBtn" onclick="generateAIPost()">âœ¨ AI ê¸€ ìƒì„±</button>
        <button class="btn btn-outline" onclick="clearAIPreview()">ì§€ìš°ê¸°</button>
      </div>
      <div class="ai-generated-preview hidden" id="aiPreview">
        <div class="ai-gen-label">âœ¨ ìƒì„±ëœ ê¸€ ë¯¸ë¦¬ë³´ê¸°</div>
        <div class="ai-gen-title" id="aiGenTitle"></div>
        <div class="ai-gen-body"  id="aiGenBody"></div>
        <input class="form-input" id="aiMediaUrl" placeholder="ë¯¸ë””ì–´ URL (ì„ íƒ, ì´ë¯¸ì§€/ë™ì˜ìƒ/ìœ íŠœë¸Œ)" style="margin-top:12px;margin-bottom:0;">
        <div class="ai-gen-actions">
          <button class="btn btn-green" id="aiPostBtn" onclick="postAIGenerated()">ğŸ“¤ ì´ ê¸€ ê²Œì‹œ</button>
          <button class="btn btn-outline btn-sm" onclick="generateAIPost()">ğŸ”„ ë‹¤ì‹œ ìƒì„±</button>
          <button class="btn btn-outline btn-sm" onclick="editAIGenerated()">âœï¸ ìˆ˜ì • í›„ ê²Œì‹œ</button>
        </div>
      </div>
    </div>

    <!-- ì§ì ‘ ì‘ì„± -->
    <div class="card">
      <div style="font-size:15px;font-weight:700;margin-bottom:14px;">ğŸ“ ì§ì ‘ ì‘ì„±</div>
      <label class="form-label">ìºë¦­í„°</label>
      <select class="form-select" id="writeCharSelect"></select>
      <label class="form-label">ì œëª©</label>
      <input class="form-input" id="writeTitle2" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="80">
      <label class="form-label">ë‚´ìš©</label>
      <textarea class="form-textarea" id="writeBody2" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." maxlength="5000" style="min-height:140px;"></textarea>
      <label class="form-label">ë¯¸ë””ì–´ URL (ì„ íƒ)</label>
      <input class="form-input" id="writeMediaUrl" placeholder="ì´ë¯¸ì§€, ë™ì˜ìƒ, ìœ íŠœë¸Œ ë§í¬ ë“±">
      <div style="margin-bottom:12px;">
        <div class="media-preview hidden" id="writeMediaPreview"></div>
      </div>
      <button class="btn btn-primary btn-full" id="writeSubmitBtn" onclick="submitManualPost()">ğŸ“¤ ê²Œì‹œí•˜ê¸°</button>
    </div>
  </div>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ íƒ­: ê³µì§€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="tabNotice" class="hidden">
    <div class="section-title">ğŸ“Œ ê³µì§€ ì‘ì„±</div>
    <div class="section-sub">ê³µì§€ì‚¬í•­ì€ í™ˆ ìƒë‹¨ì— ê³ ì • í‘œì‹œë©ë‹ˆë‹¤</div>
    <div class="card">
      <label class="form-label">ì œëª©</label>
      <input class="form-input" id="noticeTitle" placeholder="ê³µì§€ ì œëª©" maxlength="80">
      <label class="form-label">ë‚´ìš©</label>
      <textarea class="form-textarea" id="noticeBody" placeholder="ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." maxlength="3000" style="min-height:160px;"></textarea>
      <label class="form-label">ë¯¸ë””ì–´ URL (ì„ íƒ)</label>
      <input class="form-input" id="noticeMediaUrl" placeholder="ì´ë¯¸ì§€, ë™ì˜ìƒ, ìœ íŠœë¸Œ ë§í¬ ë“±" oninput="previewNoticeMedia()">
      <div class="media-preview hidden" id="noticeMediaPreview"></div>
      <button class="btn btn-primary btn-full" id="noticeSubmitBtn" onclick="submitNotice()" style="margin-top:4px;">ğŸ“Œ ê³µì§€ ê²Œì‹œ</button>
    </div>

    <div class="section-title" style="margin-top:8px;">ğŸ“‹ ê³µì§€ ëª©ë¡</div>
    <div id="noticeList">
      <div class="skel" style="height:70px;margin-bottom:8px;"></div>
      <div class="skel" style="height:70px;margin-bottom:8px;"></div>
    </div>
  </div>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ íƒ­: ê´€ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="tabManage" class="hidden">
    <div class="section-title">ğŸ”§ ê²Œì‹œê¸€ ê´€ë¦¬</div>
    <div class="section-sub">ìºë¦­í„° ê¸€ê³¼ ê²ŒìŠ¤íŠ¸ ê¸€ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</div>

    <!-- í•„í„° -->
    <div class="card" style="padding:14px;">
      <div class="form-row" style="margin-bottom:0;">
        <select class="form-select" id="mgmtFilter" onchange="loadManagePosts(true)" style="margin-bottom:0;">
          <option value="all">ì „ì²´ ê¸€</option>
          <option value="system">ìºë¦­í„° ê¸€</option>
          <option value="guest">ê²ŒìŠ¤íŠ¸ ê¸€</option>
        </select>
        <button class="btn btn-outline" onclick="loadManagePosts(true)" style="white-space:nowrap;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>

    <div id="managePostList">
      <div class="skel" style="height:80px;margin-bottom:8px;"></div>
      <div class="skel" style="height:80px;margin-bottom:8px;"></div>
      <div class="skel" style="height:80px;margin-bottom:8px;"></div>
    </div>
    <button class="btn btn-outline btn-full hidden" id="mgmtLoadMoreBtn" onclick="loadManagePosts(false)">ë” ë³´ê¸°</button>
  </div>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ íƒ­: ìºë¦­í„° ì¶”ê°€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="tabAddChar" class="hidden">
    <div class="section-title">â• ìºë¦­í„° ì¶”ê°€</div>
    <div class="section-sub">ìƒˆ ìºë¦­í„°ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤</div>
    <div class="card">
      <div class="form-row">
        <div>
          <label class="form-label">ì´ë¦„</label>
          <input class="form-input" id="addName" placeholder="í‘œì‹œ ì´ë¦„" maxlength="30">
        </div>
        <div>
          <label class="form-label">ì´ëª¨ì§€</label>
          <input class="form-input" id="addEmoji" placeholder="ğŸ¾" maxlength="4">
        </div>
      </div>
      <div class="form-row">
        <div>
          <label class="form-label">ì†Œì†</label>
          <select class="form-select" id="addGroup">
            <option value="kindergarten">ìœ ì¹˜ì›</option>
            <option value="daycare">ì–´ë¦°ì´ì§‘</option>
            <option value="teacher">ì„ ìƒë‹˜</option>
          </select>
        </div>
        <div>
          <label class="form-label">ë™ë¬¼ íƒ€ì…</label>
          <input class="form-input" id="addAnimal" placeholder="ì˜ˆ: ê°œêµ¬ë¦¬, ë¹„ë²„...">
        </div>
      </div>
      <div class="form-row">
        <div>
          <label class="form-label">ì„±ë³„</label>
          <input class="form-input" id="addGender" placeholder="male / female / ê³ ì">
        </div>
        <div>
          <label class="form-label">MBTI</label>
          <input class="form-input" id="addMbti" placeholder="ì˜ˆ: ENFP">
        </div>
      </div>
      <div class="form-row">
        <div>
          <label class="form-label">ì¢‹ì•„í•˜ëŠ” ê²ƒ</label>
          <input class="form-input" id="addLikes" placeholder="ì˜ˆ: ì•„ì´ëŒ">
        </div>
        <div>
          <label class="form-label">ì·¨ë¯¸</label>
          <input class="form-input" id="addHobby" placeholder="ì˜ˆ: ëˆ•ê¸°">
        </div>
      </div>
      <label class="form-label">ì´ë¯¸ì§€ URL (ì„ íƒ)</label>
      <input class="form-input" id="addImageUrl" placeholder="https://...">
      <label class="form-label">ë¹„ë°€ë²ˆí˜¸ (ì´ ìºë¦­í„° ì „ìš©)</label>
      <input class="form-input" type="password" id="addPassword" placeholder="ìºë¦­í„° ì „ìš© ë¹„ë²ˆ (ì„ íƒ)">
      <label class="form-label">AI ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ì„ íƒ)</label>
      <textarea class="form-textarea" id="addSystemPrompt" placeholder="ì´ ìºë¦­í„°ê°€ ê¸€ ì“¸ ë•Œì˜ ì„±ê²©/ë§íˆ¬ ì§€ì¹¨..." style="min-height:80px;"></textarea>
      <button class="btn btn-primary btn-full" id="addCharBtn" onclick="submitAddCharacter()">â• ìºë¦­í„° ë“±ë¡</button>
    </div>
  </div>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ íƒ­: ì‹œìŠ¤í…œ ìœ ì € â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="tabSysUser" class="hidden">
    <div class="section-title">ğŸ‘¤ ì‹œìŠ¤í…œ ìœ ì €</div>
    <div class="section-sub">ìºë¦­í„° ëŒ€ì‹  ëŒ“ê¸€ì„ ë‹¬ ìˆ˜ ìˆëŠ” ìœ ì €ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤</div>
    <div class="card">
      <div style="font-size:15px;font-weight:700;margin-bottom:14px;">â• ì‹œìŠ¤í…œ ìœ ì € ì¶”ê°€</div>
      <div class="form-row">
        <div>
          <label class="form-label">í‘œì‹œ ì´ë¦„</label>
          <input class="form-input" id="suName" placeholder="í‘œì‹œ ì´ë¦„" maxlength="20">
        </div>
        <div>
          <label class="form-label">ì´ëª¨ì§€</label>
          <input class="form-input" id="suEmoji" placeholder="ğŸ‘©â€ğŸ«" maxlength="4">
        </div>
      </div>
      <label class="form-label">ì´ë¯¸ì§€ URL (ì„ íƒ)</label>
      <input class="form-input" id="suImageUrl" placeholder="https://...">
      <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
      <input class="form-input" type="password" id="suPassword" placeholder="ì´ ì‹œìŠ¤í…œ ìœ ì € ë¹„ë°€ë²ˆí˜¸">
      <button class="btn btn-primary btn-full" id="suAddBtn" onclick="submitAddSysUser()">â• ì¶”ê°€</button>
    </div>
    <div class="section-title" style="margin-top:8px;">ëª©ë¡</div>
    <div id="sysUserList">
      <div class="skel" style="height:60px;margin-bottom:8px;"></div>
      <div class="skel" style="height:60px;margin-bottom:8px;"></div>
    </div>
  </div>

</div>

<!-- ìºë¦­í„° ìƒì„¸ íŒ¨ë„ -->
<div class="char-panel-overlay hidden" id="charPanelOverlay" onclick="handleCharPanelOverlay(event)">
  <div class="char-panel" onclick="event.stopPropagation()">
    <div class="char-panel-handle"></div>
    <div class="char-panel-head">
      <div class="char-panel-avatar" id="cpAvatar">ğŸ¾</div>
      <div style="flex:1;">
        <div class="char-panel-name" id="cpName"></div>
        <div class="char-panel-sub"  id="cpSub"></div>
      </div>
      <button class="char-panel-close" onclick="closeCharPanel()">âœ•</button>
    </div>
    <div class="char-panel-body">
      <div class="char-panel-tabs">
        <button class="char-panel-tab active" onclick="switchCharPanelTab('posts',this)" id="cpTabPosts">ê¸€ ëª©ë¡</button>
        <button class="char-panel-tab"        onclick="switchCharPanelTab('edit',this)"  id="cpTabEdit">ìºë¦­í„° ìˆ˜ì •</button>
      </div>
      <!-- ê¸€ ëª©ë¡ -->
      <div id="cpPosts"><div style="color:var(--sub);font-size:14px;">ë¡œë”© ì¤‘...</div></div>
      <!-- ìˆ˜ì • í¼ -->
      <div id="cpEditForm" class="hidden">
        <div class="form-row">
          <div><label class="form-label">ì´ë¦„</label><input class="form-input" id="editName" placeholder="í‘œì‹œ ì´ë¦„" maxlength="30"></div>
          <div><label class="form-label">ì´ëª¨ì§€</label><input class="form-input" id="editEmoji" placeholder="ğŸ¾" maxlength="4"></div>
        </div>
        <div class="form-row">
          <div>
            <label class="form-label">ì†Œì†</label>
            <select class="form-select" id="editGroup">
              <option value="kindergarten">ìœ ì¹˜ì›</option>
              <option value="daycare">ì–´ë¦°ì´ì§‘</option>
              <option value="teacher">ì„ ìƒë‹˜</option>
            </select>
          </div>
          <div><label class="form-label">ë™ë¬¼ íƒ€ì…</label><input class="form-input" id="editAnimal" placeholder="ì˜ˆ: ê°œêµ¬ë¦¬"></div>
        </div>
        <div class="form-row">
          <div><label class="form-label">ì„±ë³„</label><input class="form-input" id="editGender" placeholder="male / female"></div>
          <div><label class="form-label">MBTI</label><input class="form-input" id="editMbti" placeholder="ENFP"></div>
        </div>
        <div class="form-row">
          <div><label class="form-label">ì¢‹ì•„í•˜ëŠ” ê²ƒ</label><input class="form-input" id="editLikes" placeholder="ì˜ˆ: ì•„ì´ëŒ"></div>
          <div><label class="form-label">ì·¨ë¯¸</label><input class="form-input" id="editHobby" placeholder="ì˜ˆ: ëˆ•ê¸°"></div>
        </div>
        <label class="form-label">ì´ë¯¸ì§€ URL</label>
        <input class="form-input" id="editImageUrl" placeholder="https://...">
        <label class="form-label">AI ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸</label>
        <textarea class="form-textarea" id="editSystemPrompt" placeholder="ì„±ê²©/ë§íˆ¬ ì§€ì¹¨..." style="min-height:80px;"></textarea>
        <button class="btn btn-primary btn-full" id="cpSaveBtn" onclick="saveCharacterEdit()">ğŸ’¾ ì €ì¥</button>
      </div>
    </div>
  </div>
</div>

<!-- ê¸€ í¸ì§‘ ëª¨ë‹¬ -->
<div class="edit-overlay hidden" id="editOverlay" onclick="handleEditOverlay(event)">
  <div class="edit-panel" onclick="event.stopPropagation()">
    <div class="edit-handle"></div>
    <div class="edit-head">
      <div class="edit-head-title">âœï¸ ê¸€ ìˆ˜ì •</div>
      <button onclick="closeEditModal()" style="padding:6px 14px;border:1px solid var(--border);border-radius:20px;background:var(--bg);font-size:12px;cursor:pointer;font-family:inherit;">âœ• ë‹«ê¸°</button>
    </div>
    <div class="edit-body">
      <label class="form-label">ì œëª©</label>
      <input class="form-input" id="editPostTitle" placeholder="ì œëª©" maxlength="80">
      <label class="form-label">ë‚´ìš©</label>
      <textarea class="form-textarea" id="editPostBody" placeholder="ë‚´ìš©..." maxlength="5000" style="min-height:120px;"></textarea>
      <label class="form-label">ë¯¸ë””ì–´ URL (ì„ íƒ)</label>
      <input class="form-input" id="editPostMedia" placeholder="ì´ë¯¸ì§€, ë™ì˜ìƒ, ìœ íŠœë¸Œ ë§í¬">
    </div>
    <div class="edit-footer">
      <button class="btn btn-primary" id="editSaveBtn" onclick="saveEditPost()">ğŸ’¾ ì €ì¥</button>
      <button class="btn btn-outline" onclick="closeEditModal()">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<script>
  const API = 'https://rainbowkidz-api.irunaru.workers.dev/api/v1';
  let adminToken    = null;
  let characters    = [];
  let selectedCharId = null;
  let currentChar   = null;
  let editingPostId = null;
  let managePosts   = [];
  let mgmtOffset    = 0;
  const MGMT_LIMIT  = 30;
  let aiSelectedCharId = null;
  let aiGeneratedPost  = null;

  const esc = s => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  const relTime = d => {
    const s = (Date.now() - new Date(d)) / 1000;
    if (s < 60)     return 'ë°©ê¸ˆ';
    if (s < 3600)   return `${Math.floor(s/60)}ë¶„ ì „`;
    if (s < 86400)  return `${Math.floor(s/3600)}ì‹œê°„ ì „`;
    if (s < 604800) return `${Math.floor(s/86400)}ì¼ ì „`;
    return new Date(d).toLocaleDateString('ko-KR',{month:'short',day:'numeric'});
  };
  const groupLabel = g => g==='kindergarten'?'ìœ ì¹˜ì›':g==='daycare'?'ì–´ë¦°ì´ì§‘':'ì„ ìƒë‹˜';

  function showToast(msg, isError = false) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast show' + (isError ? ' error' : '');
    clearTimeout(t._tid);
    t._tid = setTimeout(() => { t.className = 'toast'; }, 3000);
  }

  // â”€â”€ ë¡œê·¸ì¸
  document.getElementById('loginInput').addEventListener('keypress', e => { if (e.key === 'Enter') doLogin(); });

  async function doLogin() {
    const pw  = document.getElementById('loginInput').value;
    const btn = document.getElementById('loginBtn');
    const err = document.getElementById('loginError');
    if (!pw) { err.textContent = 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'; return; }
    btn.disabled = true; btn.textContent = 'í™•ì¸ ì¤‘...';
    err.textContent = '';
    try {
      const r = await fetch(`${API}/admin/login`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ password: pw }),
      });
      const d = await r.json();
      if (d.ok) {
        adminToken = d.token;
        sessionStorage.setItem('rkAdminToken', adminToken);
        showMainPanel();
      } else {
        err.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ì–´ìš”';
      }
    } catch { err.textContent = 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”'; }
    btn.disabled = false; btn.textContent = 'ì…ì¥í•˜ê¸°';
  }

  function doLogout() {
    adminToken = null;
    sessionStorage.removeItem('rkAdminToken');
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('mainHeader').classList.add('hidden');
    document.getElementById('topNav').classList.add('hidden');
    document.getElementById('mainContent').classList.add('hidden');
    document.getElementById('loginInput').value = '';
  }

  function showMainPanel() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainHeader').classList.remove('hidden');
    document.getElementById('topNav').classList.remove('hidden');
    document.getElementById('mainContent').classList.remove('hidden');
    loadCharacters();
    switchMainTab('characters');
  }

  // â”€â”€ íƒ­ ì „í™˜
  const TAB_IDS = {
    characters: ['tabCharacters','mnChars'],
    write:      ['tabWrite',     'mnWrite'],
    notice:     ['tabNotice',    'mnNotice'],
    manage:     ['tabManage',    'mnManage'],
    addchar:    ['tabAddChar',   'mnAddChar'],
    sysuser:    ['tabSysUser',   'mnSysUser'],
  };

  function switchMainTab(tab) {
    Object.entries(TAB_IDS).forEach(([key, [tabId, btnId]]) => {
      document.getElementById(tabId).classList.toggle('hidden', key !== tab);
      document.getElementById(btnId).classList.toggle('active', key === tab);
    });
    if (tab === 'write')   { renderAICharGrid(); renderWriteCharSelect(); }
    if (tab === 'notice')  { loadNoticeList(); }
    if (tab === 'manage')  { loadManagePosts(true); }
    if (tab === 'sysuser') { loadSysUsers(); }
  }

  // â”€â”€ ìºë¦­í„° ë¡œë“œ
  async function loadCharacters() {
    try {
      const r = await fetch(`${API}/characters`, { headers:{'Authorization': `Bearer ${adminToken}`} });
      if (r.ok) { const d = await r.json(); characters = d.characters || []; }
    } catch {}
    renderCharGrid();
    renderAICharGrid();
    renderWriteCharSelect();
  }

  function renderCharGrid() {
    const grid = document.getElementById('charGrid');
    if (!characters.length) { grid.innerHTML = '<div style="color:var(--sub);font-size:14px;">ìºë¦­í„°ê°€ ì—†ì–´ìš”</div>'; return; }
    grid.innerHTML = characters.map(c => {
      const imgHtml = c.image_url
        ? `<img src="${esc(c.image_url)}" alt="${esc(c.display_name)}" data-emoji="${esc(c.emoji||'ğŸ¾')}" onerror="this.parentElement.removeChild(this);this.parentElement.textContent=this.dataset.emoji">`
        : '';
      return `<div class="char-card" onclick="openCharPanel(${c.id})">
        <div class="char-card-avatar">${imgHtml || esc(c.emoji||'ğŸ¾')}</div>
        <div class="char-card-name">${esc(c.display_name)}</div>
        <div class="char-card-type">${groupLabel(c.group_type)}</div>
      </div>`;
    }).join('');
  }

  function renderAICharGrid() {
    const grid = document.getElementById('aiCharGrid');
    if (!grid) return;
    grid.innerHTML = characters.map(c => {
      const imgHtml = c.image_url
        ? `<img src="${esc(c.image_url)}" alt="${esc(c.display_name)}" onerror="this.parentElement.textContent='${esc(c.emoji||'ğŸ¾')}';">`
        : '';
      const name = c.display_name.length > 4 ? c.display_name.slice(0,4)+'â€¦' : c.display_name;
      return `<div class="ai-char-mini${c.id === aiSelectedCharId?' selected':''}" onclick="selectAIChar(${c.id})" id="aiChar-${c.id}">
        <div class="ai-char-mini-av">${imgHtml || esc(c.emoji||'ğŸ¾')}</div>
        <div class="ai-char-mini-name">${esc(name)}</div>
      </div>`;
    }).join('');
    if (!aiSelectedCharId && characters.length) { aiSelectedCharId = characters[0].id; renderAICharGrid(); }
  }

  function selectAIChar(id) {
    aiSelectedCharId = id;
    document.querySelectorAll('.ai-char-mini').forEach(el => el.classList.remove('selected'));
    const el = document.getElementById(`aiChar-${id}`);
    if (el) el.classList.add('selected');
  }

  function renderWriteCharSelect() {
    const sel = document.getElementById('writeCharSelect');
    if (!sel) return;
    sel.innerHTML = characters.map(c => `<option value="${c.id}">${esc(c.display_name)} (${groupLabel(c.group_type)})</option>`).join('');
  }

  // â”€â”€ ìºë¦­í„° íŒ¨ë„
  async function openCharPanel(charId) {
    const c = characters.find(x => x.id == charId);
    if (!c) return;
    currentChar = c;
    const av = document.getElementById('cpAvatar');
    if (c.image_url) {
      av.innerHTML = `<img src="${esc(c.image_url)}" alt="${esc(c.display_name)}" data-emoji="${esc(c.emoji||'ğŸ¾')}" onerror="this.parentElement.removeChild(this);this.parentElement.textContent=this.dataset.emoji">`;
    } else { av.textContent = c.emoji || 'ğŸ¾'; }
    document.getElementById('cpName').textContent = c.display_name;
    document.getElementById('cpSub').textContent  = `${groupLabel(c.group_type)} Â· ${c.animal_type||''} Â· ${c.mbti||''}`;
    switchCharPanelTab('posts');
    fillCharEditForm(c);
    document.getElementById('charPanelOverlay').classList.remove('hidden');
    loadCharPosts(charId);
  }
  function closeCharPanel() { document.getElementById('charPanelOverlay').classList.add('hidden'); currentChar = null; }
  function handleCharPanelOverlay(e) { if (e.target.id === 'charPanelOverlay') closeCharPanel(); }

  function switchCharPanelTab(tab, btn) {
    document.getElementById('cpPosts').classList.toggle('hidden', tab !== 'posts');
    document.getElementById('cpEditForm').classList.toggle('hidden', tab !== 'edit');
    document.querySelectorAll('.char-panel-tab').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    else document.getElementById(tab === 'posts' ? 'cpTabPosts' : 'cpTabEdit').classList.add('active');
  }

  async function loadCharPosts(charId) {
    const wrap = document.getElementById('cpPosts');
    wrap.innerHTML = '<div style="color:var(--sub);font-size:14px;">ë¡œë”© ì¤‘...</div>';
    try {
      const r = await fetch(`${API}/characters/${charId}/posts?limit=20`, { headers:{'Authorization':`Bearer ${adminToken}`} });
      const d = await r.json();
      if (!d.posts?.length) { wrap.innerHTML = '<div style="color:var(--sub);font-size:14px;">ê¸€ì´ ì—†ì–´ìš”</div>'; return; }
      wrap.innerHTML = d.posts.map(p => `<div class="char-post-item">
        <div class="char-post-title">${esc(p.title||'(ì œëª© ì—†ìŒ)')}</div>
        <div class="char-post-body">${esc(p.body||'')}</div>
        <div class="char-post-meta">
          <span>ğŸ’¬ ${p.comment_count||0}</span>
          <span>ğŸŒŸ ${p.yar_count||0}</span>
          <span>ğŸ‘ ${p.view_count||0}</span>
          <span>${relTime(p.created_at)}</span>
        </div>
        <div class="char-post-btns">
          <button class="btn btn-outline btn-sm" onclick="openEditPostModal(${p.id},'${esc(p.title||'')}',${JSON.stringify(esc(p.body||''))},${JSON.stringify(esc(p.media_url||''))})">âœï¸ ìˆ˜ì •</button>
          <button class="btn btn-red btn-sm" onclick="deletePost(${p.id})">ğŸ—‘ ì‚­ì œ</button>
        </div>
      </div>`).join('');
    } catch { wrap.innerHTML = '<div style="color:var(--sub);">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>'; }
  }

  function fillCharEditForm(c) {
    document.getElementById('editName').value         = c.display_name    || '';
    document.getElementById('editEmoji').value        = c.emoji           || '';
    document.getElementById('editGroup').value        = c.group_type      || 'kindergarten';
    document.getElementById('editAnimal').value       = c.animal_type     || '';
    document.getElementById('editGender').value       = c.gender          || '';
    document.getElementById('editMbti').value         = c.mbti            || '';
    document.getElementById('editLikes').value        = c.likes           || '';
    document.getElementById('editHobby').value        = c.hobby           || '';
    document.getElementById('editImageUrl').value     = c.image_url       || '';
    document.getElementById('editSystemPrompt').value = c.system_prompt   || '';
  }

  async function saveCharacterEdit() {
    if (!currentChar) return;
    const btn = document.getElementById('cpSaveBtn');
    btn.disabled = true; btn.textContent = 'ì €ì¥ ì¤‘...';
    const payload = {
      display_name:  document.getElementById('editName').value.trim(),
      emoji:         document.getElementById('editEmoji').value.trim(),
      group_type:    document.getElementById('editGroup').value,
      animal_type:   document.getElementById('editAnimal').value.trim(),
      gender:        document.getElementById('editGender').value.trim(),
      mbti:          document.getElementById('editMbti').value.trim(),
      likes:         document.getElementById('editLikes').value.trim(),
      hobby:         document.getElementById('editHobby').value.trim(),
      image_url:     document.getElementById('editImageUrl').value.trim(),
      system_prompt: document.getElementById('editSystemPrompt').value.trim(),
    };
    try {
      const r = await fetch(`${API}/admin/characters/${currentChar.id}`, {
        method:'PATCH', headers:{'Content-Type':'application/json','Authorization':`Bearer ${adminToken}`},
        body: JSON.stringify(payload),
      });
      const d = await r.json();
      if (d.ok) {
        showToast('âœ… ìºë¦­í„°ê°€ ìˆ˜ì •ë˜ì—ˆì–´ìš”');
        await loadCharacters();
        const updated = characters.find(c => c.id === currentChar.id);
        if (updated) { currentChar = updated; fillCharEditForm(updated); }
      } else { showToast(d.error || 'ìˆ˜ì • ì‹¤íŒ¨', true); }
    } catch { showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”', true); }
    btn.disabled = false; btn.textContent = 'ğŸ’¾ ì €ì¥';
  }

  // â”€â”€ ê¸€ í¸ì§‘ ëª¨ë‹¬
  function openEditPostModal(postId, title, body, mediaUrl) {
    editingPostId = postId;
    document.getElementById('editPostTitle').value = title || '';
    document.getElementById('editPostBody').value  = body  || '';
    document.getElementById('editPostMedia').value = mediaUrl || '';
    document.getElementById('editOverlay').classList.remove('hidden');
  }
  function closeEditModal() { document.getElementById('editOverlay').classList.add('hidden'); editingPostId = null; }
  function handleEditOverlay(e) { if (e.target.id === 'editOverlay') closeEditModal(); }

  async function saveEditPost() {
    if (!editingPostId) return;
    const btn = document.getElementById('editSaveBtn');
    btn.disabled = true; btn.textContent = 'ì €ì¥ ì¤‘...';
    const payload = {
      title:     document.getElementById('editPostTitle').value.trim(),
      body:      document.getElementById('editPostBody').value.trim(),
      media_url: document.getElementById('editPostMedia').value.trim() || null,
    };
    try {
      const r = await fetch(`${API}/admin/posts/${editingPostId}`, {
        method:'PATCH', headers:{'Content-Type':'application/json','Authorization':`Bearer ${adminToken}`},
        body: JSON.stringify(payload),
      });
      const d = await r.json();
      if (d.ok) {
        showToast('âœ… ê¸€ì´ ìˆ˜ì •ë˜ì—ˆì–´ìš”');
        closeEditModal();
        if (currentChar) loadCharPosts(currentChar.id);
        if (document.getElementById('tabManage').classList.contains('hidden') === false) loadManagePosts(true);
      } else { showToast(d.error || 'ìˆ˜ì • ì‹¤íŒ¨', true); }
    } catch { showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”', true); }
    btn.disabled = false; btn.textContent = 'ğŸ’¾ ì €ì¥';
  }

  // â”€â”€ ê¸€ ì‚­ì œ
  async function deletePost(postId) {
    if (!confirm('ì´ ê¸€ì„ ì‚­ì œí• ê¹Œìš”?')) return;
    try {
      const r = await fetch(`${API}/admin/posts/${postId}`, {
        method:'DELETE', headers:{'Authorization':`Bearer ${adminToken}`},
      });
      const d = await r.json();
      if (d.ok) {
        showToast('ğŸ—‘ ê¸€ì´ ì‚­ì œë˜ì—ˆì–´ìš”');
        if (currentChar) loadCharPosts(currentChar.id);
        managePosts = managePosts.filter(p => p.id !== postId);
        renderManagePosts();
      } else { showToast(d.error || 'ì‚­ì œ ì‹¤íŒ¨', true); }
    } catch { showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”', true); }
  }

  // â”€â”€ AI ê¸€ ìƒì„±
  async function generateAIPost() {
    if (!aiSelectedCharId) { showToast('ìºë¦­í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', true); return; }
    const btn = document.getElementById('aiGenBtn');
    btn.disabled = true; btn.innerHTML = '<div class="spinner-sm"></div> ìƒì„± ì¤‘...';
    document.getElementById('aiPreview').classList.add('hidden');
    const c       = characters.find(x => x.id === aiSelectedCharId);
    const prompt  = document.getElementById('aiPrompt').value.trim();
    const tone    = document.getElementById('aiTone').value;
    try {
      const r = await fetch(`${API}/admin/generate-post`, {
        method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${adminToken}`},
        body: JSON.stringify({ character_id: aiSelectedCharId, prompt, tone }),
      });
      const d = await r.json();
      if (d.ok) {
        aiGeneratedPost = d.post;
        document.getElementById('aiGenTitle').textContent = d.post.title || '';
        document.getElementById('aiGenBody').textContent  = d.post.body  || '';
        document.getElementById('aiMediaUrl').value       = '';
        document.getElementById('aiPreview').classList.remove('hidden');
      } else { showToast(d.error || 'AI ìƒì„± ì‹¤íŒ¨', true); }
    } catch { showToast('AI ìƒì„± ì˜¤ë¥˜', true); }
    btn.disabled = false; btn.innerHTML = 'âœ¨ AI ê¸€ ìƒì„±';
  }

  function clearAIPreview() {
    aiGeneratedPost = null;
    document.getElementById('aiPreview').classList.add('hidden');
    document.getElementById('aiPrompt').value = '';
  }

  async function postAIGenerated() {
    if (!aiGeneratedPost || !aiSelectedCharId) return;
    const btn = document.getElementById('aiPostBtn');
    btn.disabled = true; btn.innerHTML = '<div class="spinner-sm"></div> ê²Œì‹œ ì¤‘...';
    const mediaUrl = document.getElementById('aiMediaUrl').value.trim();
    try {
      const r = await fetch(`${API}/admin/posts`, {
        method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${adminToken}`},
        body: JSON.stringify({
          character_id: aiSelectedCharId,
          title: aiGeneratedPost.title,
          body:  aiGeneratedPost.body,
          media_url: mediaUrl || null,
        }),
      });
      const d = await r.json();
      if (d.ok) {
        showToast('âœ… ê¸€ì´ ê²Œì‹œë˜ì—ˆì–´ìš”!');
        clearAIPreview();
      } else { showToast(d.error || 'ê²Œì‹œ ì‹¤íŒ¨', true); }
    } catch { showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”', true); }
    btn.disabled = false; btn.innerHTML = 'ğŸ“¤ ì´ ê¸€ ê²Œì‹œ';
  }

  function editAIGenerated() {
    if (!aiGeneratedPost) return;
    const charSel = document.getElementById('writeCharSelect');
    if (charSel) charSel.value = aiSelectedCharId;
    document.getElementById('writeTitle2').value = aiGeneratedPost.title || '';
    document.getElementById('writeBody2').value  = aiGeneratedPost.body  || '';
    document.getElementById('writeMediaUrl').value = document.getElementById('aiMediaUrl').value || '';
    switchMainTab('write');
  }

  // â”€â”€ ì§ì ‘ ì‘ì„±
  document.getElementById('writeMediaUrl')?.addEventListener('input', function() {
    const preview = document.getElementById('writeMediaPreview');
    const url = this.value.trim();
    if (!url) { preview.classList.add('hidden'); return; }
    if (/\.(jpg|jpeg|png|gif|webp)$/i.test(url)) {
      preview.innerHTML = `<img src="${esc(url)}" alt="ë¯¸ë¦¬ë³´ê¸°" onerror="this.parentElement.classList.add('hidden')">`;
      preview.classList.remove('hidden');
    } else { preview.innerHTML = `<div class="media-preview-url">ğŸ”— ${esc(url)}</div>`; preview.classList.remove('hidden'); }
  });

  async function submitManualPost() {
    const charId   = document.getElementById('writeCharSelect').value;
    const title    = document.getElementById('writeTitle2').value.trim();
    const body     = document.getElementById('writeBody2').value.trim();
    const mediaUrl = document.getElementById('writeMediaUrl').value.trim();
    const btn      = document.getElementById('writeSubmitBtn');
    if (!title || !body) { showToast('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', true); return; }
    btn.disabled = true; btn.innerHTML = '<div class="spinner-sm"></div> ê²Œì‹œ ì¤‘...';
    try {
      const r = await fetch(`${API}/admin/posts`, {
        method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${adminToken}`},
        body: JSON.stringify({ character_id: parseInt(charId), title, body, media_url: mediaUrl || null }),
      });
      const d = await r.json();
      if (d.ok) {
        showToast('âœ… ê¸€ì´ ê²Œì‹œë˜ì—ˆì–´ìš”!');
        document.getElementById('writeTitle2').value = '';
        document.getElementById('writeBody2').value  = '';
        document.getElementById('writeMediaUrl').value = '';
        document.getElementById('writeMediaPreview').classList.add('hidden');
      } else { showToast(d.error || 'ê²Œì‹œ ì‹¤íŒ¨', true); }
    } catch { showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”', true); }
    btn.disabled = false; btn.textContent = 'ğŸ“¤ ê²Œì‹œí•˜ê¸°';
  }

  // â”€â”€ ê³µì§€
  function previewNoticeMedia() {
    const url = document.getElementById('noticeMediaUrl').value.trim();
    const preview = document.getElementById('noticeMediaPreview');
    if (!url) { preview.classList.add('hidden'); return; }
    if (/\.(jpg|jpeg|png|gif|webp)$/i.test(url)) {
      preview.innerHTML = `<img src="${esc(url)}" alt="ë¯¸ë¦¬ë³´ê¸°" onerror="this.parentElement.classList.add('hidden')">`;
      preview.classList.remove('hidden');
    } else { preview.innerHTML = `<div class="media-preview-url">ğŸ”— ${esc(url)}</div>`; preview.classList.remove('hidden'); }
  }

  async function submitNotice() {
    const title    = document.getElementById('noticeTitle').value.trim();
    const body     = document.getElementById('noticeBody').value.trim();
    const mediaUrl = document.getElementById('noticeMediaUrl').value.trim();
    const btn      = document.getElementById('noticeSubmitBtn');
    if (!title || !body) { showToast('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', true); return; }
    btn.disabled = true; btn.innerHTML = '<div class="spinner-sm"></div> ê²Œì‹œ ì¤‘...';
    try {
      const r = await fetch(`${API}/admin/notices`, {
        method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${adminToken}`},
        body: JSON.stringify({ title, body, media_url: mediaUrl || null }),
      });
      const d = await r.json();
      if (d.ok) {
        showToast('ğŸ“Œ ê³µì§€ê°€ ê²Œì‹œë˜ì—ˆì–´ìš”!');
        document.getElementById('noticeTitle').value    = '';
        document.getElementById('noticeBody').value     = '';
        document.getElementById('noticeMediaUrl').value = '';
        document.getElementById('noticeMediaPreview').classList.add('hidden');
        loadNoticeList();
      } else { showToast(d.error || 'ê²Œì‹œ ì‹¤íŒ¨', true); }
    } catch { showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”', true); }
    btn.disabled = false; btn.textContent = 'ğŸ“Œ ê³µì§€ ê²Œì‹œ';
  }

  async function loadNoticeList() {
    const list = document.getElementById('noticeList');
    list.innerHTML = '<div class="skel" style="height:60px;margin-bottom:8px;"></div>'.repeat(2);
    try {
      const r = await fetch(`${API}/notices?limit=20`, { headers:{'Authorization':`Bearer ${adminToken}`} });
      const d = await r.json();
      const notices = d.notices || [];
      if (!notices.length) { list.innerHTML = '<div style="color:var(--sub);font-size:14px;padding:12px 0;">ê³µì§€ê°€ ì—†ì–´ìš”</div>'; return; }
      list.innerHTML = notices.map(n => `<div class="mgmt-item">
        <div class="mgmt-item-head">
          <div class="mgmt-item-info">
            <span class="mgmt-type-badge badge-notice">ğŸ“Œ ê³µì§€</span>
            <div class="mgmt-item-title">${esc(n.title)}</div>
            <div class="mgmt-item-meta">${relTime(n.created_at)}</div>
          </div>
          <div class="mgmt-item-btns">
            <button class="btn btn-red btn-sm" onclick="deleteNotice(${n.id})">ğŸ—‘ ì‚­ì œ</button>
          </div>
        </div>
      </div>`).join('');
    } catch { list.innerHTML = '<div style="color:var(--sub);">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>'; }
  }

  async function deleteNotice(id) {
    if (!confirm('ê³µì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
    try {
      const r = await fetch(`${API}/admin/notices/${id}`, {
        method:'DELETE', headers:{'Authorization':`Bearer ${adminToken}`},
      });
      const d = await r.json();
      if (d.ok) { showToast('ğŸ—‘ ê³µì§€ê°€ ì‚­ì œë˜ì—ˆì–´ìš”'); loadNoticeList(); }
      else { showToast(d.error || 'ì‚­ì œ ì‹¤íŒ¨', true); }
    } catch { showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”', true); }
  }

  // â”€â”€ ê´€ë¦¬ (ì „ì²´ ê¸€ ëª©ë¡)
  async function loadManagePosts(reset = false) {
    if (reset) { managePosts = []; mgmtOffset = 0; }
    const filter = document.getElementById('mgmtFilter').value;
    const list   = document.getElementById('managePostList');
    if (reset) list.innerHTML = '<div class="skel" style="height:80px;margin-bottom:8px;"></div>'.repeat(3);
    try {
      const params = new URLSearchParams({ limit: MGMT_LIMIT, offset: mgmtOffset, sort:'latest' });
      if (filter !== 'all') params.set('author_type', filter);
      const r = await fetch(`${API}/admin/posts?${params}`, { headers:{'Authorization':`Bearer ${adminToken}`} });
      const d = await r.json();
      const newPosts = d.posts || [];
      managePosts = reset ? newPosts : [...managePosts, ...newPosts];
      mgmtOffset += newPosts.length;
      const hasMore = mgmtOffset < (d.total || 0);
      document.getElementById('mgmtLoadMoreBtn').classList.toggle('hidden', !hasMore);
      renderManagePosts();
    } catch { list.innerHTML = '<div style="color:var(--sub);">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>'; }
  }

  function renderManagePosts() {
    const list = document.getElementById('managePostList');
    if (!managePosts.length) { list.innerHTML = '<div style="color:var(--sub);padding:12px 0;">ê¸€ì´ ì—†ì–´ìš”</div>'; return; }
    list.innerHTML = managePosts.map(p => {
      const isSystem = p.author_type === 'system';
      const authorName = isSystem ? (p.character_name||'ìºë¦­í„°') : (p.nickname||'ìµëª…');
      const badgeClass = isSystem ? 'badge-char' : 'badge-guest';
      const badgeText  = isSystem ? 'ğŸ¾ ìºë¦­í„°' : 'ğŸ—£ï¸ ê²ŒìŠ¤íŠ¸';
      return `<div class="mgmt-item">
        <div class="mgmt-item-head">
          <div class="mgmt-item-info">
            <span class="mgmt-type-badge ${badgeClass}">${badgeText}</span>
            <div class="mgmt-item-title">${esc(p.title||p.body?.slice(0,40)||'')}</div>
            <div class="mgmt-item-meta">${esc(authorName)} Â· ${relTime(p.created_at)} Â· ğŸ’¬ ${p.comment_count||0} ğŸŒŸ ${p.yar_count||0} ğŸ‘ ${p.view_count||0}</div>
          </div>
          <div class="mgmt-item-btns">
            ${isSystem ? `<button class="btn btn-outline btn-sm" onclick="openEditPostModal(${p.id},'${esc(p.title||'')}',${JSON.stringify(esc(p.body||''))},${JSON.stringify(esc(p.media_url||''))})">âœï¸</button>` : ''}
            <button class="btn btn-red btn-sm" onclick="deletePost(${p.id})">ğŸ—‘</button>
          </div>
        </div>
      </div>`;
    }).join('');
  }

  // â”€â”€ ìºë¦­í„° ì¶”ê°€
  async function submitAddCharacter() {
    const btn = document.getElementById('addCharBtn');
    const name = document.getElementById('addName').value.trim();
    if (!name) { showToast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', true); return; }
    btn.disabled = true; btn.innerHTML = '<div class="spinner-sm"></div> ë“±ë¡ ì¤‘...';
    const payload = {
      display_name:  name,
      emoji:         document.getElementById('addEmoji').value.trim() || 'ğŸ¾',
      group_type:    document.getElementById('addGroup').value,
      animal_type:   document.getElementById('addAnimal').value.trim(),
      gender:        document.getElementById('addGender').value.trim(),
      mbti:          document.getElementById('addMbti').value.trim(),
      likes:         document.getElementById('addLikes').value.trim(),
      hobby:         document.getElementById('addHobby').value.trim(),
      image_url:     document.getElementById('addImageUrl').value.trim() || null,
      password:      document.getElementById('addPassword').value || null,
      system_prompt: document.getElementById('addSystemPrompt').value.trim() || null,
    };
    try {
      const r = await fetch(`${API}/admin/characters`, {
        method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${adminToken}`},
        body: JSON.stringify(payload),
      });
      const d = await r.json();
      if (d.ok) {
        showToast(`âœ… ${name} ìºë¦­í„°ê°€ ì¶”ê°€ë˜ì—ˆì–´ìš”!`);
        ['addName','addEmoji','addAnimal','addGender','addMbti','addLikes','addHobby','addImageUrl','addPassword','addSystemPrompt'].forEach(id => { const el = document.getElementById(id); if (el) el.value=''; });
        document.getElementById('addGroup').value = 'kindergarten';
        await loadCharacters();
      } else { showToast(d.error || 'ë“±ë¡ ì‹¤íŒ¨', true); }
    } catch { showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”', true); }
    btn.disabled = false; btn.textContent = 'â• ìºë¦­í„° ë“±ë¡';
  }

  // â”€â”€ ì‹œìŠ¤í…œ ìœ ì €
  async function loadSysUsers() {
    const list = document.getElementById('sysUserList');
    list.innerHTML = '<div class="skel" style="height:60px;margin-bottom:8px;"></div>'.repeat(2);
    try {
      const r = await fetch(`${API}/admin/system-users`, { headers:{'Authorization':`Bearer ${adminToken}`} });
      const d = await r.json();
      const users = d.users || [];
      if (!users.length) { list.innerHTML = '<div style="color:var(--sub);font-size:14px;padding:12px 0;">ì‹œìŠ¤í…œ ìœ ì €ê°€ ì—†ì–´ìš”</div>'; return; }
      list.innerHTML = users.map(u => {
        const imgHtml = u.image_url
          ? `<img src="${esc(u.image_url)}" alt="${esc(u.display_name)}" style="width:36px;height:36px;border-radius:8px;object-fit:cover;border:1px solid var(--border);" onerror="this.style.display='none'">`
          : `<span style="font-size:22px;">${esc(u.emoji||'ğŸ‘¤')}</span>`;
        return `<div class="mgmt-item">
          <div class="mgmt-item-head">
            <div style="margin-right:8px;">${imgHtml}</div>
            <div class="mgmt-item-info">
              <span class="mgmt-type-badge badge-system-user">ğŸ‘¤ ì‹œìŠ¤í…œ ìœ ì €</span>
              <div class="mgmt-item-title">${esc(u.display_name)} ${esc(u.emoji||'')}</div>
            </div>
            <div class="mgmt-item-btns">
              <button class="btn btn-red btn-sm" onclick="deleteSysUser(${u.id})">ğŸ—‘</button>
            </div>
          </div>
        </div>`;
      }).join('');
    } catch { list.innerHTML = '<div style="color:var(--sub);">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>'; }
  }

  async function submitAddSysUser() {
    const btn  = document.getElementById('suAddBtn');
    const name = document.getElementById('suName').value.trim();
    const pw   = document.getElementById('suPassword').value;
    if (!name || !pw) { showToast('ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', true); return; }
    btn.disabled = true; btn.innerHTML = '<div class="spinner-sm"></div> ì¶”ê°€ ì¤‘...';
    const payload = {
      display_name: name,
      emoji:        document.getElementById('suEmoji').value.trim() || 'ğŸ‘¤',
      image_url:    document.getElementById('suImageUrl').value.trim() || null,
      password:     pw,
    };
    try {
      const r = await fetch(`${API}/admin/system-users`, {
        method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${adminToken}`},
        body: JSON.stringify(payload),
      });
      const d = await r.json();
      if (d.ok) {
        showToast(`âœ… ${name} ì‹œìŠ¤í…œ ìœ ì €ê°€ ì¶”ê°€ë˜ì—ˆì–´ìš”`);
        ['suName','suEmoji','suImageUrl','suPassword'].forEach(id => { document.getElementById(id).value=''; });
        loadSysUsers();
      } else { showToast(d.error || 'ì¶”ê°€ ì‹¤íŒ¨', true); }
    } catch { showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”', true); }
    btn.disabled = false; btn.textContent = 'â• ì¶”ê°€';
  }

  async function deleteSysUser(id) {
    if (!confirm('ì´ ì‹œìŠ¤í…œ ìœ ì €ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
    try {
      const r = await fetch(`${API}/admin/system-users/${id}`, {
        method:'DELETE', headers:{'Authorization':`Bearer ${adminToken}`},
      });
      const d = await r.json();
      if (d.ok) { showToast('ğŸ—‘ ì‚­ì œë˜ì—ˆì–´ìš”'); loadSysUsers(); }
      else { showToast(d.error || 'ì‚­ì œ ì‹¤íŒ¨', true); }
    } catch { showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”', true); }
  }

  // â”€â”€ ì„¸ì…˜ ë³µêµ¬
  const savedToken = sessionStorage.getItem('rkAdminToken');
  if (savedToken) { adminToken = savedToken; showMainPanel(); }
  document.getElementById('loginInput').focus();
</script>
</body>
</html>
