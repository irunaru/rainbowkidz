<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸŒˆ RainbowKidz Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    :root {
      --bg:#f2f2f7; --card:#fff; --text:#1c1c1e; --sub:#6e6e73; --border:#e5e5ea;
      --blue:#007aff; --green:#34c759; --orange:#ff9f0a; --red:#ff3b30; --purple:#af52de;
      --radius:16px;
    }
    body { font-family:'Noto Sans KR',-apple-system,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
    .hidden { display:none !important; }

    /* ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸ - ìƒë‹¨ ë°°ì¹˜ (ëª¨ë°”ì¼ í‚¤ë³´ë“œì— ì•ˆ ê°€ë¦¼) */
    #pwGate { position:fixed; inset:0; background:#fff; display:flex; align-items:flex-start; justify-content:center; z-index:9999; padding-top:60px; overflow-y:auto; }
    .pw-box   { text-align:center; padding:32px 28px; max-width:360px; width:90%; }
    .pw-logo  { font-size:48px; margin-bottom:12px; }
    .pw-title { font-size:20px; font-weight:900; margin-bottom:4px; }
    .pw-sub   { font-size:13px; color:var(--sub); margin-bottom:24px; }
    .pw-input { width:100%; padding:14px 18px; border:2px solid var(--border); border-radius:14px; font-size:20px; text-align:center; letter-spacing:6px; margin-bottom:10px; font-family:inherit; }
    .pw-input:focus { outline:none; border-color:var(--text); }
    .pw-btn   { width:100%; padding:14px; background:var(--text); color:#fff; border:none; border-radius:14px; font-size:16px; font-weight:800; cursor:pointer; font-family:inherit; margin-bottom:10px; }
    .pw-save  { display:flex; align-items:center; justify-content:center; gap:6px; font-size:13px; color:var(--sub); cursor:pointer; }
    .pw-save input { cursor:pointer; }
    .pw-error { margin-top:6px; font-size:13px; color:var(--red); min-height:18px; }

    /* í—¤ë” */
    .header { background:var(--card); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:100; }
    .header-inner { max-width:980px; margin:0 auto; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; }
    .logo       { display:flex; align-items:center; gap:8px; }
    .logo-main  { font-size:18px; font-weight:900; }
    .logo-badge { padding:3px 10px; background:var(--red); color:#fff; border-radius:20px; font-size:11px; font-weight:800; }
    .logout-btn { padding:7px 14px; border:1px solid var(--border); border-radius:20px; background:var(--bg); font-size:12px; color:var(--sub); cursor:pointer; font-family:inherit; }

    .container { max-width:980px; margin:0 auto; padding:16px 16px 80px; }

    /* ê¸€ë¡œë²Œ ë„êµ¬ ì¹´ë“œ (ê³µì§€ + ê²Œì‹œê¸€ê´€ë¦¬ + ê³µì§€ê´€ë¦¬) */
    .tools     { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:16px; }
    .tool-card { flex:1; min-width:240px; background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:16px; }
    .tool-title { font-size:14px; font-weight:900; margin-bottom:10px; }

    /* í¼ ìš”ì†Œ */
    .input, .textarea, .select {
      width:100%; padding:10px 12px; border:1.5px solid var(--border);
      border-radius:10px; font-size:14px; font-family:inherit; margin-bottom:8px;
    }
    .textarea { min-height:80px; resize:vertical; line-height:1.6; }
    .input:focus, .textarea:focus, .select:focus { outline:none; border-color:var(--blue); }

    /* ë²„íŠ¼ */
    .btn { padding:10px 16px; border-radius:10px; border:none; cursor:pointer; font-size:13px; font-weight:900; font-family:inherit; display:inline-flex; align-items:center; gap:6px; transition:opacity .15s; white-space:nowrap; }
    .btn:active   { opacity:.75; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .btn-ghost  { background:var(--bg); color:var(--text); border:1px solid var(--border); }
    .btn-blue   { background:var(--blue);   color:#fff; }
    .btn-green  { background:var(--green);  color:#fff; }
    .btn-purple { background:var(--purple); color:#fff; }
    .btn-red    { background:var(--red);    color:#fff; }
    .btn-sm     { padding:7px 12px; font-size:12px; }

    /* ìƒíƒœ ë©”ì‹œì§€ */
    .status { display:none; padding:10px 12px; border-radius:10px; font-size:13px; margin-top:8px; word-break:break-all; }
    .status.show    { display:block; }
    .status.info    { background:#dbeafe; color:#1e40af; }
    .status.success { background:#d1fae5; color:#065f46; }
    .status.error   { background:#fee2e2; color:#991b1b; }

    /* ê²Œì‹œê¸€/ê³µì§€ ê´€ë¦¬ ëª©ë¡ */
    .manage-list { max-height:240px; overflow-y:auto; }
    .manage-item { display:flex; align-items:flex-start; gap:10px; background:var(--bg); border-radius:12px; padding:10px; margin-bottom:8px; }
    .manage-emoji { font-size:20px; flex-shrink:0; }
    .manage-info  { flex:1; min-width:0; }
    .manage-title { font-size:13px; font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .manage-meta  { font-size:11px; color:var(--sub); margin-top:2px; }
    .manage-del   { padding:5px 9px; background:var(--red); color:#fff; border:none; border-radius:8px; font-size:11px; font-weight:700; cursor:pointer; font-family:inherit; flex-shrink:0; }

    /* â”€â”€ ìºë¦­í„° ê·¸ë¦¬ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .list-head { display:flex; align-items:center; gap:8px; margin-bottom:10px; }
    /* [Fix] ê²€ìƒ‰ì°½ ë„ˆë¹„ ê³ ì • - flex:1 ì œê±°í•˜ê³  max-width ì„¤ì • */
    .search-input { flex:1; min-width:0; max-width:320px; padding:10px 14px; border:1.5px solid var(--border); border-radius:10px; font-size:14px; font-family:inherit; }
    .search-input:focus { outline:none; border-color:var(--blue); }

    .char-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
    @media (min-width:520px) { .char-grid { grid-template-columns:repeat(6,1fr); } }
    @media (min-width:720px) { .char-grid { grid-template-columns:repeat(8,1fr); } }
    .char-tile { background:var(--card); border:1.5px solid var(--border); border-radius:14px; padding:10px 8px; cursor:pointer; text-align:center; transition:border-color .15s; }
    .char-tile:hover { border-color:var(--blue); }
    .char-emoji { font-size:26px; }
    .char-thumb { width:44px; height:44px; border-radius:10px; object-fit:cover; display:block; margin:0 auto; }
    .char-name  { font-size:11px; font-weight:900; color:var(--sub); margin-top:4px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .char-group { font-size:10px; color:var(--sub); opacity:.8; margin-top:1px; }

    /* ìºë¦­í„° íŒ¨ë„ ì˜¤ë²„ë ˆì´ */
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:flex-end; justify-content:center; z-index:2000; padding:10px; }
    .panel { width:100%; max-width:720px; background:var(--card); border-radius:20px; max-height:92vh; overflow-y:auto; border:1px solid var(--border); }
    .panel-head { position:sticky; top:0; background:var(--card); border-bottom:1px solid var(--border); padding:12px 16px; display:flex; align-items:center; gap:10px; border-radius:20px 20px 0 0; z-index:10; }
    .panel-emoji { font-size:28px; }
    .panel-name  { font-size:16px; font-weight:900; }
    .panel-sub   { font-size:12px; color:var(--sub); }
    .panel-close { margin-left:auto; border:1px solid var(--border); background:var(--bg); border-radius:12px; padding:8px 12px; cursor:pointer; font-weight:900; font-family:inherit; font-size:13px; }
    .panel-body  { padding:14px; }

    /* íŒ¨ë„ ë‚´ ì„¹ì…˜ */
    .section       { background:var(--bg); border:1px solid var(--border); border-radius:14px; padding:14px; margin-bottom:12px; }
    .section-title { font-size:13px; font-weight:900; margin-bottom:10px; }
    .row2 { display:grid; grid-template-columns:1fr 1fr;     gap:10px; margin-bottom:8px; }
    .row3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:8px; }
    @media (max-width:480px) { .row2, .row3 { grid-template-columns:1fr; } }
    .field label   { font-size:11px; font-weight:700; color:var(--sub); display:block; margin-bottom:4px; }
    .field .input,
    .field .select { margin-bottom:0; }

    /* ì´ë¯¸ì§€ í”„ë¦¬ë·° */
    .avatar-wrap { width:72px; height:72px; border-radius:18px; background:var(--card); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:34px; overflow:hidden; flex-shrink:0; }
    .avatar-wrap img { width:100%; height:100%; object-fit:cover; }

    /* AI ëŒ“ê¸€ìš© ê²Œì‹œê¸€ í”¼ì»¤ */
    .postpick { max-height:200px; overflow-y:auto; display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    .postitem         { background:var(--card); border:1.5px solid var(--border); border-radius:10px; padding:10px; cursor:pointer; transition:border-color .15s; }
    .postitem.selected { border-color:var(--blue); }
    .postitem-title   { font-size:13px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .postitem-meta    { font-size:11px; color:var(--sub); margin-top:2px; }

    /* ë²„íŠ¼ ë‚´ ìŠ¤í”¼ë„ˆ */
    .spin { display:inline-block; width:13px; height:13px; border:2px solid rgba(255,255,255,.4); border-top-color:#fff; border-radius:50%; animation:spn .8s linear infinite; }
    @keyframes spn { to { transform:rotate(360deg); } }
  </style>
</head>
<body>

<!-- ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸ -->
<div id="pwGate">
  <div class="pw-box">
    <div class="pw-logo">ğŸŒˆ</div>
    <div class="pw-title">ê´€ë¦¬ì ë¡œê·¸ì¸</div>
    <div class="pw-sub">RainbowKidz ê´€ë¦¬ì ì „ìš© í˜ì´ì§€</div>
    <input type="password" class="pw-input" id="pwInput" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" autocomplete="current-password">
    <button class="pw-btn" onclick="checkPw()">ì…ì¥í•˜ê¸°</button>
    <label class="pw-save"><input type="checkbox" id="pwSave"> ë¹„ë°€ë²ˆí˜¸ ê¸°ì–µí•˜ê¸°</label>
    <div class="pw-error" id="pwError"></div>
  </div>
</div>

<!-- í—¤ë” -->
<div class="header">
  <div class="header-inner">
    <div class="logo">
      <span style="font-size:24px;">ğŸŒˆ</span>
      <span class="logo-main">ë¬´ì§€ê°œ</span>
      <span class="logo-badge">ADMIN</span>
    </div>
    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</div>

<div class="container">

  <!-- ê¸€ë¡œë²Œ ë„êµ¬: ê³µì§€ ì‘ì„± / ê²Œì‹œê¸€ ê´€ë¦¬ / ê³µì§€ ê´€ë¦¬ -->
  <div class="tools">

    <!-- ê³µì§€ì‚¬í•­ ì‘ì„± (ì‘¤ê°ˆìŒˆ ê³ ì •) -->
    <div class="tool-card">
      <div class="tool-title">ğŸ“Œ ê³µì§€ì‚¬í•­ ì‘ì„± (ì‘¤ê°ˆìŒˆ ëª…ì˜)</div>
      <input class="input" id="noticeTitle" placeholder="ê³µì§€ ì œëª©">
      <textarea class="textarea" id="noticeBody" placeholder="ê³µì§€ ë‚´ìš©..."></textarea>

      <!-- ë¯¸ë””ì–´ ì²¨ë¶€ (ì´ë¯¸ì§€/ë™ì˜ìƒ/ìŒì•… í†µí•©) -->
      <div style="margin:10px 0 6px;font-size:13px;font-weight:700;color:var(--sub);">ğŸ“ ë¯¸ë””ì–´ ì²¨ë¶€ (ì„ íƒ)</div>
      <div style="margin-bottom:12px;">
        <div style="font-size:12px;color:var(--sub);margin-bottom:6px;">ì´ë¯¸ì§€Â·ë™ì˜ìƒÂ·ìŒì•… íŒŒì¼ ë˜ëŠ” URL (YouTube í¬í•¨)</div>
        <input type="file" id="noticeMediaFile" accept="image/*,video/*,audio/*" style="display:none;" onchange="uploadNoticeMedia()">
        <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
          <button class="btn btn-ghost btn-sm" onclick="document.getElementById('noticeMediaFile').click()">ğŸ“ íŒŒì¼ ì„ íƒ</button>
          <input class="input" id="noticeMediaUrl" placeholder="ë˜ëŠ” URL ì§ì ‘ ì…ë ¥ (YouTube, ì´ë¯¸ì§€ ë“±)" style="flex:1;min-width:180px;margin:0;" oninput="onNoticeUrlInput()">
          <button class="btn btn-ghost btn-sm" onclick="clearNoticeMedia()">âœ• ì œê±°</button>
        </div>
        <div id="noticeMediaStatus" style="font-size:12px;color:var(--sub);margin-top:4px;min-height:16px;"></div>
        <div id="noticeMediaPreview" style="margin-top:8px;"></div>
      </div>

      <button class="btn btn-blue" onclick="publishNotice()">ğŸ“Œ ê³µì§€ ë“±ë¡</button>
      <div class="status" id="noticeStatus"></div>
    </div>

    <!-- ê²Œì‹œê¸€ ê´€ë¦¬ -->
    <div class="tool-card">
      <div class="tool-title">ğŸ“‹ ê²Œì‹œê¸€ ê´€ë¦¬</div>
      <button class="btn btn-ghost btn-sm" onclick="loadManagePosts()" style="margin-bottom:10px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      <div class="manage-list" id="manageList">
        <div style="color:var(--sub);font-size:13px;">ë¡œë”© ì¤‘...</div>
      </div>
      <div class="status" id="manageStatus"></div>
    </div>

    <!-- ê³µì§€ ê´€ë¦¬ (ì‚­ì œ ê°€ëŠ¥) -->
    <div class="tool-card">
      <div class="tool-title">ğŸ—‘ï¸ ê³µì§€ ê´€ë¦¬</div>
      <button class="btn btn-ghost btn-sm" onclick="loadManageNotices()" style="margin-bottom:10px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      <div class="manage-list" id="manageNotices">
        <div style="color:var(--sub);font-size:13px;">ë¡œë”© ì¤‘...</div>
      </div>
      <div class="status" id="noticeManageStatus"></div>
    </div>

  </div>

  <!-- ìºë¦­í„° ê²€ìƒ‰ + ê·¸ë¦¬ë“œ -->
  <div class="list-head">
    <!-- [Fix] max-widthë¡œ ê²€ìƒ‰ì°½ ë„ˆë¹„ ì œí•œ â†’ ë²„íŠ¼ ê³µê°„ í™•ë³´ -->
    <input class="search-input" id="charSearch" placeholder="ìºë¦­í„° ê²€ìƒ‰..." oninput="renderGrid()">
    <button class="btn btn-ghost btn-sm" onclick="reloadAll()" style="flex-shrink:0;">ì „ì²´ ìƒˆë¡œê³ ì¹¨</button>
  </div>
  <div class="char-grid" id="charGrid">
    <div style="color:var(--sub);font-size:13px;grid-column:1/-1;">ë¡œë”© ì¤‘...</div>
  </div>

</div>

<!-- ìºë¦­í„° í”„ë¡œí•„ íŒ¨ë„ -->
<div id="overlay" class="overlay hidden" onclick="handleOverlayClick(event)">
  <div class="panel" onclick="event.stopPropagation()">

    <div class="panel-head">
      <div class="panel-emoji" id="pEmoji">ğŸ™‚</div>
      <div>
        <div class="panel-name" id="pName">ìºë¦­í„°</div>
        <div class="panel-sub"  id="pSub"></div>
      </div>
      <button class="panel-close" onclick="closePanel()">âœ• ë‹«ê¸°</button>
    </div>

    <div class="panel-body">

      <!-- â‘  ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
      <div class="section">
        <div class="section-title">ğŸ–¼ï¸ í”„ë¡œí•„ ì´ë¯¸ì§€</div>
        <div style="display:flex;align-items:center;gap:14px;">
          <div class="avatar-wrap" id="pAvatar">ğŸ™‚</div>
          <div style="flex:1;">
            <div style="font-size:12px;color:var(--sub);margin-bottom:10px;">Supabase Storageì— ì—…ë¡œë“œë©ë‹ˆë‹¤ (ìµœëŒ€ 5MB)</div>
            <input type="file" id="pImgFile" accept="image/*" style="display:none;" onchange="uploadImage()">
            <button class="btn btn-blue btn-sm" onclick="document.getElementById('pImgFile').click()">ğŸ“¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
            <div class="status" id="pImgStatus"></div>
          </div>
        </div>
      </div>

      <!-- â‘¡ AI ê²Œì‹œê¸€ ìƒì„± -->
      <!-- [Fix] ì„¹ì…˜ ìˆœì„œ ë³€ê²½: ì´ë¯¸ì§€ â†’ AIê²Œì‹œê¸€ â†’ AIëŒ“ê¸€ â†’ ìºë¦­í„°í¸ì§‘ -->
      <div class="section">
        <div class="section-title">âœ¨ AI ê²Œì‹œê¸€ ì œì•ˆ</div>
        <div style="font-size:12px;color:var(--sub);margin-bottom:10px;">AIê°€ ì´ ìºë¦­í„° ë§íˆ¬ë¡œ ì´ˆì•ˆì„ ì œì•ˆí•´ìš”. ì§ì ‘ ìˆ˜ì • í›„ ê²Œì‹œí•˜ì„¸ìš”!</div>
        <input class="input" id="aiTitle" placeholder="ì œëª© (AI ì œì•ˆ í›„ ì—¬ê¸°ì— ë‚˜íƒ€ë‚˜ìš”)">
        <textarea class="textarea" id="aiBody" placeholder="ë³¸ë¬¸ (AI ì œì•ˆ í›„ ì—¬ê¸°ì— ë‚˜íƒ€ë‚˜ìš” â€” ììœ ë¡­ê²Œ ìˆ˜ì •í•˜ì„¸ìš”)"></textarea>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-purple" id="btnGenPost"  onclick="generatePost()">ğŸ¤– AI ì œì•ˆ ë°›ê¸°</button>
          <button class="btn btn-green"  id="btnPubPost"  onclick="publishPost()">ğŸ“¤ ê²Œì‹œí•˜ê¸°</button>
          <button class="btn btn-ghost btn-sm" onclick="clearPost()">ì´ˆê¸°í™”</button>
        </div>
        <div class="status" id="aiPostStatus"></div>
      </div>

      <!-- â‘¢ AI ëŒ“ê¸€ ìƒì„± -->
      <div class="section">
        <div class="section-title">ğŸ’¬ AI ëŒ“ê¸€ ì œì•ˆ</div>
        <div style="font-size:12px;color:var(--sub);margin-bottom:8px;">ê²Œì‹œê¸€ì„ ì„ íƒí•˜ë©´ AIê°€ ì´ ìºë¦­í„° ë§íˆ¬ë¡œ ëŒ“ê¸€ ì´ˆì•ˆì„ ì œì•ˆí•´ìš”. ìˆ˜ì • í›„ ê²Œì‹œí•˜ì„¸ìš”!</div>
        <div class="postpick" id="postPicker">
          <div style="color:var(--sub);font-size:13px;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
        <textarea class="textarea" id="aiComment" placeholder="ëŒ“ê¸€ ë‚´ìš©..." style="min-height:60px;"></textarea>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-purple" id="btnGenComment" onclick="generateComment()">ğŸ¤– AI ì œì•ˆ ë°›ê¸°</button>
          <button class="btn btn-green"  id="btnPubComment" onclick="publishComment()">ğŸ“¤ ëŒ“ê¸€ ê²Œì‹œ</button>
          <button class="btn btn-ghost btn-sm" onclick="document.getElementById('aiComment').value=''">ì´ˆê¸°í™”</button>
        </div>
        <div class="status" id="aiCommentStatus"></div>
      </div>

      <!-- â‘£ ìºë¦­í„° ì •ë³´ í¸ì§‘ (ë§¨ ì•„ë˜ë¡œ ì´ë™) -->
      <div class="section">
        <div class="section-title">ğŸ‘¥ ìºë¦­í„° ì •ë³´ í¸ì§‘</div>

        <div class="row2">
          <div class="field"><label>ì´ë¦„ (display_name)</label><input class="input" id="fName"></div>
          <div class="field"><label>ì´ëª¨ì§€</label><input class="input" id="fEmoji"></div>
        </div>
        <div class="row3">
          <div class="field">
            <label>ì†Œì†</label>
            <select class="select" id="fGroup">
              <option value="kindergarten">ìœ ì¹˜ì›</option>
              <option value="daycare">ì–´ë¦°ì´ì§‘</option>
              <option value="teacher">ì„ ìƒë‹˜</option>
            </select>
          </div>
          <!-- ì„±ë³„: ììœ ì…ë ¥ (ì„ì¼í›„ = 'ê³ ì' ì§€ì›) -->
          <div class="field"><label>ì„±ë³„ (ììœ ì…ë ¥)</label><input class="input" id="fGender" placeholder="female, male, ê³ ì..."></div>
          <div class="field"><label>MBTI</label><input class="input" id="fMbti" placeholder="ENFP"></div>
        </div>
        <div class="row2">
          <div class="field"><label>ë™ë¬¼ì¢…ë¥˜ (animal_type)</label><input class="input" id="fAnimal"></div>
          <div class="field"><label>íŠ¹ì§• (personality)</label><input class="input" id="fPersonality"></div>
        </div>
        <div class="row2">
          <div class="field"><label>ìƒë…„ì›”ì¼</label><input class="input" type="date" id="fBirthday"></div>
          <div class="field"><label>ë‚˜ì´</label><input class="input" type="number" id="fAge" placeholder="3" min="0" max="20"></div>
        </div>
        <div class="row2">
          <div class="field"><label>ì¢‹ì•„í•˜ëŠ” ê²ƒ (likes)</label><input class="input" id="fLikes"></div>
          <div class="field"><label>ì‹«ì–´í•˜ëŠ” ê²ƒ (dislikes)</label><input class="input" id="fDislikes"></div>
        </div>
        <div class="row2">
          <div class="field"><label>ì·¨ë¯¸ (hobby)</label><input class="input" id="fHobby"></div>
          <div class="field"><label>ë¹„ë°€ (secret)</label><input class="input" id="fSecret"></div>
        </div>
        <div class="field" style="margin-bottom:12px;">
          <label>ë§íˆ¬ íŒíŠ¸ (speech_style) â€” AI ìƒì„± í”„ë¡¬í”„íŠ¸ì— ì‚¬ìš©ë©ë‹ˆë‹¤</label>
          <input class="input" id="fSpeech" placeholder="ë°ê³  ì¥ë‚œê¸° ë§ì€ ë§íˆ¬, ë¯¼ì´ˆ ë•í›„" style="margin-bottom:0;">
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-green" id="btnSave" onclick="saveProfile()">ğŸ’¾ ì €ì¥</button>
          <button class="btn btn-ghost btn-sm" onclick="resetForm()">ë˜ëŒë¦¬ê¸°</button>
        </div>
        <div class="status" id="pSaveStatus"></div>
      </div>

    </div><!-- /panel-body -->
  </div><!-- /panel -->
</div><!-- /overlay -->

<script>
  const API       = 'https://rainbowkidz-api.irunaru.workers.dev/api/v1';
  const ADMIN_KEY = 'yimkim1221';
  const PW        = 'yimkim1221';

  let characters    = [];
  let cachedFeed    = [];
  let selectedChar  = null;
  let selectedPostId = null;

  // â”€â”€ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const esc = s => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  const groupLabel = g => g === 'kindergarten' ? 'ìœ ì¹˜ì›' : g === 'daycare' ? 'ì–´ë¦°ì´ì§‘' : 'ì„ ìƒë‹˜';
  const relTime = d => {
    const s = (Date.now() - new Date(d)) / 1000;
    if (s < 60)    return 'ë°©ê¸ˆ';
    if (s < 3600)  return `${Math.floor(s / 60)}ë¶„ ì „`;
    if (s < 86400) return `${Math.floor(s / 3600)}ì‹œê°„ ì „`;
    return `${Math.floor(s / 86400)}ì¼ ì „`;
  };

  function showStatus(id, msg, type = 'info') {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = msg;
    el.className = `status show ${type}`;
    if (type !== 'info') setTimeout(() => el.classList.remove('show'), 6000);
  }

  async function adminFetch(path, opts = {}) {
    const headers = new Headers(opts.headers || {});
    headers.set('X-Admin-Key', ADMIN_KEY);
    if (!(opts.body instanceof FormData) && !headers.has('Content-Type')) {
      headers.set('Content-Type', 'application/json');
    }
    return fetch(API + path, { ...opts, headers });
  }

  // â”€â”€ ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // localStorageì— ì €ì¥ëœ ë¹„ë°€ë²ˆí˜¸ ìë™ ì±„ìš°ê¸°
  (function() {
    const saved = localStorage.getItem('rk_admin_pw');
    if (saved) {
      document.getElementById('pwInput').value = saved;
      document.getElementById('pwSave').checked = true;
    }
  })();

  function checkPw() {
    const val = document.getElementById('pwInput').value;
    if (val === PW) {
      // ì €ì¥ ì—¬ë¶€ì— ë”°ë¼ localStorage ì²˜ë¦¬
      if (document.getElementById('pwSave').checked) {
        localStorage.setItem('rk_admin_pw', val);
      } else {
        localStorage.removeItem('rk_admin_pw');
      }
      document.getElementById('pwGate').classList.add('hidden');
      sessionStorage.setItem('rk_admin', '1');
      init();
    } else {
      const errEl = document.getElementById('pwError');
      errEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ì–´ìš”';
      document.getElementById('pwInput').value = '';
      document.getElementById('pwInput').focus();
      setTimeout(() => { errEl.textContent = ''; }, 2000);
    }
  }
  function logout() {
    sessionStorage.removeItem('rk_admin');
    location.reload();
  }
  document.getElementById('pwInput').addEventListener('keypress', e => { if (e.key === 'Enter') checkPw(); });
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closePanel(); });
  // ì„¸ì…˜ ìœ ì§€ (íƒ­ ë‹«ê¸° ì „ê¹Œì§€)
  if (sessionStorage.getItem('rk_admin') === '1') {
    document.getElementById('pwGate').classList.add('hidden');
    window.addEventListener('DOMContentLoaded', init);
  }

  // â”€â”€ ì´ˆê¸° ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function init() {
    await loadCharacters();
    renderGrid();
    await Promise.all([loadManagePosts(), loadManageNotices(), loadFeed()]);
  }

  async function reloadAll() {
    await loadCharacters();
    renderGrid();
    await Promise.all([loadManagePosts(), loadManageNotices(), loadFeed()]);
    if (selectedChar) renderPostPicker();
  }

  async function loadCharacters() {
    try {
      const r = await fetch(API + '/characters');
      if (r.ok) {
        const d = await r.json();
        characters = d.characters?.length ? d.characters : MOCK_CHARS;
      } else { characters = MOCK_CHARS; }
    } catch { characters = MOCK_CHARS; }
  }

  async function loadFeed(limit = 30) {
    try {
      const r = await fetch(API + `/feed?limit=${limit}`);
      const d = await r.json();
      cachedFeed = d.posts || [];
    } catch { cachedFeed = []; }
  }

  // â”€â”€ ìºë¦­í„° ê·¸ë¦¬ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderGrid() {
    const q = (document.getElementById('charSearch').value || '').toLowerCase();
    const filtered = characters.filter(c =>
      !q || `${c.display_name} ${c.group_type} ${c.mbti || ''} ${c.animal_type || ''}`.toLowerCase().includes(q)
    );
    document.getElementById('charGrid').innerHTML = filtered.length
      ? filtered.map(c => {
          const avatar = c.image_url
            ? `<img class="char-thumb" src="${esc(c.image_url)}" alt="${esc(c.display_name)}" data-emoji="${esc(c.emoji||'ğŸ™‚')}" onerror="this.outerHTML='<div class=\'char-emoji\'>' + this.dataset.emoji + '</div>'">`
            : `<div class="char-emoji">${esc(c.emoji || 'ğŸ™‚')}</div>`;
          return `<div class="char-tile" onclick="openPanel(${c.id})">
            ${avatar}
            <div class="char-name">${esc(c.display_name)}</div>
            <div class="char-group">${groupLabel(c.group_type)} Â· ${esc(c.mbti || '')}</div>
          </div>`;
        }).join('')
      : '<div style="color:var(--sub);font-size:13px;grid-column:1/-1;">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
  }

  // â”€â”€ íŒ¨ë„ ì—´ê¸°/ë‹«ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function handleOverlayClick(e) { if (e.target.id === 'overlay') closePanel(); }
  function closePanel() {
    document.getElementById('overlay').classList.add('hidden');
    selectedChar = null;
    selectedPostId = null;
  }

  async function openPanel(charId) {
    const c = characters.find(x => x.id == charId);
    if (!c) return;
    selectedChar   = c;
    selectedPostId = null;

    document.getElementById('pEmoji').textContent = c.emoji || 'ğŸ™‚';
    document.getElementById('pName').textContent  = c.display_name;
    document.getElementById('pSub').textContent   = `${groupLabel(c.group_type)} Â· ${c.animal_type || ''} Â· ${c.mbti || ''}`;

    const av = document.getElementById('pAvatar');
    if (c.image_url) {
      av.innerHTML = `<img src="${esc(c.image_url)}" alt="${esc(c.display_name)}" data-emoji="${esc(c.emoji || 'ğŸ™‚')}" onerror="this.parentElement.removeChild(this);this.parentElement.textContent=this.dataset.emoji">`;
    } else {
      av.textContent = c.emoji || 'ğŸ™‚';
    }

    fillForm(c);
    clearPost();
    document.getElementById('aiComment').value = '';
    ['pImgStatus','pSaveStatus','aiPostStatus','aiCommentStatus'].forEach(id => {
      const el = document.getElementById(id);
      el.textContent = '';
      el.className = 'status';
    });

    // ìºì‹œì— í”¼ë“œê°€ ì—†ì„ ë•Œë§Œ ìƒˆë¡œ ë¡œë“œ
    if (!cachedFeed.length) await loadFeed(30);
    renderPostPicker();

    document.getElementById('overlay').classList.remove('hidden');
    document.getElementById('aiTitle').focus();
  }

  function fillForm(c) {
    document.getElementById('fName').value        = c.display_name || '';
    document.getElementById('fEmoji').value       = c.emoji        || '';
    document.getElementById('fGroup').value       = c.group_type   || 'kindergarten';
    document.getElementById('fGender').value      = c.gender       || '';
    document.getElementById('fMbti').value        = c.mbti         || '';
    document.getElementById('fAnimal').value      = c.animal_type  || '';
    document.getElementById('fPersonality').value = c.personality  || '';
    document.getElementById('fBirthday').value    = c.birthday     || '';
    document.getElementById('fAge').value         = c.age          != null ? c.age : '';
    document.getElementById('fLikes').value       = c.likes        || '';
    document.getElementById('fDislikes').value    = c.dislikes     || '';
    document.getElementById('fHobby').value       = c.hobby        || '';
    document.getElementById('fSecret').value      = c.secret       || '';
    document.getElementById('fSpeech').value      = c.speech_style || '';
  }

  function resetForm() {
    if (selectedChar) { fillForm(selectedChar); showStatus('pSaveStatus', 'ë˜ëŒë ¸ìŠµë‹ˆë‹¤', 'info'); }
  }

  // â”€â”€ ìºë¦­í„° ì €ì¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function saveProfile() {
    if (!selectedChar) return;
    const update = {
      display_name: document.getElementById('fName').value.trim(),
      emoji:        document.getElementById('fEmoji').value.trim(),
      group_type:   document.getElementById('fGroup').value,
      gender:       document.getElementById('fGender').value.trim(),
      mbti:         document.getElementById('fMbti').value.trim(),
      animal_type:  document.getElementById('fAnimal').value.trim(),
      personality:  document.getElementById('fPersonality').value.trim(),
      birthday:     document.getElementById('fBirthday').value || null,
      age:          document.getElementById('fAge').value !== '' ? Number(document.getElementById('fAge').value) : null,
      likes:        document.getElementById('fLikes').value.trim(),
      dislikes:     document.getElementById('fDislikes').value.trim(),
      hobby:        document.getElementById('fHobby').value.trim(),
      secret:       document.getElementById('fSecret').value.trim(),
      speech_style: document.getElementById('fSpeech').value.trim(),
    };
    const btn = document.getElementById('btnSave');
    btn.disabled = true; btn.innerHTML = '<span class="spin"></span> ì €ì¥ì¤‘';
    showStatus('pSaveStatus', 'ì €ì¥ ì¤‘...', 'info');
    try {
      const r = await adminFetch(`/admin/characters/${selectedChar.id}`, { method:'PATCH', body:JSON.stringify(update) });
      const d = await r.json();
      if (d.ok) {
        Object.assign(selectedChar, update);
        document.getElementById('pEmoji').textContent = update.emoji || 'ğŸ™‚';
        document.getElementById('pName').textContent  = update.display_name;
        document.getElementById('pSub').textContent   = `${groupLabel(update.group_type)} Â· ${update.animal_type || ''} Â· ${update.mbti || ''}`;
        renderGrid();
        showStatus('pSaveStatus', 'âœ… ì €ì¥ ì™„ë£Œ', 'success');
      } else { showStatus('pSaveStatus', `âŒ ${d.error}`, 'error'); }
    } catch (e) { showStatus('pSaveStatus', `âŒ ${e.message}`, 'error'); }
    btn.disabled = false; btn.innerHTML = 'ğŸ’¾ ì €ì¥';
  }

  // â”€â”€ ì´ë¯¸ì§€ ì—…ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function uploadImage() {
    if (!selectedChar) return;
    const input = document.getElementById('pImgFile');
    const file  = input.files?.[0];
    if (!file) return;
    if (file.size > 5 * 1024 * 1024) {
      showStatus('pImgStatus', 'âŒ 5MB ì´í•˜ ì´ë¯¸ì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
      input.value = ''; return;
    }
    showStatus('pImgStatus', 'ì—…ë¡œë“œ ì¤‘...', 'info');
    const form = new FormData();
    form.append('image', file);
    form.append('character_id', selectedChar.id);
    try {
      const r = await fetch(API + '/admin/upload-image', {
        method: 'POST', headers: { 'X-Admin-Key': ADMIN_KEY }, body: form,
      });
      const d = await r.json();
      if (d.ok) {
        selectedChar.image_url = d.image_url;
        const av = document.getElementById('pAvatar');
        av.innerHTML = `<img src="${esc(d.image_url)}" alt="">`;
        renderGrid();
        showStatus('pImgStatus', 'âœ… ì—…ë¡œë“œ ì™„ë£Œ', 'success');
      } else { showStatus('pImgStatus', `âŒ ${d.error}`, 'error'); }
    } catch (e) { showStatus('pImgStatus', `âŒ ${e.message}`, 'error'); }
    input.value = '';
  }

  // â”€â”€ ê³µì§€ ë¯¸ë””ì–´ (í†µí•©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let noticeMediaUrl = null; // ìµœì¢… ì €ì¥ë  URL

  // íŒŒì¼ íƒ€ì… ê°ì§€ (MIME íƒ€ì… ê¸°ë°˜)
  function detectFileType(file) {
    const t = file.type || '';
    if (t.startsWith('image/')) return 'image';
    if (t.startsWith('video/')) return 'video';
    if (t.startsWith('audio/')) return 'audio';
    return 'file';
  }

  // URL íƒ€ì… ê°ì§€ (í™•ì¥ì ê¸°ë°˜)
  function detectUrlType(url) {
    if (!url) return null;
    const u = url.toLowerCase().split('?')[0];
    if (/\.(jpg|jpeg|png|gif|webp|avif|svg)$/.test(u)) return 'image';
    if (/\.(mp4|webm|mov|avi|mkv)$/.test(u)) return 'video';
    if (/\.(mp3|wav|ogg|m4a|aac|flac)$/.test(u)) return 'audio';
    if (/youtube\.com|youtu\.be/.test(url)) return 'youtube';
    return 'link';
  }

  function renderAdminPreview(type, url) {
    if (type === 'image')   return `<img src="${esc(url)}" style="max-width:100%;max-height:200px;border-radius:10px;display:block;">`;
    if (type === 'video')   return `<video src="${esc(url)}" controls style="max-width:100%;max-height:200px;border-radius:10px;display:block;"></video>`;
    if (type === 'audio')   return `<audio src="${esc(url)}" controls style="width:100%;border-radius:8px;"></audio>`;
    if (type === 'youtube') {
      const m = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
      if (m) return `<div style="position:relative;padding-top:56.25%;border-radius:10px;overflow:hidden;"><iframe src="https://www.youtube.com/embed/${m[1]}" style="position:absolute;inset:0;width:100%;height:100%;border:none;" allowfullscreen></iframe></div>`;
    }
    return `<a href="${esc(url)}" target="_blank" rel="noopener" style="font-size:13px;color:#007aff;">ğŸ”— ${esc(url)}</a>`;
  }

  // íŒŒì¼ ì—…ë¡œë“œ
  async function uploadNoticeMedia() {
    const file = document.getElementById('noticeMediaFile').files[0];
    if (!file) return;
    if (file.size > 50 * 1024 * 1024) {
      document.getElementById('noticeMediaStatus').textContent = 'âŒ 50MB ì´í•˜ íŒŒì¼ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤';
      document.getElementById('noticeMediaFile').value = '';
      return;
    }
    const ftype = detectFileType(file);
    // ë¡œì»¬ ë¯¸ë¦¬ë³´ê¸° ì¦‰ì‹œ í‘œì‹œ
    const localUrl = URL.createObjectURL(file);
    document.getElementById('noticeMediaPreview').innerHTML = renderAdminPreview(ftype, localUrl);
    document.getElementById('noticeMediaStatus').textContent = 'â³ ì—…ë¡œë“œ ì¤‘...';
    document.getElementById('noticeMediaUrl').value = '';
    noticeMediaUrl = null;

    try {
      const form = new FormData();
      form.append('file', file);
      form.append('type', ftype);
      const r = await adminFetch('/admin/upload-media', { method: 'POST', body: form });
      const d = await r.json();
      if (d.ok) {
        noticeMediaUrl = d.url;
        document.getElementById('noticeMediaUrl').value = d.url;
        document.getElementById('noticeMediaStatus').textContent = 'âœ… ì—…ë¡œë“œ ì™„ë£Œ';
        document.getElementById('noticeMediaPreview').innerHTML = renderAdminPreview(ftype, d.url);
      } else {
        document.getElementById('noticeMediaStatus').textContent = `âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${d.error}`;
        noticeMediaUrl = null;
      }
    } catch (e) {
      document.getElementById('noticeMediaStatus').textContent = `âŒ ${e.message}`;
      noticeMediaUrl = null;
    }
    document.getElementById('noticeMediaFile').value = '';
  }

  // URL ì§ì ‘ ì…ë ¥ ì‹œ ë¯¸ë¦¬ë³´ê¸°
  function onNoticeUrlInput() {
    const url = document.getElementById('noticeMediaUrl').value.trim();
    if (!url) { clearNoticeMedia(); return; }
    const utype = detectUrlType(url);
    noticeMediaUrl = url;
    document.getElementById('noticeMediaStatus').textContent = `ğŸ“ ${utype === 'youtube' ? 'YouTube' : utype} ë§í¬`;
    document.getElementById('noticeMediaPreview').innerHTML = renderAdminPreview(utype, url);
  }

  // ë¯¸ë””ì–´ ì œê±°
  function clearNoticeMedia() {
    noticeMediaUrl = null;
    document.getElementById('noticeMediaUrl').value = '';
    document.getElementById('noticeMediaFile').value = '';
    document.getElementById('noticeMediaPreview').innerHTML = '';
    document.getElementById('noticeMediaStatus').textContent = '';
  }

  // â”€â”€ ê³µì§€ì‚¬í•­ ì‘ì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function publishNotice() {
    const title = document.getElementById('noticeTitle').value.trim();
    const body  = document.getElementById('noticeBody').value.trim();
    if (!title) { showStatus('noticeStatus', 'ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
    if (!body)  { showStatus('noticeStatus', 'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
    const teacher = characters.find(c => c.group_type === 'teacher');
    if (!teacher) { showStatus('noticeStatus', 'âŒ ì„ ìƒë‹˜ ìºë¦­í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”', 'error'); return; }

    // URL ì…ë ¥ë€ê³¼ ì—…ë¡œë“œ ê²°ê³¼ ëª¨ë‘ í™•ì¸
    const mediaUrl = noticeMediaUrl || document.getElementById('noticeMediaUrl').value.trim() || null;

    showStatus('noticeStatus', 'ë“±ë¡ ì¤‘...', 'info');
    try {
      const r = await adminFetch('/system/posts', {
        method: 'POST',
        body: JSON.stringify({
          system_user_id: teacher.id, title, body, is_notice: true,
          media_url: mediaUrl,
        }),
      });
      const d = await r.json();
      if (d.ok) {
        document.getElementById('noticeTitle').value = '';
        document.getElementById('noticeBody').value  = '';
        clearNoticeMedia();
        showStatus('noticeStatus', 'âœ… ê³µì§€ ë“±ë¡ ì™„ë£Œ!', 'success');
        loadManageNotices();
      } else { showStatus('noticeStatus', `âŒ ${d.error}`, 'error'); }
    } catch (e) { showStatus('noticeStatus', `âŒ ${e.message}`, 'error'); }
  }

  // â”€â”€ ê²Œì‹œê¸€ ê´€ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadManagePosts() {
    const wrap = document.getElementById('manageList');
    wrap.innerHTML = '<div style="color:var(--sub);font-size:13px;">ë¡œë”© ì¤‘...</div>';
    await loadFeed(30);
    if (!cachedFeed.length) {
      wrap.innerHTML = '<div style="color:var(--sub);font-size:13px;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      return;
    }
    wrap.innerHTML = cachedFeed.map(p => `
      <div class="manage-item" id="mpost-${p.id}">
        <div class="manage-emoji">${esc(p.character_emoji || 'ğŸ‘¤')}</div>
        <div class="manage-info">
          <div class="manage-title">${esc(p.title || p.body?.slice(0, 40) || 'ì œëª©ì—†ìŒ')}</div>
          <div class="manage-meta">${esc(p.character_name || 'ìµëª…')} Â· ì•¼ë¥´ ${p.yar_count || 0} Â· ëŒ“ê¸€ ${p.comment_count || 0} Â· ${relTime(p.created_at)}</div>
        </div>
        <button class="manage-del" onclick="deletePost(${p.id})">ì‚­ì œ</button>
      </div>`).join('');
  }

  async function deletePost(postId) {
    if (!confirm('ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí• ê¹Œìš”?')) return;
    try {
      const r = await adminFetch(`/admin/posts/${postId}`, { method: 'DELETE' });
      const d = await r.json();
      if (d.ok) {
        document.getElementById(`mpost-${postId}`)?.remove();
        cachedFeed = cachedFeed.filter(p => p.id !== postId);
        if (selectedChar) renderPostPicker();
        showStatus('manageStatus', 'âœ… ì‚­ì œ ì™„ë£Œ', 'success');
      } else { showStatus('manageStatus', `âŒ ${d.error}`, 'error'); }
    } catch (e) { showStatus('manageStatus', `âŒ ${e.message}`, 'error'); }
  }

  // â”€â”€ ê³µì§€ ê´€ë¦¬ (ì‚­ì œ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadManageNotices() {
    const wrap = document.getElementById('manageNotices');
    wrap.innerHTML = '<div style="color:var(--sub);font-size:13px;">ë¡œë”© ì¤‘...</div>';
    try {
      const r = await adminFetch('/admin/notices?limit=20');
      const d = await r.json();
      if (!d.notices?.length) {
        wrap.innerHTML = '<div style="color:var(--sub);font-size:13px;">ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }
      wrap.innerHTML = d.notices.map(n => `
        <div class="manage-item" id="mnotice-${n.id}">
          <div class="manage-emoji">ğŸ“Œ</div>
          <div class="manage-info">
            <div class="manage-title">${esc(n.title || 'ì œëª©ì—†ìŒ')}</div>
            <div class="manage-meta">${esc(n.system_users?.display_name || '')} Â· ${relTime(n.created_at)}</div>
          </div>
          <button class="manage-del" onclick="deleteNotice(${n.id})">ì‚­ì œ</button>
        </div>`).join('');
    } catch (e) {
      wrap.innerHTML = `<div style="color:var(--sub);font-size:13px;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e.message}</div>`;
    }
  }

  async function deleteNotice(postId) {
    if (!confirm('ì´ ê³µì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
    try {
      const r = await adminFetch(`/admin/posts/${postId}`, { method: 'DELETE' });
      const d = await r.json();
      if (d.ok) {
        document.getElementById(`mnotice-${postId}`)?.remove();
        showStatus('noticeManageStatus', 'âœ… ê³µì§€ ì‚­ì œ ì™„ë£Œ', 'success');
      } else { showStatus('noticeManageStatus', `âŒ ${d.error}`, 'error'); }
    } catch (e) { showStatus('noticeManageStatus', `âŒ ${e.message}`, 'error'); }
  }

  // â”€â”€ AI ê²Œì‹œê¸€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function clearPost() {
    document.getElementById('aiTitle').value = '';
    document.getElementById('aiBody').value  = '';
  }

  async function generatePost() {
    if (!selectedChar) { alert('ìºë¦­í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
    const btn = document.getElementById('btnGenPost');
    btn.disabled = true; btn.innerHTML = '<span class="spin"></span> ìƒì„±ì¤‘';
    showStatus('aiPostStatus', `${selectedChar.display_name} ê¸€ ìƒì„± ì¤‘...`, 'info');
    try {
      const r = await adminFetch('/admin/generate-post', {
        method: 'POST', body: JSON.stringify({ character_id: selectedChar.id }),
      });
      const d = await r.json();
      if (d.ok) {
        document.getElementById('aiTitle').value = d.title || '';
        document.getElementById('aiBody').value  = d.body  || '';
        showStatus('aiPostStatus', 'âœ… AI ì œì•ˆ ì™„ë£Œ! ììœ ë¡­ê²Œ ìˆ˜ì • í›„ ê²Œì‹œí•˜ì„¸ìš” âœï¸', 'success');
      } else {
        // [Fix] ì‹¤ì œ Gemini ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
        showStatus('aiPostStatus', `âŒ ${d.error}`, 'error');
      }
    } catch (e) { showStatus('aiPostStatus', `âŒ ${e.message}`, 'error'); }
    btn.disabled = false; btn.innerHTML = 'âœ¨ ìƒì„±';
  }

  async function publishPost() {
    if (!selectedChar) { alert('ìºë¦­í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
    const title = document.getElementById('aiTitle').value.trim();
    const body  = document.getElementById('aiBody').value.trim();
    if (!title) { showStatus('aiPostStatus', 'ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
    if (!body)  { showStatus('aiPostStatus', 'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
    const btn = document.getElementById('btnPubPost');
    btn.disabled = true; btn.innerHTML = '<span class="spin"></span> ê²Œì‹œì¤‘';
    showStatus('aiPostStatus', 'ê²Œì‹œ ì¤‘...', 'info');
    try {
      const r = await adminFetch('/system/posts', {
        method: 'POST', body: JSON.stringify({ system_user_id: selectedChar.id, title, body }),
      });
      const d = await r.json();
      if (d.ok) {
        showStatus('aiPostStatus', 'âœ… ê²Œì‹œ ì™„ë£Œ', 'success');
        clearPost();
        await loadFeed(30); renderPostPicker(); loadManagePosts();
      } else { showStatus('aiPostStatus', `âŒ ${d.error}`, 'error'); }
    } catch (e) { showStatus('aiPostStatus', `âŒ ${e.message}`, 'error'); }
    btn.disabled = false; btn.innerHTML = 'ğŸ“¤ ê²Œì‹œ';
  }

  // â”€â”€ ê²Œì‹œê¸€ í”¼ì»¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderPostPicker() {
    const wrap = document.getElementById('postPicker');
    if (!cachedFeed.length) {
      wrap.innerHTML = '<div style="color:var(--sub);font-size:13px;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      return;
    }
    wrap.innerHTML = cachedFeed.map(p => `
      <div class="postitem ${String(selectedPostId) === String(p.id) ? 'selected' : ''}" onclick="selectPost(${p.id})">
        <div class="postitem-title">${esc((p.character_emoji || 'ğŸ‘¤') + ' ' + (p.title || p.body?.slice(0, 30) || 'ì œëª©ì—†ìŒ'))}</div>
        <div class="postitem-meta">${esc(p.character_name || 'ìµëª…')} Â· ëŒ“ê¸€ ${p.comment_count || 0}</div>
      </div>`).join('');
  }

  function selectPost(id) { selectedPostId = id; renderPostPicker(); }

  // â”€â”€ AI ëŒ“ê¸€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function generateComment() {
    if (!selectedChar)   { showStatus('aiCommentStatus', 'ìºë¦­í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');  return; }
    if (!selectedPostId) { showStatus('aiCommentStatus', 'ê²Œì‹œê¸€ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error'); return; }
    const btn = document.getElementById('btnGenComment');
    btn.disabled = true; btn.innerHTML = '<span class="spin"></span> ìƒì„±ì¤‘';
    showStatus('aiCommentStatus', 'ëŒ“ê¸€ ìƒì„± ì¤‘...', 'info');
    try {
      const r = await adminFetch('/admin/generate-comment', {
        method: 'POST', body: JSON.stringify({ post_id: selectedPostId, character_id: selectedChar.id }),
      });
      const d = await r.json();
      if (d.ok) {
        document.getElementById('aiComment').value = d.comment || '';
        showStatus('aiCommentStatus', 'âœ… AI ì œì•ˆ ì™„ë£Œ! ìˆ˜ì • í›„ ê²Œì‹œí•˜ì„¸ìš” âœï¸', 'success');
      } else {
        // [Fix] ì‹¤ì œ Gemini ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
        showStatus('aiCommentStatus', `âŒ ${d.error}`, 'error');
      }
    } catch (e) { showStatus('aiCommentStatus', `âŒ ${e.message}`, 'error'); }
    btn.disabled = false; btn.innerHTML = 'âœ¨ ëŒ“ê¸€ ìƒì„±';
  }

  async function publishComment() {
    if (!selectedChar)   { showStatus('aiCommentStatus', 'ìºë¦­í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');  return; }
    if (!selectedPostId) { showStatus('aiCommentStatus', 'ê²Œì‹œê¸€ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error'); return; }
    const body = document.getElementById('aiComment').value.trim();
    if (!body) { showStatus('aiCommentStatus', 'ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
    const btn = document.getElementById('btnPubComment');
    btn.disabled = true; btn.innerHTML = '<span class="spin"></span> ê²Œì‹œì¤‘';
    showStatus('aiCommentStatus', 'ê²Œì‹œ ì¤‘...', 'info');
    try {
      const r = await adminFetch('/admin/system-comment', {
        method: 'POST', body: JSON.stringify({ post_id: selectedPostId, system_user_id: selectedChar.id, body }),
      });
      const d = await r.json();
      if (d.ok) {
        document.getElementById('aiComment').value = '';
        showStatus('aiCommentStatus', 'âœ… ëŒ“ê¸€ ê²Œì‹œ ì™„ë£Œ', 'success');
        await loadFeed(30); renderPostPicker(); loadManagePosts();
      } else { showStatus('aiCommentStatus', `âŒ ${d.error}`, 'error'); }
    } catch (e) { showStatus('aiCommentStatus', `âŒ ${e.message}`, 'error'); }
    btn.disabled = false; btn.innerHTML = 'ğŸ“¤ ëŒ“ê¸€ ê²Œì‹œ';
  }

  // â”€â”€ MOCK ë°ì´í„° (API ì‹¤íŒ¨ ì‹œ í´ë°±) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const MOCK_CHARS = [
    {id:1,  display_name:'ì„ì¼í›„',   emoji:'ğŸ¦†', group_type:'kindergarten', animal_type:'ì˜¤ë¦¬',     gender:'ê³ ì',   mbti:'ENTP',   speech_style:'ì•„ì´ëŒ ì´ì•¼ê¸°ë¥¼ ìì£¼í•˜ëŠ” í¸ì•ˆí•œ ë§íˆ¬'},
    {id:2,  display_name:'ì¨©êµ¬ë¦¬',   emoji:'ğŸ¸', group_type:'kindergarten', animal_type:'ê°œêµ¬ë¦¬',   gender:'female', mbti:'ESTP',   speech_style:'í™œë°œí•˜ê³  ê²Œì„ ì´ì•¼ê¸° ë§ì´ í•¨'},
    {id:3,  display_name:'ì¨©ê·œë¦¬',   emoji:'ğŸ¸', group_type:'kindergarten', animal_type:'ê°œêµ¬ë¦¬',   gender:'female', mbti:'ENFP',   speech_style:'ì¥ë‚œìŠ¤ëŸ½ê³  ì¬ë¯¸ìˆëŠ” ë§íˆ¬'},
    {id:4,  display_name:'ë£¨í”¼',     emoji:'ğŸ¦«', group_type:'kindergarten', animal_type:'ë¹„ë²„',     gender:'male',   mbti:'INTP',   speech_style:'ì°¨ë¶„í•˜ì§€ë§Œ ê±¸ê·¸ë£¹ ì´ì•¼ê¸°ë§Œ ë‚˜ì˜¤ë©´ ì‹ ë‚¨'},
    {id:5,  display_name:'ì•¼ì½”',     emoji:'ğŸ·', group_type:'kindergarten', animal_type:'ë¼ì§€',     gender:'male',   mbti:'ENFP',   speech_style:'ë°ê³  ì¥ë‚œê¸° ë§ì€ ë§íˆ¬ ë¯¼ì´ˆ ë•í›„'},
    {id:6,  display_name:'ìš°ì‚¬ê¸°',   emoji:'ğŸ°', group_type:'kindergarten', animal_type:'í† ë¼',     gender:'female', mbti:'ISTP',   speech_style:'ì§„ì§€í•˜ê³  ê³µë¶€ ì´ì•¼ê¸°ë§Œ í•¨'},
    {id:7,  display_name:'ì¨©ë‹´ê³°',   emoji:'ğŸ»', group_type:'kindergarten', animal_type:'ê³°',       gender:'female', mbti:'ISTJ',   speech_style:'ë˜‘ë˜‘í•œ ì²™í•˜ëŠ” ë§íˆ¬'},
    {id:8,  display_name:'ì¨©ë¹¤ì®¸',   emoji:'ğŸ°', group_type:'kindergarten', animal_type:'í† ë¼',     gender:'female', mbti:'ENFP',   speech_style:'íŒ¬í‹° ì´ì•¼ê¸°ë¥¼ ìì£¼í•˜ëŠ” ê·€ì—¬ìš´ ë§íˆ¬'},
    {id:9,  display_name:'ì¨©ì„¤',     emoji:'ğŸ¯', group_type:'kindergarten', animal_type:'í˜¸ë‘ì´',   gender:'female', mbti:'ENFP',   speech_style:'ìš´ë™ ì´ì•¼ê¸°ë¥¼ ì¢‹ì•„í•˜ëŠ” í™œë°œí•œ ë§íˆ¬'},
    {id:10, display_name:'ì¹˜ì´ì¹´ì™€', emoji:'ğŸ»', group_type:'kindergarten', animal_type:'ê³°',       gender:'female', mbti:'ENFP',   speech_style:'ìš”ì¿ ë¥´íŠ¸ ì´ì•¼ê¸°ë¥¼ ìì£¼í•˜ëŠ” ê·€ì—¬ìš´ ë§íˆ¬'},
    {id:11, display_name:'í•˜ì¹˜ì™€ë ˆ', emoji:'ğŸ±', group_type:'kindergarten', animal_type:'ê³ ì–‘ì´',   gender:'female', mbti:'ENFP',   speech_style:'ê·€ì—½ê³  ë°ì€ ë§íˆ¬'},
    {id:12, display_name:'ì¨©ë¬¸ì–´',   emoji:'ğŸ™', group_type:'kindergarten', animal_type:'ë°˜ì „ë¬¸ì–´', gender:'female', mbti:'ENFP',   speech_style:'ë°ê³  ê¸ì •ì ì¸ ë§íˆ¬'},
    {id:13, display_name:'ì¨©ìŠ',     emoji:'ğŸ¦§', group_type:'kindergarten', animal_type:'ì˜¤ë‘ìš°íƒ„', gender:'female', mbti:'ENFP',   speech_style:'ë¨¹ëŠ” ê²ƒê³¼ ë¦¬ë“¬ì²´ì¡° ì´ì•¼ê¸°ë¥¼ ì¢‹ì•„í•¨'},
    {id:14, display_name:'ì¨©ì†¡',     emoji:'ğŸ¦§', group_type:'kindergarten', animal_type:'ì˜¤ë‘ìš°íƒ„', gender:'female', mbti:'ENFP',   speech_style:'ë…¸ë˜ì™€ ë®¤ì§€ì»¬ ì´ì•¼ê¸°ë¥¼ ì¢‹ì•„í•¨'},
    {id:15, display_name:'ë£¹í¬',     emoji:'ğŸ¦«', group_type:'daycare',      animal_type:'ë¹„ë²„',     gender:'female', mbti:'ENFP',   speech_style:'ì¹˜í‚¨ ì´ì•¼ê¸°ì™€ ê¶Œíˆ¬ ì´ì•¼ê¸°ë¥¼ ì¢‹ì•„í•¨'},
    {id:16, display_name:'ë¤‚ì´',     emoji:'ğŸ¦«', group_type:'daycare',      animal_type:'ë¹„ë²„',     gender:'female', mbti:'ESTJ',   speech_style:'ìŒì ˆê³¤ê³¼ ë¬´ìˆ  ì´ì•¼ê¸°ë¥¼ ì¢‹ì•„í•¨'},
    {id:17, display_name:'ì‚¬ë™',     emoji:'ğŸ·', group_type:'daycare',      animal_type:'ë¼ì§€',     gender:'male',   mbti:'ENFP',   speech_style:'ë°±ì„¤ì´ì™€ ìœ íŠœë¸Œ ì´ì•¼ê¸°ë¥¼ ìì£¼ í•¨'},
    {id:18, display_name:'ì¨©ë§Œë“€',   emoji:'ğŸ™', group_type:'daycare',      animal_type:'ë°˜ì „ë¬¸ì–´', gender:'female', mbti:'ISTP',   speech_style:'ê¹¨ë—í•œ ê²ƒì„ ì¢‹ì•„í•˜ê³  ê·¸ë¦¼ ì´ì•¼ê¸°ë¥¼ í•¨'},
    {id:19, display_name:'ì¨©ë§Œì¥¬',   emoji:'ğŸ™', group_type:'daycare',      animal_type:'ë°˜ì „ë¬¸ì–´', gender:'female', mbti:'ISTP',   speech_style:'ë¨¹ëŠ” ì´ì•¼ê¸°ë¥¼ ìì£¼í•˜ëŠ” ê·€ì—¬ìš´ ë§íˆ¬'},
    {id:20, display_name:'ì¨©ë¬´ë„ˆ',   emoji:'ğŸ™', group_type:'daycare',      animal_type:'ë°˜ì „ë¬¸ì–´', gender:'female', mbti:'ISTP',   speech_style:'ëŠ˜ ë†€ê³  ì‹¶ì–´í•˜ëŠ” í™œë°œí•œ ë§íˆ¬'},
    {id:21, display_name:'ì¨©ì„œë¹ˆ',   emoji:'ğŸ¦›', group_type:'daycare',      animal_type:'ë² ë êµ¬ì–´', gender:'female', mbti:'ENFP',   speech_style:'ì• ê¸° ê°™ì€ ê·€ì—¬ìš´ ë§íˆ¬'},
    {id:22, display_name:'ì¨©í¬ìš©',   emoji:'ğŸ¶', group_type:'daycare',      animal_type:'ê°•ì•„ì§€',   gender:'female', mbti:'ENFP',   speech_style:'ë³µì‹±ê³¼ íŒ¨ê¸° ì´ì•¼ê¸°ë¥¼ ì¢‹ì•„í•˜ëŠ” í™œë°œí•œ ë§íˆ¬'},
    {id:23, display_name:'ì¨©ì„¸ë¹ˆ',   emoji:'ğŸ¦›', group_type:'daycare',      animal_type:'ë² ë êµ¬ì–´', gender:'female', mbti:'ENFP',   speech_style:'ìê¸°ê°€ ì„¸ë‹¤ê³  ìƒê°í•˜ëŠ” ê·€ì—¬ìš´ ë§íˆ¬'},
    {id:24, display_name:'ì‘¤ê°ˆìŒˆ',   emoji:'ğŸ‘©â€ğŸ«',group_type:'teacher',      animal_type:'ì„ ìƒë‹˜',   gender:'female', mbti:'ENFJ-T', speech_style:'ë”°ëœ»í•˜ê³  ì¡°ìš©íˆ ê´€ì°°í•˜ëŠ” ë§íˆ¬'},
  ];
</script>
</body>
</html>
