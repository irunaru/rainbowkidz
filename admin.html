<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸŒˆ RainbowKidz Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    /* â”€â”€ ë¦¬ì…‹ & CSS ë³€ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    :root {
      --bg:#f2f2f7;
      --card:#fff;
      --text:#1c1c1e;
      --sub:#6e6e73;
      --border:#e5e5ea;
      --blue:#007aff;
      --green:#34c759;
      --orange:#ff9f0a;
      --red:#ff3b30;
      --purple:#af52de;
      --radius:16px;
    }
    body { font-family:'Noto Sans KR',-apple-system,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
    .hidden { display:none !important; }

    /* â”€â”€ ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* í˜ì´ì§€ ì§„ì… ì‹œ ê°€ì¥ ë¨¼ì € ë³´ì´ëŠ” í™”ë©´ */
    #pwGate { position:fixed; inset:0; background:#fff; display:flex; align-items:center; justify-content:center; z-index:9999; }
    .pw-box   { text-align:center; padding:40px 32px; max-width:360px; width:90%; }
    .pw-logo  { font-size:52px; margin-bottom:16px; }
    .pw-title { font-size:22px; font-weight:900; margin-bottom:6px; }
    .pw-sub   { font-size:14px; color:var(--sub); margin-bottom:28px; }
    .pw-input { width:100%; padding:14px 18px; border:2px solid var(--border); border-radius:14px; font-size:18px; text-align:center; letter-spacing:4px; margin-bottom:14px; font-family:inherit; }
    .pw-input:focus { outline:none; border-color:var(--text); }
    .pw-btn   { width:100%; padding:14px; background:var(--text); color:#fff; border:none; border-radius:14px; font-size:16px; font-weight:800; cursor:pointer; font-family:inherit; }
    .pw-error { margin-top:10px; font-size:13px; color:var(--red); min-height:18px; }

    /* â”€â”€ í—¤ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .header { background:var(--card); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:100; }
    .header-inner { max-width:980px; margin:0 auto; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; }
    .logo       { display:flex; align-items:center; gap:8px; }
    .logo-main  { font-size:18px; font-weight:900; }
    .logo-badge { padding:3px 10px; background:var(--red); color:#fff; border-radius:20px; font-size:11px; font-weight:800; }
    .logout-btn { padding:7px 14px; border:1px solid var(--border); border-radius:20px; background:var(--bg); font-size:12px; color:var(--sub); cursor:pointer; font-family:inherit; }

    /* â”€â”€ ì»¨í…Œì´ë„ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .container { max-width:980px; margin:0 auto; padding:16px 16px 80px; }

    /* â”€â”€ ê¸€ë¡œë²Œ ë„êµ¬ ì¹´ë“œ ì˜ì—­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* ê³µì§€ì‚¬í•­ + ê²Œì‹œê¸€ ê´€ë¦¬ ë‘ ì¹´ë“œê°€ ë‚˜ë€íˆ ë°°ì¹˜ë¨ */
    .tools     { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:16px; }
    .tool-card { flex:1; min-width:260px; background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:16px; }
    .tool-title { font-size:14px; font-weight:900; margin-bottom:10px; }

    /* â”€â”€ ê³µí†µ í¼ ìš”ì†Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .input, .textarea, .select {
      width:100%; padding:10px 12px; border:1.5px solid var(--border);
      border-radius:10px; font-size:14px; font-family:inherit; margin-bottom:8px;
    }
    .textarea { min-height:80px; resize:vertical; line-height:1.6; }
    .input:focus, .textarea:focus, .select:focus { outline:none; border-color:var(--blue); }

    /* â”€â”€ ë²„íŠ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn { padding:10px 16px; border-radius:10px; border:none; cursor:pointer; font-size:13px; font-weight:900; font-family:inherit; display:inline-flex; align-items:center; gap:6px; transition:opacity .15s; }
    .btn:active   { opacity:.75; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .btn-ghost  { background:var(--bg); color:var(--text); border:1px solid var(--border); }
    .btn-blue   { background:var(--blue);   color:#fff; }
    .btn-green  { background:var(--green);  color:#fff; }
    .btn-purple { background:var(--purple); color:#fff; }
    .btn-red    { background:var(--red);    color:#fff; }
    .btn-sm     { padding:7px 12px; font-size:12px; }

    /* â”€â”€ ìƒíƒœ ë©”ì‹œì§€ ë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .status { display:none; padding:10px 12px; border-radius:10px; font-size:13px; margin-top:8px; }
    .status.show    { display:block; }
    .status.info    { background:#dbeafe; color:#1e40af; }
    .status.success { background:#d1fae5; color:#065f46; }
    .status.error   { background:#fee2e2; color:#991b1b; }

    /* â”€â”€ ê²Œì‹œê¸€ ê´€ë¦¬ ëª©ë¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .manage-list { max-height:260px; overflow-y:auto; }
    .manage-item { display:flex; align-items:flex-start; gap:10px; background:var(--bg); border-radius:12px; padding:10px; margin-bottom:8px; }
    .manage-emoji { font-size:22px; flex-shrink:0; }
    .manage-info  { flex:1; min-width:0; }
    .manage-title { font-size:13px; font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .manage-meta  { font-size:11px; color:var(--sub); margin-top:2px; }
    .manage-del   { padding:6px 10px; background:var(--red); color:#fff; border:none; border-radius:8px; font-size:11px; font-weight:700; cursor:pointer; font-family:inherit; flex-shrink:0; }

    /* â”€â”€ ìºë¦­í„° ê·¸ë¦¬ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .list-head   { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
    .search-input { flex:1; padding:10px 14px; border:1.5px solid var(--border); border-radius:10px; font-size:14px; font-family:inherit; }
    .search-input:focus { outline:none; border-color:var(--blue); }
    .char-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
    @media (min-width:520px) { .char-grid { grid-template-columns:repeat(6,1fr); } }
    @media (min-width:720px) { .char-grid { grid-template-columns:repeat(8,1fr); } }
    .char-tile { background:var(--card); border:1.5px solid var(--border); border-radius:14px; padding:10px 8px; cursor:pointer; text-align:center; transition:border-color .15s; }
    .char-tile:hover { border-color:var(--blue); }
    .char-emoji { font-size:26px; }
    .char-name  { font-size:11px; font-weight:900; color:var(--sub); margin-top:4px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .char-group { font-size:10px; color:var(--sub); opacity:.8; margin-top:1px; }

    /* â”€â”€ ìºë¦­í„° í”„ë¡œí•„ íŒ¨ë„ ì˜¤ë²„ë ˆì´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:flex-end; justify-content:center; z-index:2000; padding:10px; }
    .panel { width:100%; max-width:720px; background:var(--card); border-radius:20px; max-height:92vh; overflow-y:auto; border:1px solid var(--border); }

    /* íŒ¨ë„ ìƒë‹¨ ê³ ì • í—¤ë” */
    .panel-head { position:sticky; top:0; background:var(--card); border-bottom:1px solid var(--border); padding:12px 16px; display:flex; align-items:center; gap:10px; border-radius:20px 20px 0 0; z-index:10; }
    .panel-emoji { font-size:28px; }
    .panel-name  { font-size:16px; font-weight:900; }
    .panel-sub   { font-size:12px; color:var(--sub); }
    .panel-close { margin-left:auto; border:none; background:var(--bg); border:1px solid var(--border); border-radius:12px; padding:8px 12px; cursor:pointer; font-weight:900; font-family:inherit; font-size:13px; }
    .panel-body  { padding:14px; }

    /* â”€â”€ íŒ¨ë„ ë‚´ ì„¹ì…˜ ì¹´ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section       { background:var(--bg); border:1px solid var(--border); border-radius:14px; padding:14px; margin-bottom:12px; }
    .section-title { font-size:13px; font-weight:900; margin-bottom:10px; }

    /* 2ì¹¸/3ì¹¸ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
    .row2 { display:grid; grid-template-columns:1fr 1fr;     gap:10px; margin-bottom:8px; }
    .row3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:8px; }
    @media (max-width:480px) { .row2, .row3 { grid-template-columns:1fr; } }

    /* í•„ë“œ ë ˆì´ë¸” */
    .field label    { font-size:11px; font-weight:700; color:var(--sub); display:block; margin-bottom:4px; }
    .field .input,
    .field .select  { margin-bottom:0; }

    /* â”€â”€ ì´ë¯¸ì§€ í”„ë¦¬ë·° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .avatar-wrap { width:72px; height:72px; border-radius:18px; background:var(--card); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:34px; overflow:hidden; flex-shrink:0; }
    .avatar-wrap img { width:100%; height:100%; object-fit:cover; }

    /* â”€â”€ AI ëŒ“ê¸€ìš© ê²Œì‹œê¸€ í”¼ì»¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .postpick { max-height:200px; overflow-y:auto; display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    .postitem         { background:var(--card); border:1.5px solid var(--border); border-radius:10px; padding:10px; cursor:pointer; transition:border-color .15s; }
    .postitem.selected { border-color:var(--blue); }
    .postitem-title   { font-size:13px; font-weight:700; }
    .postitem-meta    { font-size:11px; color:var(--sub); margin-top:2px; }

    /* â”€â”€ ë¡œë”© ìŠ¤í”¼ë„ˆ (ë²„íŠ¼ ë‚´ë¶€) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .spin { display:inline-block; width:13px; height:13px; border:2px solid rgba(255,255,255,.4); border-top-color:#fff; border-radius:50%; animation:spn .8s linear infinite; }
    @keyframes spn { to { transform:rotate(360deg); } }
  </style>
</head>
<body>

<!-- â”€â”€ ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<!-- sessionStorageì— ì¸ì¦ ì •ë³´ ì €ì¥ â†’ ìƒˆë¡œê³ ì¹¨ ì‹œ ì¬ì…ë ¥ ë¶ˆí•„ìš” -->
<div id="pwGate">
  <div class="pw-box">
    <div class="pw-logo">ğŸŒˆ</div>
    <div class="pw-title">ê´€ë¦¬ì ë¡œê·¸ì¸</div>
    <div class="pw-sub">RainbowKidz ê´€ë¦¬ì ì „ìš© í˜ì´ì§€</div>
    <input type="password" class="pw-input" id="pwInput" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" autocomplete="current-password" aria-label="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸">
    <button class="pw-btn" onclick="checkPw()">ì…ì¥í•˜ê¸°</button>
    <div class="pw-error" id="pwError"></div>
  </div>
</div>

<!-- â”€â”€ í—¤ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="header">
  <div class="header-inner">
    <div class="logo">
      <span style="font-size:24px;">ğŸŒˆ</span>
      <span class="logo-main">ë¬´ì§€ê°œ</span>
      <span class="logo-badge">ADMIN</span>
    </div>
    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</div>

<!-- â”€â”€ ë©”ì¸ ì»¨í…Œì´ë„ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="container">

  <!-- ê¸€ë¡œë²Œ ë„êµ¬: ê³µì§€ì‚¬í•­ + ê²Œì‹œê¸€ ê´€ë¦¬ -->
  <div class="tools">

    <!-- ê³µì§€ì‚¬í•­ ì‘ì„± (ì„ ìƒë‹˜ ì‘¤ê°ˆìŒˆ ëª…ì˜ ê³ ì •) -->
    <div class="tool-card">
      <div class="tool-title">ğŸ“Œ ê³µì§€ì‚¬í•­ (ì„ ìƒë‹˜ ì‘¤ê°ˆìŒˆ ëª…ì˜)</div>
      <input class="input" id="noticeTitle" placeholder="ê³µì§€ ì œëª©" aria-label="ê³µì§€ ì œëª©">
      <textarea class="textarea" id="noticeBody" placeholder="ê³µì§€ ë‚´ìš©..." aria-label="ê³µì§€ ë‚´ìš©"></textarea>
      <button class="btn btn-blue" onclick="publishNotice()">ë“±ë¡</button>
      <div class="status" id="noticeStatus"></div>
    </div>

    <!-- ê²Œì‹œê¸€ ê´€ë¦¬ (ì „ì²´ ëª©ë¡, ì‚­ì œ ê°€ëŠ¥) -->
    <div class="tool-card">
      <div class="tool-title">ğŸ“‹ ê²Œì‹œê¸€ ê´€ë¦¬</div>
      <button class="btn btn-ghost btn-sm" onclick="loadManagePosts()" style="margin-bottom:10px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      <div class="manage-list" id="manageList">
        <div style="color:var(--sub);font-size:13px;">ë¡œë”© ì¤‘...</div>
      </div>
      <div class="status" id="manageStatus"></div>
    </div>

  </div>

  <!-- ìºë¦­í„° ê²€ìƒ‰ + ê·¸ë¦¬ë“œ -->
  <div class="list-head">
    <input class="search-input" id="charSearch" placeholder="ìºë¦­í„° ì´ë¦„ ê²€ìƒ‰..." oninput="renderGrid()" aria-label="ìºë¦­í„° ê²€ìƒ‰">
    <button class="btn btn-ghost btn-sm" onclick="reloadAll()">ìƒˆë¡œê³ ì¹¨</button>
  </div>
  <div class="char-grid" id="charGrid">
    <div style="color:var(--sub);font-size:13px;grid-column:1/-1;">ë¡œë”© ì¤‘...</div>
  </div>

</div>

<!-- â”€â”€ ìºë¦­í„° í”„ë¡œí•„ í¸ì§‘ íŒ¨ë„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<!-- ìºë¦­í„° í´ë¦­ ì‹œ ì—´ë¦¬ëŠ” í•˜ë‹¨ ìŠ¬ë¼ì´ë“œì—… íŒ¨ë„ -->
<div id="overlay" class="overlay hidden" onclick="handleOverlayClick(event)">
  <div class="panel" onclick="event.stopPropagation()">

    <!-- íŒ¨ë„ ìƒë‹¨: ìºë¦­í„° ê¸°ë³¸ ì •ë³´ + ë‹«ê¸° ë²„íŠ¼ -->
    <div class="panel-head">
      <div class="panel-emoji" id="pEmoji">ğŸ™‚</div>
      <div>
        <div class="panel-name" id="pName">ìºë¦­í„°</div>
        <div class="panel-sub"  id="pSub"></div>
      </div>
      <button class="panel-close" onclick="closePanel()">âœ• ë‹«ê¸°</button>
    </div>

    <div class="panel-body">

      <!-- â‘  ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
      <div class="section">
        <div class="section-title">ğŸ–¼ï¸ í”„ë¡œí•„ ì´ë¯¸ì§€</div>
        <div style="display:flex;align-items:center;gap:14px;">
          <!-- í˜„ì¬ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
          <div class="avatar-wrap" id="pAvatar">ğŸ™‚</div>
          <div style="flex:1;">
            <div style="font-size:12px;color:var(--sub);margin-bottom:10px;">Supabase Storageì— ì—…ë¡œë“œë©ë‹ˆë‹¤</div>
            <!-- [ì¤‘ìš”] accept="image/*" â€” ì´ë¯¸ì§€ íŒŒì¼ë§Œ í—ˆìš© -->
            <input type="file" id="pImgFile" accept="image/*" style="display:none;" onchange="uploadImage()" aria-label="ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ">
            <button class="btn btn-blue btn-sm" onclick="document.getElementById('pImgFile').click()">ğŸ“¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
            <div class="status" id="pImgStatus"></div>
          </div>
        </div>
      </div>

      <!-- â‘¡ ìºë¦­í„° ì •ë³´ í¸ì§‘ -->
      <div class="section">
        <div class="section-title">ğŸ‘¥ ìºë¦­í„° ì •ë³´ í¸ì§‘</div>

        <div class="row2">
          <div class="field"><label>ì´ë¦„ (display_name)</label><input class="input" id="fName"  aria-label="ì´ë¦„"></div>
          <div class="field"><label>ì´ëª¨ì§€</label>              <input class="input" id="fEmoji" aria-label="ì´ëª¨ì§€"></div>
        </div>
        <div class="row3">
          <div class="field">
            <label>ì†Œì†</label>
            <!-- [ì¤‘ìš”] group_type ê°’: kindergarten / daycare / teacher -->
            <select class="select" id="fGroup" aria-label="ì†Œì†">
              <option value="kindergarten">ìœ ì¹˜ì›</option>
              <option value="daycare">ì–´ë¦°ì´ì§‘</option>
              <option value="teacher">ì„ ìƒë‹˜</option>
            </select>
          </div>
          <!-- [ì¤‘ìš”] ì„±ë³„ì€ selectê°€ ì•„ë‹Œ text input â€” ì„ì¼í›„ì²˜ëŸ¼ 'ê³ ì' ê°™ì€ ììœ ê°’ ì§€ì› -->
          <div class="field"><label>ì„±ë³„ (ììœ  ì…ë ¥)</label><input class="input" id="fGender"  placeholder="ì˜ˆ: female, male, ê³ ì..." aria-label="ì„±ë³„"></div>
          <div class="field"><label>MBTI</label>              <input class="input" id="fMbti"    placeholder="ì˜ˆ: ENFP"                 aria-label="MBTI"></div>
        </div>
        <div class="row2">
          <div class="field"><label>ë™ë¬¼ì¢…ë¥˜ (animal_type)</label><input class="input" id="fAnimal"      aria-label="ë™ë¬¼ì¢…ë¥˜"></div>
          <div class="field"><label>íŠ¹ì§• (personality)</label>    <input class="input" id="fPersonality" aria-label="íŠ¹ì§•"></div>
        </div>
        <div class="row2">
          <!-- [ì¤‘ìš”] birthday: DATE íƒ€ì…ì´ë¼ type="date" ì‚¬ìš© -->
          <div class="field"><label>ìƒë…„ì›”ì¼</label><input class="input" type="date"   id="fBirthday" aria-label="ìƒë…„ì›”ì¼"></div>
          <div class="field"><label>ë‚˜ì´</label>    <input class="input" type="number" id="fAge"      placeholder="3" min="0" max="20" aria-label="ë‚˜ì´"></div>
        </div>
        <div class="row2">
          <div class="field"><label>ì¢‹ì•„í•˜ëŠ” ê²ƒ (likes)</label>    <input class="input" id="fLikes"    aria-label="ì¢‹ì•„í•˜ëŠ” ê²ƒ"></div>
          <div class="field"><label>ì‹«ì–´í•˜ëŠ” ê²ƒ (dislikes)</label>  <input class="input" id="fDislikes" aria-label="ì‹«ì–´í•˜ëŠ” ê²ƒ"></div>
        </div>
        <div class="row2">
          <div class="field"><label>ì·¨ë¯¸ (hobby)</label>  <input class="input" id="fHobby"  aria-label="ì·¨ë¯¸"></div>
          <div class="field"><label>ë¹„ë°€ (secret)</label> <input class="input" id="fSecret" aria-label="ë¹„ë°€"></div>
        </div>
        <div class="field" style="margin-bottom:12px;">
          <!-- speech_style: Gemini AI ìƒì„± í”„ë¡¬í”„íŠ¸ì—ì„œ ìºë¦­í„° ë§íˆ¬ íŒíŠ¸ë¡œ ì‚¬ìš© -->
          <label>ë§íˆ¬ íŒíŠ¸ (speech_style) â€” AI ê²Œì‹œê¸€ ìƒì„±ì— ì‚¬ìš©ë©ë‹ˆë‹¤</label>
          <input class="input" id="fSpeech" placeholder="ì˜ˆ: ë°ê³  ì¥ë‚œê¸° ë§ì€ ë§íˆ¬, ë¯¼ì´ˆ ë•í›„" aria-label="ë§íˆ¬ íŒíŠ¸" style="margin-bottom:0;">
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-green" id="btnSave" onclick="saveProfile()">ğŸ’¾ ì €ì¥</button>
          <button class="btn btn-ghost btn-sm" onclick="resetForm()">ë˜ëŒë¦¬ê¸°</button>
        </div>
        <div class="status" id="pSaveStatus"></div>
      </div>

      <!-- â‘¢ AI ê²Œì‹œê¸€ ìƒì„± -->
      <div class="section">
        <div class="section-title">ğŸ¤– AI ê²Œì‹œê¸€ ìƒì„±</div>
        <div style="font-size:12px;color:var(--sub);margin-bottom:10px;">
          Gemini 2.0 Flashê°€ ì„ íƒëœ ìºë¦­í„° ë§íˆ¬ë¡œ ê²Œì‹œê¸€ì„ ìƒì„±í•©ë‹ˆë‹¤.<br>
          ìƒì„± í›„ ë‚´ìš©ì„ ìˆ˜ì •í•˜ê³  ê²Œì‹œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
        </div>
        <input class="input" id="aiTitle" placeholder="ì œëª© (15ì ê¶Œì¥)" aria-label="AI ê²Œì‹œê¸€ ì œëª©">
        <textarea class="textarea" id="aiBody" placeholder="ë³¸ë¬¸ (ìƒì„± í›„ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤)" aria-label="AI ê²Œì‹œê¸€ ë³¸ë¬¸"></textarea>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-purple" id="btnGenPost"  onclick="generatePost()">âœ¨ ìƒì„±</button>
          <button class="btn btn-green"  id="btnPubPost"  onclick="publishPost()">ğŸ“¤ ê²Œì‹œ</button>
          <button class="btn btn-ghost btn-sm" onclick="clearPost()">ì´ˆê¸°í™”</button>
        </div>
        <div class="status" id="aiPostStatus"></div>
      </div>

      <!-- â‘£ AI ëŒ“ê¸€ ìƒì„± -->
      <div class="section">
        <div class="section-title">ğŸ’¬ AI ëŒ“ê¸€ ìƒì„±</div>
        <div style="font-size:12px;color:var(--sub);margin-bottom:8px;">
          ê²Œì‹œê¸€ì„ ì„ íƒí•˜ê³  ëŒ“ê¸€ì„ ìƒì„±í•©ë‹ˆë‹¤.
        </div>
        <!-- ê²Œì‹œê¸€ ì„ íƒ í”¼ì»¤ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥) -->
        <div class="postpick" id="postPicker">
          <div style="color:var(--sub);font-size:13px;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
        <textarea class="textarea" id="aiComment" placeholder="ëŒ“ê¸€ ë‚´ìš©..." style="min-height:60px;" aria-label="AI ëŒ“ê¸€ ë‚´ìš©"></textarea>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-purple" id="btnGenComment"  onclick="generateComment()">âœ¨ ëŒ“ê¸€ ìƒì„±</button>
          <button class="btn btn-green"  id="btnPubComment"  onclick="publishComment()">ğŸ“¤ ëŒ“ê¸€ ê²Œì‹œ</button>
          <button class="btn btn-ghost btn-sm" onclick="document.getElementById('aiComment').value=''">ì´ˆê¸°í™”</button>
        </div>
        <div class="status" id="aiCommentStatus"></div>
      </div>

    </div><!-- /panel-body -->
  </div><!-- /panel -->
</div><!-- /overlay -->

<script>
  // â”€â”€ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const API       = 'https://rainbowkidz-api.irunaru.workers.dev/api/v1';
  const ADMIN_KEY = 'yimkim1221'; // worker.jsì˜ ADMIN_KEY ì‹œí¬ë¦¿ê³¼ ë™ì¼í•´ì•¼ í•¨
  const PW        = 'yimkim1221'; // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ (í•„ìš”ì‹œ ë³€ê²½)

  // â”€â”€ ì•± ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let characters    = [];   // ì „ì²´ ìºë¦­í„° ë°°ì—´
  let cachedFeed    = [];   // í”¼ë“œ ê²Œì‹œê¸€ ìºì‹œ (ê²Œì‹œê¸€ ê´€ë¦¬ + ëŒ“ê¸€ í”¼ì»¤ ê³µìš©)
  let selectedChar  = null; // í˜„ì¬ ì—´ë¦° íŒ¨ë„ì˜ ìºë¦­í„° ê°ì²´
  let selectedPostId = null; // AI ëŒ“ê¸€ìš© ì„ íƒëœ ê²Œì‹œê¸€ ID

  // â”€â”€ ìœ í‹¸ í•¨ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const esc = s => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  const groupLabel = g => g === 'kindergarten' ? 'ìœ ì¹˜ì›' : g === 'daycare' ? 'ì–´ë¦°ì´ì§‘' : 'ì„ ìƒë‹˜';
  const relTime = d => {
    const s = (Date.now() - new Date(d)) / 1000;
    if (s < 60)    return 'ë°©ê¸ˆ';
    if (s < 3600)  return `${Math.floor(s / 60)}ë¶„ ì „`;
    if (s < 86400) return `${Math.floor(s / 3600)}ì‹œê°„ ì „`;
    return `${Math.floor(s / 86400)}ì¼ ì „`;
  };

  /** ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ. type: 'info' | 'success' | 'error' */
  function showStatus(id, msg, type = 'info') {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = msg;
    el.className = `status show ${type}`;
    if (type !== 'info') setTimeout(() => { el.classList.remove('show'); }, 4000);
  }

  /** ê´€ë¦¬ì ì¸ì¦ í—¤ë” í¬í•¨í•œ fetch */
  async function adminFetch(path, opts = {}) {
    const headers = new Headers(opts.headers || {});
    headers.set('X-Admin-Key', ADMIN_KEY);
    // FormDataëŠ” Content-Typeì„ ìë™ ì„¤ì •í•˜ë¯€ë¡œ ì§ì ‘ ì„¸íŒ… ì•ˆ í•¨
    if (!(opts.body instanceof FormData) && !headers.has('Content-Type')) {
      headers.set('Content-Type', 'application/json');
    }
    return fetch(API + path, { ...opts, headers });
  }

  // â”€â”€ ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  /** ë¹„ë°€ë²ˆí˜¸ í™•ì¸. ì„¸ì…˜ì— ì €ì¥í•´ì„œ ìƒˆë¡œê³ ì¹¨ ì‹œ ì¬ì…ë ¥ ë¶ˆí•„ìš” */
  function checkPw() {
    if (document.getElementById('pwInput').value === PW) {
      document.getElementById('pwGate').classList.add('hidden');
      sessionStorage.setItem('rk_admin', '1');
      init();
    } else {
      const errEl = document.getElementById('pwError');
      errEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ì–´ìš”';
      document.getElementById('pwInput').value = '';
      document.getElementById('pwInput').focus();
      setTimeout(() => { errEl.textContent = ''; }, 2000);
    }
  }

  function logout() {
    sessionStorage.removeItem('rk_admin');
    location.reload();
  }

  // ì—”í„°í‚¤ ë¡œê·¸ì¸
  document.getElementById('pwInput').addEventListener('keypress', e => { if (e.key === 'Enter') checkPw(); });
  // ESC í‚¤ë¡œ íŒ¨ë„ ë‹«ê¸°
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closePanel(); });
  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¸ì…˜ ì²´í¬
  if (sessionStorage.getItem('rk_admin') === '1') {
    document.getElementById('pwGate').classList.add('hidden');
    window.addEventListener('DOMContentLoaded', init);
  }

  // â”€â”€ ì´ˆê¸° ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function init() {
    await loadCharacters();
    renderGrid();
    await Promise.all([loadManagePosts(), loadFeed()]);
  }

  /** ì „ì²´ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ */
  async function reloadAll() {
    await loadCharacters();
    renderGrid();
    await Promise.all([loadManagePosts(), loadFeed()]);
    // íŒ¨ë„ì´ ì—´ë ¤ìˆìœ¼ë©´ í”¼ì»¤ë„ ê°±ì‹ 
    if (selectedChar) renderPostPicker();
  }

  // â”€â”€ ìºë¦­í„° ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadCharacters() {
    try {
      const r = await fetch(API + '/characters');
      if (r.ok) {
        const d = await r.json();
        characters = d.characters?.length ? d.characters : MOCK_CHARS;
      } else {
        characters = MOCK_CHARS;
      }
    } catch { characters = MOCK_CHARS; }
  }

  /** í”¼ë“œ ê²Œì‹œê¸€ ë¡œë“œ (ê²Œì‹œê¸€ ê´€ë¦¬ + ëŒ“ê¸€ í”¼ì»¤ ê³µìš©) */
  async function loadFeed(limit = 30) {
    try {
      const r = await fetch(API + `/feed?limit=${limit}`);
      const d = await r.json();
      cachedFeed = d.posts || [];
    } catch { cachedFeed = []; }
  }

  // â”€â”€ ìºë¦­í„° ê·¸ë¦¬ë“œ ë Œë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderGrid() {
    const q = (document.getElementById('charSearch').value || '').toLowerCase();
    const filtered = characters.filter(c => {
      const haystack = `${c.display_name} ${c.group_type} ${c.mbti || ''} ${c.animal_type || ''}`.toLowerCase();
      return !q || haystack.includes(q);
    });
    document.getElementById('charGrid').innerHTML = filtered.length
      ? filtered.map(c => `
          <div class="char-tile" onclick="openPanel(${c.id})">
            <div class="char-emoji">${esc(c.emoji || 'ğŸ™‚')}</div>
            <div class="char-name">${esc(c.display_name)}</div>
            <div class="char-group">${groupLabel(c.group_type)} Â· ${esc(c.mbti || '')}</div>
          </div>`).join('')
      : '<div style="color:var(--sub);font-size:13px;grid-column:1/-1;">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
  }

  // â”€â”€ ìºë¦­í„° íŒ¨ë„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function handleOverlayClick(e) { if (e.target.id === 'overlay') closePanel(); }
  function closePanel() {
    document.getElementById('overlay').classList.add('hidden');
    selectedChar = null;
    selectedPostId = null;
  }

  async function openPanel(charId) {
    // [Bug fix] == ì‚¬ìš© (idê°€ number/string í˜¼ìš© ê°€ëŠ¥)
    const c = characters.find(x => x.id == charId);
    if (!c) return;
    selectedChar   = c;
    selectedPostId = null;

    // íŒ¨ë„ í—¤ë” ì—…ë°ì´íŠ¸
    document.getElementById('pEmoji').textContent = c.emoji || 'ğŸ™‚';
    document.getElementById('pName').textContent  = c.display_name;
    document.getElementById('pSub').textContent   = `${groupLabel(c.group_type)} Â· ${c.animal_type || ''} Â· ${c.mbti || ''}`;

    // ì•„ë°”íƒ€ ì´ë¯¸ì§€ - [Bug fix] data-emojië¡œ onerror ì²˜ë¦¬ (ë”°ì˜´í‘œ ì´ìŠ¤ì¼€ì´í”„ ë°©ì§€)
    const av = document.getElementById('pAvatar');
    if (c.image_url) {
      av.innerHTML = `<img src="${esc(c.image_url)}" alt="${esc(c.display_name)}" data-emoji="${esc(c.emoji || 'ğŸ™‚')}" onerror="this.parentElement.removeChild(this);this.parentElement.textContent=this.dataset.emoji">`;
    } else {
      av.innerHTML = esc(c.emoji || 'ğŸ™‚');
    }

    fillForm(c);
    clearPost();
    document.getElementById('aiComment').value = '';

    // ìƒíƒœ ë©”ì‹œì§€ ì „ë¶€ ì´ˆê¸°í™”
    ['pImgStatus','pSaveStatus','aiPostStatus','aiCommentStatus'].forEach(id => {
      const el = document.getElementById(id);
      el.textContent = '';
      el.className = 'status';
    });

    // í”¼ë“œ ë¡œë“œ í›„ ê²Œì‹œê¸€ í”¼ì»¤ ë Œë”
    await loadFeed(30);
    renderPostPicker();

    document.getElementById('overlay').classList.remove('hidden');
    document.getElementById('fName').focus();
  }

  /** ìºë¦­í„° ë°ì´í„°ë¥¼ í¼ì— ì±„ìš°ê¸° */
  function fillForm(c) {
    document.getElementById('fName').value        = c.display_name || '';
    document.getElementById('fEmoji').value       = c.emoji        || '';
    document.getElementById('fGroup').value       = c.group_type   || 'kindergarten';
    document.getElementById('fGender').value      = c.gender       || '';
    document.getElementById('fMbti').value        = c.mbti         || '';
    document.getElementById('fAnimal').value      = c.animal_type  || '';
    document.getElementById('fPersonality').value = c.personality  || '';
    document.getElementById('fBirthday').value    = c.birthday     || '';
    document.getElementById('fAge').value         = c.age          != null ? c.age : '';
    document.getElementById('fLikes').value       = c.likes        || '';
    document.getElementById('fDislikes').value    = c.dislikes     || '';
    document.getElementById('fHobby').value       = c.hobby        || '';
    document.getElementById('fSecret').value      = c.secret       || '';
    document.getElementById('fSpeech').value      = c.speech_style || '';
  }

  /** í¼ì„ ì›ë˜ ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ê¸° */
  function resetForm() {
    if (selectedChar) {
      fillForm(selectedChar);
      showStatus('pSaveStatus', 'ë˜ëŒë ¸ìŠµë‹ˆë‹¤', 'info');
    }
  }

  // â”€â”€ ìºë¦­í„° ì •ë³´ ì €ì¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function saveProfile() {
    if (!selectedChar) return;

    // [ì¤‘ìš”] ìˆ˜ì • í—ˆìš© í•„ë“œ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ - worker.jsì˜ ALLOWED ë°°ì—´ê³¼ ì¼ì¹˜í•´ì•¼ í•¨
    const update = {
      display_name: document.getElementById('fName').value.trim(),
      emoji:        document.getElementById('fEmoji').value.trim(),
      group_type:   document.getElementById('fGroup').value,
      gender:       document.getElementById('fGender').value.trim(),      // ììœ  ì…ë ¥ (ì„ì¼í›„: 'ê³ ì')
      mbti:         document.getElementById('fMbti').value.trim(),
      animal_type:  document.getElementById('fAnimal').value.trim(),
      personality:  document.getElementById('fPersonality').value.trim(),
      birthday:     document.getElementById('fBirthday').value || null,
      age:          document.getElementById('fAge').value !== '' ? Number(document.getElementById('fAge').value) : null,
      likes:        document.getElementById('fLikes').value.trim(),
      dislikes:     document.getElementById('fDislikes').value.trim(),
      hobby:        document.getElementById('fHobby').value.trim(),
      secret:       document.getElementById('fSecret').value.trim(),
      speech_style: document.getElementById('fSpeech').value.trim(),
    };

    const btn = document.getElementById('btnSave');
    btn.disabled = true;
    btn.innerHTML = '<span class="spin"></span> ì €ì¥ì¤‘';
    showStatus('pSaveStatus', 'ì €ì¥ ì¤‘...', 'info');

    try {
      const r = await adminFetch(`/admin/characters/${selectedChar.id}`, {
        method: 'PATCH',
        body: JSON.stringify(update),
      });
      const d = await r.json();

      if (d.ok) {
        // ë¡œì»¬ ìºë¦­í„° ë°ì´í„° ì—…ë°ì´íŠ¸
        Object.assign(selectedChar, update);
        // íŒ¨ë„ í—¤ë” ê°±ì‹ 
        document.getElementById('pEmoji').textContent = update.emoji || 'ğŸ™‚';
        document.getElementById('pName').textContent  = update.display_name;
        document.getElementById('pSub').textContent   = `${groupLabel(update.group_type)} Â· ${update.animal_type || ''} Â· ${update.mbti || ''}`;
        renderGrid(); // ê·¸ë¦¬ë“œë„ ë°˜ì˜
        showStatus('pSaveStatus', 'âœ… ì €ì¥ ì™„ë£Œ', 'success');
      } else {
        showStatus('pSaveStatus', `âŒ ${d.error}`, 'error');
      }
    } catch (e) {
      showStatus('pSaveStatus', `âŒ ì˜¤ë¥˜: ${e.message}`, 'error');
    }

    btn.disabled = false;
    btn.innerHTML = 'ğŸ’¾ ì €ì¥';
  }

  // â”€â”€ ì´ë¯¸ì§€ ì—…ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function uploadImage() {
    if (!selectedChar) return;
    const input = document.getElementById('pImgFile');
    const file  = input.files?.[0];
    if (!file) return;

    // íŒŒì¼ í¬ê¸° ì œí•œ: 5MB
    if (file.size > 5 * 1024 * 1024) {
      showStatus('pImgStatus', 'âŒ 5MB ì´í•˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
      input.value = '';
      return;
    }

    showStatus('pImgStatus', 'ì—…ë¡œë“œ ì¤‘...', 'info');
    const form = new FormData();
    form.append('image', file);
    form.append('character_id', selectedChar.id);

    try {
      const r = await fetch(API + '/admin/upload-image', {
        method: 'POST',
        headers: { 'X-Admin-Key': ADMIN_KEY },
        body: form,
      });
      const d = await r.json();
      if (d.ok) {
        selectedChar.image_url = d.image_url;
        // ì•„ë°”íƒ€ ë¯¸ë¦¬ë³´ê¸° ì¦‰ì‹œ ê°±ì‹ 
        const av = document.getElementById('pAvatar');
        av.innerHTML = `<img src="${esc(d.image_url)}" alt="${esc(selectedChar.display_name)}">`;
        renderGrid();
        showStatus('pImgStatus', 'âœ… ì—…ë¡œë“œ ì™„ë£Œ', 'success');
      } else {
        showStatus('pImgStatus', `âŒ ${d.error}`, 'error');
      }
    } catch (e) {
      showStatus('pImgStatus', `âŒ ${e.message}`, 'error');
    }
    input.value = ''; // ê°™ì€ íŒŒì¼ ì¬ì„ íƒ ê°€ëŠ¥í•˜ê²Œ
  }

  // â”€â”€ ê³µì§€ì‚¬í•­ ê²Œì‹œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function publishNotice() {
    const title = document.getElementById('noticeTitle').value.trim();
    const body  = document.getElementById('noticeBody').value.trim();
    if (!title) { showStatus('noticeStatus', 'ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
    if (!body)  { showStatus('noticeStatus', 'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }

    // ì„ ìƒë‹˜ ìºë¦­í„°(ì‘¤ê°ˆìŒˆ) ê³ ì • - group_typeì´ 'teacher'ì¸ ìºë¦­í„°
    const teacher = characters.find(c => c.group_type === 'teacher');
    if (!teacher) { showStatus('noticeStatus', 'âŒ ì„ ìƒë‹˜ ìºë¦­í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”', 'error'); return; }

    showStatus('noticeStatus', 'ë“±ë¡ ì¤‘...', 'info');
    try {
      const r = await adminFetch('/system/posts', {
        method: 'POST',
        body: JSON.stringify({ system_user_id: teacher.id, title, body, is_notice: true }),
      });
      const d = await r.json();
      if (d.ok) {
        document.getElementById('noticeTitle').value = '';
        document.getElementById('noticeBody').value  = '';
        showStatus('noticeStatus', 'âœ… ê³µì§€ ë“±ë¡ ì™„ë£Œ', 'success');
      } else {
        showStatus('noticeStatus', `âŒ ${d.error}`, 'error');
      }
    } catch (e) {
      showStatus('noticeStatus', `âŒ ${e.message}`, 'error');
    }
  }

  // â”€â”€ ê²Œì‹œê¸€ ê´€ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadManagePosts() {
    const wrap = document.getElementById('manageList');
    wrap.innerHTML = '<div style="color:var(--sub);font-size:13px;">ë¡œë”© ì¤‘...</div>';
    await loadFeed(30);

    if (!cachedFeed.length) {
      wrap.innerHTML = '<div style="color:var(--sub);font-size:13px;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      return;
    }
    wrap.innerHTML = cachedFeed.map(p => `
      <div class="manage-item" id="mpost-${p.id}">
        <div class="manage-emoji">${esc(p.character_emoji || 'ğŸ‘¤')}</div>
        <div class="manage-info">
          <div class="manage-title">${esc(p.title || p.body?.slice(0, 40) || 'ì œëª©ì—†ìŒ')}</div>
          <div class="manage-meta">${esc(p.character_name || 'ìµëª…')} Â· ì•¼ë¥´ ${p.yar_count || 0} Â· ëŒ“ê¸€ ${p.comment_count || 0} Â· ${relTime(p.created_at)}</div>
        </div>
        <button class="manage-del" onclick="deletePost(${p.id})">ì‚­ì œ</button>
      </div>`).join('');
  }

  async function deletePost(postId) {
    if (!confirm('ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí• ê¹Œìš”?')) return;
    try {
      const r = await adminFetch(`/admin/posts/${postId}`, { method: 'DELETE' });
      const d = await r.json();
      if (d.ok) {
        // DOMì—ì„œ ì¦‰ì‹œ ì œê±°
        document.getElementById(`mpost-${postId}`)?.remove();
        cachedFeed = cachedFeed.filter(p => p.id !== postId);
        // íŒ¨ë„ì´ ì—´ë ¤ìˆìœ¼ë©´ í”¼ì»¤ë„ ê°±ì‹ 
        if (selectedChar) renderPostPicker();
        showStatus('manageStatus', 'âœ… ì‚­ì œ ì™„ë£Œ', 'success');
      } else {
        showStatus('manageStatus', `âŒ ${d.error}`, 'error');
      }
    } catch (e) {
      showStatus('manageStatus', `âŒ ${e.message}`, 'error');
    }
  }

  // â”€â”€ AI ê²Œì‹œê¸€ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function clearPost() {
    document.getElementById('aiTitle').value = '';
    document.getElementById('aiBody').value  = '';
  }

  async function generatePost() {
    if (!selectedChar) { alert('ìºë¦­í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }

    const btn = document.getElementById('btnGenPost');
    btn.disabled = true;
    btn.innerHTML = '<span class="spin"></span> ìƒì„±ì¤‘';
    showStatus('aiPostStatus', `${selectedChar.display_name} ê¸€ ìƒì„± ì¤‘...`, 'info');

    try {
      const r = await adminFetch('/admin/generate-post', {
        method: 'POST',
        body: JSON.stringify({ character_id: selectedChar.id }),
      });
      const d = await r.json();
      if (d.ok) {
        document.getElementById('aiTitle').value = d.title || '';
        document.getElementById('aiBody').value  = d.body  || '';
        showStatus('aiPostStatus', 'âœ… ìƒì„± ì™„ë£Œ! ìˆ˜ì • í›„ ê²Œì‹œí•˜ì„¸ìš”', 'success');
      } else {
        showStatus('aiPostStatus', `âŒ ${d.error}`, 'error');
      }
    } catch (e) {
      showStatus('aiPostStatus', `âŒ ${e.message}`, 'error');
    }

    btn.disabled = false;
    btn.innerHTML = 'âœ¨ ìƒì„±';
  }

  async function publishPost() {
    if (!selectedChar) { alert('ìºë¦­í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
    const title = document.getElementById('aiTitle').value.trim();
    const body  = document.getElementById('aiBody').value.trim();
    if (!title) { showStatus('aiPostStatus', 'ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
    if (!body)  { showStatus('aiPostStatus', 'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }

    const btn = document.getElementById('btnPubPost');
    btn.disabled = true;
    btn.innerHTML = '<span class="spin"></span> ê²Œì‹œì¤‘';
    showStatus('aiPostStatus', 'ê²Œì‹œ ì¤‘...', 'info');

    try {
      const r = await adminFetch('/system/posts', {
        method: 'POST',
        body: JSON.stringify({ system_user_id: selectedChar.id, title, body }),
      });
      const d = await r.json();
      if (d.ok) {
        showStatus('aiPostStatus', 'âœ… ê²Œì‹œ ì™„ë£Œ', 'success');
        clearPost();
        await loadFeed(30);
        renderPostPicker();
        loadManagePosts();
      } else {
        showStatus('aiPostStatus', `âŒ ${d.error}`, 'error');
      }
    } catch (e) {
      showStatus('aiPostStatus', `âŒ ${e.message}`, 'error');
    }

    btn.disabled = false;
    btn.innerHTML = 'ğŸ“¤ ê²Œì‹œ';
  }

  // â”€â”€ ê²Œì‹œê¸€ í”¼ì»¤ (AI ëŒ“ê¸€ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderPostPicker() {
    const wrap = document.getElementById('postPicker');
    if (!cachedFeed.length) {
      wrap.innerHTML = '<div style="color:var(--sub);font-size:13px;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      return;
    }
    wrap.innerHTML = cachedFeed.map(p => `
      <div class="postitem ${String(selectedPostId) === String(p.id) ? 'selected' : ''}" onclick="selectPost(${p.id})">
        <div class="postitem-title">${esc((p.character_emoji || 'ğŸ‘¤') + ' ' + (p.title || p.body?.slice(0, 30) || 'ì œëª©ì—†ìŒ'))}</div>
        <div class="postitem-meta">${esc(p.character_name || 'ìµëª…')} Â· ëŒ“ê¸€ ${p.comment_count || 0}</div>
      </div>`).join('');
  }

  function selectPost(id) {
    selectedPostId = id;
    renderPostPicker(); // ì„ íƒ í‘œì‹œ ì—…ë°ì´íŠ¸
  }

  // â”€â”€ AI ëŒ“ê¸€ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function generateComment() {
    if (!selectedChar)   { showStatus('aiCommentStatus', 'ìºë¦­í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');  return; }
    if (!selectedPostId) { showStatus('aiCommentStatus', 'ê²Œì‹œê¸€ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error'); return; }

    const btn = document.getElementById('btnGenComment');
    btn.disabled = true;
    btn.innerHTML = '<span class="spin"></span> ìƒì„±ì¤‘';
    showStatus('aiCommentStatus', 'ëŒ“ê¸€ ìƒì„± ì¤‘...', 'info');

    try {
      const r = await adminFetch('/admin/generate-comment', {
        method: 'POST',
        body: JSON.stringify({ post_id: selectedPostId, character_id: selectedChar.id }),
      });
      const d = await r.json();
      if (d.ok) {
        document.getElementById('aiComment').value = d.comment || '';
        showStatus('aiCommentStatus', 'âœ… ìƒì„± ì™„ë£Œ! ìˆ˜ì • í›„ ê²Œì‹œí•˜ì„¸ìš”', 'success');
      } else {
        showStatus('aiCommentStatus', `âŒ ${d.error}`, 'error');
      }
    } catch (e) {
      showStatus('aiCommentStatus', `âŒ ${e.message}`, 'error');
    }

    btn.disabled = false;
    btn.innerHTML = 'âœ¨ ëŒ“ê¸€ ìƒì„±';
  }

  async function publishComment() {
    if (!selectedChar)   { showStatus('aiCommentStatus', 'ìºë¦­í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');  return; }
    if (!selectedPostId) { showStatus('aiCommentStatus', 'ê²Œì‹œê¸€ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error'); return; }
    const body = document.getElementById('aiComment').value.trim();
    if (!body) { showStatus('aiCommentStatus', 'ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }

    const btn = document.getElementById('btnPubComment');
    btn.disabled = true;
    btn.innerHTML = '<span class="spin"></span> ê²Œì‹œì¤‘';
    showStatus('aiCommentStatus', 'ê²Œì‹œ ì¤‘...', 'info');

    try {
      const r = await adminFetch('/admin/system-comment', {
        method: 'POST',
        body: JSON.stringify({ post_id: selectedPostId, system_user_id: selectedChar.id, body }),
      });
      const d = await r.json();
      if (d.ok) {
        document.getElementById('aiComment').value = '';
        showStatus('aiCommentStatus', 'âœ… ëŒ“ê¸€ ê²Œì‹œ ì™„ë£Œ', 'success');
        await loadFeed(30);
        renderPostPicker();
        loadManagePosts();
      } else {
        showStatus('aiCommentStatus', `âŒ ${d.error}`, 'error');
      }
    } catch (e) {
      showStatus('aiCommentStatus', `âŒ ${e.message}`, 'error');
    }

    btn.disabled = false;
    btn.innerHTML = 'ğŸ“¤ ëŒ“ê¸€ ê²Œì‹œ';
  }

  // â”€â”€ 24ëª… í´ë°± MOCK ë°ì´í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // API ì‹¤íŒ¨ ì‹œ ì‚¬ìš©. ì‹¤ì œ DB ë°ì´í„°ë¥¼ ë°˜ì˜í•œ ê¸°ë³¸ê°’
  const MOCK_CHARS = [
    {id:1,  display_name:'ì„ì¼í›„',   emoji:'ğŸ¦†', group_type:'kindergarten', animal_type:'ì˜¤ë¦¬',     gender:'ê³ ì',   mbti:'ENTP',   likes:'ì•„ì´ëŒ',   hobby:'ëˆ•ê¸°',          speech_style:'ì•„ì´ëŒ ì´ì•¼ê¸°ë¥¼ ìì£¼í•˜ëŠ” í¸ì•ˆí•œ ë§íˆ¬'},
    {id:2,  display_name:'ì¨©êµ¬ë¦¬',   emoji:'ğŸ¸', group_type:'kindergarten', animal_type:'ê°œêµ¬ë¦¬',   gender:'female', mbti:'ESTP',   likes:'ê²Œì„',     hobby:'ê°œêµ´ê±°ë¦¬ê¸°',    speech_style:'í™œë°œí•˜ê³  ê²Œì„ ì´ì•¼ê¸° ë§ì´ í•¨'},
    {id:3,  display_name:'ì¨©ê·œë¦¬',   emoji:'ğŸ¸', group_type:'kindergarten', animal_type:'ê°œêµ¬ë¦¬',   gender:'female', mbti:'ENFP',   likes:'ë†€ê¸°',     hobby:'ì¥ë‚œì¹˜ê¸°',      speech_style:'ì¥ë‚œìŠ¤ëŸ½ê³  ì¬ë¯¸ìˆëŠ” ë§íˆ¬'},
    {id:4,  display_name:'ë£¨í”¼',     emoji:'ğŸ¦«', group_type:'kindergarten', animal_type:'ë¹„ë²„',     gender:'male',   mbti:'INTP',   likes:'ê±¸ê·¸ë£¹',   hobby:'í‚¥ë³µì‹±',        speech_style:'ì°¨ë¶„í•˜ì§€ë§Œ ê±¸ê·¸ë£¹ ì´ì•¼ê¸°ë§Œ ë‚˜ì˜¤ë©´ ì‹ ë‚¨'},
    {id:5,  display_name:'ì•¼ì½”',     emoji:'ğŸ·', group_type:'kindergarten', animal_type:'ë¼ì§€',     gender:'male',   mbti:'ENFP',   likes:'ë¯¼ì´ˆ',     hobby:'ë¯¼ì´ˆë¨¹ê¸°',      speech_style:'ë°ê³  ì¥ë‚œê¸° ë§ì€ ë§íˆ¬ ë¯¼ì´ˆ ë•í›„'},
    {id:6,  display_name:'ìš°ì‚¬ê¸°',   emoji:'ğŸ°', group_type:'kindergarten', animal_type:'í† ë¼',     gender:'female', mbti:'ISTP',   likes:'ê³µë¶€',     hobby:'ê³µë¶€',          speech_style:'ì§„ì§€í•˜ê³  ê³µë¶€ ì´ì•¼ê¸°ë§Œ í•¨'},
    {id:7,  display_name:'ì¨©ë‹´ê³°',   emoji:'ğŸ»', group_type:'kindergarten', animal_type:'ê³°',       gender:'female', mbti:'ISTJ',   likes:'ì²œì¬',     hobby:'ì ìê¸°',        speech_style:'ë˜‘ë˜‘í•œ ì²™í•˜ëŠ” ë§íˆ¬'},
    {id:8,  display_name:'ì¨©ë¹¤ì®¸',   emoji:'ğŸ°', group_type:'kindergarten', animal_type:'í† ë¼',     gender:'female', mbti:'ENFP',   likes:'íŒ¬í‹°',     hobby:'ë³µì‹±',          speech_style:'íŒ¬í‹° ì´ì•¼ê¸°ë¥¼ ìì£¼í•˜ëŠ” ê·€ì—¬ìš´ ë§íˆ¬'},
    {id:9,  display_name:'ì¨©ì„¤',     emoji:'ğŸ¯', group_type:'kindergarten', animal_type:'í˜¸ë‘ì´',   gender:'female', mbti:'ENFP',   likes:'ìŠ¤í‚¤',     hobby:'íƒœê¶Œë„',        speech_style:'ìš´ë™ ì´ì•¼ê¸°ë¥¼ ì¢‹ì•„í•˜ëŠ” í™œë°œí•œ ë§íˆ¬'},
    {id:10, display_name:'ì¹˜ì´ì¹´ì™€', emoji:'ğŸ»', group_type:'kindergarten', animal_type:'ê³°',       gender:'female', mbti:'ENFP',   likes:'ìš”ì¿ ë¥´íŠ¸', hobby:'ìš”êµ¬ë¥´íŠ¸ ë¨¹ê¸°', speech_style:'ìš”ì¿ ë¥´íŠ¸ ì´ì•¼ê¸°ë¥¼ ìì£¼í•˜ëŠ” ê·€ì—¬ìš´ ë§íˆ¬'},
    {id:11, display_name:'í•˜ì¹˜ì™€ë ˆ', emoji:'ğŸ±', group_type:'kindergarten', animal_type:'ê³ ì–‘ì´',   gender:'female', mbti:'ENFP',   likes:'ê·€ì—¬ìš´ê±°', hobby:'ë…¸ë˜',          speech_style:'ê·€ì—½ê³  ë°ì€ ë§íˆ¬'},
    {id:12, display_name:'ì¨©ë¬¸ì–´',   emoji:'ğŸ™', group_type:'kindergarten', animal_type:'ë°˜ì „ë¬¸ì–´', gender:'female', mbti:'ENFP',   likes:'ì°©í•œê±°',   hobby:'ë…¸ë˜ë¶€ë¥´ê¸°',    speech_style:'ë°ê³  ê¸ì •ì ì¸ ë§íˆ¬'},
    {id:13, display_name:'ì¨©ìŠ',     emoji:'ğŸ¦§', group_type:'kindergarten', animal_type:'ì˜¤ë‘ìš°íƒ„', gender:'female', mbti:'ENFP',   likes:'ë¦¬ë“¬ì²´ì¡°', hobby:'ë¨¹ê¸°',          speech_style:'ë¨¹ëŠ” ê²ƒê³¼ ë¦¬ë“¬ì²´ì¡° ì´ì•¼ê¸°ë¥¼ ì¢‹ì•„í•¨'},
    {id:14, display_name:'ì¨©ì†¡',     emoji:'ğŸ¦§', group_type:'kindergarten', animal_type:'ì˜¤ë‘ìš°íƒ„', gender:'female', mbti:'ENFP',   likes:'ë®¤ì§€ì»¬',   hobby:'íŠ¸ë¡¯íŠ¸ë¶€ë¥´ê¸°',  speech_style:'ë…¸ë˜ì™€ ë®¤ì§€ì»¬ ì´ì•¼ê¸°ë¥¼ ì¢‹ì•„í•¨'},
    {id:15, display_name:'ë£¹í¬',     emoji:'ğŸ¦«', group_type:'daycare',      animal_type:'ë¹„ë²„',     gender:'female', mbti:'ENFP',   likes:'ì¹˜í‚¨',     hobby:'ê¶Œíˆ¬',          speech_style:'ì¹˜í‚¨ ì´ì•¼ê¸°ì™€ ê¶Œíˆ¬ ì´ì•¼ê¸°ë¥¼ ì¢‹ì•„í•¨'},
    {id:16, display_name:'ë¤‚ì´',     emoji:'ğŸ¦«', group_type:'daycare',      animal_type:'ë¹„ë²„',     gender:'female', mbti:'ESTJ',   likes:'ìŒì ˆê³¤',   hobby:'ìŒì ˆê³¤',        speech_style:'ìŒì ˆê³¤ê³¼ ë¬´ìˆ  ì´ì•¼ê¸°ë¥¼ ì¢‹ì•„í•¨'},
    {id:17, display_name:'ì‚¬ë™',     emoji:'ğŸ·', group_type:'daycare',      animal_type:'ë¼ì§€',     gender:'male',   mbti:'ENFP',   likes:'ë°±ì„¤ì´',   hobby:'ìœ íŠœë¸Œë³´ê¸°',    speech_style:'ë°±ì„¤ì´ì™€ ìœ íŠœë¸Œ ì´ì•¼ê¸°ë¥¼ ìì£¼ í•¨'},
    {id:18, display_name:'ì¨©ë§Œë“€',   emoji:'ğŸ™', group_type:'daycare',      animal_type:'ë°˜ì „ë¬¸ì–´', gender:'female', mbti:'ISTP',   likes:'ê¹¨ë—í•œê±°', hobby:'ê·¸ë¦¼ê·¸ë¦¬ê¸°',    speech_style:'ê¹¨ë—í•œ ê²ƒì„ ì¢‹ì•„í•˜ê³  ê·¸ë¦¼ ì´ì•¼ê¸°ë¥¼ í•¨'},
    {id:19, display_name:'ì¨©ë§Œì¥¬',   emoji:'ğŸ™', group_type:'daycare',      animal_type:'ë°˜ì „ë¬¸ì–´', gender:'female', mbti:'ISTP',   likes:'ë§›ìˆëŠ”ê±°', hobby:'ë¨¹ê¸°',          speech_style:'ë¨¹ëŠ” ì´ì•¼ê¸°ë¥¼ ìì£¼í•˜ëŠ” ê·€ì—¬ìš´ ë§íˆ¬'},
    {id:20, display_name:'ì¨©ë¬´ë„ˆ',   emoji:'ğŸ™', group_type:'daycare',      animal_type:'ë°˜ì „ë¬¸ì–´', gender:'female', mbti:'ISTP',   likes:'ë†€ê¸°',     hobby:'ë†€ê¸°',          speech_style:'ëŠ˜ ë†€ê³  ì‹¶ì–´í•˜ëŠ” í™œë°œí•œ ë§íˆ¬'},
    {id:21, display_name:'ì¨©ì„œë¹ˆ',   emoji:'ğŸ¦›', group_type:'daycare',      animal_type:'ë² ë êµ¬ì–´', gender:'female', mbti:'ENFP',   likes:'ìª½ìª½ì´',   hobby:'ìª½ìª½ì´ë¬¼ê¸°',    speech_style:'ì• ê¸° ê°™ì€ ê·€ì—¬ìš´ ë§íˆ¬'},
    {id:22, display_name:'ì¨©í¬ìš©',   emoji:'ğŸ¶', group_type:'daycare',      animal_type:'ê°•ì•„ì§€',   gender:'female', mbti:'ENFP',   likes:'íŒ¨ê¸°',     hobby:'íŒ¨ê¸°',          speech_style:'ë³µì‹±ê³¼ íŒ¨ê¸° ì´ì•¼ê¸°ë¥¼ ì¢‹ì•„í•˜ëŠ” í™œë°œí•œ ë§íˆ¬'},
    {id:23, display_name:'ì¨©ì„¸ë¹ˆ',   emoji:'ğŸ¦›', group_type:'daycare',      animal_type:'ë² ë êµ¬ì–´', gender:'female', mbti:'ENFP',   likes:'ìˆë†ˆ',     hobby:'ì€ê·¼ì”',        speech_style:'ìê¸°ê°€ ì„¸ë‹¤ê³  ìƒê°í•˜ëŠ” ê·€ì—¬ìš´ ë§íˆ¬'},
    {id:24, display_name:'ì‘¤ê°ˆìŒˆ',   emoji:'ğŸ‘©â€ğŸ«',group_type:'teacher',      animal_type:'ì„ ìƒë‹˜',   gender:'female', mbti:'ENFJ-T', likes:'ì•„ì´ë“¤',   hobby:'ê´€ì°°ë©”ëª¨',      speech_style:'ë”°ëœ»í•˜ê³  ì¡°ìš©íˆ ê´€ì°°í•˜ëŠ” ë§íˆ¬'},
  ];
</script>
</body>
</html>
