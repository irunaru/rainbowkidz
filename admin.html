<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸŒˆ ê´€ë¦¬ì - ë¬´ì§€ê°œ ìœ ì¹˜ì›</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    /* ===== DESIGN TOKENS (SAFE TO EDIT) ===== */
  :root {
      --bg:#f2f2f7; --card:#fff; --text:#1c1c1e; --sub:#636366; --sub2:#8e8e93; --border:#e5e5ea;
      --blue:#007aff; --green:#34c759; --red:#ff3b30; --orange:#ff9f0a; --purple:#af52de; --accent:#ff3b30;
      --radius:16px;
    }
    body { font-family:'Noto Sans KR',-apple-system,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
    .hidden { display:none !important; }
    @keyframes spin { to { transform:rotate(360deg); } }

  /* ===== COMPONENTS (SAFE TO EDIT) ===== */
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    .skel { background:linear-gradient(90deg,#f0f0f0 25%,#e8e8e8 50%,#f0f0f0 75%); background-size:200% 100%; animation:shimmer 1.4s ease-in-out infinite; border-radius:12px; }
    .spinner { display:inline-block; width:14px; height:14px; border:2px solid rgba(255,255,255,.35); border-top-color:#fff; border-radius:50%; animation:spin .7s linear infinite; }

    /* â”€â”€ ë¡œê·¸ì¸ ê²Œì´íŠ¸ (ìƒë‹¨ ì •ë ¬ - ëª¨ë°”ì¼ í‚¤ë³´ë“œì— ì•ˆ ê°€ë¦¼) */
    #pwGate { position:fixed; inset:0; background:var(--bg); display:flex; align-items:flex-start; justify-content:center; z-index:9999; padding:60px 20px 20px; overflow-y:auto; }
    .pw-box   { background:var(--card); border-radius:20px; padding:32px 28px; width:100%; max-width:360px; text-align:center; box-shadow:0 4px 24px rgba(0,0,0,.1); }
    .pw-logo  { font-size:48px; margin-bottom:12px; }
    .pw-title { font-size:20px; font-weight:900; margin-bottom:4px; }
    .pw-sub   { font-size:13px; color:var(--sub); margin-bottom:24px; }
    .pw-input { width:100%; padding:14px 16px; border:2px solid var(--border); border-radius:14px; font-size:20px; text-align:center; letter-spacing:6px; font-family:inherit; margin-bottom:10px; }
    .pw-input:focus { outline:none; border-color:var(--text); }
    .pw-btn { width:100%; padding:14px; background:var(--text); color:#fff; border:none; border-radius:14px; font-size:16px; font-weight:800; cursor:pointer; font-family:inherit; margin-bottom:10px; }
    .pw-btn:disabled { opacity:.5; }
    .pw-save { display:flex; align-items:center; justify-content:center; gap:6px; font-size:13px; color:var(--sub); cursor:pointer; margin-bottom:6px; }
    .pw-save input { cursor:pointer; accent-color:var(--text); width:16px; height:16px; }
    .pw-error { font-size:13px; color:var(--red); min-height:18px; margin-top:4px; }

    /* â”€â”€ í—¤ë” */
    .header { background:var(--card); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:200; }
    .header-inner { max-width:1000px; margin:0 auto; padding:11px 16px; display:flex; align-items:center; justify-content:space-between; }
    .logo { display:flex; align-items:center; gap:8px; }
    .logo-icon  { font-size:22px; }
    .logo-name  { font-size:17px; font-weight:900; }
    .logo-badge { padding:2px 10px; background:var(--red); color:#fff; border-radius:20px; font-size:11px; font-weight:800; }
    .hdr-right { display:flex; align-items:center; gap:8px; }
    .hdr-btn { padding:7px 14px; border:1px solid var(--border); border-radius:20px; background:var(--bg); font-size:12px; color:var(--sub); cursor:pointer; font-family:inherit; text-decoration:none; display:inline-block; }

    .container { max-width:1000px; margin:0 auto; padding:16px 16px 80px; }

    /* â”€â”€ ìƒë‹¨ ë„êµ¬ ì˜ì—­ */
    .tools-row { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px,1fr)); gap:12px; margin-bottom:16px; }
    .tool-card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:16px; }
    .tool-title { font-size:14px; font-weight:900; margin-bottom:12px; }

    /* â”€â”€ í¼ ìš”ì†Œ */
    .inp, .txa, .sel {
      width:100%; padding:10px 12px; border:1.5px solid var(--border);
      border-radius:10px; font-size:14px; font-family:inherit; background:var(--card); margin-bottom:8px;
    }
    .txa { min-height:76px; resize:vertical; line-height:1.6; }
    .inp:focus, .txa:focus, .sel:focus { outline:none; border-color:var(--blue); }
    .inp-sm { padding:8px 10px; font-size:13px; }

    /* â”€â”€ ë²„íŠ¼ */
    .btn { padding:9px 16px; border-radius:10px; border:none; cursor:pointer; font-size:13px; font-weight:700; font-family:inherit; display:inline-flex; align-items:center; gap:5px; white-space:nowrap; }
    .btn:disabled { opacity:.45; cursor:not-allowed; }
    .btn-ghost  { background:var(--bg); color:var(--text); border:1.5px solid var(--border); }
    .btn-blue   { background:var(--blue);   color:#fff; }
    .btn-green  { background:var(--green);  color:#fff; }
    .btn-purple { background:var(--purple); color:#fff; }
    .btn-red    { background:var(--red);    color:#fff; }
    .btn-sm     { padding:6px 11px; font-size:12px; }
    .btn-full   { width:100%; justify-content:center; }
    .btn-row    { display:flex; gap:8px; flex-wrap:wrap; }

    /* â”€â”€ ìƒíƒœ ë©”ì‹œì§€ */
    .status { display:none; padding:9px 12px; border-radius:10px; font-size:13px; margin-top:8px; word-break:break-all; }
    .status.show    { display:block; }
    .status.info    { background:#dbeafe; color:#1e40af; }
    .status.success { background:#d1fae5; color:#065f46; }
    .status.error   { background:#fee2e2; color:#991b1b; }

    /* â”€â”€ ê´€ë¦¬ ëª©ë¡ */
    .manage-list { max-height:220px; overflow-y:auto; margin-top:8px; }
    .manage-item { display:flex; align-items:flex-start; gap:8px; background:var(--bg); border-radius:10px; padding:10px; margin-bottom:6px; }
    .manage-em   { font-size:18px; flex-shrink:0; padding-top:1px; }
    .manage-info { flex:1; min-width:0; }
    .manage-title { font-size:13px; font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .manage-meta  { font-size:11px; color:var(--sub); margin-top:2px; }
    .manage-del { padding:5px 9px; background:var(--red); color:#fff; border:none; border-radius:8px; font-size:11px; font-weight:700; cursor:pointer; font-family:inherit; flex-shrink:0; }

    /* â”€â”€ ìºë¦­í„° ê·¸ë¦¬ë“œ (5ì—´ ê¸°ì¤€) */
    .list-head { display:flex; align-items:center; gap:8px; margin-bottom:10px; }
    .search-inp { flex:1; min-width:0; max-width:300px; padding:9px 13px; border:1.5px solid var(--border); border-radius:10px; font-size:14px; font-family:inherit; }
    .search-inp:focus { outline:none; border-color:var(--blue); }

    .char-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:8px; }
    @media (max-width:480px) { .char-grid { grid-template-columns:repeat(4,1fr); } }
    @media (min-width:700px) { .char-grid { grid-template-columns:repeat(6,1fr); } }
    @media (min-width:900px) { .char-grid { grid-template-columns:repeat(8,1fr); } }

    .char-tile { background:var(--card); border:1.5px solid var(--border); border-radius:12px; padding:8px 6px; cursor:pointer; text-align:center; transition:border-color .15s,transform .1s; }
    .char-tile:hover  { border-color:var(--blue); }
    .char-tile:active { transform:scale(.94); }
    .char-av   { width:44px; height:44px; border-radius:10px; object-fit:cover; display:block; margin:0 auto; }
    .char-emoji { font-size:26px; line-height:44px; }
    .char-name  { font-size:11px; font-weight:700; color:var(--text); margin-top:4px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .char-group { font-size:10px; color:var(--sub); margin-top:1px; }

    /* ===== LAYOUT (SAFE TO EDIT) ===== */
  /* â”€â”€ ì˜¤ë²„ë ˆì´ íŒ¨ë„ */
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:flex-end; justify-content:center; z-index:500; padding:8px; }
    .panel { width:100%; max-width:740px; background:var(--card); border-radius:20px; max-height:93vh; overflow-y:auto; }
    .panel-head { position:sticky; top:0; background:var(--card); border-bottom:1px solid var(--border); padding:12px 16px; display:flex; align-items:center; gap:10px; border-radius:20px 20px 0 0; z-index:10; }
    .panel-av   { width:44px; height:44px; border-radius:10px; object-fit:cover; flex-shrink:0; }
    .panel-emoji { font-size:28px; }
    .panel-name { font-size:16px; font-weight:900; }
    .panel-sub  { font-size:12px; color:var(--sub); }
    .panel-close { margin-left:auto; border:1px solid var(--border); background:var(--bg); border-radius:12px; padding:7px 14px; cursor:pointer; font-weight:700; font-family:inherit; font-size:13px; }
    .panel-body { padding:14px; }

    /* â”€â”€ íŒ¨ë„ ì„¹ì…˜ */
    .sec { background:var(--bg); border:1px solid var(--border); border-radius:14px; padding:14px; margin-bottom:12px; }
    .sec-title { font-size:13px; font-weight:900; margin-bottom:10px; }

    /* â”€â”€ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°+ì—…ë¡œë“œ ì¸ë¼ì¸ (4ë²ˆ ìš”êµ¬ì‚¬í•­) */
    .img-row { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
    .img-thumb { width:60px; height:60px; border-radius:12px; object-fit:cover; background:var(--card); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:28px; flex-shrink:0; overflow:hidden; }
    .img-thumb img { width:100%; height:100%; object-fit:cover; }
    .img-url-inp { flex:1; min-width:0; padding:10px 12px; border:1.5px solid var(--border); border-radius:10px; font-size:13px; font-family:inherit; background:var(--card); }
    .img-url-inp:focus { outline:none; border-color:var(--blue); }
    .img-up-btn { padding:10px 13px; background:var(--bg); border:1.5px solid var(--border); border-radius:10px; font-size:12px; font-weight:700; cursor:pointer; font-family:inherit; flex-shrink:0; }

    /* â”€â”€ ì„±ë³„ ë¼ë””ì˜¤ */
    .gender-wrap { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:6px; }
    .gender-wrap label { font-size:13px; display:flex; align-items:center; gap:4px; cursor:pointer; }

    /* â”€â”€ ìºë¦­í„° ìˆ˜ì • í¼ ê·¸ë¦¬ë“œ */
    .row2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px; }
    .row3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:10px; }
    @media (max-width:500px) { .row2, .row3 { grid-template-columns:1fr; } }
    .field label { font-size:11px; font-weight:700; color:var(--sub); display:block; margin-bottom:4px; }
    .field .inp, .field .sel { margin-bottom:0; }

    /* â”€â”€ ê²Œì‹œê¸€ í”¼ì»¤ (AI ëŒ“ê¸€ìš©) */
    .postpick { max-height:180px; overflow-y:auto; display:flex; flex-direction:column; gap:5px; margin-bottom:10px; }
    .postitem { background:var(--card); border:1.5px solid var(--border); border-radius:10px; padding:9px 11px; cursor:pointer; transition:border-color .1s; }
    .postitem.sel { border-color:var(--blue); background:#eef5ff; }
    .postitem-title { font-size:13px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .postitem-meta  { font-size:11px; color:var(--sub); margin-top:2px; }

    /* â”€â”€ ëŒ“ê¸€ ëª©ë¡ í™•ì¥ */
    .cmt-wrap { background:var(--bg); border-radius:10px; padding:10px; margin-top:8px; }
    .cmt-item { display:flex; align-items:flex-start; justify-content:space-between; gap:8px; padding:7px 0; border-bottom:1px solid var(--border); }
    .cmt-item:last-child { border-bottom:none; }
    .cmt-body { font-size:13px; flex:1; }
    .cmt-meta { font-size:11px; color:var(--sub); margin-top:2px; }

    /* â”€â”€ ìºë¦­í„° ì¶”ê°€ ì˜ì—­ */
    .addchar-card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:16px; margin-bottom:16px; }

    /* â”€â”€ í† ìŠ¤íŠ¸ */
    .toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%); background:#1c1c1e; color:#fff; padding:10px 20px; border-radius:20px; font-size:13px; font-weight:600; z-index:9999; opacity:0; transition:opacity .25s; pointer-events:none; white-space:nowrap; max-width:90vw; text-align:center; }
    .toast.show  { opacity:1; }
    .toast.err   { background:var(--red); }
  </style>
</head>
<body>

<div class="toast" id="toast"></div>

<!-- â”€â”€ ë¡œê·¸ì¸ ê²Œì´íŠ¸ -->
<div id="pwGate">
  <div class="pw-box">
    <div class="pw-logo">ğŸŒˆ</div>
    <div class="pw-title">ê´€ë¦¬ì ë¡œê·¸ì¸</div>
    <div class="pw-sub">ë¬´ì§€ê°œ ìœ ì¹˜ì› & ì–´ë¦°ì´ì§‘</div>
    <input type="password" class="pw-input" id="pwInput" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" autocomplete="current-password">
    <button class="pw-btn" id="pwBtn" onclick="checkPw()">ì…ì¥í•˜ê¸°</button>
    <label class="pw-save"><input type="checkbox" id="pwSave"> ì´ ê¸°ê¸°ì—ì„œ ê¸°ì–µí•˜ê¸°</label>
    <div class="pw-error" id="pwError"></div>
  </div>
</div>

<!-- â”€â”€ í—¤ë” -->
<div class="header" id="mainHeader" style="display:none">
  <div class="header-inner">
    <div class="logo">
      <span class="logo-icon">ğŸŒˆ</span>
      <span class="logo-name">ë¬´ì§€ê°œ ê´€ë¦¬ì</span>
      <span class="logo-badge">ADMIN</span>
    </div>
    <div class="hdr-right">
      <a href="index.html" class="hdr-btn">ğŸ  í™ˆ</a>
      <button class="hdr-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>
</div>

<div class="container" id="mainContent" style="display:none">

  <!-- â”€â”€ ìƒë‹¨ ë„êµ¬ ì˜ì—­ -->
  <div class="tools-row">

    <!-- ê³µì§€ ì‘ì„± -->
    <div class="tool-card">
      <div class="tool-title">ğŸ“Œ ê³µì§€ ì‘ì„±</div>
      <select class="inp" id="noticeCharId" style="margin-bottom:8px;">
        <option value="">-- ì‘ì„± ìºë¦­í„° ì„ íƒ --</option>
      </select>
      <input  class="inp" id="noticeTitle" placeholder="ê³µì§€ ì œëª©">
      <textarea class="txa" id="noticeBody" placeholder="ê³µì§€ ë‚´ìš©..." style="min-height:64px;"></textarea>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
          <button class="btn" onclick="document.getElementById('noticeImgInput').click()" style="padding:8px 14px;font-size:12px;">ğŸ“· ì´ë¯¸ì§€ ì²¨ë¶€</button>
          <span id="noticeImgName" style="font-size:12px;color:var(--sub);">ì„ íƒ ì—†ìŒ</span>
          <button id="noticeImgClear" onclick="clearNoticeImg()" style="display:none;padding:4px 8px;font-size:12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);cursor:pointer;">âœ•</button>
        </div>
        <input type="file" id="noticeImgInput" accept="image/*" style="display:none" onchange="handleNoticeImg(this)">
        <div id="noticeImgPreview" style="margin-bottom:8px;"></div>
      <button class="btn btn-blue btn-full" id="noticeSendBtn" onclick="publishNotice()">ğŸ“Œ ê³µì§€ ê²Œì‹œ</button>
      <div class="status" id="noticeStatus"></div>
    </div>

    <!-- ê²Œì‹œê¸€ ê´€ë¦¬ -->
    <div class="tool-card">
      <div class="tool-title">ğŸ”§ ê²Œì‹œê¸€ ê´€ë¦¬</div>
      <div style="display:flex;gap:6px;margin-bottom:8px;">
        <select class="sel" id="mgmtFilter" style="margin-bottom:0;flex:1;" onchange="loadManagePosts()">
          <option value="all">ì „ì²´ ê¸€</option>
          <option value="system">ìºë¦­í„° ê¸€</option>
          <option value="guest">ê²ŒìŠ¤íŠ¸ ê¸€</option>
        </select>
        <button class="btn btn-ghost btn-sm" onclick="loadManagePosts()">ğŸ”„</button>
      </div>
      <div class="manage-list" id="managePosts">
        <div class="skel" style="height:50px;margin-bottom:6px;"></div>
        <div class="skel" style="height:50px;"></div>
      </div>
      <div class="status" id="manageStatus"></div>
    </div>

    <!-- ê³µì§€ ê´€ë¦¬ -->
    <div class="tool-card">
      <div class="tool-title">ğŸ“‹ ê³µì§€ ê´€ë¦¬</div>
      <button class="btn btn-ghost btn-sm" onclick="loadManageNotices()" style="margin-bottom:8px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      <div class="manage-list" id="manageNotices">
        <div class="skel" style="height:50px;margin-bottom:6px;"></div>
        <div class="skel" style="height:50px;"></div>
      </div>
      <div class="status" id="noticeManageStatus"></div>
    </div>

    <!-- ê¸ˆì§€ì–´ ê´€ë¦¬ -->
    <div class="tool-card">
      <div class="tool-title">ğŸš« ê¸ˆì§€ì–´ ê´€ë¦¬</div>
      <div style="display:flex;gap:6px;margin-bottom:8px;">
        <input class="inp" id="newBannedWord" placeholder="ê¸ˆì§€ì–´ ì…ë ¥" style="margin-bottom:0;flex:1;" onkeypress="if(event.key==='Enter')addBannedWord()">
        <button class="btn btn-red btn-sm" onclick="addBannedWord()">ì¶”ê°€</button>
      </div>
      <div class="manage-list" id="bannedWordsList">
        <div class="skel" style="height:36px;margin-bottom:4px;"></div>
      </div>
      <div class="status" id="bannedWordsStatus"></div>
    </div>

  </div>

  <!-- â”€â”€ ìºë¦­í„° ì¶”ê°€ -->
  <div class="addchar-card" id="addCharCard">
    <div class="tool-title" style="cursor:pointer;" onclick="toggleAddChar()">â• ìƒˆ ìºë¦­í„° ì¶”ê°€ <span id="addCharArrow">â–¶</span></div>
    <div id="addCharBody" class="hidden">
      <div class="row2" style="margin-bottom:8px;">
        <div class="field"><label>ì´ë¦„ *</label><input class="inp" id="acName" placeholder="ì¨©ì˜ˆì‹œ" style="margin-bottom:0;"></div>
        <div class="field"><label>ì´ëª¨ì§€</label><input class="inp" id="acEmoji" placeholder="ğŸ±" style="margin-bottom:0;"></div>
      </div>
      <!-- ì´ë¯¸ì§€ (ì´ë¦„ ë‹¤ìŒ ë°”ë¡œ) -->
      <div style="font-size:11px;font-weight:700;color:var(--sub);margin-bottom:5px;">í”„ë¡œí•„ ì´ë¯¸ì§€</div>
      <div class="img-row">
        <div class="img-thumb" id="acThumb">ğŸ¾</div>
        <input class="img-url-inp" id="acImgUrl" placeholder="ì´ë¯¸ì§€ URL ì§ì ‘ ì…ë ¥" oninput="syncThumb('acImgUrl','acThumb','acEmoji')">
        <input type="file" id="acImgFile" accept="image/*" style="display:none;" onchange="uploadImg(this,'acImgUrl','acThumb','acEmoji')">
        <button class="img-up-btn" onclick="document.getElementById('acImgFile').click()">ğŸ“· ì—…ë¡œë“œ</button>
      </div>
      <div class="row3" style="margin-bottom:8px;">
        <div class="field">
          <label>ì†Œì†</label>
          <select class="sel" id="acGroup" style="margin-bottom:0;">
            <option value="kindergarten">ìœ ì¹˜ì›</option>
            <option value="daycare">ì–´ë¦°ì´ì§‘</option>
            <option value="teacher">ì„ ìƒë‹˜</option>
          </select>
        </div>
        <div class="field"><label>ë™ë¬¼ì¢…ë¥˜</label><input class="inp" id="acAnimal" placeholder="ê³ ì–‘ì´" style="margin-bottom:0;"></div>
        <div class="field"><label>MBTI</label><input class="inp" id="acMbti" placeholder="ENFP" style="margin-bottom:0;"></div>
      </div>
      <div style="font-size:11px;font-weight:700;color:var(--sub);margin-bottom:5px;">ì„±ë³„</div>
      <div class="gender-wrap" id="acGenderWrap">
        <label><input type="radio" name="acGR" value="female" checked onchange="handleGender('ac',this)"> ì—¬ì</label>
        <label><input type="radio" name="acGR" value="male"   onchange="handleGender('ac',this)"> ë‚¨ì</label>
        <label><input type="radio" name="acGR" value="other"  onchange="handleGender('ac',this)"> ê¸°íƒ€</label>
        <label><input type="radio" name="acGR" value="secret" onchange="handleGender('ac',this)"> ë°íˆê³ ì‹¶ì§€ì•ŠìŒ</label>
      </div>
      <input class="inp inp-sm hidden" id="acGenderOther" placeholder="ì„±ë³„ ì§ì ‘ ì…ë ¥" style="margin-top:4px;">
      <div class="row2" style="margin-bottom:8px;margin-top:4px;">
        <div class="field"><label>ì¢‹ì•„í•˜ëŠ” ê²ƒ</label><input class="inp" id="acLikes" placeholder="ì•„ì´ëŒ" style="margin-bottom:0;"></div>
        <div class="field"><label>ì·¨ë¯¸</label><input class="inp" id="acHobby" placeholder="ëˆ•ê¸°" style="margin-bottom:0;"></div>
      </div>
      <div style="font-size:11px;font-weight:700;color:var(--sub);margin-bottom:5px;">AI ë§íˆ¬ íŒíŠ¸</div>
      <input class="inp" id="acSpeech" placeholder="ë°ê³  ì¥ë‚œê¸° ë§ì€ ë§íˆ¬, ë¯¼ì´ˆ ë•í›„">
      <button class="btn btn-green btn-full" id="acAddBtn" onclick="addCharacter()">â• ìºë¦­í„° ë“±ë¡</button>
      <div class="status" id="acStatus"></div>
    </div>
  </div>

  <!-- â”€â”€ ìºë¦­í„° ê²€ìƒ‰ + ê·¸ë¦¬ë“œ -->
  <div class="list-head">
    <input class="search-inp" id="charSearch" placeholder="ğŸ” ìºë¦­í„° ê²€ìƒ‰..." oninput="renderGrid()">
    <button class="btn btn-ghost btn-sm" onclick="loadCharacters()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
  </div>
  <div class="char-grid" id="charGrid">
    <div class="skel" style="height:80px;"></div>
    <div class="skel" style="height:80px;"></div>
    <div class="skel" style="height:80px;"></div>
    <div class="skel" style="height:80px;"></div>
    <div class="skel" style="height:80px;"></div>
  </div>

</div><!-- /container -->

<!-- â”€â”€ ìºë¦­í„° íŒ¨ë„ ì˜¤ë²„ë ˆì´ -->
<div id="overlay" class="overlay hidden" onclick="if(event.target===this)closePanel()">
  <div class="panel" onclick="event.stopPropagation()">
    <div class="panel-head">
      <div id="pHeadAv" class="panel-emoji">ğŸ™‚</div>
      <div style="flex:1;min-width:0;">
        <div class="panel-name" id="pName">ìºë¦­í„°</div>
        <div class="panel-sub"  id="pSub"></div>
      </div>
      <button class="panel-close" onclick="closePanel()">âœ• ë‹«ê¸°</button>
    </div>
    <div class="panel-body">

      <!-- â‘  ì´ë¦„ + ì´ë¯¸ì§€ (ì´ë¦„ ë‹¤ìŒ ë°”ë¡œ) -->
      <div class="sec">
        <div class="sec-title">ğŸ‘¤ ê¸°ë³¸ ì •ë³´ Â· ì´ë¯¸ì§€</div>
        <div class="row2" style="margin-bottom:10px;">
          <div class="field"><label>ì´ë¦„</label><input class="inp" id="fName" style="margin-bottom:0;"></div>
          <div class="field"><label>ì´ëª¨ì§€</label><input class="inp" id="fEmoji" style="margin-bottom:0;"></div>
        </div>
        <!-- ì´ë¯¸ì§€ ì¸ë¼ì¸ (4ë²ˆ) -->
        <div style="font-size:11px;font-weight:700;color:var(--sub);margin-bottom:5px;">í”„ë¡œí•„ ì´ë¯¸ì§€</div>
        <div class="img-row">
          <div class="img-thumb" id="pThumb">ğŸ™‚</div>
          <input class="img-url-inp" id="fImgUrl" placeholder="ì´ë¯¸ì§€ URL ì§ì ‘ ì…ë ¥" oninput="syncThumb('fImgUrl','pThumb','fEmoji')">
          <input type="file" id="pImgFile" accept="image/*" style="display:none;" onchange="uploadImg(this,'fImgUrl','pThumb','fEmoji')">
          <button class="img-up-btn" onclick="document.getElementById('pImgFile').click()">ğŸ“· ì—…ë¡œë“œ</button>
        </div>
        <div class="status" id="pImgStatus"></div>
      </div>

      <!-- â‘¡ AI ê²Œì‹œê¸€ ìƒì„± -->
      <div class="sec">
        <div class="sec-title">âœ¨ AI ê²Œì‹œê¸€ ì œì•ˆ</div>
        <div style="font-size:12px;color:var(--sub);margin-bottom:8px;">AIê°€ ì´ ìºë¦­í„° ë§íˆ¬ë¡œ ì´ˆì•ˆì„ ì œì•ˆí•´ìš”. ìˆ˜ì • í›„ ê²Œì‹œí•˜ì„¸ìš”!</div>
        <textarea class="txa" id="aiBody" placeholder="ë³¸ë¬¸"></textarea>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
          <button class="btn" onclick="document.getElementById('aiImgInput').click()" style="padding:8px 14px;font-size:12px;">ğŸ“· ì´ë¯¸ì§€ ì²¨ë¶€</button>
          <span id="aiImgName" style="font-size:12px;color:var(--sub);">ì„ íƒ ì—†ìŒ</span>
          <button id="aiImgClear" onclick="clearAdminImg()" style="display:none;padding:4px 8px;font-size:12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);cursor:pointer;">âœ•</button>
        </div>
        <input type="file" id="aiImgInput" accept="image/*" style="display:none" onchange="handleAdminImg(this)">
        <div id="aiImgPreview" style="margin-bottom:8px;"></div>
        <div style="font-size:11px;font-weight:700;color:var(--sub);margin-bottom:4px;">ì˜ˆì•½ ê²Œì‹œ ì‹œê°„ (ë¹„ì›Œë‘ë©´ ì¦‰ì‹œ)</div>
        <input class="inp" type="datetime-local" id="postScheduled" style="margin-bottom:10px;">
        <div class="btn-row">
          <button class="btn btn-purple" id="btnGenPost" onclick="generatePost()">ğŸ¤– AI ì œì•ˆ</button>
          <button class="btn btn-green"  id="btnPubPost" onclick="publishPost()">ğŸ“¤ ê²Œì‹œ</button>
          <button class="btn btn-ghost btn-sm" onclick="clearPost()">ì´ˆê¸°í™”</button>
        </div>
        <div class="status" id="aiPostStatus"></div>
      </div>

      <!-- â‘¡ - ì˜ˆì•½ ëŒ“ê¸€ ê´€ë¦¬ -->
      <div class="sec">
        <div class="sec-title">ğŸ“‹ ì˜ˆì•½ ëŒ“ê¸€ ê´€ë¦¬</div>
        <div style="font-size:12px;color:var(--sub);margin-bottom:8px;">ê²Œì‹œê¸€ì„ ì„ íƒí•˜ë©´ ì˜ˆì•½ëœ ëŒ“ê¸€ ëª©ë¡ì„ ë³¼ ìˆ˜ ìˆì–´ìš”.</div>
        <div id="scheduledCmtList" style="font-size:13px;color:var(--sub);">ê²Œì‹œê¸€ì„ ì„ íƒí•˜ì„¸ìš”.</div>
      </div>

      <!-- â‘¢ AI ëŒ“ê¸€ ìƒì„± + ì˜ˆì•½ ì‹œê°„ (5ë²ˆ) -->
      <div class="sec">
        <div class="sec-title">ğŸ’¬ AI ëŒ“ê¸€ ì œì•ˆ</div>
        <div style="font-size:12px;color:var(--sub);margin-bottom:8px;">ê²Œì‹œê¸€ì„ ì„ íƒí•˜ë©´ AIê°€ ì´ ìºë¦­í„° ë§íˆ¬ë¡œ ëŒ“ê¸€ì„ ì œì•ˆí•´ìš”.</div>
        <div class="postpick" id="postPicker"><div style="color:var(--sub);font-size:13px;">ê²Œì‹œê¸€ ì—†ìŒ</div></div>
        <textarea class="txa" id="aiComment" placeholder="ëŒ“ê¸€ ë‚´ìš©..." style="min-height:56px;"></textarea>
        <div style="font-size:11px;font-weight:700;color:var(--sub);margin-bottom:4px;">ì˜ˆì•½ ê²Œì‹œ ì‹œê°„ (ë¹„ì›Œë‘ë©´ ì¦‰ì‹œ)</div>
        <input class="inp" type="datetime-local" id="cmtScheduled" style="margin-bottom:10px;">
        <div class="btn-row">
          <button class="btn btn-purple" id="btnGenCmt" onclick="generateComment()">ğŸ¤– AI ì œì•ˆ</button>
          <button class="btn btn-green"  id="btnPubCmt" onclick="publishComment()">ğŸ“¤ ëŒ“ê¸€ ê²Œì‹œ</button>
          <button class="btn btn-ghost btn-sm" onclick="document.getElementById('aiComment').value=''">ì´ˆê¸°í™”</button>
        </div>
        <div class="status" id="aiCommentStatus"></div>
      </div>

      <!-- â‘£ ëŒ“ê¸€ ë³´ê¸°/ì‚­ì œ -->
      <div class="sec">
        <div class="sec-title">ğŸ—‚ ëŒ“ê¸€ ê´€ë¦¬</div>
        <div style="font-size:12px;color:var(--sub);margin-bottom:8px;">ìœ„ì—ì„œ ê²Œì‹œê¸€ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ ê¸€ì˜ ëŒ“ê¸€ì„ ê´€ë¦¬í•  ìˆ˜ ìˆì–´ìš”.</div>
        <button class="btn btn-ghost btn-sm" onclick="loadSelectedPostComments()">ğŸ’¬ ì„ íƒí•œ ê²Œì‹œê¸€ ëŒ“ê¸€ ë³´ê¸°</button>
        <div id="cmtManageWrap"></div>
      </div>

      <!-- â‘¤ ìºë¦­í„° ì •ë³´ í¸ì§‘ -->
      <div class="sec">
        <div class="sec-title">ğŸ“ ìºë¦­í„° ì •ë³´ í¸ì§‘</div>
        <div class="row3">
          <div class="field">
            <label>ì†Œì†</label>
            <select class="sel" id="fGroup" style="margin-bottom:0;">
              <option value="kindergarten">ìœ ì¹˜ì›</option>
              <option value="daycare">ì–´ë¦°ì´ì§‘</option>
              <option value="teacher">ì„ ìƒë‹˜</option>
            </select>
          </div>
          <div class="field"><label>ë™ë¬¼ì¢…ë¥˜</label><input class="inp" id="fAnimal" style="margin-bottom:0;"></div>
          <div class="field"><label>MBTI</label><input class="inp" id="fMbti" placeholder="ENFP" style="margin-bottom:0;"></div>
        </div>
        <!-- ì„±ë³„ ë¼ë””ì˜¤ (3ë²ˆ) -->
        <div style="font-size:11px;font-weight:700;color:var(--sub);margin:10px 0 5px;">ì„±ë³„</div>
        <div class="gender-wrap">
          <label><input type="radio" name="fGR" value="female" onchange="handleGender('f',this)"> ì—¬ì</label>
          <label><input type="radio" name="fGR" value="male"   onchange="handleGender('f',this)"> ë‚¨ì</label>
          <label><input type="radio" name="fGR" value="other"  onchange="handleGender('f',this)"> ê¸°íƒ€</label>
          <label><input type="radio" name="fGR" value="secret" onchange="handleGender('f',this)"> ë°íˆê³ ì‹¶ì§€ì•ŠìŒ</label>
        </div>
        <input class="inp inp-sm hidden" id="fGenderOther" placeholder="ì„±ë³„ ì§ì ‘ ì…ë ¥" style="margin-top:4px;margin-bottom:8px;">
        <div class="row2">
          <div class="field"><label>ì¢‹ì•„í•˜ëŠ” ê²ƒ</label><input class="inp" id="fLikes" style="margin-bottom:0;"></div>
          <div class="field"><label>ì·¨ë¯¸</label><input class="inp" id="fHobby" style="margin-bottom:0;"></div>
        </div>
        <div class="row2" style="margin-top:10px;">
          <div class="field"><label>ì‹«ì–´í•˜ëŠ” ê²ƒ</label><input class="inp" id="fDislikes" style="margin-bottom:0;"></div>
          <div class="field"><label>ë¹„ë°€</label><input class="inp" id="fSecret" style="margin-bottom:0;"></div>
        </div>
        <div style="margin-top:10px;">
          <div style="font-size:11px;font-weight:700;color:var(--sub);margin-bottom:4px;">AI ë§íˆ¬ íŒíŠ¸ (speech_style)</div>
          <input class="inp" id="fSpeech" placeholder="ë°ê³  ì¥ë‚œê¸° ë§ì€ ë§íˆ¬, ë¯¼ì´ˆ ë•í›„">
        </div>
        <div style="margin-top:2px;">
          <div style="font-size:11px;font-weight:700;color:var(--sub);margin-bottom:4px;">ë‹µëŒ“ê¸€ ë°˜ì‘ì†ë„ (ë¶„, ê¸°ë³¸ 30)</div>
          <input class="inp" type="number" id="fSpeed" placeholder="30" min="1" max="1440">
        </div>
        <div class="btn-row">
          <button class="btn btn-green" id="btnSave" onclick="saveProfile()">ğŸ’¾ ì €ì¥</button>
          <button class="btn btn-ghost btn-sm" onclick="resetForm()">ë˜ëŒë¦¬ê¸°</button>
        </div>
        <div class="status" id="pSaveStatus"></div>
      </div>

    </div>
  </div>
</div>
<script>
  var API = 'https://rainbowkidz-api.irunaru.workers.dev/api/v1';
  var ADMIN_PW = 'yimkim1221';

  var adminKey      = '';
  var characters    = [];
  var cachedFeed    = [];
  var selectedChar  = null;
  var adminImgFile  = null;
  var noticeImgFile = null;

  function handleNoticeImg(input) {
    const file = input.files[0];
    if (!file) return;
    if (file.size > 5 * 1024 * 1024) { alert('ì´ë¯¸ì§€ëŠ” 5MB ì´í•˜ë§Œ ì²¨ë¶€í•  ìˆ˜ ìˆì–´ìš”'); input.value=''; return; }
    noticeImgFile = file;
    document.getElementById('noticeImgName').textContent = file.name;
    document.getElementById('noticeImgClear').style.display = 'inline-block';
    const url = URL.createObjectURL(file);
    document.getElementById('noticeImgPreview').innerHTML =
      `<img src="${url}" style="width:80px;height:80px;border-radius:8px;object-fit:cover;border:1.5px solid var(--border);">`;
  }

  function clearNoticeImg() {
    noticeImgFile = null;
    document.getElementById('noticeImgInput').value = '';
    document.getElementById('noticeImgName').textContent = 'ì„ íƒ ì—†ìŒ';
    document.getElementById('noticeImgClear').style.display = 'none';
    document.getElementById('noticeImgPreview').innerHTML = '';
  }
  var selectedPostId = null;

  // â”€â”€ ìœ í‹¸
  const esc = s => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  const groupLabel = g => g==='kindergarten'?'ìœ ì¹˜ì›':g==='daycare'?'ì–´ë¦°ì´ì§‘':'ì„ ìƒë‹˜';
  const relTime = d => {
    const s = (Date.now()-new Date(d))/1000;
    if(s<60)    return 'ë°©ê¸ˆ';
    if(s<3600)  return `${Math.floor(s/60)}ë¶„ ì „`;
    if(s<86400) return `${Math.floor(s/3600)}ì‹œê°„ ì „`;
    return `${Math.floor(s/86400)}ì¼ ì „`;
  };

  function toast(msg, err=false) {
    const t=document.getElementById('toast');
    t.textContent=msg; t.className='toast show'+(err?' err':'');
    clearTimeout(t._t); t._t=setTimeout(()=>{t.className='toast';},3000);
  }
  function showStatus(id, msg, type='info') {
    const el=document.getElementById(id); if(!el) return;
    el.textContent=msg; el.className='status show '+type;
  }
  function hideStatus(id) {
    const el=document.getElementById(id); if(el) el.className='status';
  }

  // â”€â”€ API fetch ê³µí†µ
  function adminFetch(path, opts) {
    opts = opts || {};
    var headers = {'X-Admin-Key': adminKey};
    if (opts.body && typeof opts.body === 'string') {
      headers['Content-Type'] = 'application/json';
    }
    var mergedHeaders = Object.assign({}, headers, opts.headers || {});
    return fetch(API + path, Object.assign({}, opts, {headers: mergedHeaders}))
      .then(function(res) {
        if (res.status === 401) {
          // í‚¤ ë§Œë£Œ/ë¶ˆì¼ì¹˜ â†’ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
          adminKey = '';
          localStorage.removeItem('rkAdminKey');
          sessionStorage.removeItem('rkAdminKey');
          document.getElementById('pwGate').style.display = '';
          document.getElementById('mainHeader').style.display = 'none';
          document.getElementById('mainContent').style.display = 'none';
          document.getElementById('pwError').textContent = 'ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆì–´ìš”. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.';
        }
        return res;
      });
  }

  // â”€â”€ ë¡œê·¸ì¸ (ë‹¨ìˆœ ë¡œì»¬ ë¹„êµ)
  function checkPw() {
    var pw  = document.getElementById('pwInput').value.trim();
    var err = document.getElementById('pwError');
    err.textContent = '';
    if (!pw) { err.textContent = 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'; return; }
    if (pw !== ADMIN_PW) { err.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ì–´ìš”'; return; }
    adminKey = ADMIN_PW;
    try {
      if (document.getElementById('pwSave').checked) localStorage.setItem('rkAdminKey', ADMIN_PW);
      sessionStorage.setItem('rkAdminKey', ADMIN_PW);
    } catch(e) {}
    enterAdmin();
  }

  function enterAdmin() {
    document.getElementById('pwGate').style.display = 'none';
    document.getElementById('mainHeader').style.display = '';
    document.getElementById('mainContent').style.display = '';
    init();
  }

  function logout() {
    adminKey = '';
    try { sessionStorage.removeItem('rkAdminKey'); localStorage.removeItem('rkAdminKey'); } catch(e) {}
    document.getElementById('pwGate').style.display = '';
    document.getElementById('mainHeader').style.display = 'none';
    document.getElementById('mainContent').style.display = 'none';
    document.getElementById('pwInput').value = '';
    document.getElementById('pwSave').checked = false;
  }

  // â”€â”€ ì—”í„°í‚¤ ë¡œê·¸ì¸
  document.getElementById('pwInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') checkPw();
  });

  // â”€â”€ ìë™ ë¡œê·¸ì¸ (ì €ì¥ëœ í‚¤)
  (function() {
    try {
      var saved = localStorage.getItem('rkAdminKey') || sessionStorage.getItem('rkAdminKey');
      if (saved && saved === ADMIN_PW) {
        adminKey = saved;
        if (localStorage.getItem('rkAdminKey')) document.getElementById('pwSave').checked = true;
        enterAdmin();
        return;
      }
    } catch(e) {}
    document.getElementById('pwInput').focus();
  })();

  // â”€â”€ ì´ˆê¸°í™”
  async function init() {
    await Promise.all([loadCharacters(), loadManagePosts(), loadManageNotices(), loadBannedWords()]);
    await loadFeed();
  }

  // â”€â”€ ìºë¦­í„° ë¡œë“œ
  async function loadCharacters() {
    try {
      const r = await adminFetch('/characters');
      if(r.ok) {
        const d=await r.json();
        characters=d.characters||[];
        // ê³µì§€ ì‘ì„± ìºë¦­í„° - ì„ ìƒë‹˜(teacher)ìœ¼ë¡œ ê³ ì •, ë³€ê²½ ë¶ˆê°€
        const sel = document.getElementById('noticeCharId');
        if (sel) {
          const teacher = characters.find(c => c.group_type === 'teacher');
          if (teacher) {
            sel.innerHTML = `<option value="${teacher.id}" selected>${teacher.emoji||''} ${teacher.display_name} (ì„ ìƒë‹˜ ê³ ì •)</option>`;
            sel.value = teacher.id;
            sel.disabled = true;
          }
        }
      }
    } catch {}
    renderGrid();
  }

  async function loadFeed(limit=50) {
    try {
      const r = await fetch(API+`/timeline?limit=${limit}&sort=latest`);
      if(r.ok) { const d=await r.json(); cachedFeed=d.posts||[]; }
    } catch {}
  }

  function renderGrid() {
    const q    = (document.getElementById('charSearch')?.value||'').toLowerCase();
    const grid = document.getElementById('charGrid');
    const list = q ? characters.filter(c=>c.display_name.toLowerCase().includes(q)) : characters;
    if(!list.length) { grid.innerHTML='<div style="color:var(--sub);font-size:13px;grid-column:1/-1;">ìºë¦­í„° ì—†ìŒ</div>'; return; }
    grid.innerHTML = list.map(c => {
      const avEl = c.image_url
        ? `<img class="char-av" src="${esc(c.image_url)}" alt="${esc(c.display_name)}" onerror="this.style.display='none';this.nextSibling.style.display='block'"><span class="char-emoji" style="display:none;">${esc(c.emoji||'ğŸ¾')}</span>`
        : `<div class="char-emoji">${esc(c.emoji||'ğŸ¾')}</div>`;
      return `<div class="char-tile" onclick="openPanel(${c.id})">
        ${avEl}
        <div class="char-name">${esc(c.display_name)}</div>
        <div class="char-group">${groupLabel(c.group_type)}</div>
      </div>`;
    }).join('');
  }

  // â”€â”€ ìºë¦­í„° íŒ¨ë„
  async function openPanel(charId) {
    const c = characters.find(x=>x.id===charId);
    if(!c) return;
    selectedChar=c; selectedPostId=null;
    // í—¤ë”
    const hav = document.getElementById('pHeadAv');
    if(c.image_url) {
      hav.innerHTML=`<img class="panel-av" src="${esc(c.image_url)}" alt="${esc(c.display_name)}" onerror="this.parentElement.textContent='${esc(c.emoji||'ğŸ¾')}'">`;
    } else { hav.textContent=c.emoji||'ğŸ¾'; }
    document.getElementById('pName').textContent = c.display_name;
    document.getElementById('pSub').textContent  = `${groupLabel(c.group_type)} Â· ${c.animal_type||''} Â· ${c.mbti||''}`;
    fillForm(c);
    if(!cachedFeed.length) await loadFeed();
    renderPostPicker();
    document.getElementById('overlay').classList.remove('hidden');
    document.getElementById('aiCommentStatus').className='status';
    document.getElementById('aiPostStatus').className='status';
    document.getElementById('pSaveStatus').className='status';
    document.getElementById('cmtManageWrap').innerHTML='';
  }

  function closePanel() {
    document.getElementById('overlay').classList.add('hidden');
    selectedChar=null; selectedPostId=null;
  }

  // â”€â”€ í¼ ì±„ìš°ê¸°
  function fillForm(c) {
    document.getElementById('fName').value   = c.display_name||'';
    document.getElementById('fEmoji').value  = c.emoji||'';
    document.getElementById('fGroup').value  = c.group_type||'kindergarten';
    document.getElementById('fAnimal').value = c.animal_type||'';
    document.getElementById('fMbti').value   = c.mbti||'';
    document.getElementById('fLikes').value  = c.likes||'';
    document.getElementById('fHobby').value  = c.hobby||'';
    document.getElementById('fDislikes').value = c.dislikes||'';
    document.getElementById('fSecret').value   = c.secret||'';
    document.getElementById('fSpeech').value   = c.speech_style||'';
    document.getElementById('fSpeed').value    = c.response_speed||'';
    document.getElementById('fImgUrl').value   = c.image_url||'';
    // ì´ë¯¸ì§€ ì¸ë„¤ì¼
    const th = document.getElementById('pThumb');
    if(c.image_url) th.innerHTML=`<img src="${esc(c.image_url)}" alt="${esc(c.display_name)}" onerror="this.parentElement.textContent='${esc(c.emoji||'ğŸ¾')}'">`;
    else th.textContent=c.emoji||'ğŸ¾';
    // ì„±ë³„
    setGender('f', c.gender||'');
  }

  function resetForm() {
    if(selectedChar) { fillForm(selectedChar); showStatus('pSaveStatus','ë˜ëŒë ¸ìŠµë‹ˆë‹¤','info'); }
  }

  // â”€â”€ ì„±ë³„ ê³µí†µ í•¸ë“¤ëŸ¬
  function handleGender(prefix, radio) {
    const otherEl = document.getElementById(prefix==='ac'?'acGenderOther':'fGenderOther');
    otherEl.classList.toggle('hidden', radio.value!=='other');
  }
  function setGender(prefix, val) {
    const knownVals = ['female','male','secret'];
    const isKnown   = knownVals.includes(val);
    const otherEl   = document.getElementById(prefix==='ac'?'acGenderOther':'fGenderOther');
    const radioVal  = isKnown ? val : (val?'other':'female');
    const radios    = document.querySelectorAll(`input[name="${prefix}GR"]`);
    radios.forEach(r => { if(r.value===radioVal) r.checked=true; });
    otherEl.classList.toggle('hidden', radioVal!=='other');
    if(!isKnown && val) otherEl.value=val;
  }
  function getGender(prefix) {
    const radios = document.querySelectorAll(`input[name="${prefix}GR"]`);
    let val='';
    radios.forEach(r=>{ if(r.checked) val=r.value; });
    if(val==='other') return (document.getElementById(prefix==='ac'?'acGenderOther':'fGenderOther').value.trim());
    if(val==='secret') return 'ë°íˆê³ ì‹¶ì§€ì•ŠìŒ';
    return val;
  }

  // â”€â”€ ì´ë¯¸ì§€ ì—…ë¡œë“œ ê³µí†µ
  function syncThumb(urlId, thumbId, emojiId) {
    const url   = document.getElementById(urlId).value.trim();
    const thumb = document.getElementById(thumbId);
    const emoji = document.getElementById(emojiId)?.value || 'ğŸ¾';
    if(!url) { thumb.innerHTML=''; thumb.textContent=emoji; return; }
    thumb.innerHTML=`<img src="${esc(url)}" alt="ë¯¸ë¦¬ë³´ê¸°" onerror="this.parentElement.textContent='${esc(emoji)}'">`;
  }

  async function uploadImg(inputEl, urlId, thumbId, emojiId) {
    const file = inputEl.files[0]; if(!file) return;
    if(file.size>5*1024*1024) { toast('5MB ì´í•˜ ì´ë¯¸ì§€ë§Œ ê°€ëŠ¥í•´ìš”',true); return; }
    const thumb = document.getElementById(thumbId);
    thumb.innerHTML='<div class="spinner" style="border-top-color:var(--blue);border-color:var(--border);"></div>';
    const fd=new FormData(); fd.append('image',file);
    if(selectedChar?.id) fd.append('character_id', selectedChar.id);
    try {
      const r = await adminFetch('/admin/upload-image', { method:'POST', body:fd });
      const d = await r.json();
      if(d.ok) {
        document.getElementById(urlId).value=d.image_url;
        syncThumb(urlId,thumbId,emojiId);
        toast('âœ… ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ');
      } else { toast(d.error||'ì—…ë¡œë“œ ì‹¤íŒ¨',true); thumb.textContent='âŒ'; }
    } catch { toast('ì—…ë¡œë“œ ì˜¤ë¥˜',true); thumb.textContent='âŒ'; }
    inputEl.value='';
  }

  // â”€â”€ ìºë¦­í„° ì €ì¥
  async function saveProfile() {
    if(!selectedChar) return;
    const btn=document.getElementById('btnSave');
    btn.disabled=true; btn.innerHTML='<span class="spinner"></span> ì €ì¥ ì¤‘';
    showStatus('pSaveStatus','ì €ì¥ ì¤‘...','info');
    const payload = {
      display_name:   document.getElementById('fName').value.trim(),
      emoji:          document.getElementById('fEmoji').value.trim(),
      group_type:     document.getElementById('fGroup').value,
      animal_type:    document.getElementById('fAnimal').value.trim(),
      gender:         getGender('f'),
      mbti:           document.getElementById('fMbti').value.trim(),
      likes:          document.getElementById('fLikes').value.trim(),
      hobby:          document.getElementById('fHobby').value.trim(),
      dislikes:       document.getElementById('fDislikes').value.trim(),
      secret:         document.getElementById('fSecret').value.trim(),
      speech_style:   document.getElementById('fSpeech').value.trim(),
      response_speed: parseInt(document.getElementById('fSpeed').value)||null,
      image_url:      document.getElementById('fImgUrl').value.trim()||null,
    };
    try {
      const r = await adminFetch(`/admin/characters/${selectedChar.id}`, {
        method:'PATCH', body:JSON.stringify(payload),
      });
      const d = await r.json();
      if(d.ok) {
        showStatus('pSaveStatus','âœ… ì €ì¥ëì–´ìš”','success');
        await loadCharacters();
        const updated=characters.find(c=>c.id===selectedChar.id);
        if(updated) { selectedChar=updated; fillForm(updated); }
        // í—¤ë” ì•„ë°”íƒ€ ê°±ì‹ 
        const hav=document.getElementById('pHeadAv');
        if(updated?.image_url) hav.innerHTML=`<img class="panel-av" src="${esc(updated.image_url)}" alt="${esc(updated.display_name)}">`;
        else hav.textContent=updated?.emoji||'ğŸ¾';
        document.getElementById('pName').textContent=updated?.display_name||'';
      } else { showStatus('pSaveStatus','âŒ '+d.error,'error'); }
    } catch(e) { showStatus('pSaveStatus','âŒ '+e.message,'error'); }
    btn.disabled=false; btn.textContent='ğŸ’¾ ì €ì¥';
  }

  // â”€â”€ AI ê²Œì‹œê¸€
  function clearPost() {
    document.getElementById('aiBody').value='';
    document.getElementById('postScheduled').value='';
    hideStatus('aiPostStatus');
    clearAdminImg();
  }

  function handleAdminImg(input) {
    const file = input.files[0];
    if (!file) return;
    if (file.size > 5 * 1024 * 1024) { alert('ì´ë¯¸ì§€ëŠ” 5MB ì´í•˜ë§Œ ì²¨ë¶€í•  ìˆ˜ ìˆì–´ìš”'); input.value=''; return; }
    adminImgFile = file;
    document.getElementById('aiImgName').textContent = file.name;
    document.getElementById('aiImgClear').style.display = 'inline-block';
    const url = URL.createObjectURL(file);
    document.getElementById('aiImgPreview').innerHTML =
      `<img src="${url}" style="width:80px;height:80px;border-radius:8px;object-fit:cover;border:1.5px solid var(--border);">`;
  }

  function clearAdminImg() {
    adminImgFile = null;
    document.getElementById('aiImgInput').value = '';
    document.getElementById('aiImgName').textContent = 'ì„ íƒ ì—†ìŒ';
    document.getElementById('aiImgClear').style.display = 'none';
    document.getElementById('aiImgPreview').innerHTML = '';
  }

  async function generatePost() {
    if(!selectedChar) { toast('ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”',true); return; }
    const btn=document.getElementById('btnGenPost');
    btn.disabled=true; btn.innerHTML='<span class="spinner"></span> ìƒì„± ì¤‘';
    showStatus('aiPostStatus','ìƒì„± ì¤‘...','info');
    try {
      const r=await adminFetch('/admin/generate-post', {
        method:'POST', body:JSON.stringify({character_id:selectedChar.id}),
      });
      const d=await r.json();
      if(d.ok && d.post) {
        document.getElementById('aiBody').value =d.post.body ||'';
        showStatus('aiPostStatus','âœ… AI ì œì•ˆ ì™„ë£Œ! ìˆ˜ì • í›„ ê²Œì‹œí•˜ì„¸ìš”','success');
      } else { showStatus('aiPostStatus','âŒ '+(d.error||'ìƒì„± ì‹¤íŒ¨'),'error'); }
    } catch(e) { showStatus('aiPostStatus','âŒ '+e.message,'error'); }
    btn.disabled=false; btn.innerHTML='ğŸ¤– AI ì œì•ˆ';
  }

  async function publishPost() {
    if(!selectedChar) { toast('ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”',true); return; }
    const body     = document.getElementById('aiBody').value.trim();
    if(!body) { showStatus('aiPostStatus','ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”','error'); return; }
    const btn=document.getElementById('btnPubPost');
    btn.disabled=true; btn.innerHTML='<span class="spinner"></span> ê²Œì‹œ ì¤‘';
    showStatus('aiPostStatus','ê²Œì‹œ ì¤‘...','info');
    try {
      // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ë¨¼ì € ì—…ë¡œë“œ
      let mediaUrl = null;
      if (adminImgFile) {
        const fd = new FormData();
        fd.append('image', adminImgFile);
        fd.append('character_id', `post_${selectedChar.id}_${Date.now()}`);
        const upRes = await adminFetch('/admin/upload-image', { method:'POST', body:fd });
        const upData = await upRes.json();
        if (upData.image_url) mediaUrl = upData.image_url;
        else { showStatus('aiPostStatus','ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨','error'); btn.disabled=false; btn.innerHTML='ğŸ“¤ ê²Œì‹œ'; return; }
      }
      const scheduled = document.getElementById('postScheduled').value;
      const r=await adminFetch('/system/posts', {
        method:'POST', body:JSON.stringify({
          system_user_id: selectedChar.id, title: '', body,
          is_notice: false, media_url: mediaUrl||null,
          scheduled_at: scheduled ? new Date(scheduled).toISOString() : null,
        }),
      });
      const d=await r.json();
      if(d.ok) {
        const msg = scheduled ? `âœ… ê²Œì‹œ ì˜ˆì•½ ì™„ë£Œ (${new Date(scheduled).toLocaleString('ko-KR')})` : 'âœ… ê²Œì‹œ ì™„ë£Œ';
        showStatus('aiPostStatus', msg, 'success');
        clearPost(); await loadFeed(); renderPostPicker(); loadManagePosts();
      } else { showStatus('aiPostStatus','âŒ '+(d.error||'ì‹¤íŒ¨'),'error'); }
    } catch(e) { showStatus('aiPostStatus','âŒ '+e.message,'error'); }
    btn.disabled=false; btn.innerHTML='ğŸ“¤ ê²Œì‹œ';
  }

  // â”€â”€ ê²Œì‹œê¸€ í”¼ì»¤
  function renderPostPicker() {
    const wrap=document.getElementById('postPicker');
    if(!cachedFeed.length) { wrap.innerHTML='<div style="color:var(--sub);font-size:13px;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤</div>'; return; }
    wrap.innerHTML = cachedFeed.map(p=>`
      <div class="postitem${String(selectedPostId)===String(p.id)?' sel':''}" onclick="selectPost(${p.id})">
        <div class="postitem-title">${esc((p.character_emoji||p.author_emoji||'ğŸ‘¤')+' '+(p.title||p.body?.slice(0,30)||'ì œëª©ì—†ìŒ'))}</div>
        <div class="postitem-meta">${esc(p.character_name||p.nickname||'ìµëª…')} Â· ID:${p.id} Â· ëŒ“ê¸€ ${p.comment_count||0}</div>
      </div>`).join('');
  }
  function selectPost(id) { selectedPostId=id; renderPostPicker(); loadScheduledComments(id); }

  async function loadScheduledComments(postId) {
    const el = document.getElementById('scheduledCmtList');
    if (!el) return;
    el.innerHTML = 'ë¡œë”© ì¤‘...';
    try {
      // Supabaseì—ì„œ ë¯¸ë˜ ì˜ˆì•½ëŒ“ê¸€ë§Œ ì¡°íšŒ
      const now = new Date().toISOString();
      const r = await adminFetch(`/admin/scheduled-comments?post_id=${postId}`);
      const d = await r.json();
      const list = d.comments || [];
      if (!list.length) { el.innerHTML = '<span style="color:var(--sub);">ì˜ˆì•½ëœ ëŒ“ê¸€ì´ ì—†ì–´ìš”.</span>'; return; }
      el.innerHTML = list.map(c => `
        <div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);">
          <div style="flex:1;min-width:0;">
            <div style="font-weight:700;font-size:12px;">${esc(c.nickname||'ìºë¦­í„°')}</div>
            <div style="font-size:12px;color:var(--sub);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(c.body)}</div>
            <div style="font-size:11px;color:var(--sub2);">â° ${new Date(c.scheduled_at).toLocaleString('ko-KR')}</div>
          </div>
          <button class="btn btn-red btn-sm" onclick="cancelScheduledComment(${c.id})">ì·¨ì†Œ</button>
        </div>`).join('');
    } catch(e) { el.innerHTML = `<span style="color:var(--accent);">ì˜¤ë¥˜: ${e.message}</span>`; }
  }

  async function cancelScheduledComment(commentId) {
    if (!confirm('ì˜ˆì•½ ëŒ“ê¸€ì„ ì·¨ì†Œ(ì‚­ì œ)í• ê¹Œìš”?')) return;
    const r = await adminFetch(`/admin/comments/${commentId}`, { method:'DELETE' });
    const d = await r.json();
    if (d.ok) { toast('ì˜ˆì•½ ëŒ“ê¸€ ì·¨ì†Œë¨'); if (selectedPostId) loadScheduledComments(selectedPostId); }
    else toast('ì‚­ì œ ì‹¤íŒ¨: ' + (d.error||''), true);
  }

  // â”€â”€ AI ëŒ“ê¸€ (ì˜ˆì•½ ì‹œê°„ í¬í•¨, 5ë²ˆ)
  async function generateComment() {
    if(!selectedChar)   { showStatus('aiCommentStatus','ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”','error');  return; }
    if(!selectedPostId) { showStatus('aiCommentStatus','ê²Œì‹œê¸€ì„ ì„ íƒí•˜ì„¸ìš”','error'); return; }
    const btn=document.getElementById('btnGenCmt');
    btn.disabled=true; btn.innerHTML='<span class="spinner"></span> ìƒì„± ì¤‘';
    showStatus('aiCommentStatus','ìƒì„± ì¤‘...','info');
    try {
      const r=await adminFetch('/admin/generate-comment', {
        method:'POST', body:JSON.stringify({post_id:selectedPostId, character_id:selectedChar.id}),
      });
      const d=await r.json();
      if(d.ok) {
        document.getElementById('aiComment').value=d.comment||'';
        showStatus('aiCommentStatus','âœ… AI ì œì•ˆ ì™„ë£Œ! ìˆ˜ì • í›„ ê²Œì‹œí•˜ì„¸ìš”','success');
      } else { showStatus('aiCommentStatus','âŒ '+(d.error||'ì‹¤íŒ¨'),'error'); }
    } catch(e) { showStatus('aiCommentStatus','âŒ '+e.message,'error'); }
    btn.disabled=false; btn.innerHTML='ğŸ¤– AI ì œì•ˆ';
  }

  async function publishComment() {
    if(!selectedChar)   { showStatus('aiCommentStatus','ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”','error');  return; }
    if(!selectedPostId) { showStatus('aiCommentStatus','ê²Œì‹œê¸€ì„ ì„ íƒí•˜ì„¸ìš”','error'); return; }
    const body      = document.getElementById('aiComment').value.trim();
    const scheduled = document.getElementById('cmtScheduled').value;
    if(!body) { showStatus('aiCommentStatus','ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”','error'); return; }
    const btn=document.getElementById('btnPubCmt');
    btn.disabled=true; btn.innerHTML='<span class="spinner"></span> ê²Œì‹œ ì¤‘';
    showStatus('aiCommentStatus','ê²Œì‹œ ì¤‘...','info');
    try {
      const payload={post_id:selectedPostId, system_user_id:selectedChar.id, body};
      if(scheduled) payload.scheduled_at=new Date(scheduled).toISOString();
      const r=await adminFetch('/admin/system-comment', {
        method:'POST', body:JSON.stringify(payload),
      });
      const d=await r.json();
      if(d.ok) {
        document.getElementById('aiComment').value='';
        document.getElementById('cmtScheduled').value='';
        const msg = scheduled ? `âœ… ëŒ“ê¸€ ì˜ˆì•½ ì™„ë£Œ (${new Date(scheduled).toLocaleString('ko-KR')})` : 'âœ… ëŒ“ê¸€ ê²Œì‹œ ì™„ë£Œ';
        showStatus('aiCommentStatus',msg,'success');
        await loadFeed(); renderPostPicker(); loadManagePosts();
      } else { showStatus('aiCommentStatus','âŒ '+(d.error||'ì‹¤íŒ¨'),'error'); }
    } catch(e) { showStatus('aiCommentStatus','âŒ '+e.message,'error'); }
    btn.disabled=false; btn.innerHTML='ğŸ“¤ ëŒ“ê¸€ ê²Œì‹œ';
  }

  // â”€â”€ ëŒ“ê¸€ ê´€ë¦¬ (7ë²ˆ - ëŒ“ê¸€ ë³´ê¸°/ì‚­ì œ)
  async function loadSelectedPostComments() {
    const wrap=document.getElementById('cmtManageWrap');
    if(!selectedPostId) { wrap.innerHTML='<div style="color:var(--sub);font-size:13px;margin-top:8px;">ê²Œì‹œê¸€ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”</div>'; return; }
    wrap.innerHTML='<div style="color:var(--sub);font-size:13px;margin-top:8px;">ë¡œë”© ì¤‘...</div>';
    try {
      const r=await fetch(API+`/posts/${selectedPostId}/comments?limit=100`);
      const d=await r.json();
      const cmts=d.comments||[];
      if(!cmts.length) { wrap.innerHTML='<div class="cmt-wrap"><div style="color:var(--sub);font-size:13px;">ëŒ“ê¸€ì´ ì—†ì–´ìš”</div></div>'; return; }
      wrap.innerHTML=`<div class="cmt-wrap">${cmts.map(cm=>{
        const nick=cm.system_users?.display_name||cm.nickname||'ìµëª…';
        const badge=cm.author_type==='system'?'ğŸ¾':'ğŸ—£ï¸';
        return `<div class="cmt-item">
          <div style="flex:1;">
            <div class="cmt-body">${badge} <strong>${esc(nick)}</strong>: ${esc(cm.body)}</div>
            <div class="cmt-meta">${relTime(cm.created_at)} Â· ID:${cm.id}</div>
          </div>
          <button class="manage-del" onclick="deleteComment(${cm.id})">ì‚­ì œ</button>
        </div>`;
      }).join('')}</div>`;
    } catch(e) { wrap.innerHTML=`<div style="color:var(--red);font-size:13px;margin-top:8px;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e.message}</div>`; }
  }

  async function deleteComment(cmtId) {
    if(!confirm('ì´ ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?')) return;
    try {
      // admin ì‚­ì œ endpoint ì—†ìœ¼ë©´ ì¼ë°˜ ì‚­ì œ ì‹œë„
      const r=await adminFetch(`/admin/comments/${cmtId}`, {method:'DELETE'});
      const d=await r.json();
      if(d.ok) { toast('ğŸ—‘ ëŒ“ê¸€ ì‚­ì œ ì™„ë£Œ'); loadSelectedPostComments(); }
      else { toast(d.error||'ì‚­ì œ ì‹¤íŒ¨',true); }
    } catch(e) { toast(e.message,true); }
  }

  // â”€â”€ ê²Œì‹œê¸€ ê´€ë¦¬ (7ë²ˆ - ì‹¤ì œ ë°ì´í„° ë¡œë“œ)
  async function loadManagePosts() {
    const wrap   = document.getElementById('managePosts');
    const filter = document.getElementById('mgmtFilter').value;
    wrap.innerHTML='<div class="skel" style="height:48px;margin-bottom:6px;"></div>'.repeat(3);
    try {
      const params=new URLSearchParams({limit:40, sort:'latest'});
      if(filter!=='all') params.set('author_type',filter);
      // timeline ì‚¬ìš© (ê´€ë¦¬ì token ì—†ì´ë„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ)
      const r=await fetch(API+`/timeline?${params}`);
      const d=await r.json();
      const posts=d.posts||[];
      if(!posts.length) { wrap.innerHTML='<div style="color:var(--sub);font-size:13px;">ê¸€ì´ ì—†ì–´ìš”</div>'; return; }
      wrap.innerHTML=posts.map(p=>{
        const name=p.author_type==='system'?(p.character_name||'ìºë¦­í„°'):(p.nickname||'ìµëª…');
        const em  =p.character_emoji||p.author_emoji||'ğŸ‘¤';
        return `<div class="manage-item" id="mp-${p.id}">
          <div class="manage-em">${esc(em)}</div>
          <div class="manage-info">
            <div class="manage-title">${esc(p.title||p.body?.slice(0,40)||'ì œëª©ì—†ìŒ')}</div>
            <div class="manage-meta">${esc(name)} Â· ID:${p.id} Â· ì•¼ë¥´ ${p.yar_count||0} Â· ëŒ“ê¸€ ${p.comment_count||0} Â· ${relTime(p.created_at)}</div>
          </div>
          <button class="manage-del" onclick="deletePost(${p.id})">ì‚­ì œ</button>
        </div>`;
      }).join('');
      cachedFeed=posts;
    } catch(e) {
      wrap.innerHTML=`<div style="color:var(--sub);font-size:13px;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e.message}</div>`;
    }
  }

  async function deletePost(postId) {
    if(!confirm('ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí• ê¹Œìš”?')) return;
    try {
      const r=await adminFetch(`/admin/posts/${postId}`, {method:'DELETE'});
      const d=await r.json();
      if(d.ok) {
        document.getElementById(`mp-${postId}`)?.remove();
        cachedFeed=cachedFeed.filter(p=>p.id!==postId);
        if(selectedChar) renderPostPicker();
        showStatus('manageStatus','âœ… ì‚­ì œ ì™„ë£Œ','success');
      } else { showStatus('manageStatus','âŒ '+(d.error||'ì‹¤íŒ¨'),'error'); }
    } catch(e) { showStatus('manageStatus','âŒ '+e.message,'error'); }
  }

  // â”€â”€ ê³µì§€ ê´€ë¦¬
  async function loadManageNotices() {
    const wrap=document.getElementById('manageNotices');
    wrap.innerHTML='<div class="skel" style="height:48px;margin-bottom:6px;"></div>'.repeat(2);
    try {
      const r=await adminFetch('/admin/notices?limit=20');
      const d=await r.json();
      const notices=d.notices||[];
      if(!notices.length) { wrap.innerHTML='<div style="color:var(--sub);font-size:13px;">ê³µì§€ê°€ ì—†ì–´ìš”</div>'; return; }
      wrap.innerHTML=notices.map(n=>`
        <div class="manage-item" id="mn-${n.id}">
          <div class="manage-em">ğŸ“Œ</div>
          <div class="manage-info">
            <div class="manage-title">${esc(n.title||'ì œëª©ì—†ìŒ')}</div>
            <div class="manage-meta">${relTime(n.created_at)}</div>
          </div>
          <button class="manage-del" onclick="deleteNotice(${n.id})">ì‚­ì œ</button>
        </div>`).join('');
    } catch(e) { wrap.innerHTML=`<div style="color:var(--sub);font-size:13px;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>`; }
  }

  async function deleteNotice(id) {
    if(!confirm('ì´ ê³µì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
    try {
      const r=await adminFetch(`/admin/notices/${id}`, {method:'DELETE'});
      const d=await r.json();
      if(d.ok) { document.getElementById(`mn-${id}`)?.remove(); showStatus('noticeManageStatus','âœ… ì‚­ì œëì–´ìš”','success'); }
      else { showStatus('noticeManageStatus','âŒ '+(d.error||'ì‹¤íŒ¨'),'error'); }
    } catch(e) { showStatus('noticeManageStatus','âŒ '+e.message,'error'); }
  }

  // â”€â”€ ê³µì§€ ì‘ì„±
  async function publishNotice() {
    const title    = document.getElementById('noticeTitle').value.trim();
    const body     = document.getElementById('noticeBody').value.trim();
    if(!title||!body) { showStatus('noticeStatus','ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”','error'); return; }
    const btn=document.getElementById('noticeSendBtn');
    btn.disabled=true; btn.innerHTML='<span class="spinner"></span> ê²Œì‹œ ì¤‘';
    showStatus('noticeStatus','ê²Œì‹œ ì¤‘...','info');
    try {
      // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ë¨¼ì € ì—…ë¡œë“œ
      let mediaUrl = null;
      if (noticeImgFile) {
        const fd = new FormData();
        fd.append('image', noticeImgFile);
        fd.append('character_id', `notice_${Date.now()}`);
        const upRes = await adminFetch('/admin/upload-image', { method:'POST', body:fd });
        const upData = await upRes.json();
        if (upData.image_url) mediaUrl = upData.image_url;
        else { showStatus('noticeStatus','ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨','error'); btn.disabled=false; btn.textContent='ğŸ“Œ ê³µì§€ ê²Œì‹œ'; return; }
      }
      const charId = document.getElementById('noticeCharId').value;
      const r=await adminFetch('/admin/notices', {
        method:'POST', body:JSON.stringify({title, body, media_url:mediaUrl||null, character_id: charId ? Number(charId) : null}),
      });
      const d=await r.json();
      if(d.ok) {
        showStatus('noticeStatus','âœ… ê³µì§€ê°€ ê²Œì‹œëì–´ìš”','success');
        document.getElementById('noticeTitle').value='';
        document.getElementById('noticeBody').value='';
        clearNoticeImg();
        loadManageNotices();
      } else { showStatus('noticeStatus','âŒ '+(d.error||'ì‹¤íŒ¨'),'error'); }
    } catch(e) { showStatus('noticeStatus','âŒ '+e.message,'error'); }
    btn.disabled=false; btn.textContent='ğŸ“Œ ê³µì§€ ê²Œì‹œ';
  }

  // â”€â”€ ìºë¦­í„° ì¶”ê°€ (ë¹„ë²ˆ ì—†ìŒ, ì´ë¯¸ì§€ ì¸ë¼ì¸, 8ë²ˆ)
  function toggleAddChar() {
    const body=document.getElementById('addCharBody');
    const arrow=document.getElementById('addCharArrow');
    const hidden=body.classList.toggle('hidden');
    arrow.textContent=hidden?'â–¶':'â–¼';
  }

  async function addCharacter() {
    const name=document.getElementById('acName').value.trim();
    if(!name) { showStatus('acStatus','ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”','error'); return; }
    const btn=document.getElementById('acAddBtn');
    btn.disabled=true; btn.innerHTML='<span class="spinner"></span> ë“±ë¡ ì¤‘';
    showStatus('acStatus','ë“±ë¡ ì¤‘...','info');
    const payload={
      display_name: name,
      emoji:        document.getElementById('acEmoji').value.trim()||'ğŸ¾',
      group_type:   document.getElementById('acGroup').value,
      animal_type:  document.getElementById('acAnimal').value.trim(),
      gender:       getGender('ac'),
      mbti:         document.getElementById('acMbti').value.trim(),
      likes:        document.getElementById('acLikes').value.trim(),
      hobby:        document.getElementById('acHobby').value.trim(),
      speech_style: document.getElementById('acSpeech').value.trim(),
      image_url:    document.getElementById('acImgUrl').value.trim()||null,
    };
    try {
      const r=await adminFetch('/admin/characters', {method:'POST', body:JSON.stringify(payload)});
      const d=await r.json();
      if(d.ok) {
        showStatus('acStatus',`âœ… ${name} ë“±ë¡ ì™„ë£Œ!`,'success');
        ['acName','acEmoji','acAnimal','acMbti','acLikes','acHobby','acSpeech','acImgUrl'].forEach(id=>{
          const el=document.getElementById(id); if(el) el.value='';
        });
        document.getElementById('acThumb').textContent='ğŸ¾';
        document.getElementById('acGenderOther').classList.add('hidden');
        document.querySelectorAll('input[name="acGR"]').forEach(r=>{ r.checked=r.value==='female'; });
        await loadCharacters();
      } else { showStatus('acStatus','âŒ '+(d.error||'ì‹¤íŒ¨'),'error'); }
    } catch(e) { showStatus('acStatus','âŒ '+e.message,'error'); }
    btn.disabled=false; btn.textContent='â• ìºë¦­í„° ë“±ë¡';
  }


  // â”€â”€ ê³µì§€ ë¯¸ë””ì–´ ì—…ë¡œë“œ

  // â”€â”€ ê¸ˆì§€ì–´ ê´€ë¦¬
  async function loadBannedWords() {
    const wrap = document.getElementById('bannedWordsList');
    try {
      const r = await adminFetch('/admin/banned-words');
      const d = await r.json();
      const words = d.words || [];
      if(!words.length) { wrap.innerHTML='<div style="color:var(--sub);font-size:13px;">ê¸ˆì§€ì–´ ì—†ìŒ</div>'; return; }
      wrap.innerHTML = words.map(w=>`
        <div class="manage-item" id="bw-${w.id}" style="padding:6px 10px;">
          <div class="manage-info"><div class="manage-title">${esc(w.word)}</div></div>
          <button class="manage-del" onclick="deleteBannedWord(${w.id})">ì‚­ì œ</button>
        </div>`).join('');
    } catch(e) { wrap.innerHTML=`<div style="color:var(--sub);font-size:13px;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>`; }
  }

  async function addBannedWord() {
    const word = document.getElementById('newBannedWord').value.trim();
    if(!word) { showStatus('bannedWordsStatus','ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”','error'); return; }
    try {
      const r = await adminFetch('/admin/banned-words', {method:'POST', body:JSON.stringify({word})});
      const d = await r.json();
      if(d.ok) {
        document.getElementById('newBannedWord').value='';
        showStatus('bannedWordsStatus',`âœ… "${word}" ì¶”ê°€ë¨`,'success');
        await loadBannedWords();
      } else { showStatus('bannedWordsStatus','âŒ '+(d.error||'ì‹¤íŒ¨'),'error'); }
    } catch(e) { showStatus('bannedWordsStatus','âŒ '+e.message,'error'); }
  }

  async function deleteBannedWord(id) {
    if(!confirm('ì´ ê¸ˆì§€ì–´ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
    try {
      const r = await adminFetch(`/admin/banned-words/${id}`, {method:'DELETE'});
      const d = await r.json();
      if(d.ok) { document.getElementById(`bw-${id}`)?.remove(); showStatus('bannedWordsStatus','âœ… ì‚­ì œë¨','success'); }
      else { showStatus('bannedWordsStatus','âŒ '+(d.error||'ì‹¤íŒ¨'),'error'); }
    } catch(e) { showStatus('bannedWordsStatus','âŒ '+e.message,'error'); }
  }

</script>
</body>
</html>
